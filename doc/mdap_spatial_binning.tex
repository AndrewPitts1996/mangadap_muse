\subsection{{\tt mdap\_spatial\_binning.pro}}
\label{dap_sec:mdap_spatial_binning}

This module is an interface for the mdap\_voronoi\_2d\_binning.pro
module, which uses the Voronoi Binning scheme (modified Loyd
algorithm) to combine adjacent spectra in the field of view till a
minimum $S/N$ is reached (see Section
\ref{dap_sec:mdap_voronoi_2d_binning}).

If the minimum $S/N$ is not reached, the requirement will be
automatically decreased by a factor 0.7 till convergence. By default,
spectra with mean $S/N < 4$ per \AA will be discarded. At least, 1
spectrum per datacube will be produced.

If user-defined spatial binning is provided (via the user\_bin\_map
keyword) the Voronoi binning scheme is overrided.

Table \ref{dap_tab:mdap_spatial_binning} lists the inputs and outputs
required for this module.

\begin{center}
\begin{longtable}{p{2.7cm}| p{11.1cm} }
\caption{Inputs and outputs parameters of mdap\_spatial\_binning.pro} \label{dap_tab:mdap_spatial_binning} \\
\hline
\endfirsthead
\hline
\endhead
\hline
\endlastfoot
\hline
{\bf  INPUTS} & \\
\hline
data   &    Galaxy spectra as produced by mdap\_read\_datacube.pro.
           [NxMxT dbl array] if DATACUBE format or [NxT dbl array]if RSS format.\\
%
error  &    Errors associated to data, produced by mdap\_read\_datacube.pro.
           [NxMxT dbl array] if DATACUBE format or [NxT dbl array]if RSS format.\\
%
signal  &   Mean galaxy signal per \AA, produced by mdap\_read\_datacube.pro.
           [NxM dbl array] if DATACUBE format or [N dbl array]if RSS format.\\
%
noise  &    Mean galaxy error per \AA,  produced by mdap\_read\_datacube.pro. 
           [NxM dbl array] if DATACUBE format or [N dbl array]if RSS format.\\
%
min\_sn &    [float] Minimum S/N (per \AA) required for the output binned spectra.\\
%
x2d   &     Array containing the x coordinates in arcseconds (0 is the center of the field of view), produced by  mdap\_read\_datacube.pro.    
            [NxM dbl array] if DATACUBE format or [N dbl array]if RSS format.\\
%
y2d   &     Array containing the y coordinates in arcseconds (0 is the center of the field of view), produced by  mdap\_read\_datacube.pro.    
           [NxM dbl array] if DATACUBE format or [N dbl array] if RSS format.\\
%
stepx  &    [float] Scale arcsec/pixel along X direction, computed by  mdap\_read\_datacube.pro. \\
%
stepy   &   [float] Scale arcsec/pixel along Y direction, computed by  mdap\_read\_datacube.pro. \\
%
\hline
{\bf OPTIONAL INPUTS} & \\
\hline
%
sn\_thr   &  [float] If specified, spectra with S/N lower than this value will be excluded from the analysis. \\ 
%
x2d\_ reconstructed & [N'xM' array] Two-dimesional map of X coordinates where the output spatial\_binning should be created. Required and used only  
                    if the input data are in RSS format. \\
%
y2d\_ reconstructed & [N'xM' array] Two-dimesional map of Y coordinates where the output spatial\_binning should be created. Required and used only 
                    if the input data are in RSS format. \\
%
SN\_ CALIBRATION    & vector. If provided, the estimated signal-to-noise ({\tt SN\_est}) is converted into the real signal-to-noise ({\tt SN\_real}) using the empirical
                  calibration function defined in mdap\_calibrate\_sn.pro:
           \[
           {\rm S/N_{REAL}} = \sum_{i=1,N} C_i \cdot \left( \frac{{\rm S/N_{ESTIMATED}}^{C_0}}{ \sqrt{{\rm N}_{\rm spax} }} \right)^{i-1} 
            \]

                    where {\tt Nbin} is the number of spectra added in that spatial bin.\\
%
user\_bin\_map   &  string  If provided, the spatial map will be created
                      from the fits fiel specified by this input. The
                      fits file must contain the CRVAL1, CRVAL2,
                      CDELT1, CDELT2, NAXIS1, NAXIS2, CRPIX1, and
                      CRIX2 header keywords (coordinate units in
                      arcseconds, 0,0 indicates the center of the
                      field of view. \\

\hline
{\bf INPUT KEYWORDS} & \\
\hline
%
/plot        &       If set, some plots on X11 terminal will be shown. Not suggested if the task is launched remotely. \\
% 
/weight\_for\_sn & If set, the spectra in the same spatial bin will be
                 weighted by $S/N^2$ before being added. If The voronoi binning scheme
                 is adopted, the S/N in the bin is computed via equation (3) of
                 Cappellari \& Copin (2003) and the centers of te spatial bins are computed by
                 weighting spectra coordinates by $S/N^2$.\\ 
%
\hline
{\bf OUTPUTS} & \\
\hline
%
binning\_map & Two dimensional map showing the binning sheme. Pixels beloning to the i-th bin have value i (i=0, 1, ..., Nbins). 
             Pixels associated to no spatial bin have value -1.  
             [NxM dbl array] if inputs are in DATACUBE format or [N'xM' dbl array] if inputs are in RSS format (interpolated 
             over x2d\_reconstructed and y2d\_reconstructed).\\
%
spectra   &  [Nbins x T dbl array]    The binned spectra of the spatial Nbins. i-th spectrum is associated to the i-th bin. \\
%
errors    &  [Nbins x T dbl array]    Errors vectors associate do the binned spectra. \\
%
xNode     &  [Nbins elements array]   X-Coordinates in arcsec of the luminosity weighted centers of the spatial bins. \\
%
yNode     &  [Nbins elements array]   Y-Coordinates in arcsec of the luminosity weighted centers of the spatial bins. \\
%
area\_bins &  [Nbins elements array]   Area (in arcsec$^2$) of each spatial bin.  \\
%
bin\_sn   &  [Nbins elements array]   Mean S/N per \AA reached in each spatial bin. \\
%
\hline
{\bf OPTIONAL OUTPUTS} & \\
\hline
%
 nelements\_ within\_ bin & [Nbins elements array] number of spaxels (in the case of DATACUBE format) or number of fibres (in the case of RSS format) coadded in each spatial bin.\\
%
 version   & [string]            Module version. If requested, the module is not execute and only version flag is returned.\\
\hline
\end{longtable}
\end{center}


