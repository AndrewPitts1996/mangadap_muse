
\documentclass[11pt]{book}
%usepackage[italian]{babel}
\usepackage{epsfig}
%\usepackage{psfig}
\usepackage{amssymb}
\usepackage{latexsym}
\usepackage{longtable}
\usepackage{subfigure}
\usepackage{graphics}
\usepackage{lscape}
\usepackage{a4wide}

\usepackage{graphicx}
\usepackage{natbib}


\newcommand{\msun}{M$_{\odot}$}
\newcommand{\kms}{km s$^{-1}$}

\begin{document}
\begin{titlepage}
\title{{\Huge The MANGA Data Analysis Pipeline: \\
a prototype}}
\author{L. Coccato \& MANGA team}
\end{titlepage}

\maketitle
\tableofcontents

% ======================================================================
%\newcommand{\kms}{km s$^{-1}$}
%\chapter{Introduction}
%\label{dap}
%
%
%\section{Abstract}
%\label{dap_sec:abstract}%
%
%This chapter %
%
%\subsection{Acronyms and definitions}%
%
%In this chapter, we will adopt the following acronyms and definitions:
%
%\begin{tabular}{l l}
%DRP & Data Reduction Pipeline \\
%DAP & Data Analysis Pipeline \\
%LOSVD & Line Of Sight Velocity Distribution \\
%LSF & Line Spread Function \\
%SRD & Sciente Requirement Document \\
%
%
%\end{tabular}




\chapter{Introduction}
\label{dap_chap:introduction}


\section{Data Analysis Pipeline (DAP): overview}
\label{dap_sec:dap_overview}

The scope of the Data Analysis Pipeline is to analyse the output of
the Data Reduction Pipeline and deliver science products. They are
classed into two groups, the {\bf High level data products} and the
{\bf Model dependent data products}.

High level data products are:
\begin{itemize}
     \item Stellar kinematics (velocity, velocity dispersion, h3, and h4 Gauss-Hermite moments).
     \item Emission line kinematics (velocity, and velocity dispersion).
     \item Equivalent widths and fluxes of emission lines.
     \item Absorption line strengths.
     \item Reddening.
     \item Radial gradients of measured quantities.
     \item Rotation curves and kinemetric parameters.
     \item Stellar weights from full spectral fitting.
\end{itemize}

Model dependent data products are:
\begin{itemize}
    \item Stellar population parameters age, metallicity, chemical
      element ratios, and IMF, and their radial gradients (from absorption features).
    \item Stellar population parameters age, metallicity, chemical
      element ratios, and IMF, and their radial gradients (from full spectral fitting).
    \item Extinction corrected star formation rates and hystories.
    \item Gas metallicities, BPT diagrams.
    \item Mass to light ratio (from stellar population).
    \item Mass to light ratio, dynamical mass (from dynamical
      modeling).
    \item Angular momentum.
   % \item Characterization of asymmetries, see Section \ref{sec:dynamical_state}.
   % \item Measurements of the Toomre Q-parameter, see Section  \ref{sec:growth_bulges}.
\end{itemize}%

\subsection{Installation and requirements}
\label{dap_sec:installation}
T.B.D.

\include{dap_workflow_description}

\include{configuration_file}

\subsection{Version control and tags. Obsolete}
\label{dap_sec:dap_version}


At the beginning of the execution, the DAP check whether the output
.fits file and .idl sessions exist. If so, it reads the version(s)
used to generate the existing files. If the current module versions
are greater than those used to generate the output file, the analysis
is performed again.

\begin{itemize}

\item {\bf manga\_dap\_version}. The version of the DAP. If the module
  version is greater than that stored in the output files, the entire
  analysis is performed again (currently, blocks 1-5).

\item {\bf mdap\_read\_datacube\_version}. The version of modules in
  block 1. If it is greater than that stored in the output file, blocs
  1-5 are executed again.

\item {\bf mdap\_spatial\_binning\_version}. The version of modules in
  block 2. If it is greater than that stored in the output file, blocs
  2-5 are executed again. It must include version information about
  mdap\_voronoi\_binning.pro as well.

\item {\bf mdap\_log\_rebin\_version}. The version of modules in
  block 3. If it is greater than that stored in the output file, blocs
  3-5 are executed again.

\item {\bf mdap\_spectral\_fitting\_version}. The version of modules
  in block 4. If it is greater than that stored in the output file,
  blocs 4-5 are executed again. It must include version information
  about mdap\_sgandalf.pro as well.

\item {\bf mdap\_measure\_index\_version}. The version of modules in
  block 5. If it is greater than that stored in the output file, block
  5 is executed again.

\end{itemize}

Warning: the version control is enabled only if the keyword
/check\_version is set.

\begin{figure}
\begin{center}
%\hspace{-2cm}
%\includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}  25 150 810 445
\psfig{file=figures/mangaDAP_workflow_1.ps, width=9cm, clip=, bb= 140 20 450 800}
%\vspace*{0cm}
\caption{Workflow chart of the Data Analysis Pipeline (High Level Data products).}
 \label{dap_fig:dap_workflow_1}
\end{center}
\end{figure}


\begin{figure}
\begin{center}
%\hspace{-2cm}
%\includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}  65 144 702  420 
\psfig{file=figures/mangaDAP_workflow_2.ps,  width=9cm, clip=, bb= 22 20 340 800}
%\vspace*{0cm}
\caption{Workflow chart of the Data Analysis Pipeline (Model Dependent Data products).}
 \label{dap_fig:dap_workflow_2}
\end{center}
\end{figure}

\chapter{BLOCKs and ``interface'' modules}
\label{dap_chap:blocks}

\section{DAP Block 1: reading the input data}
\label{dap_sec:block1}

This block reads the input data (in the form of a datacube or RSS
files) and extracts the all information needed for further processing,
such as the galaxy spectra and errors, wavelength vector, 2D maps
containing the coordinates, and galaxy signal and noise. The interface
module in this block is: mdap\_read\_datacube.pro (see Section
\ref{dap_sec:mdap_read_datacube} for a list of inputs and outputs).

The main modules in the block, called by the interface, are
mdap\_calculate\_spectrum\_sn.pro (see Section
\ref{dap_sec:mdap_calculate_spectrum_sn} for a list of inputs and
outputs).

The Block will provide the galaxy spectra (and errors),
two-dimensional maps with coordinates (in arcseconds, the center of
the field has coordinates 0,0), the two-dimensional maps of the signal
and the noise (per angstrom), the wavelength vector (in \AA) and
related quantities (initial \AA, reciprocal dispersion
\AA\ pixel$^{-1}$), and header information for 2-dimensional
maps. Figure \ref{dap_fig:block1} illustrates the flowchart of block
1.


\begin{figure}
\begin{center}
\psfig{file=figures/block1.ps, width=15.0cm, clip=}
\caption{Workflow chart of the block 1 of the Data Analysis
  Pipeline. See Section \ref{dap_sec:mdap_read_datacube} for a
  description of inputs and outputs.}
 \label{dap_fig:block1}
\end{center}
\end{figure}


\include{mdap_read_datacube}


\section[DAP Block 2: Spatial binning]{DAP Block 2: Spatial binning}
\label{dap_sec:block2}

This block adds adjacent spectra in the field of view to reach a
minimum signa-to-noise ratio, and organizes the observations into
spatial bins. 

It requires the spectra, errors, signals and noise for each spectrum,
and the coordinates obtained from block 1 as inputs. It returns the
binned spectra (and errors) and all the geometrical information of the
spatial bin (2D maps and coordinates of the bins center). It handles
both datacubes and RSS input files format.

Three different spatial binning schemes with different
are handled, depending on the scientific purposes.


\begin{enumerate}

\item First binning, which requires a minimum $S/N = 40$ per
  \AA. The spectra binned this way will be used to measure the
  equivalent width ob absorption line indices, to perform the full
  spectral fitting, and to derive the stellar population properties.

\item Second binning, which requires a minimum $S/N = 25$ per
  \AA. The spectra binned this way will be used to measure the
  stellar kinematics and dynamical models.


\item Third binning, which requires a minimum $S/N = 15$ per
  \AA. The spectra binned this way will be used to measure the
  emission line kinematics, fluxes, and widths, the reddening, gas
  metallicities and star formation rates.

\end{enumerate}

$S/N$s are computed in the wavelength range $5560 < \lambda < 6942$
(SLOAN r-band).


The interface module in this block is mdap\_spatial\_binning.pro (see
Section \ref{dap_sec:mdap_spatial_binning}). The main module is
mdap\_voronoi\_2d\_binning.pro (Section
\ref{dap_sec:mdap_voronoi_2d_binning}).

mdap\_voronoi\_2d\_binning.pro uses an imlementation of the Voronoi
Binning technique developed by \citet{Cappellari+03} (see Section
\ref{dap_sec:mdap_voronoi_2d_binning}). The implementation accounts
for spatial correlation between errors of adjacent spectra: the
estimated $S/N$ is calibrated to the real $S/N$ via empirical relation
and it is done by the utility module mdap\_calibrate\_sn.pro.

Note that RSS spectra do not require the above $S/N$ calibration,
because the errors between adjacent RSS files are not correlated.


The interface mdap\_spatial\_binning.pro accepts an user-defined fits
file describing the spatial binning scheme. This file needs to be
provided via the input keyword: user\_bin\_map. The names are defined
in the DAP configuration file (see Section
\ref{dap_sec:configuration}). The inclusion of an used-defined file
overrides the Voronoi binning.

On request, the spectra in the same spatial bin can be added together
by weighting them with their $S/N^2$ (weight\_by\_sn keyword).

Figure \ref{dap_fig:block2} illustrates the flowchart of block 2.

\subsubsection{Future implementations}
Future implementations:

\begin{itemize}

 \item calculation of spatial covariance matrix to account for error
   correlations and avoid the use of $S/N$ calibration relations.

  \item Allow for an equal flux surface binning scheme (Sanchez et
    al. ?) instead of the Voronoi binning scheme.

\end{itemize}

\begin{figure}
\begin{center}
%\hspace{-2cm}
%\includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}
\psfig{file=figures/block2.ps, width=16.0cm, clip=,bb=25 77 590 815}
%\vspace*{0cm}
\caption{Workflow chart of the block 2 of the Data Analysis
  Pipeline.}
 \label{dap_fig:block2}
\end{center}
\end{figure}

\include{mdap_spatial_binning}

\section[DAP Block 3: Logarithmic sampling]{DAP Block 3: Logarithmic sampling of input galaxy spectra and stellar templates}
\label{dap_sec:block3}

This block is responsable for:

\begin{itemize}

\item resampling the input galaxy spectra and errors (rebinned
  spectra, input from block 2) to a ln-wavelength constant step.

\item resampling the stars in the spectral library in the same
  ln-wavelength constant step used for galaxy spectra, and ensuring
  that the stars have the same instrumental resolution (i.e. the same
  LSF) of the galaxy spectra.

\item selecting only the wavelength region of interest, making sure
  that the wavelenght range of the template stars is larger than that
  of the galaxy spectra.

\item defyning the wavelenght vectors (ln units) over which the galaxy
  spectra, galaxy errors, and template stars are defined.

\end{itemize}

Because the DAP performs three different spatial binnings of the input
galaxy, the block operates

The interface module in this block is mdap\_log\_rebin.pro (see
Section \ref{dap_sec:mdap_log_rebin}), which calls the main module
mdap\_do\_log\_rebin.pro that performs the logarithmic resampling (see
Section \ref{dap_sec:mdap_do_log_rebin}). Because the DAP performs
three different spatial binnings of the input galaxy, block 3 executes
mdap\_log\_rebin.pro three times, one for each set of spatially binned
spectra. The workflow of block 3 is shown in Figure
\ref{dap_fig:block3}.

The current version of the DAP uses the MARCS stellar library models
(Maraston \& Stromback, 2011, MNRAS, 418, 2785).

\begin{figure}
\begin{center}
%\hspace{-2cm} \includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}
\psfig{file=figures/block3.ps, width=13.5cm, clip=,bb=30 70 592 790}
%\vspace*{0cm}
\caption{Workflow chart of the block 3 of the Data Analysis
  Pipeline.}
 \label{dap_fig:block3}
\end{center}
\end{figure}

\include{mdap_log_rebin}

\section[DAP Block 4: Spectral fitting]{DAP Block 4: Spectral fitting}

This block is responsible for fitting the input galaxy spectra with a
set of stellar templates and Gaussian Emission lines to derive the
kinematics of stars, ionized gas, and emission line fluxes and
equivalent widths.

This block has two interfaces: mdap\_spectral\_fitting.pro (see
Section \ref{dap_sec:mdap_spectral_fitting}) and
mdap\_ create\_starting\_guesses (see Section
\ref{dap_sec:mdap_create_starting_guesses}).


The interface mdap\_create\_starting\_guesses handles the starting
guesses (either from the user input file, or using the results of a
previous fit) and feeds the spectral fitting interface.


The interface mdap\_spectral\_fitting arranges inputs and outputs for
the routine that performs the actual fit, i.e.
mdap\_gandalf\_wrap.pro, which is an adapted version of the pPXF
(\citealt{Cappellari+04}) and gandalf (\citealt{Sarzi+06}) routines
(see Section \ref{dap_sec:mdap_gandalf_wrap} for information on how
the fit is performed). 

Block 4 requires as input the log-resampled spectra of the galaxy (and
errors) and the stars, wavelenght vectors, the binning spatial
informations, and starting guesses for the galaxy redshift and
velocity dispersion.

The fitting procedure can be fed with a vector that describes the
variation of the instrumental velocity dispersion with
wavelength \footnote{This affects only emission lines measurements,
  because the stellar templates have already been convolved in Block 3
  to match the instrumental resolution, see \ref{dap_sec:block3}}. If
not provided, a constant instrumental velocity dispersion of 52 km/sec
will be adopted.

The block executes the module mdap\_spectral\_fitting.pro three times,
once for each set of spatially binned spectra.  The current version of
the DAP uses the MARCS library of ssp  (Maraston \& Stromback,
2011, MNRAS, 418, 2785) for the spectral fitting.




\begin{enumerate}

\item {\it First module execution.} The log-sampled Galaxy spectra are
  fitted with a linear combination of templates and Gaussian Emission
  lines. This step requires input starting guesses of the galaxy
  redshift and stellar velocity dispersion (more than one redshift,
  and coordinates of galaxy centers if more galaxies are presented in
  the field of view). The galaxy spectra with the best-fit emission
  lines removed produced as output will be used to measure the
  absorption line strenghts (block 5).  Galaxy reddening is also
  fitted, if required. This execution does not provide final highlevel
  data products, but it will provides: i) galaxy spectra with the
  best-fit emission lines removed (which will be used in block 5 to
  measure the absorption line indices), ii) the weights of the stellar
  templates (which will be used to compute the stellar populations in
  block 7).
  %If the Milky-Way
  %extinction value is provided, the input galaxy spectra are corrected
  %before fitting.

\item {\it Second module execution.} The results of the first
  execution (stellar and emission lines kinematics) are re-sampled
  over the second spatial sampling and used as starting guesses for
  the second execution on the second set of galaxy spectra (second
  spatial binning). This step is performed by the interface
  mdap\_create\_starting\_guesses.pro (Section
  \ref{dap_sec:mdap_create_starting_guesses}) and the utility
  mdap\_interpolate\_2dmaps.pro (Section
  \ref{dap_sec:mdap_interpolate_2dmaps}. As in the first execution,
  log-sampled Galaxy spectra are fitted with a linear combination of
  stellar templates and Gaussian Emission lines. Only those stellar
  templates that are selected in the first execution, will be used in
  the second run (unless the keyword /dont\_remove\_ null\_templates
  of the manga\_dap is set, see Section
  \ref{dap_sec:dap_inputs_outputs}).

% If the Milky-Way extinction value
%  is provided, the input galaxy spectra are corrected before
%  fitting. The final high level products produced in this execution
%  are the stellar kinematics (V,$\sigma$, H3, and H4).

\item {\it Third module execution.} The emission line kinematics from
  the second execution are re-sampled over the third spatial sampling
  and used as starting guesses for the third execution. The stellar
  kinematics from the second execution are re-sampled over the third
  spatial sampling and {\it fixed} in the third execution. This step
  is performed by the interface mdap\_create\_starting\_guesses.pro
  (Section \ref{dap_sec:mdap_create_starting_guesses}) and the utility
  mdap\_interpolate\_2dmaps.pro (Section
  \ref{dap_sec:mdap_interpolate_2dmaps}. As in the first execution,
  log-sampled Galaxy spectra are fitted with a linear combination of
  stellar templates and Gaussian Emission lines. Only those stellar
  templates that are selected in the first execution, will be used in
  the third run (unless the keyword /dont\_remove\_ null\_templates of
  the manga\_dap is set, see Section
  \ref{dap_sec:dap_inputs_outputs}).

%If the Milky-Way extinction value
%  is provided, the input galaxy spectra are corrected before
%  fitting. The final high level products produced in this execution
%  are: the emission line kinematics (V,$\sigma$), reddening, and
%  fluxes and equivalent widths (reddening corrected).

\end{enumerate}


At the end of block 4, the stellar kinematics (V, $\sigma$, h3, and
h4), emission line kinematics (V, $\sigma$), emission line fluxes and
equivalent widths, reddening (stars and gas) and stellar template
weights for each of spectrum and for the spatial binning scheme are
produced.

Figures \ref{dap_fig:block4} and \ref{dap_fig:block4a} shows the
flowchart of block 4.

\begin{figure}
\begin{center}
%\hspace{-2cm}
%\includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}
\psfig{file=figures/block4.ps, width=17cm, clip=, bb=35 25 560 620}
%\vspace*{0cm}
\caption{Workflow chart of the block 4 of the Data Analysis Pipeline.}
 \label{dap_fig:block4}
\end{center}
\end{figure}

\include{mdap_create_starting_guesses}

\include{mdap_spectral_fitting}

%\begin{figure}
%\begin{center}
%%\hspace{-2cm}
%%\includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}
%\psfig{file=figures/Block_4_zoom.ps, width=16cm, clip=}
%%\vspace*{0cm}
%\caption{Workflow chart of the block 4 of the Data Analysis Pipeline,
 % zoom around the first fit section.}
% \label{dap_fig:block4a}
%\end{center}
%\end{figure}


\section{DAP Block 5: Measurement of absorption line indices}
\label{dap_sec:block5}

This module is responsible for measuring the equivalent width of
absorption line indices on the galaxy spectra where the best fit model
for emission lines has been removed.

It requires the following inputs:
\begin{itemize}
 
\item The galaxy spectra with emission lines removed (from block 4).

\item The stellar velocity.

  \item The LSF as function of wavelenght (to a proper
broadening of the input spectra to the reference calibration system,
e.g. Lick, MILES).

\item The best fitting stellar template and the best fitting stellar
  template convolved by the best fitting LOSVD, for intrinsic
  broadening correction (from block 4).

\end{itemize}

Figure \ref{dap_fig:block5} illustrates the flowchart of this block.

The main module in this block is mdap\_measure\_ indices.pro (see
Section \ref{dap_sec:mdap_measure_indices}), which calls the procedure
that performs the measurement mdap\_do\_ measure\_index.pro (see
Section \ref{dap_sec:mdap_do_measure_index.pro}).

Figure \ref{dap_fig:block5} illustrates the flowchart of the main module in this block.

\begin{figure}
\begin{center}
%\hspace{-2cm}
%\includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}
\psfig{file=figures/block5.ps, width=13.5cm, clip=}
%\vspace*{0cm}
\caption{Workflow chart of mdap\_measure\_indices.pro, the main module in block 5 of the Data Analysis Pipeline.}
 \label{dap_fig:block5}
\end{center}
\end{figure}



\section{DAP Block 6: Radial properties of high level data products}
\label{dap_sec:block6}

\section{DAP Block 7: Stellar population analysis}
\label{dap_sec:block7}
T.B.D.

\section{DAP Block 8: Properties of the emission lines}
\label{dap_sec:block8}
T.B.D.

\section{DAP Block 9: Mass modeling}
\label{dap_sec:block9}
T.B.D.


\chapter{Main modules}
\label{dap_chap:dap_modules}

In this Chapter we describe the main modules of the DAP.

\include{mdap_calculate_spectrum_sn}

\include{mdap_do_log_rebin}

\include{mdap_voronoi_2d_binning}


\subsection{{\tt mdap\_sgandalf.pro}}
\label{dap_sec:mdap_sgandalf}

This procedure is called by mdap\_spectral\_fit.pro and it fits an
input galaxy spectrum with a set of stellar templates and Gaussian
emission lines to get the absorption and emission line kinematics, the
emission lines fluxes and equivalent widths, the weighs of the stellar
templates, the best fit models for stars and gas, the best fitting
stellar template and the best fitting stellar template convolved by
the LOSVD, the residuals, and the reddening (if required).

The kinematics are recovered parametrically, using a Gauss function
plus high order Gauss-Hermite moments for the stellar kinematics, and
a Gaussian function for the emission line kinematics.

The code itself is an implementation of the ppxf code by M. Capellari
(insert reference), and the spectroscopic decomposition code by
L. Coccato \citep{Coccato+11}.

The input galaxy spectrum is fitted according to the following steps:

\begin{enumerate}

  \item an optimal stellar template is build as linear combination of
    stars in a library. Regularization over the stellar population
    properties can be used.

  \item an optimal emission line spectrum is build as linear
    combination of N Gaussian emission lines. The number N of the
    emission lines and their rest-frame wavelength are read from an
    input file. This step should account for instrumenal LSF (to be
    developed).

  \item the optimal stellar template is convolved with a Gauss-Hermite
    line of sight velocity distribution, parametrized by V, $\sigma$,
    h3, and h4.

  \item the optimal emission line spectrum is convolved with a
    Gaussian line of sight velocity distribution, parametrized by V
    and $\sigma$.

  \item the convolved optimal emission line spectrum and optimal
    template are multiplied by set of legendre polynomials, or by a
    reddening function, parametrized by $E(B-V)$ according to the
    mdap\_dust\_calzetti.pro function (Section
    \ref{dap_sec:mdap_dust_calzetti}).

  \item spectra from points 4 and 5 are added together and compared to
    the input galaxy spectrum.

  \item points from 1 to 6 are repeated till minimum $\chi^2$ is
    reached.

\end{enumerate}

The list of input/output parameters is given in Table
\ref{dap_tab:mdap_sgandalf}.


\begin{center}
\begin{longtable}{p{2.7cm}| p{11.1cm}}
\caption{Inputs and outputs parameters of mdap\_sgandalf} \label{dap_tab:mdap_sgandalf} \\
\hline
\endfirsthead
\hline
\endhead
\hline
\endlastfoot
\hline
{\bf  INPUTS} & \\
TEMPLATES1 & [dbl array].  Vector containing the spectrum of a single template star or
        more ; commonly an array of dimensions
        TEMPLATES[nPixels,nTemplates] containing ; different templates
        to be optimized during the fit of the kinematics.  ; nPixels
        has to be $\geq$ the number of galaxy pixels.  

         Tips:
           \begin{itemize}

   \item To apply linear regularization to the WEIGHTS via the
     keyword REGUL, TEMPLATES should be an array of two
     TEMPLATES[nPixels, nAge], three TEMPLATES[nPixels, nAge, nMetal]
     or four TEMPLATES[nPixels,nAge,nMetal,nAlpha] dimensions,
     depending on the number of population variables one wants to
     study.  This can be useful to try to attach a physical meaning
     to the output WEIGHTS, in term of the galaxy star formation
     history and chmemical composition distribution.  In that case
     the templates may represent single stellar population SSP
     models and should be arranged in sequence of increasing age,
     metallicity or alpha along the second, third or fourth
     dimension of the array respectively.

   \item TEMPLATES and GALAXY do not need to span the same
     wavelength range. However an error will be returned by
     SGANDALF, if the velocity shift in pixels, required to match
     the galaxy with the templates, becomes larger than nPixels. In
     that case one has to truncate either the galaxy or the
     templates to make the two rest-frame spectral ranges more
     similar.

      \end{itemize} \\
%
TEMPLATES2: &[N x 2  dbl array]. It contains:

  \begin{itemize} 
    \item TEMPLATES2[*,0] the values of the wavelenghts of the N
      emission lines to fit, in logarithmic units (ln or Log10 as in
      the input galaxy spectrum).
    \item TEMPLATES2[*,1] The N signs of the gas lines to fit, +1 for
      emission lines, -1 for absorption lines (e.g. NaI.)
   \end{itemize} \\
%
   GALAXY: & [dbl array]. It contains the spectrum of the galaxy to be measured. The
       star and the galaxy spectra have to be logarithmically rebinned but the
       continuum does *not* have to be subtracted. The rebinning may be
       performed with the mdap\_do\_ log\_rebin.pro (Section \ref{dap_sec:mdap_do_log_rebin}).
 For high redshift galaxies, one should bring the spectra
       close to the restframe wavelength, before doing the SGANDALF
       fit, to prevent too large velocity shifts of the
       templates. This can be done by dividing the observed
       wavelenghts by (1+z), where z is a rough estimate of the
       galaxy redshift, before the logarithmic rebinning. TO BE
       IMPLEMENTED IN THE PIPELINE.\\
%
NOISE: & [dbl array vector]. It contains the 1*sigma error (per pixel)
     in the galaxy spectrum. IMPORTANT: the penalty term of the
     sgandalf method is based on the *relative* change of the fit
     residuals. For this reason the penalty will work as expected even if
     no reliable estimate of the NOISE is available (see Cappellari \&
     Emsellem [2004] for details).  If no reliable noise is available this
     keyword can just be set to: NOISE = galaxy*0+1 ; Same weight for all
     pixels. \\
% 
VELSCALE: & [float]. Velocity scale of the spectra in km/s per pixel. It
     has to be the same for both the galaxy and the template spectra.\\
%
  START: & [6 elements vector]. [velStart\_ stars,sigmaStart\_ stars, h3, h4, velStart\_ gas, sigmaStart\_ gas] 
      with the initial estimate for the velocity and the velocity dispersion in km/s.\\
%
\hline
{\bf OPTIONAL INPUTS} &   \\
%
BIAS: & [float]. This parameter biases the (h3,h4,...) measurements towards zero
       (Gaussian LOSVD) unless their inclusion significantly decreses the
       error in the fit. Set this to BIAS=0.0 not to bias the fit (Default value used in the DAP): the
       solution (including [V,$\sigma$]) will be noisier in that case. The
       default BIAS should provide acceptable results in most cases, but it
       would be safe to test it with Monte Carlo simulations. This keyword
       precisely corresponds to the parameter $\backslash$lambda in the Cappellari \&
       Emsellem (2004) paper. Note that the penalty depends on the *relative*
       change of the fit residuals, so it is insensitive to proper scaling
       of the NOISE vector. A nonzero BIAS can be safely used even without a
       reliable NOISE spectrum, or with equal weighting for all pixels.\\
%
DEGREE: & [integer]. degree of the *additive* Legendre polynomial used to correct
       the template continuum shape during the fit.
       Default: DEGREE = -1, i.e. no additive polynomial are fitted.\\
% 
GOODPIXELS:& [integer array]. It contains the indices of the good
       pixels in the GALAXY spectrum (in increasing order). Only these
       pixels are included in the fit. If the /CLEAN keyword is set,
       in output this vector will be updated to contain the indices of
       the pixels that were actually used in the fit.\\
%: 
LAMBDA: & [dbl array]. When the keyword REDDENING is used, the user has
      to pass in this keyword a vector with the same dimensions of GALAXY,
      giving the restframe wavelength in Angstrom of every pixel in the
      input galaxy spectrum, i.e. lambda = EXP(logLam).\\
%
MDEGREE: & [integer]. degree of the *multiplicative* Legendre polynomial (with mean of 1)
       used to correct the continuum shape during the fit (default: 0). The
       zero degree multiplicative polynomial is always included in the fit as
       it corresponds to the weights assigned to the templates.
       Note that the computation time is longer with multiplicative
       polynomials than with the same number of additive polynomials.
       IMPORTANT: Multiplicative polynomials cannot be used when
       the REDDENING keyword is set.\\
%
   MOMENTS: & [integer]. Order of the Gauss-Hermite moments to fit. Set this keyword to 4
       to fit [h3,h4] and to 6 to fit [h3,h4,h5,h6]. Note that in all cases
       the G-H moments are fitted (nonlinearly) *together* with [V,sigma].

       If MOMENTS=2 or MOMENTS is not set then only [V,sigma] are
       fitted and the other parameters are returned as zero.

       If MOMENTS=0 then only the templates and the continuum additive
       polynomials are fitted and the WEIGHTS are returned in output.\\
%
  REDDENING: & [Float]. Set this keyword to an initail estimate of the reddening $E(B-V)>=0$
      to fit a positive reddening together with the kinematics and the templates.
      After the fit the input estimate is replaced with the best fitting $E(B-V)$ value.
      The fit assumes the exctinction curve of Calzetti et al. (2000, ApJ, 533, 682)
      but any other prescriptions could be trivially implemented by modifying the
      function SGANDALF\_REDDENING\_CURVE within the procedure.

      IMPORTANT: The MDEGREE keyword cannot be used when REDDENING is set. \\
%
   REGUL:  & [Float]. If this keyword is nonzero, the program applies second-degree
       linear regularization to the WEIGHTS during the SGANDALF fit.
       Regularization is done in one, two or three dimensions depending on whether
       the array of TEMPLATES has two, three or four dimensions respectively.
       Large REGUL values correspond to smoother WEIGHTS output. The WEIGHTS tend
       to a linear trend for large REGUL. When this keyword is nonzero the solution
       will be a trade-off between smoothness of WEIGHTS and goodness of fit.

       The effect of the regularization scheme is to enforce the numerical second 
       derivatives between neighbouring weights (in every dimension) to be equal 
       to -w[j-1]+2*w[j]-w[j+1]=0 with an error Delta=1/REGUL. It may be helpful 
       to define REGUL=1/Delta and view Delta as the regularization error.

      IMPORTANT: Delta needs to be of the same order of magnitude as the typical 
       WEIGHTS to play an effect on the regularization. One way to achieve this is: 
     \begin{itemize}
       \item divide the TEMPLATES array by a scalar in such a way that the typical 
         template has a median of one (e.g. TEMPLATES/=median(TEMPLATES)); 
       \item do the same for the input GALAXY spectrum (e.g. GALAXY/=median(GALAXY)). 
         In this situation Delta and REGUL should be *roughly* of order unity. 
     \end{itemize}

     Here is a possible recipe for chosing the regularization parameter REGUL:
     \begin{itemize}
          \item Perform an un-regularized fit (REGUL=0) and then rescale the input
              NOISE spectrum so that $\chi^2$/DOF = $\chi^2$/N\_ELEMENTS(goodPixels) = 1.
              This is achieved by rescaling the input NOISE spectrum as
              NOISE = NOISE*sqrt($\chi^2$/DOF) = NOISE*sqrt(SOL[6]);
         \item Increase REGUL and iteratively redo the sgandalf fit until the $\chi^2$
              increases from the unregularized $\chi^2$ = N\_ELEMENTS(goodPixels)
              value by $\Delta chi^2$ = sqrt(2*n\_elements(goodPixels)).
     \end{itemize}
       The derived regularization corresponds to the maximum one still consistent
       with the observations and the derived star formation history will be the
       smoothest (minimum curvature) that is still consistent with the observations.

       For a detailed explanation see Section 18.5 of Press et al. (1992,
       Numerical Recipes 2nd ed.) available here http://www.nrbook.com/a/bookfpdf.php.
       The adopted implementation corresponds to their equation (18.5.10).\\
%
   VSYST: & [Float]. Difference in km/sec between the first pixel of the ln-wavelenght of the template stars and 
       the ln-wavelenght of the galaxy, i.e. dv = (loglam\_templates[0]-loglam\_gal[0])*c (it is computed in mdap\_spectral\_fitting.pro.\\ 
{\bf OPTIONAL KEYWORDS} &   \\
   /CLEAN &  set this keyword to use the iterative sigma clipping method
       described in Section 2.1 of Cappellari et al. (2002, ApJ, 578, 787).
       This is useful to remove from the fit unmasked bad pixels, residual
       gas emissions or cosmic rays. IMPORTANT: This is recommended *only* if a reliable estimate of the
       NOISE spectrum is available. See also note below for SOL.\\
%
   /QUIET &   set this keyword to suppress verbose output of the best fitting
       parameters at the end of the fit.\\
\hline
{\bf OUTPUTS} &  \\ 
  SOL: &[9+MDEGREE elements vector]. It contains  the values of
       [Vel\_star, Sigma\_Star, h3, h4, h5, h6,$\chi^2$/DOF, Vel\_gas, Sigma\_gas] of the best fitting solution, where DOF
       is the number of Degrees of Freedom (number of fitted spectral pixels).
       Vel is the velocity, Sigma is the velocity dispersion, h3-h6 are the
       Gauss-Hermite coefficients. The model parameter are fitted simultaneously.

       The following safety limits on the fitting parameters are hardcoded(check!!):
      \begin{enumerate}
         \item Vel is constrained to be +/-2000 km/s from the first input guess
         \item velScale/10 < Sigma < 1000 km/s
         \item -0.3 < [h3,h4,...] < 0.3 (limits are extreme value for real galaxies)
           \end{enumerate}

       IMPORTANT: if $\chi^2$/DOF is not $\sim$1 it means that the errors are not
       properly estimated, or that the template is bad and it is *not* safe
       to set the /CLEAN keyword.

      When MDEGREE > 1 then SOL contains in output the 9+MDEGREE elements
       [Vel\_star, Sigma\_Star, h3, h4, h5, h6,  $\chi^2$/DOF,Vel\_gas,Sigma\_gas, 
       cx1, cx2, ..., cxn], where cx1, cx2,...,c xn
       are the coefficients of the multiplicative Legendre polynomials
       of order 1, 2, ..., n. The polynomial can be explicitly evaluated as:

           x = range(-1d,1d,n\_elements(galaxy))

           mpoly = 1d ; Multiplicative polynomial

           for j=1,MDEGREE do mpoly += legendre(x,j)*sol[6+j]

      When the reddening correction is used, SOL contains 10
       elements [Vel\_star,Sigma\_Star, h3, h4, h5, h6, $\chi^2$/DOF, Vel\_gas,Sigma\_gas, ebv], where ebv 
       is the best fitting reddening value.\\
%;
gas\_intens &[dbl array].  It contains the intensities of the emission lines (corrected for reddening if the reddening is fitted).\\
%;
gas\_fluxes  &[dbl array].  It contains the fluxes of the emission lines (corrected for reddening if the reddening is fitted).\\
%;
gas\_ew &[dbl array].  It contains the equivalent widths of the emission lines (corrected for reddening if the reddening is fitted).\\
%;
gas\_intens\_ err &[dbl array]. It contains the errors associated to gas\_intens.\\
%;
gas\_fluxes\_ err &[dbl array]. It contains the errors associated to gas\_fluxes.\\
%;
gas\_ew\_err & [dbl array]. It contains the errors associated to gas\_ew.\\
%;
\hline
{\bf OPTIONAL OUTPUTS} &  \\ 
 BESTFIT: &[dbl array]. A named variable to receive a vector with the best fitting
       model: this is a linear combination of the templates,
       multiplied by multiplicative pols (if any) or reddening
       corrected (if required), convolved with the best fitting
       LOSVD, with added polynomial continuum terms
       and the best fitting gas emission lines.\\
%
 BF\_COMP1 &[dbl array]. A  named variable to receive a vector with the best fitting
       model for the stellar component: this is a linear combination
       of the stellar templates,
       multiplied by multiplicative pols (if any) or reddening
       corrected (if required), convolved with the best fitting
       LOSVD. It does not contain additive pols.\\
%
 BF\_COMP2  &[dbl array]. A  named variable to receive a vector with the best fitting
        ionized gas kinematics, convolved with the gas LOSVD, and
        mutiplied by the reddening curve (if applicable).\\
%
 OPT\_TEMPL &[dbl array]. A  named variable to reveive a vector containing the optimal
       template. This is the linear combination of the templates,
       multiplied by multiplicative pols (if any) or reddening corrected
       (if required), NOT CONVOLVED with the stellar LOSVD. It does
       not contain additive pols.\\
%
 MPOLY &[dbl array]. A  named variable to receive a vector with the multiplicative
       pol that has been multipliedto BF\_COMP1 and BESTFIT.\\
%
 ADDITIVE\_POL &[dbl array]. A  named variable to receive a vector with the additive
      pol that has been added to BESTFIT. \\
%
ERROR: &[dbl array]. A  named variable that will contain a vector of *formal* errors
       (1*sigma) for the fitted parameters in the output vector SOL.\\
%
POLYWEIGHTS: &[Flt array]. A named variable to receive the weights of the additive Legendre polynomials.
       The best fitting additive polynomial can be explicitly evaluated as

           x = range(-1d,1d,n\_elements(galaxy))

           apoly = 0d ; Additive polynomial

           for j=0,DEGREE do apoly += legendre(x,j)*polyWeights[j]

     When doing a two-sided fitting (see help for GALAXY parameter), the additive
       polynomials are allowed to be different for the left and right spectrum.
       In that case the output weights of the additive polynomials alternate between
       the first (left) spectrum and the second (right) spectrum.\\
%
   WEIGHTS  &[float array] a named variable to receive the value of the weights by which each stellar
       template and ionized gas template was multiplied to best fit
       the galaxy spectrum.
        Stellar weights are WEIGHTS[0:Ntemplates1-1]
        Gas emission lines intensities are  WEIGHTS[Ntemplates1 : *]
        N.B. Gas intensities are de-reddened (i.e. the intensity in
        the input spectrum is lower than WEIGHTS[Ntemplates1 : *],
        because it account for the reddening at that wavelength.
        If reddening is not fitted, then intensities and weights
        are the same.\\
%
\hline
\end{longtable}
\end{center}



\subsection{{\tt mdap\_measure\_indices.pro}}
\label{dap_sec:mdap_measure_indices}

This module is responsible for measuring the strength of the
absoprtion line indices (performed with
mdap\_do\_measure\_indices.pro, see Section
\ref{dap_sec:mdap_do_measure_indices}), their errors, and correct them for galaxy
intrinsic broadening. Broadening correction is applied to the input
galaxy spectra to match the spectral resolution of the spectral
indices system (e.g. Lick). Input galaxy spectra must have emission
lines removed.

Broadening correction is done according to the following formula

\[
I_{\rm corr} = I_{\rm gal} \frac{I_{\rm templ}}{I_{\rm templ\ LOSVD}}
\]
for atomic indices, and 
\[
I_{\rm corr} = I_{\rm gal} + I_{\rm templ} - I_{\rm templ\ LOSVD}
\]
for molecular indices.  $I_{\rm corr}$ is the index line strength
corrected for intrinsic broadening, $I_{\rm templ}$ is the index line
strength measured on the best fitting stellar template, and $I_{\rm templ\
  LOSVD}$ is the index line strength measured on the best fitting
stellar template convolved by the best fitting LOSVD.

The list of input/output parameters for this module is given in Table
\ref{dap_tab:mdap_measure_indices}.


\begin{center}
\begin{longtable}{p{2.7cm}| p{11.1cm}}
\caption{Inputs and outputs parameters of mdap\_measure\_indices.pro} \label{dap_tab:mdap_measure_indices} \\
\hline
\endfirsthead
\hline
\endhead
\hline
\endlastfoot
\hline
{\bf  INPUTS} & \\
\hline
wavelength & [N dblarray]. Vector containing the wavelenghts of the input spectra. The dispersion can be also not constant.\\
%
spectra & [T x N dblarray].  Vector containing the T input galaxy spextra, with emission line removed. Spectra are defined over the vector wavelength.\\
%
best\_template & [T x N dblarray]. Vector containing the T best fitting stellar templates obtained when fitting the kinematics of the input spectra. 
                Spectra are defined over the vector wavelength.\\
%
best\_template\_ LOSVD, & [T x N dblarray]. Vector containing the T best fitting stellar templates, convolved with the best-fitting stellar LOSVD, obtained when 
                  fitting the kinematics of the input spectra. Spectra are defined over the vector wavelength. \\
%
stellar\_velocity & [T flt array]. Vector containing the best fitting stellar velocity for the T input spectra in km/sec. P.S. Set it to zero if the input spectra are in rest-frame\\
%
residuals & [T x N dblarray]. Vector containing the residuals from the best fit model to the input galaxy spectra. Residuals are defined over the vector wavelength.  \\
%
fwhm\_diff\_ indices\_ & [N dblarray]. Vector that specifies the FWHM($\lambda$) (in \AA) that should be used to broaden the spectra, best\_template, and best\_template\_LOSVD to match the spectral resolution of the spectral indices system.\\
\hline 
{\bf OPTIONAL INPUTS} & \\
dir=dir  &  Directory where to store the ps files showing the measurements \\
%
\hline
{\bf OUTPUTS} & \\
abs\_line\_ indices & [T x 37 dbl array]. Absorption line indices of the T inut spectra, corrected for intrinsic broadening. The 37 measure indices are defined in 
   aborption\_line\_ indices\_definition, which is an to in the DAP.\\
%
abs\_line\_ indices\_errors & [T x 37 dbl array]. Errors associated to abs\_line\_ indices. \\
%
abs\_line\_ indices\_template &  Absorption line indices measured on best\_template \\
%
abs\_line\_ indices\_template\_ losvd &   Absorption line indices measured on best\_template\_ LOSVD.\\
\hline
{\bf  OPTIONAL OUTPUTS} &  \\
version & string specifying the module version. If requested, the module is not execute and only version flag is returned.\\
\hline
\end{longtable}
\end{center}





\subsection{{\tt mdap\_do\_measure\_indices.pro}}
\label{dap_sec:mdap_do_measure_indices}

This procedure measures the line strenght of a give index, according to the following definitions (from \citealt{Worthey+94}): 


\begin{eqnarray}
F\left(\lambda; \lambda_1, \lambda_2 \right) &=& \int_{\lambda_2}^{\lambda_1} F(\lambda)d\lambda/(\lambda_2 - \lambda_1) \nonumber \\
F_{PB} &=& F\left(\lambda; \lambda_{\rm BLUE\ CONT\ 1}, \lambda_{\rm BLUE\ CONT\ 2} \right) \nonumber \\
F_{PR} &=& F\left(\lambda; \lambda_{\rm RED\ CONT\ 1}, \lambda_{\rm RED\ CONT\ 2} \right) \nonumber  \\
F_{I} &=& F\left(\lambda; \lambda_{\rm INDEX\ 1}, \lambda_{\rm INDEX\ 2} \right) \nonumber  \nonumber  \\
\lambda_{\rm BLUE\ C} &=& 0.5 \cdot (\lambda_{\rm BLUE\ CONT\ 1} + \lambda_{\rm BLUE\ CONT\ 2}) \nonumber  \\
\lambda_{\rm RED\ C} &=& 0.5 \cdot (\lambda_{\rm RED\ CONT\ 1} + \lambda_{\rm RED\ CONT\ 2}) \nonumber  \\
\lambda_{\rm INDEX\ C} &=& 0.5 \cdot (\lambda_{\rm INDEX\ CONT\ 1} + \lambda_{\rm INDEX\ CONT\ 2}) \nonumber  \\
F_P(\lambda) &=& (\lambda_{\rm RED\ C} -\lambda_{\rm BLUE\ C} )\frac{\lambda-\lambda_{\rm BLUE\ C}}{\lambda_{\rm RED\ C} -\lambda_{\rm BLUE\ C}}+\lambda_{\rm BLUE\ C}
\end{eqnarray}

The Equivalent width (in \AA) for atomic indices is:

\[
EW =  \int_{\lambda_{\rm INDEX\ 1}}^{\lambda_{\rm INDEX\ 2}} \left( 1 - \frac{F_I}{F_P} \right) d\lambda
\]

The Equivalent width (in magnitudes) for molecular indices is:

\[
EW =  -2.5 \ln \left[ \left( \frac{1}{\lambda_{\rm INDEX\ 2} - \lambda_{\rm INDEX\ 1}} \right)  \int_{\lambda_{\rm INDEX\ 1}}^{\lambda_{\rm INDEX\ 2}} \left( F_I/F_P\right) d\lambda \right]
\]

The list of input/output parameters for this module is given in Table
\ref{dap_tab:mdap_do_measure_indices}.

Errors on the indices are calculated using the Empirical formula by
Cardiel et al. (1998), A\&AS, 127, 597 Equations 41 -46.

\begin{center}
\begin{longtable}{p{2.7cm}| p{11.1cm}}
\caption{Inputs and outputs parameters of mdap\_do\_measure\_indices.pro} \label{dap_tab:mdap_do_measure_indices} \\
\hline
\endfirsthead
\hline
\endhead
\hline
\endlastfoot
\hline
{\bf  INPUTS} & \\
\hline
%
spc    &  [dbl array].  Vector containing  spectra to calculate the line strenght index. It should be without emission lines, and at the same 
                         spectral resolution of the desired spectroscopic system.\\
%
lambda &  [dbl array].  Vector (same number of elements of spc) containing the wavelengths (in \AA). The vector must have constant \AA/pixel step.\\
%
passband & [flt array].    2 elements array defining the index passband boundaries.\\
%
blue\_cont &[flt array].    2 elements array defining the blue pseudocontinua boundaries.\\
%
red\_cont  &flt [array].    2 elements array defining the red pseudocontinua boundaries.\\
\hline 
{\bf OPTIONAL INPUTS} & \\
norm    &  [float].    Value of $\lambda$ (in \AA) at which compute the normalization. The input spectrum is normalized by spc(norm). Defaul: no normalization.\\
%
title   &  [string].   Title to write into the plot produced as output. \\
%
plbound &  [array].    Two elements array specifying the boundaries of
                     the plot (Y axis), which will be set to [plbound[0]*midplot,plbound[1]*midplot]
                     where midplot is the value of the spectrum at
                     the wavelenght middle range. Default plbound=[0.6,1.35]; midplot=1.\\
%
rebin   &  [float].  If set, the input spectrum will be rebinned according to a new step (\AA/pixel, defined by
                     rebin). The starting point of lambda will remains  unchaged. The input "lambda" and "spc" parameters are not overwritten.
                     Default: no rebinning.\\
%
noise    & [float].   It is useful only when errors need to be retrieved. Default: noise = sqrt(spc).\\ 
\hline
{\bf OPTIONAL KEYWORDS}  & \\
/noplot     &         If set, all the plotting commands (plot, oplot, plots and xyouts) in the routine are not executed.\\
{\bf OUTPUTS} & \\
ew         &[float].    Line equivalent width in angstrom.\\
%
index\_mag &[float].    Linestrenght index value in magnitudes.\\
%
\hline
{\bf OPTIONAL OUTPUTS} & \\
errors    &[float].    This variable will contain the errors on the indices computed using Cardiel et al. 1998, A\&AS, 127, 597.\\
\hline
\end{longtable}
\end{center}




\include{mdap_gandalf}


\subsection{{mdap\_dust\_calzetti.pro}}
\label{dap_sec:mdap_do_measure_indices}  



This procedure uses the dust model of Calzetti et al. (2000, ApJ, 533,
682), and for a given E(B-V) value returns the flux attenuation array,
which can be used to get reddened templates. Here the spectra are
assumed to be binned on a ln-rebinned wavelentgh grid as defined by
input parameters. The input receiding velocity is used to derive the
dust reddening in the galaxy rest-frame.

Can be used also to de-reddened the galaxy spectra by the Milky-Way
dust extinction, using as E(B-V) the opposite of the Schlegel et
al. values found in NED and vstar = 0.

Initial version kindly provided by S. Kaviray, Oxford, 2006.

The list of input parameters and the return value for this function is
given in Table \ref{dap_tab:mdap_dust_calzetti}.

\begin{center}
\begin{longtable}{p{2.7cm}| p{11.1cm}}
\caption{Inputs parameters and return value of mdap\_dust\_calzetti.pro function} \label{dap_tab:mdap_dust_calzetti} \\
\hline
\endfirsthead
\hline
\endhead
\hline
\endlastfoot
\hline
{\bf  INPUTS}  & \\
\hline
l0\_gal & [double]. Starting ln-wavelength where the galaxy spectrum is defined. Default ln($\lambda$), if $\backslash$log10 keyword 
          is set, $\log_{10}(\lambda)$ is assumed. \\
%
lstep\_gal & [double]. Constant logarithmic step (natural log, unless  $\backslash$log10 keyword is set). \\
%
npix & [integer]. Number of pixels of the galaxy spectrum.\\
%
ebv & [double]. E(B-V) reddening coefficient.\\
%
vstar & [double]. Vector of lambda will be de-redshifted by this amount to provide correction at restframe.\\
\hline
{\bf  OPTIONAL KEYWORDS} & \\
$\backslash$ &  If set, input quantities l0\_gal and lstep\_gal are assumed to be in $\log_{10}$. Default is natural log.\\
\hline
{\bf  RETURN VALUE} & [dbl array]. array with npix elements containing the reddening vector. This is used to correct an input galaxy spectrum, like
spc\_obs = spc\_corr $times$ mdap\_dust\_calzetti(l0\_gal, lstep\_gal, npix, ebv, vstar)\\
\end{longtable}
\end{center}


\chapter{Utility modules}

\include{mdap_convol_sigma}

\include{mdap_calibrate_sn}

\include{mdap_interpolate_2dmaps}

\section{Visualization and Web Interface. T.B.D.}
\label{dap_sec:visualization}

We want at least the beginning of a plan here for what we have in mind
for visualization tools and the web interface.  This is meant to spark
discussion at the Portsmouth meeting, get us thinking ahead of time,
and also get some feedback from the panelists.


\subsection{{\tt mdap\_get\_2d\_map.pro}}
\label{dap_sec:mdap_get_2d_map}

This module is responsable to arrange the outputs of
mdap\_spectral\_fitting.pro into a two-dimensional map, given some
spatial binning informations. 

Table \ref{dap_tab:mdap_get_2d_map} lists the inputs and
outputs required for this module.



\begin{center}
\begin{longtable}{p{2.7cm}| p{11.1cm}}
\caption{Inputs and outputs parameters of mdap\_get\_2d\_map.pro} \label{dap_tab:mdap_get_2d_map} \\
\hline
\endfirsthead
\hline
\endhead
\hline
\endlastfoot
\hline
{\bf  INPUTS} &  \\
%
values   &   [Nbins elements dbl array].  Measured quantity for each spatial bin (first elements is associated with bin 0 , 
            second element with bin 1, and soforth). It can be either an output of block 4 or block 5. \\
%
binning  &   [N x M dbl array]. Two dimensional map showing the binning sheme. Pixels beloning to the i+1-th 
                               bin have value i (i= 0, 1, ..., Nbins-1). Pixels associated to no spatial bin
                               have value -1 (produced in block 2 by mdap\_spatial\_binning.pro). Nbins is the number of spatial bins. \\
%
x2d      & [N x M flt array].  X coordinates of the field of view, in arcsec (produced in block 1 by mdap\_read\_datacube.pro). Coordinate 0 is the center of the field of view.\\
%
y2d      & [N x M flt array].  Y coordinates of the field of view, in arcsec (produced in block 1 by mdap\_read\_datacube.pro). Coordinate 0 is the center of the field of view.\\
%
\hline
{\bf OUTPOUTS}        &    \\
%
map      & [N x M flt array].  Measured values over the two-dimensional field of view. Pixels belonging to the same spatial bin 
                               have the same value (i.e. no spatial smoothing or interpolation are performed). \\
\hline
\end{longtable}
\end{center}



\subsection{{\tt mdap\_display\_2dmap\_ps.pro}}
\label{dap_sec:mdap_display_2dmap_ps}
T.B.D.


%\bibliographystyle{apj}
%\bibliography{dap}
	
% remove the \end{document} command before uploading
\end{document}
