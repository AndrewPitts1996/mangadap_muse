
\documentclass[11pt]{book}
%usepackage[italian]{babel}
\usepackage{epsfig}
%\usepackage{psfig}
\usepackage{amssymb}
\usepackage{latexsym}
\usepackage{longtable}
\usepackage{subfigure}
\usepackage{graphics}
\usepackage{lscape}
\usepackage{a4wide}

\usepackage{graphicx}
\usepackage{natbib}


\newcommand{\msun}{M$_{\odot}$}
\newcommand{\kms}{km s$^{-1}$}

\begin{document}
\begin{titlepage}
\title{{\Huge The MANGA Data Analysis Pipeline: \\
a prototype}}
\author{L. Coccato \& MANGA team}
\end{titlepage}

\maketitle
\tableofcontents

% ======================================================================
%\newcommand{\kms}{km s$^{-1}$}
%\chapter{Introduction}
%\label{dap}
%
%
%\section{Abstract}
%\label{dap_sec:abstract}%
%
%This chapter %
%
%\subsection{Acronyms and definitions}%
%
%In this chapter, we will adopt the following acronyms and definitions:
%
%\begin{tabular}{l l}
%DRP & Data Reduction Pipeline \\
%DAP & Data Analysis Pipeline \\
%LOSVD & Line Of Sight Velocity Distribution \\
%LSF & Line Spread Function \\
%SRD & Sciente Requirement Document \\
%
%
%\end{tabular}




\chapter{Introduction}
\label{dap_chap:introduction}


\section{Data Analysis Pipeline (DAP): overview}
\label{dap_sec:dap_overview}

The scope of the Data Analysis Pipeline is to analyse the output of
the Data Reduction Pipeline and deliver science products. They are
classed into two groups, the {\bf High level data products} and the
{\bf Model dependent data products}.

High level data products are:
\begin{itemize}
     \item Stellar kinematics (velocity, velocity dispersion, h3, and h4 Gauss-Hermite moments).
     \item Emission line kinematics (velocity, and velocity dispersion).
     \item Equivalent widths and fluxes of emission lines.
     \item Absorption line strengths.
     \item Reddening.
     \item Radial gradients of measured quantities.
     \item Rotation curves and kinemetric parameters.
     \item Stellar weights from full spectral fitting.
\end{itemize}

Model dependent data products are:
\begin{itemize}
    \item Stellar population parameters age, metallicity, chemical
      element ratios, and IMF, and their radial gradients (from absorption features).
    \item Stellar population parameters age, metallicity, chemical
      element ratios, and IMF, and their radial gradients (from full spectral fitting).
    \item Extinction corrected star formation rates and hystories.
    \item Gas metallicities, BPT diagrams.
    \item Mass to light ratio (from stellar population).
    \item Mass to light ratio, dynamical mass (from dynamical
      modeling).
    \item Angular momentum.
   % \item Characterization of asymmetries, see Section \ref{sec:dynamical_state}.
   % \item Measurements of the Toomre Q-parameter, see Section  \ref{sec:growth_bulges}.
\end{itemize}%

\subsection{Installation and requirements}
\label{dap_sec:installation}
T.B.D.

\include{dap_workflow_description}

\include{configuration_file}

\subsection{Version control and tags. Obsolete}
\label{dap_sec:dap_version}


At the beginning of the execution, the DAP check whether the output
.fits file and .idl sessions exist. If so, it reads the version(s)
used to generate the existing files. If the current module versions
are greater than those used to generate the output file, the analysis
is performed again.

\begin{itemize}

\item {\bf manga\_dap\_version}. The version of the DAP. If the module
  version is greater than that stored in the output files, the entire
  analysis is performed again (currently, blocks 1-5).

\item {\bf mdap\_read\_datacube\_version}. The version of modules in
  block 1. If it is greater than that stored in the output file, blocs
  1-5 are executed again.

\item {\bf mdap\_spatial\_binning\_version}. The version of modules in
  block 2. If it is greater than that stored in the output file, blocs
  2-5 are executed again. It must include version information about
  mdap\_voronoi\_binning.pro as well.

\item {\bf mdap\_log\_rebin\_version}. The version of modules in
  block 3. If it is greater than that stored in the output file, blocs
  3-5 are executed again.

\item {\bf mdap\_spectral\_fitting\_version}. The version of modules
  in block 4. If it is greater than that stored in the output file,
  blocs 4-5 are executed again. It must include version information
  about mdap\_sgandalf.pro as well.

\item {\bf mdap\_measure\_index\_version}. The version of modules in
  block 5. If it is greater than that stored in the output file, block
  5 is executed again.

\end{itemize}

Warning: the version control is enabled only if the keyword
/check\_version is set.

\begin{figure}
\begin{center}
%\hspace{-2cm}
%\includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}  25 150 810 445
\psfig{file=figures/mangaDAP_workflow_1.ps, width=9cm, clip=, bb= 140 20 450 800}
%\vspace*{0cm}
\caption{Workflow chart of the Data Analysis Pipeline (High Level Data products).}
 \label{dap_fig:dap_workflow_1}
\end{center}
\end{figure}


\begin{figure}
\begin{center}
%\hspace{-2cm}
%\includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}  65 144 702  420 
\psfig{file=figures/mangaDAP_workflow_2.ps,  width=9cm, clip=, bb= 22 20 340 800}
%\vspace*{0cm}
\caption{Workflow chart of the Data Analysis Pipeline (Model Dependent Data products).}
 \label{dap_fig:dap_workflow_2}
\end{center}
\end{figure}

\chapter{BLOCKs and ``interface'' modules}
\label{dap_chap:blocks}

\section{DAP Block 1: reading the input data}
\label{dap_sec:block1}

This block reads the input data (in the form of a datacube or RSS
files) and extracts the all information needed for further processing,
such as the galaxy spectra and errors, wavelength vector, 2D maps
containing the coordinates, and galaxy signal and noise. The interface
module in this block is: mdap\_read\_datacube.pro (see Section
\ref{dap_sec:mdap_read_datacube} for a list of inputs and outputs).

The main modules in the block, called by the interface, are
mdap\_calculate\_spectrum\_sn.pro (see Section
\ref{dap_sec:mdap_calculate_spectrum_sn} for a list of inputs and
outputs).

The Block will provide the galaxy spectra (and errors),
two-dimensional maps with coordinates (in arcseconds, the center of
the field has coordinates 0,0), the two-dimensional maps of the signal
and the noise (per angstrom), the wavelength vector (in \AA) and
related quantities (initial \AA, reciprocal dispersion
\AA\ pixel$^{-1}$), and header information for 2-dimensional
maps. Figure \ref{dap_fig:block1} illustrates the flowchart of block
1.


\begin{figure}
\begin{center}
\psfig{file=figures/block1.ps, width=15.0cm, clip=}
\caption{Workflow chart of the block 1 of the Data Analysis
  Pipeline. See Section \ref{dap_sec:mdap_read_datacube} for a
  description of inputs and outputs.}
 \label{dap_fig:block1}
\end{center}
\end{figure}


\include{mdap_read_datacube}


\section[DAP Block 2: Spatial binning]{DAP Block 2: Spatial binning}
\label{dap_sec:block2}

This block adds adjacent spectra in the field of view to reach a
minimum signa-to-noise ratio, and organizes the observations into
spatial bins. 

It requires the spectra, errors, signals and noise for each spectrum,
and the coordinates obtained from block 1 as inputs. It returns the
binned spectra (and errors) and all the geometrical information of the
spatial bin (2D maps and coordinates of the bins center). It handles
both datacubes and RSS input files format.

Three different spatial binning schemes with different
are handled, depending on the scientific purposes.


\begin{enumerate}

\item First binning, which requires a minimum $S/N = 40$ per
  \AA. The spectra binned this way will be used to measure the
  equivalent width ob absorption line indices, to perform the full
  spectral fitting, and to derive the stellar population properties.

\item Second binning, which requires a minimum $S/N = 25$ per
  \AA. The spectra binned this way will be used to measure the
  stellar kinematics and dynamical models.


\item Third binning, which requires a minimum $S/N = 15$ per
  \AA. The spectra binned this way will be used to measure the
  emission line kinematics, fluxes, and widths, the reddening, gas
  metallicities and star formation rates.

\end{enumerate}

$S/N$s are computed in the wavelength range $5560 < \lambda < 6942$
(SLOAN r-band).


The interface module in this block is mdap\_spatial\_binning.pro (see
Section \ref{dap_sec:mdap_spatial_binning}). The main module is
mdap\_voronoi\_2d\_binning.pro (Section
\ref{dap_sec:mdap_voronoi_2d_binning}).

mdap\_voronoi\_2d\_binning.pro uses an imlementation of the Voronoi
Binning technique developed by \citet{Cappellari+03} (see Section
\ref{dap_sec:mdap_voronoi_2d_binning}). The implementation accounts
for spatial correlation between errors of adjacent spectra: the
estimated $S/N$ is calibrated to the real $S/N$ via empirical relation
and it is done by the utility module mdap\_calibrate\_sn.pro.

Note that RSS spectra do not require the above $S/N$ calibration,
because the errors between adjacent RSS files are not correlated.


The interface mdap\_spatial\_binning.pro accepts an user-defined fits
file describing the spatial binning scheme. This file needs to be
provided via the input keyword: user\_bin\_map. The names are defined
in the DAP configuration file (see Section
\ref{dap_sec:configuration}). The inclusion of an used-defined file
overrides the Voronoi binning.

On request, the spectra in the same spatial bin can be added together
by weighting them with their $S/N^2$ (weight\_by\_sn keyword).

Figure \ref{dap_fig:block2} illustrates the flowchart of block 2.

\subsubsection{Future implementations}
Future implementations:

\begin{itemize}

 \item calculation of spatial covariance matrix to account for error
   correlations and avoid the use of $S/N$ calibration relations.

  \item Allow for an equal flux surface binning scheme (Sanchez et
    al. ?) instead of the Voronoi binning scheme.

\end{itemize}

\begin{figure}
\begin{center}
%\hspace{-2cm}
%\includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}
\psfig{file=figures/block2.ps, width=16.0cm, clip=,bb=25 77 590 815}
%\vspace*{0cm}
\caption{Workflow chart of the block 2 of the Data Analysis
  Pipeline.}
 \label{dap_fig:block2}
\end{center}
\end{figure}

\include{mdap_spatial_binning}

\section[DAP Block 3: Logarithmic sampling]{DAP Block 3: Logarithmic sampling of input galaxy spectra and stellar templates}
\label{dap_sec:block3}

This block is responsable for:

\begin{itemize}

\item resampling the input galaxy spectra and errors (rebinned
  spectra, input from block 2) to a ln-wavelength constant step.

\item resampling the stars in the spectral library in the same
  ln-wavelength constant step used for galaxy spectra, and ensuring
  that the stars have the same instrumental resolution (i.e. the same
  LSF) of the galaxy spectra.

\item selecting only the wavelength region of interest, making sure
  that the wavelenght range of the template stars is larger than that
  of the galaxy spectra.

\item defyning the wavelenght vectors (ln units) over which the galaxy
  spectra, galaxy errors, and template stars are defined.

\end{itemize}

Because the DAP performs three different spatial binnings of the input
galaxy, the block operates

The interface module in this block is mdap\_log\_rebin.pro (see
Section \ref{dap_sec:mdap_log_rebin}), which calls the main module
mdap\_do\_log\_rebin.pro that performs the logarithmic resampling (see
Section \ref{dap_sec:mdap_do_log_rebin}). Because the DAP performs
three different spatial binnings of the input galaxy, block 3 executes
mdap\_log\_rebin.pro three times, one for each set of spatially binned
spectra. The workflow of block 3 is shown in Figure
\ref{dap_fig:block3}.

The current version of the DAP uses the MARCS stellar library models
(Maraston \& Stromback, 2011, MNRAS, 418, 2785).

\begin{figure}
\begin{center}
%\hspace{-2cm} \includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}
\psfig{file=figures/block3.ps, width=13.5cm, clip=,bb=30 70 592 790}
%\vspace*{0cm}
\caption{Workflow chart of the block 3 of the Data Analysis
  Pipeline.}
 \label{dap_fig:block3}
\end{center}
\end{figure}

\include{mdap_log_rebin}

\section[DAP Block 4: Spectral fitting]{DAP Block 4: Spectral fitting}

This block is responsible for fitting the input galaxy spectra with a
set of stellar templates and Gaussian Emission lines to derive the
kinematics of stars, ionized gas, and emission line fluxes and
equivalent widths.

This block has two interfaces: mdap\_spectral\_fitting.pro (see
Section \ref{dap_sec:mdap_spectral_fitting}) and
mdap\_ create\_starting\_guesses (see Section
\ref{dap_sec:mdap_create_starting_guesses}).


The interface mdap\_create\_starting\_guesses handles the starting
guesses (either from the user input file, or using the results of a
previous fit) and feeds the spectral fitting interface.


The interface mdap\_spectral\_fitting arranges inputs and outputs for
the routine that performs the actual fit, i.e.
mdap\_gandalf\_wrap.pro, which is an adapted version of the pPXF
(\citealt{Cappellari+04}) and gandalf (\citealt{Sarzi+06}) routines
(see Section \ref{dap_sec:mdap_gandalf_wrap} for information on how
the fit is performed). 

Block 4 requires as input the log-resampled spectra of the galaxy (and
errors) and the stars, wavelenght vectors, the binning spatial
informations, and starting guesses for the galaxy redshift and
velocity dispersion.

The fitting procedure can be fed with a vector that describes the
variation of the instrumental velocity dispersion with
wavelength \footnote{This affects only emission lines measurements,
  because the stellar templates have already been convolved in Block 3
  to match the instrumental resolution, see \ref{dap_sec:block3}}. If
not provided, a constant instrumental velocity dispersion of 52 km/sec
will be adopted.

The block executes the module mdap\_spectral\_fitting.pro three times,
once for each set of spatially binned spectra.  The current version of
the DAP uses the MARCS library of ssp  (Maraston \& Stromback,
2011, MNRAS, 418, 2785) for the spectral fitting.




\begin{enumerate}

\item {\it First module execution.} The log-sampled Galaxy spectra are
  fitted with a linear combination of templates and Gaussian Emission
  lines. This step requires input starting guesses of the galaxy
  redshift and stellar velocity dispersion (more than one redshift,
  and coordinates of galaxy centers if more galaxies are presented in
  the field of view). The galaxy spectra with the best-fit emission
  lines removed produced as output will be used to measure the
  absorption line strenghts (block 5).  Galaxy reddening is also
  fitted, if required. This execution does not provide final highlevel
  data products, but it will provides: i) galaxy spectra with the
  best-fit emission lines removed (which will be used in block 5 to
  measure the absorption line indices), ii) the weights of the stellar
  templates (which will be used to compute the stellar populations in
  block 7).
  %If the Milky-Way
  %extinction value is provided, the input galaxy spectra are corrected
  %before fitting.

\item {\it Second module execution.} The results of the first
  execution (stellar and emission lines kinematics) are re-sampled
  over the second spatial sampling and used as starting guesses for
  the second execution on the second set of galaxy spectra (second
  spatial binning). This step is performed by the interface
  mdap\_create\_starting\_guesses.pro (Section
  \ref{dap_sec:mdap_create_starting_guesses}) and the utility
  mdap\_interpolate\_2dmaps.pro (Section
  \ref{dap_sec:mdap_interpolate_2dmaps}. As in the first execution,
  log-sampled Galaxy spectra are fitted with a linear combination of
  stellar templates and Gaussian Emission lines. Only those stellar
  templates that are selected in the first execution, will be used in
  the second run (unless the keyword /dont\_remove\_ null\_templates
  of the manga\_dap is set, see Section
  \ref{dap_sec:dap_inputs_outputs}).

% If the Milky-Way extinction value
%  is provided, the input galaxy spectra are corrected before
%  fitting. The final high level products produced in this execution
%  are the stellar kinematics (V,$\sigma$, H3, and H4).

\item {\it Third module execution.} The emission line kinematics from
  the second execution are re-sampled over the third spatial sampling
  and used as starting guesses for the third execution. The stellar
  kinematics from the second execution are re-sampled over the third
  spatial sampling and {\it fixed} in the third execution. This step
  is performed by the interface mdap\_create\_starting\_guesses.pro
  (Section \ref{dap_sec:mdap_create_starting_guesses}) and the utility
  mdap\_interpolate\_2dmaps.pro (Section
  \ref{dap_sec:mdap_interpolate_2dmaps}. As in the first execution,
  log-sampled Galaxy spectra are fitted with a linear combination of
  stellar templates and Gaussian Emission lines. Only those stellar
  templates that are selected in the first execution, will be used in
  the third run (unless the keyword /dont\_remove\_ null\_templates of
  the manga\_dap is set, see Section
  \ref{dap_sec:dap_inputs_outputs}).

%If the Milky-Way extinction value
%  is provided, the input galaxy spectra are corrected before
%  fitting. The final high level products produced in this execution
%  are: the emission line kinematics (V,$\sigma$), reddening, and
%  fluxes and equivalent widths (reddening corrected).

\end{enumerate}


At the end of block 4, the stellar kinematics (V, $\sigma$, h3, and
h4), emission line kinematics (V, $\sigma$), emission line fluxes and
equivalent widths, reddening (stars and gas) and stellar template
weights for each of spectrum and for the spatial binning scheme are
produced.

Figures \ref{dap_fig:block4} and \ref{dap_fig:block4a} shows the
flowchart of block 4.

\begin{figure}
\begin{center}
%\hspace{-2cm}
%\includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}
\psfig{file=figures/block4.ps, width=17cm, clip=, bb=35 25 560 620}
%\vspace*{0cm}
\caption{Workflow chart of the block 4 of the Data Analysis Pipeline.}
 \label{dap_fig:block4}
\end{center}
\end{figure}

\include{mdap_create_starting_guesses}

\include{mdap_spectral_fitting}

%\begin{figure}
%\begin{center}
%%\hspace{-2cm}
%%\includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}
%\psfig{file=figures/Block_4_zoom.ps, width=16cm, clip=}
%%\vspace*{0cm}
%\caption{Workflow chart of the block 4 of the Data Analysis Pipeline,
 % zoom around the first fit section.}
% \label{dap_fig:block4a}
%\end{center}
%\end{figure}


\section{DAP Block 5: Measurement of absorption line indices T.B.D.}
\label{dap_sec:block5}

This block is responsible for measuring the equivalent width of
absorption line indices on the galaxy spectra where the best fit model
for emission lines has been removed.

It requires the following inputs:
\begin{itemize}
 
\item The galaxy spectra with emission lines removed (from block 4).

\item The stellar velocity.

  \item The LSF as function of wavelenght (to a proper
broadening of the input spectra to the reference calibration system,
e.g. Lick, MILES).

\item The best fitting stellar template and the best fitting stellar
  template convolved by the best fitting LOSVD, for intrinsic
  broadening correction (from block 4).

\end{itemize}

The interface module in block 5 is {\tt mdap\_measure\_indices.pro}
(Section \ref{dap_sec:mdap_measure_indices}). Figure
\ref{dap_fig:block5} illustrates the flowchart of this module.  Table
\ref{dap_tab:mdap_measure_indices} describes the inputs and outputs of
this interface. The actual measurements are performed by the main
module {\tt mdap\_do\_measure\_indices.pro} (Section
\ref{dap_sec:mdap_do_measure_indices}).


\begin{figure}
\begin{center}
%\hspace{-2cm}
%\includegraphics[width=6cm,angle=90]{dap_workflow_1.ps}
\psfig{file=figures/block5.ps, width=16.5cm, clip=,bb= 22 363 566 816}
%\vspace*{0cm}
\caption{Workflow chart of mdap\_measure\_indices.pro, the interface
  module in block 5 of the Data Analysis Pipeline.}
 \label{dap_fig:block5}
\end{center}
\end{figure}


\include{mdap_measure_indices} 

\section{DAP Block 6: Radial properties of high level data products}
\label{dap_sec:block6}

This block measures the radial properties of the absorption line
indices (part 1) and the kinematics i.e. rotation curves (part 2).

The first part uses the restframed galaxy spectra (and errors) with
removed emission lines produced in block 4 from the third spatial
binning. Spectra are grouped according to elliptical bins (using the
user input mean ellipticity an position angle) and added
together. Then the spectra are fitted ({\tt mdap\_spectral\_fitting},
Section \ref{dap_sec:mdap_spectral_fitting}) and the indices are
measures ({\tt mdap\_measure\_indices.pro}, Section
\ref{dap_sec:mdap_measure_indices}).  In the spectral fitting,
emission lines are fitted again (except NaD absorptions), to remove
additional residuals; each emission line has can have its own velocity
and velocity dispersion. Stellar kinematics is bound to be within $-50
< V < 50$ km/sec. Reddening is not fitted.

Then, the output spectra (with residual emission lines removed, along
with the best fitting stellar template (to correct for intrinsic
broadening) are used to measure the absorption line indices.

The second part uses the stellar and emission line kinematics from
block 4 to measure the kinematic position angle, kinematic center,
kinematic axial ratio, rotation curve and amplitude of
inflows/outflows. The interface that handles the second part is {\tt
  mdap\_do\_kinemetry.pro} (Section \ref{dap_sec:mdap_do_kinemetry}),
which implements kinemetry.pro by Kraijnovic et al. 2008.

\include{mdap_do_kinemetry}

\section{DAP Block 7: Stellar population analysis}
\label{dap_sec:block7}
T.B.D.

\section{DAP Block 8: Properties of the emission lines}
\label{dap_sec:block8}
T.B.D.

\section{DAP Block 9: Mass modeling}
\label{dap_sec:block9}
T.B.D.


\chapter{Main modules}
\label{dap_chap:dap_modules}

In this Chapter we describe the main modules of the DAP.

\include{mdap_calculate_spectrum_sn}

\include{mdap_do_log_rebin}

\include{mdap_voronoi_2d_binning}

\include{mdap_gandalf_wrap}

\include{mdap_ppxf}

\include{mdap_gandalf}

\include{mdap_dust_calzetti}

\include{mdap_do_measure_index}

\include{mdap_kinemetry}

\chapter{Utility modules}

\include{mdap_convol_sigma}

\include{mdap_calibrate_sn}

\include{mdap_interpolate_2dmaps}



%\section{Visualization and Web Interface. T.B.D.}
%\label{dap_sec:visualization}
%
%We want at least the beginning of a plan here for what we have in mind
%for visualization tools and the web interface.  This is meant to spark
%discussion at the Portsmouth meeting, get us thinking ahead of time,
%and also get some feedback from the panelists.




%\bibliographystyle{apj}
%\bibliography{dap}
	
% remove the \end{document} command before uploading
\end{document}
