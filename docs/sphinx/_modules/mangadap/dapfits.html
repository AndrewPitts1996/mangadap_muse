

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mangadap.dapfits &mdash; mangadap 2.2.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="mangadap 2.2.2 documentation" href="../../index.html"/>
        <link rel="up" title="mangadap" href="../mangadap.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> mangadap
          

          
          </a>

          
            
            
              <div class="version">
                2.2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mangadap.html">mangadap package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">mangadap</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../mangadap.html">mangadap</a> &raquo;</li>
        
      <li>mangadap.dapfits</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mangadap.dapfits</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Defines a class used to interface with the final maps files produced by</span>
<span class="sd">the MaNGA Data Analysis Pipeline (DAP).</span>

<span class="sd">*License*:</span>
<span class="sd">    Copyright (c) 2015, SDSS-IV/MaNGA Pipeline Group</span>
<span class="sd">        Licensed under BSD 3-clause license - see LICENSE.rst</span>

<span class="sd">*Source location*:</span>
<span class="sd">    $MANGADAP_DIR/python/mangadap/dapfits.py</span>

<span class="sd">*Imports and python version compliance*:</span>
<span class="sd">    ::</span>

<span class="sd">        from __future__ import print_function</span>
<span class="sd">        from __future__ import division</span>
<span class="sd">        from __future__ import absolute_import</span>
<span class="sd">        from __future__ import unicode_literals</span>

<span class="sd">        import sys</span>
<span class="sd">        if sys.version &gt; &#39;3&#39;:</span>
<span class="sd">            long = int</span>

<span class="sd">        import logging</span>
<span class="sd">        import time</span>
<span class="sd">        import os</span>
<span class="sd">        import numpy</span>
<span class="sd">        import warnings</span>

<span class="sd">        from astropy.wcs import WCS</span>
<span class="sd">        from astropy.io import fits</span>
<span class="sd">        import astropy.constants</span>

<span class="sd">        from .drpfits import DRPFits, DRPQuality3DBitMask</span>
<span class="sd">        from .util.fitsutil import DAPFitsUtil</span>
<span class="sd">        from .util.bitmask import BitMask</span>
<span class="sd">        from .util.log import log_output</span>
<span class="sd">        from .util.fileio import channel_dictionary</span>
<span class="sd">        from .util.exception_tools import print_frame</span>
<span class="sd">        from .par.obsinput import ObsInputPar</span>
<span class="sd">        from .config.defaults import default_drp_version, dap_source_dir, default_dap_version</span>
<span class="sd">        from .config.defaults import default_dap_par_file, default_analysis_path</span>
<span class="sd">        from .config.defaults import default_dap_method, default_dap_method_path</span>
<span class="sd">        from .config.defaults import default_dap_file_name</span>
<span class="sd">        from .proc.reductionassessments import ReductionAssessment</span>
<span class="sd">        from .proc.spatiallybinnedspectra import SpatiallyBinnedSpectra</span>
<span class="sd">        from .proc.stellarcontinuummodel import StellarContinuumModel</span>
<span class="sd">        from .proc.emissionlinemoments import EmissionLineMoments</span>
<span class="sd">        from .proc.emissionlinemodel import EmissionLineModel</span>
<span class="sd">        from .proc.spectralindices import SpectralIndices</span>

<span class="sd">*Class usage examples*:</span>
<span class="sd">    Add some usage comments here!</span>

<span class="sd">*Revision history*:</span>
<span class="sd">    | **08 Jun 2016**: Original Implementation by K. Westfall (KBW)</span>
<span class="sd">    | **25 Aug 2016**: (KBW) Added :func:`DAPFits.unique_indices`,</span>
<span class="sd">        :func:`DAPFits.unique_mask`, and :func:`DAPFits.channel_map`</span>
<span class="sd">    | **Feb 2017**: (KBW) Merged construct maps and cube functions here</span>
<span class="sd">        and removed dapmaps.py and dapcube.py.</span>
<span class="sd">    | ** 3 May 2017**: (KBW) Allow output maps and cube types to be</span>
<span class="sd">        single-precision (float32) floats, and changed BINID from int</span>
<span class="sd">        (defaults to 64-bit) to int32.</span>
<span class="sd">    | **24 Aug 2017**: (KBW) Added BADGEOM DAPQUAL bit; signifies </span>
<span class="sd">        invalid photometric geometry parameters used when instantiating</span>
<span class="sd">        the :class:`mangadap.par.obsinput.ObsInputPar` object.</span>
<span class="sd">    | **29 Aug 2017**: (KBW) Add S/N metrics to the MAPS primary header</span>
<span class="sd">    | **30 Aug 2017**: (KBW) Convert some changes from Xihan Ji.</span>
<span class="sd">    | **19 Mar 2018**: (KBW) Mask spectral indices with incomplete band</span>
<span class="sd">        coverage as unreliable.</span>

<span class="sd">.. todo::</span>
<span class="sd">    - Allow DAPFits to read/access both the MAPS and the LOGCUBE files,</span>
<span class="sd">      not just the former.</span>

<span class="sd">.. _astropy.io.fits.hdu.hdulist.HDUList: http://docs.astropy.org/en/v1.0.2/io/fits/api/hdulists.html</span>
<span class="sd">.. _astropy.io.fits.open: http://docs.astropy.org/en/stable/io/fits/api/files.html#astropy.io.fits.open</span>
<span class="sd">.. _astropy.io.fits.Header: http://docs.astropy.org/en/stable/io/fits/api/headers.html</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
    <span class="n">long</span> <span class="o">=</span> <span class="nb">int</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="k">import</span> <span class="n">WCS</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">astropy.constants</span>

<span class="kn">from</span> <span class="nn">.drpfits</span> <span class="k">import</span> <span class="n">DRPFits</span><span class="p">,</span> <span class="n">DRPQuality3DBitMask</span>
<span class="kn">from</span> <span class="nn">.util.fitsutil</span> <span class="k">import</span> <span class="n">DAPFitsUtil</span>
<span class="kn">from</span> <span class="nn">.util.bitmask</span> <span class="k">import</span> <span class="n">BitMask</span>
<span class="kn">from</span> <span class="nn">.util.log</span> <span class="k">import</span> <span class="n">log_output</span>
<span class="kn">from</span> <span class="nn">.util.fileio</span> <span class="k">import</span> <span class="n">channel_dictionary</span>
<span class="kn">from</span> <span class="nn">.util.exception_tools</span> <span class="k">import</span> <span class="n">print_frame</span>
<span class="kn">from</span> <span class="nn">.util.geometry</span> <span class="k">import</span> <span class="n">SemiMajorAxisCoo</span>
<span class="kn">from</span> <span class="nn">.util.covariance</span> <span class="k">import</span> <span class="n">Covariance</span>
<span class="kn">from</span> <span class="nn">.par.obsinput</span> <span class="k">import</span> <span class="n">ObsInputPar</span>
<span class="kn">from</span> <span class="nn">.config.defaults</span> <span class="k">import</span> <span class="n">default_drp_version</span><span class="p">,</span> <span class="n">dap_source_dir</span><span class="p">,</span> <span class="n">default_dap_version</span>
<span class="kn">from</span> <span class="nn">.config.defaults</span> <span class="k">import</span> <span class="n">default_dap_par_file</span><span class="p">,</span> <span class="n">default_analysis_path</span>
<span class="kn">from</span> <span class="nn">.config.defaults</span> <span class="k">import</span> <span class="n">default_dap_method</span><span class="p">,</span> <span class="n">default_dap_method_path</span>
<span class="kn">from</span> <span class="nn">.config.defaults</span> <span class="k">import</span> <span class="n">default_dap_file_name</span>
<span class="kn">from</span> <span class="nn">.proc.reductionassessments</span> <span class="k">import</span> <span class="n">ReductionAssessment</span>
<span class="kn">from</span> <span class="nn">.proc.spatiallybinnedspectra</span> <span class="k">import</span> <span class="n">SpatiallyBinnedSpectra</span>
<span class="kn">from</span> <span class="nn">.proc.stellarcontinuummodel</span> <span class="k">import</span> <span class="n">StellarContinuumModel</span>
<span class="kn">from</span> <span class="nn">.proc.emissionlinemoments</span> <span class="k">import</span> <span class="n">EmissionLineMoments</span>
<span class="kn">from</span> <span class="nn">.proc.emissionlinemodel</span> <span class="k">import</span> <span class="n">EmissionLineModel</span>
<span class="kn">from</span> <span class="nn">.proc.spectralindices</span> <span class="k">import</span> <span class="n">SpectralIndices</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

<span class="c1">#-----------------------------------------------------------------------</span>
<div class="viewcode-block" id="DAPQualityBitMask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPQualityBitMask">[docs]</a><span class="k">class</span> <span class="nc">DAPQualityBitMask</span><span class="p">(</span><span class="n">BitMask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .. todo::</span>
<span class="sd">        - Force read IDLUTILS version as opposed to internal one?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_dapsrc</span> <span class="o">=</span> <span class="n">dap_source_dir</span><span class="p">()</span> <span class="k">if</span> <span class="n">dapsrc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">)</span>
        <span class="n">BitMask</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ini_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_dapsrc</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;mangadap&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;bitmasks&#39;</span><span class="p">,</span> <span class="s1">&#39;dap_quality_bits.ini&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="DAPMapsBitMask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPMapsBitMask">[docs]</a><span class="k">class</span> <span class="nc">DAPMapsBitMask</span><span class="p">(</span><span class="n">BitMask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .. todo::</span>
<span class="sd">        - Force read IDLUTILS version as opposed to internal one?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_dapsrc</span> <span class="o">=</span> <span class="n">dap_source_dir</span><span class="p">()</span> <span class="k">if</span> <span class="n">dapsrc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">)</span>
        <span class="n">BitMask</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ini_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_dapsrc</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;mangadap&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;bitmasks&#39;</span><span class="p">,</span> <span class="s1">&#39;dap_maps_bits.ini&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="DAPCubeBitMask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPCubeBitMask">[docs]</a><span class="k">class</span> <span class="nc">DAPCubeBitMask</span><span class="p">(</span><span class="n">BitMask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .. todo::</span>
<span class="sd">        - Force read IDLUTILS version as opposed to internal one?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_dapsrc</span> <span class="o">=</span> <span class="n">dap_source_dir</span><span class="p">()</span> <span class="k">if</span> <span class="n">dapsrc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">)</span>
        <span class="n">BitMask</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ini_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_dapsrc</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;mangadap&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;bitmasks&#39;</span><span class="p">,</span> <span class="s1">&#39;dap_cube_bits.ini&#39;</span><span class="p">))</span></div>


<span class="c1">#-----------------------------------------------------------------------</span>
<div class="viewcode-block" id="DAPFits"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits">[docs]</a><span class="k">class</span> <span class="nc">DAPFits</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object used to hold properties of and read data from a DAP-produced file.</span>

<span class="sd">    Args:</span>
<span class="sd">        plate (int): Plate number</span>
<span class="sd">        ifudesign (int): IFU design</span>
<span class="sd">        method (str): Method type (e.g., ``&#39;SPX-GAU-MILESTHIN&#39;``)</span>
<span class="sd">        drpver (str): (**Optional**) DRP version, which is used to</span>
<span class="sd">            define the default DAP analysis path.  Default is defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_drp_version`</span>
<span class="sd">        dapver (str): (**Optional**) DAP version, which is used to define</span>
<span class="sd">            the default DAP analysis path.  Default is defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_dap_version`</span>
<span class="sd">        analysis_path (str): (**Optional**) The path to the top level</span>
<span class="sd">            directory containing the DAP output files for a given DRP</span>
<span class="sd">            and DAP version.  Default is defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_analysis_path`.</span>
<span class="sd">        directory_path (str): (**Optional**) The exact path to the DAP</span>
<span class="sd">            file.  Default is defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_dap_method_path`.</span>
<span class="sd">        reference_path (str): (**Optional**) The exact path of the DAP</span>
<span class="sd">            reference directory.  Default is defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_dap_method_path`.</span>
<span class="sd">        par_file (str): (**Optional**) SDSS parameter file used to</span>
<span class="sd">            provide input parameters for the DAP.  Default is defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_dap_par_file`.</span>
<span class="sd">        read (bool) : (**Optional**) Read the DAP file upon</span>
<span class="sd">            instantiation of the object.</span>
<span class="sd">        checksum (bool): (**Optional**) Flag for `astropy.io.fits.open`_</span>
<span class="sd">            checksum operation.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        plate (int): Plate number</span>
<span class="sd">        ifudesign (int): IFU design</span>
<span class="sd">        method (str): Method type</span>
<span class="sd">        drpver (str): DRP version</span>
<span class="sd">        dapver (str): DAP version</span>
<span class="sd">        analysis_path (str): The path to the top level</span>
<span class="sd">            directory containing the DAP output files for a given DRP</span>
<span class="sd">            and DAP version.</span>
<span class="sd">        directory_path (str): The exact path to the DAP file.</span>
<span class="sd">        reference_path (str): The exact path of the DAP reference directory.</span>
<span class="sd">        par_file (str): SDSS parameter file used to provide input</span>
<span class="sd">            parameters for the DAP.</span>
<span class="sd">        dapqual (:class:`mangadap.dapmaps.DAPQualityBitMask`): Global</span>
<span class="sd">            quality bit</span>
<span class="sd">        bitmask (:class:`mangadap.dapmaps.DAPMapsBitMask`): Map mask</span>
<span class="sd">            bits</span>
<span class="sd">        hdu (`astropy.io.fits.hdu.hdulist.HDUList`_): HDUList read from</span>
<span class="sd">            the DRP file</span>
<span class="sd">        par (:class:`mangadap.par.ObsInputPar`): List of parameters used</span>
<span class="sd">            by the DAP.</span>
<span class="sd">        checksum (bool): Boolean to use for checksum in</span>
<span class="sd">            `astropy.io.fits.open`_.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">drpver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">directory_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">par_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">checksum</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># Set the attributes, forcing a known type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">plate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ifudesign</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ifudesign</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>

        <span class="c1"># TODO: Do we need drpver, dapver, analysis_path to be kept</span>
        <span class="c1"># by self?</span>
        <span class="k">if</span> <span class="n">directory_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drpver</span> <span class="o">=</span> <span class="n">default_drp_version</span><span class="p">()</span> <span class="k">if</span> <span class="n">drpver</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">drpver</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dapver</span> <span class="o">=</span> <span class="n">default_dap_version</span><span class="p">()</span> <span class="k">if</span> <span class="n">dapver</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">dapver</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span> <span class="o">=</span> <span class="n">default_analysis_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">)</span> \
                                 <span class="k">if</span> <span class="n">analysis_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">analysis_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span> <span class="o">=</span> <span class="n">default_dap_method_path</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">plate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span>
                                                          <span class="n">ifudesign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span>
                                                          <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span>
                                                          <span class="n">analysis_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drpver</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dapver</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)</span>

        <span class="c1"># Set the reference directory path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_path</span> <span class="o">=</span> <span class="n">default_dap_method_path</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">plate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span>
                                                      <span class="n">ifudesign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                      <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span>
                                                      <span class="n">analysis_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">)</span> \
                                    <span class="k">if</span> <span class="n">reference_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">reference_path</span>

        <span class="c1"># drpver, dapver, and analysis_path can be None and par_file</span>
        <span class="c1"># will still only use the above defined directory_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_file</span> <span class="o">=</span> <span class="n">default_dap_par_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span> <span class="s1">&#39;CUBE&#39;</span><span class="p">,</span>
                                             <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span>
                                             <span class="n">analysis_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span>
                                             <span class="n">directory_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_path</span><span class="p">)</span> \
                                             <span class="k">if</span> <span class="n">par_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">par_file</span><span class="p">)</span>

        <span class="c1"># Set the bitmasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">DAPMapsBitMask</span><span class="p">()</span>

        <span class="c1"># Read in the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smap_ext</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># Extensions with single maps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mmap_ext</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># Extensions with multiple maps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="n">checksum</span>
        <span class="k">if</span> <span class="n">read</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_hdu</span><span class="p">(</span><span class="n">checksum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">checksum</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_par</span><span class="p">()</span>


<span class="c1">#    def __del__(self):</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        Destroy the dapfile object, ensuring that the fits file is</span>
<span class="c1">#        properly closed.</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        if self.hdu is None:</span>
<span class="c1">#            return</span>
<span class="c1">#        self.hdu.close()</span>
<span class="c1">#        self.hdu = None</span>


    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Access elements of the hdu.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


<div class="viewcode-block" id="DAPFits.open_hdu"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits.open_hdu">[docs]</a>    <span class="k">def</span> <span class="nf">open_hdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permissions</span><span class="o">=</span><span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the fits file and save it to :attr:`hdu`; if :attr:`hdu` is</span>
<span class="sd">        not None, the function returns without re-reading the data.</span>

<span class="sd">        Args:</span>
<span class="sd">            permissions (string): (**Optional**) Open the fits file with</span>
<span class="sd">                these read/write permissions.</span>
<span class="sd">            checksum (bool): (**Optional**) Flag for</span>
<span class="sd">                `astropy.io.fits.open`_ checksum operation.  This</span>
<span class="sd">                overrides the internal :attr:`checksum` attribute **for</span>
<span class="sd">                the current operation only**.</span>
<span class="sd">            quiet (bool): (**Optional**) Suppress terminal output</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: Raised if the DAP file doesn&#39;t exist.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DAP file already open!&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Cannot open file: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inp</span><span class="p">))</span>

        <span class="c1"># Open the fits file with the requested read/write permission</span>
        <span class="c1">#check = self.checksum if checksum is None else checksum</span>
<span class="c1">#        self.hdu = fits.open(inp, mode=permissions, checksum=checksum)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">permissions</span><span class="o">=</span><span class="n">permissions</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="n">checksum</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
<span class="c1">#        print(self.spatial_shape)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">smap_ext</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1"># Extensions with single maps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mmap_ext</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1"># Extensions with multiple maps</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">smap_ext</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">h</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mmap_ext</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">h</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmap_ext</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmap_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">channel_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmap_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmap_ext</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channel_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mmap_ext</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">channel_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmap_ext</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>

<span class="c1">#        if not restructure:</span>
<span class="c1">#            return</span>
<span class="c1">#</span>
<span class="c1">#        if len(self.smap_ext) &gt; 0:</span>
<span class="c1">#            if not quiet:</span>
<span class="c1">#                print(&#39;Restructuring single map extensions.&#39;)</span>
<span class="c1">#            DAPFitsUtil.restructure_map(self.hdu, ext=self.smap_ext)</span>
<span class="c1">#        if len(self.mmap_ext) &gt; 0:</span>
<span class="c1">#            if not quiet:</span>
<span class="c1">#                print(&#39;Restructuring multi-map extensions.&#39;)</span>
<span class="c1">#            DAPFitsUtil.restructure_cube(self.hdu, ext=self.mmap_ext)</span>


<div class="viewcode-block" id="DAPFits.read_par"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits.read_par">[docs]</a>    <span class="k">def</span> <span class="nf">read_par</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the parameter file and save it to :attr:`par`; if</span>
<span class="sd">        :attr:`par` is not None, the function returns without re-reading</span>
<span class="sd">        the data.</span>

<span class="sd">        Args:</span>
<span class="sd">            quiet (bool): Suppress terminal output</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parameter file already read!&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par_file</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Input parameters unavailable; cannot open </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par_file</span><span class="p">))</span>
            <span class="k">return</span>
            
        <span class="c1"># Set the input parameters</span>
        <span class="c1"># TODO: Is all of this also in the file header?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par</span> <span class="o">=</span> <span class="n">ObsInputPar</span><span class="o">.</span><span class="n">from_par_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par_file</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="DAPFits.file_name"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits.file_name">[docs]</a>    <span class="k">def</span> <span class="nf">file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of the DAP file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">default_dap_file_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;MAPS&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DAPFits.file_path"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits.file_path">[docs]</a>    <span class="k">def</span> <span class="nf">file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the full path to the DAP file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">())</span></div>

    
<div class="viewcode-block" id="DAPFits.list_channels"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits.list_channels">[docs]</a>    <span class="k">def</span> <span class="nf">list_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provide a list of the channels in a given extension.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_hdu</span><span class="p">(</span><span class="n">checksum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">checksum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">smap_ext</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> contains a single channel.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ext</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Channels in extension </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ext</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#  </span><span class="si">{0:&gt;3}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;CH&#39;</span><span class="p">,</span><span class="s1">&#39;KEY&#39;</span><span class="p">))</span>
        <span class="n">srt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_dict</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_dict</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))[</span><span class="n">srt</span><span class="p">],</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_dict</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))[</span><span class="n">srt</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   </span><span class="si">{0:&gt;3}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">))</span></div>


<div class="viewcode-block" id="DAPFits.thin_disk_polar_coo"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits.thin_disk_polar_coo">[docs]</a>    <span class="k">def</span> <span class="nf">thin_disk_polar_coo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Calculate the disk-plane coordinates for all the binned spectra</span>
<span class="sd">        using :class:`mangadap.util.geometry.SemiMajorAxisCoo`.  See the</span>
<span class="sd">        documentation their for further information regarding the</span>
<span class="sd">        calculations.</span>

<span class="sd">        If not provided, the default position angle and inclination will</span>
<span class="sd">        be taken from the input parameter file, if available.  If the</span>
<span class="sd">        parameter file cannot be read, the default values for the</span>
<span class="sd">        position angle and ellipticity in</span>
<span class="sd">        :class:`mangadap.util.geometry.SemiMajorAxisCoo` are used.</span>

<span class="sd">        Args:</span>
<span class="sd">            xc,yc (float,float): (**Optional**) a reference on-sky</span>
<span class="sd">                position relative to the center of the projected plane</span>
<span class="sd">                (galaxy center).</span>
<span class="sd">            rot (float): (**Optional**) Cartesian rotation of the</span>
<span class="sd">                focal-plane relative to the sky-plane (+x toward East;</span>
<span class="sd">                +y toward North).</span>
<span class="sd">            pa (float): (**Optional**) On-sky position angle of the</span>
<span class="sd">                major axis of the ellipse traced on the sky by a circle</span>
<span class="sd">                in the projected plane, defined as the angle from North</span>
<span class="sd">                through East.</span>
<span class="sd">            inc (float): (**Optional**) Inclination of the plane, angle</span>
<span class="sd">                between the disk normal and the normal of the sky plane</span>
<span class="sd">                (inc=0 is a face-on plane).</span>
<span class="sd">            flip (bool): (**Optional**) Offset the provided position</span>
<span class="sd">                angle by 180 deg; e.g., to set the position angle will</span>
<span class="sd">                be defined along the receding major axis.</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Two numpy arrays with the projected polar</span>
<span class="sd">                coordinates: :math:`R, \theta`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Flip if requested</span>
        <span class="k">if</span> <span class="n">pa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">flip</span><span class="p">:</span>
            <span class="n">pa</span> <span class="o">+=</span> <span class="mi">180</span>
            <span class="k">if</span> <span class="n">pa</span> <span class="o">&gt;=</span> <span class="mi">360</span><span class="p">:</span>
                <span class="n">pa</span> <span class="o">-=</span> <span class="mi">360</span>

        <span class="c1"># Position angle and inclination</span>
        <span class="k">if</span> <span class="n">pa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">inc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_par</span><span class="p">()</span>                <span class="c1"># Try to read the parameter file</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Using default pa and/or inclination.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pa</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_position_angle</span><span class="p">(</span><span class="n">flip</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">inc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_inclination</span><span class="p">()</span>

        <span class="c1"># Declare the galaxy coo object</span>
        <span class="n">disk_plane</span> <span class="o">=</span> <span class="n">SemiMajorAxisCoo</span><span class="p">(</span><span class="n">xc</span><span class="o">=</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="o">=</span><span class="n">yc</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="n">rot</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="n">pa</span><span class="p">,</span>
                                      <span class="n">ell</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">inc</span><span class="p">)))</span>

        <span class="c1"># Calculate the in-plane radius and azimuth for each bin</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_hdu</span><span class="p">(</span><span class="n">checksum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">checksum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">disk_plane</span><span class="o">.</span><span class="n">polar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;SPX_SKYCOO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;SPX_SKYCOO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">])</span></div>

    
<div class="viewcode-block" id="DAPFits.guess_inclination"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits.guess_inclination">[docs]</a>    <span class="k">def</span> <span class="nf">guess_inclination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Return a guess inclination based on the isophotal ellipticity</span>
<span class="sd">        from the input parameter file using the equation:</span>

<span class="sd">        .. math::</span>
<span class="sd">        </span>
<span class="sd">            \cos^2 i = \frac{ q^2 - q_0^2 }{ 1 - q_0^2 },</span>

<span class="sd">        where :math:`q` is the observed oblateness (the semi-minor to</span>
<span class="sd">        semi-major axis ratio, :math:`q = 1-\epsilon = b/a`) and</span>
<span class="sd">        :math:`q_0` is the intrinsic oblateness.</span>
<span class="sd">        </span>
<span class="sd">        If :math:`q &lt; q_0`, the function returns a 90 degree</span>
<span class="sd">        inclination.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            q0 (float): (**Optional**) The intrinsic oblateness of the</span>
<span class="sd">                system.  If not provided, the system is assumed to be</span>
<span class="sd">                infinitely thin.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Raised if the input intrinsic oblatenss is not</span>
<span class="sd">                less than one and greater than 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_par</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">q0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">q0</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;ell&#39;</span><span class="p">])</span> <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">q0</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">q0</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Intrinsic oblateness must be 0.0 &lt;= q0 &lt; 1.0!&#39;</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;ell&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">q</span> <span class="o">&lt;</span> <span class="n">q0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">90.0</span>

        <span class="n">q02</span> <span class="o">=</span> <span class="n">q0</span><span class="o">*</span><span class="n">q0</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="n">q</span> <span class="o">-</span> <span class="n">q02</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">q02</span><span class="p">)</span> <span class="p">)))</span></div>


<div class="viewcode-block" id="DAPFits.guess_position_angle"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits.guess_position_angle">[docs]</a>    <span class="k">def</span> <span class="nf">guess_position_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the guess position angle from the parameter file.</span>

<span class="sd">        Args:</span>
<span class="sd">            flip (bool): (**Optional**) Offset the provided position</span>
<span class="sd">                angle by 180 deg.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_par</span><span class="p">()</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">flip</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span>
        <span class="k">return</span> <span class="n">pa</span> <span class="k">if</span> <span class="n">pa</span> <span class="o">&lt;</span> <span class="mi">360</span> <span class="k">else</span> <span class="n">pa</span><span class="o">-</span><span class="mi">360</span></div>
       

<div class="viewcode-block" id="DAPFits.effective_radius"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits.effective_radius">[docs]</a>    <span class="k">def</span> <span class="nf">effective_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the effective radius from the parameter file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_par</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;reff&#39;</span><span class="p">]</span></div>


<span class="c1">#    def nsa_ellipticity(self):</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        Return the ellipticity from the parameter file.</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        self.read_par()</span>
<span class="c1">#        return self.par[&#39;ell&#39;]</span>
<span class="c1">#</span>
<span class="c1">#</span>
<div class="viewcode-block" id="DAPFits.guess_cz"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits.guess_cz">[docs]</a>    <span class="k">def</span> <span class="nf">guess_cz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the guess redshift (cz) from the parameter file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_par</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="DAPFits.unique_indices"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits.unique_indices">[docs]</a>    <span class="k">def</span> <span class="nf">unique_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the BINID extension to select the spaxels with unique data.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Returns the list of indices **in the</span>
<span class="sd">            flattened array of a map** that are unique.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_hdu</span><span class="p">(</span><span class="n">checksum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">checksum</span><span class="p">)</span>

        <span class="n">unique_bins</span><span class="p">,</span> <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">indx</span><span class="p">[</span><span class="n">unique_bins</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="DAPFits.unique_mask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits.unique_mask">[docs]</a>    <span class="k">def</span> <span class="nf">unique_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a boolean mask for the unique bins.</span>
<span class="sd">        </span>
<span class="sd">        The returned map is True for spaxels that are part of a unique</span>
<span class="sd">        bin, Fals otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_indices</span><span class="p">()</span>
        <span class="n">msk</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="n">msk</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">msk</span></div>


<div class="viewcode-block" id="DAPFits.channel_map"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.DAPFits.channel_map">[docs]</a>    <span class="k">def</span> <span class="nf">channel_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a 2D array with the map for the specified channel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Channel must be satisfied</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must specify channel for extension </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ext</span><span class="p">))</span>
            <span class="c1"># Return unmasked array</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="c1"># Attempt to get the mask extension from the header</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mask_ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;QUALDATA&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mask extension not specified in header.  Unable to mask array.&#39;</span><span class="p">)</span>
            <span class="c1"># Return a masked array, masking the specified flags</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                        <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">mask_ext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                                  <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">channel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_dict</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No channel </span><span class="si">{0}</span><span class="s1"> in extension </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">channel</span><span class="p">))</span>

        <span class="c1"># Return unmasked array</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_dict</span><span class="p">[</span><span class="n">ext</span><span class="p">][</span><span class="n">channel</span><span class="p">]])</span>
        <span class="c1"># Attempt to get the mask extension from the header</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mask_ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;QUALDATA&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mask extension not specified in header.  Unable to mask array.&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_dict</span><span class="p">[</span><span class="n">ext</span><span class="p">][</span><span class="n">channel</span><span class="p">]],</span>
                                    <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">mask_ext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_dict</span><span class="p">[</span><span class="n">ext</span><span class="p">][</span><span class="n">channel</span><span class="p">]],</span>
                                      <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">))</span></div></div>


<span class="c1">#-----------------------------------------------------------------------</span>
<div class="viewcode-block" id="construct_maps_file"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file">[docs]</a><span class="k">class</span> <span class="nc">construct_maps_file</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a DAP MAPS file.</span>

<span class="sd">    Set as a class for coherency reasons, but should not be used as an</span>
<span class="sd">    object!</span>

<span class="sd">    Should force all intermediate objects to be provided.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drpf</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rdxqa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">emission_line_moments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">emission_line_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spectral_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">nsa_redshift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">directory_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">loggers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">single_precision</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Initialize the reporting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loggers</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">loggers</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">loggers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span> <span class="k">if</span> <span class="n">single_precision</span> <span class="k">else</span> <span class="s1">&#39;float&#39;</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Check input types</span>
        <span class="n">confirm_dap_types</span><span class="p">(</span><span class="n">drpf</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">rdxqa</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="p">,</span>
                          <span class="n">emission_line_moments</span><span class="p">,</span> <span class="n">emission_line_model</span><span class="p">,</span> <span class="n">spectral_indices</span><span class="p">)</span>

<span class="c1">#        print(&#39;inside construct&#39;)</span>
<span class="c1">#        bin_indx = stellar_continuum[&#39;BINID&#39;].data.copy().ravel()</span>
<span class="c1">#        pyplot.imshow(DAPFitsUtil.reconstruct_map(drpf.spatial_shape, bin_indx, #vel),</span>
<span class="c1">#                                                  stellar_continuum[&#39;PAR&#39;].data[&#39;KIN&#39;][:,0]),</span>
<span class="c1">#                      origin=&#39;lower&#39;, interpolation=&#39;nearest&#39;)</span>
<span class="c1">#        pyplot.show()</span>
<span class="c1">#</span>
<span class="c1">#        pyplot.imshow(DAPFitsUtil.reconstruct_map(drpf.spatial_shape, bin_indx, #vel),</span>
<span class="c1">#                                                  stellar_continuum[&#39;PAR&#39;].data[&#39;KIN&#39;][:,1]),</span>
<span class="c1">#                      origin=&#39;lower&#39;, interpolation=&#39;nearest&#39;)</span>
<span class="c1">#        pyplot.show()</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Set the output paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drpf</span> <span class="o">=</span> <span class="n">drpf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_paths</span><span class="p">(</span><span class="n">directory_path</span><span class="p">,</span> <span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span>
                        <span class="n">stellar_continuum</span><span class="p">)</span>

        <span class="c1"># Save input for reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">spatial_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsa_redshift</span> <span class="o">=</span> <span class="n">nsa_redshift</span>
<span class="c1">#        self.multichannel_arrays = None</span>
<span class="c1">#        self._set_multichannel_arrays(emission_line_moments, emission_line_model, spectral_indices)</span>
<span class="c1">#        self.singlechannel_arrays = None</span>
<span class="c1">#        self._set_singlechannel_arrays(emission_line_moments, emission_line_model, spectral_indices)</span>

        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0:^50}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;CONSTRUCTING OUTPUT MAPS&#39;</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Output path: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Output file: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Output maps have shape </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;NSA redshift: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsa_redshift</span><span class="p">))</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Check if the file already exists</span>
        <span class="n">ofile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="c1"># TODO: Perform some checks to make sure the existing file</span>
            <span class="c1"># has the correct content?</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Output file exists!  Set clobber=True to overwrite.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Initialize the primary header</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">initialize_dap_primary_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span> <span class="n">maskname</span><span class="o">=</span><span class="s1">&#39;MANGA_DAPPIXMASK&#39;</span><span class="p">)</span>
        <span class="c1"># Add the DAP method</span>
        <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;DAPTYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">default_dap_method</span><span class="p">(</span><span class="n">binned_spectra</span><span class="o">=</span><span class="n">binned_spectra</span><span class="p">,</span>
                                                <span class="n">stellar_continuum</span><span class="o">=</span><span class="n">stellar_continuum</span><span class="p">),</span>
                             <span class="s1">&#39;DAP analysis method&#39;</span><span class="p">)</span>
        <span class="c1"># Add the format of this file</span>
        <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;DAPFRMT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;MAPS&#39;</span><span class="p">,</span> <span class="s1">&#39;DAP data file format&#39;</span><span class="p">)</span>

        <span class="c1"># Get the base map headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multichannel_maphdr</span> \
                <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">build_map_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span>
                                <span class="s1">&#39;K Westfall &amp; B Andrews &lt;westfall@ucolick.org, andrewsb@pitt.edu&gt;&#39;</span><span class="p">,</span>
                                               <span class="n">multichannel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maskname</span><span class="o">=</span><span class="s1">&#39;MANGA_DAPPIXMASK&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span> \
                <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">build_map_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span>
                                <span class="s1">&#39;K Westfall &amp; B Andrews &lt;westfall@ucolick.org, andrewsb@pitt.edu&gt;&#39;</span><span class="p">,</span>
                                               <span class="n">maskname</span><span class="o">=</span><span class="s1">&#39;MANGA_DAPPIXMASK&#39;</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Initialize the pixel mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">DAPMapsBitMask</span><span class="p">(</span><span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>

        <span class="c1"># Get the mask for the binned spectra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bin_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_binning_mask</span><span class="p">(</span><span class="n">binned_spectra</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Construct the hdu list for each input object.</span>
        <span class="c1"># Reduction assessments:</span>
        <span class="n">rdxqalist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction_assessment_maps</span><span class="p">(</span><span class="n">prihdr</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">rdxqa</span><span class="p">)</span>
        <span class="c1"># Construct the BINID extension</span>
        <span class="n">binidlist</span> <span class="o">=</span> <span class="n">combine_binid_extensions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="p">,</span>
                                             <span class="n">emission_line_moments</span><span class="p">,</span> <span class="n">emission_line_model</span><span class="p">,</span>
                                             <span class="n">spectral_indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
        <span class="c1"># Binned spectra:</span>
        <span class="n">bspeclist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra_maps</span><span class="p">(</span><span class="n">prihdr</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">)</span>
        <span class="c1"># Stellar-continuum fits:</span>
        <span class="n">contlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stellar_continuum_maps</span><span class="p">(</span><span class="n">prihdr</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="p">)</span>
        <span class="c1"># Emission-line moments:</span>
        <span class="n">emlmomlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_moment_maps</span><span class="p">(</span><span class="n">prihdr</span><span class="p">,</span> <span class="n">emission_line_moments</span><span class="p">)</span>
        <span class="c1"># Emission-line models:</span>
        <span class="n">elmodlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model_maps</span><span class="p">(</span><span class="n">prihdr</span><span class="p">,</span> <span class="n">emission_line_model</span><span class="p">)</span>

<span class="c1">#        print(elmodlist[10].name)</span>
<span class="c1">#        print(elmodlist[10].data.shape)</span>
<span class="c1">#        print(numpy.sum(numpy.invert(numpy.isfinite(elmodlist[10].data))))</span>

        <span class="c1"># Spectral indices:</span>
        <span class="n">sindxlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_index_maps</span><span class="p">(</span><span class="n">prihdr</span><span class="p">,</span> <span class="n">spectral_indices</span><span class="p">)</span>

        <span class="c1"># Save the data to the hdu attribute</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">add_snr_metrics_to_header</span><span class="p">(</span><span class="n">prihdr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span> <span class="n">rdxqalist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                           <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>
        
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">finalize_dap_primary_header</span><span class="p">(</span><span class="n">prihdr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span>
                                             <span class="n">stellar_continuum</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">,</span>
                                             <span class="n">loggers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">prihdr</span><span class="p">),</span>
                                  <span class="o">*</span><span class="n">rdxqalist</span><span class="p">,</span>
                                  <span class="o">*</span><span class="n">binidlist</span><span class="p">,</span>
                                  <span class="o">*</span><span class="n">bspeclist</span><span class="p">,</span>
                                  <span class="o">*</span><span class="n">contlist</span><span class="p">,</span>
                                  <span class="o">*</span><span class="n">emlmomlist</span><span class="p">,</span>
                                  <span class="o">*</span><span class="n">elmodlist</span><span class="p">,</span>
                                  <span class="o">*</span><span class="n">sindxlist</span>
                                <span class="p">])</span>

        <span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span> <span class="n">h</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="p">]</span>

<span class="c1">#        print(&#39;maps&#39;)</span>
<span class="c1">#        pyplot.imshow(self.hdu[&#39;STELLAR_VEL&#39;].data, origin=&#39;lower&#39;, interpolation=&#39;nearest&#39;)</span>
<span class="c1">#        pyplot.show()</span>
<span class="c1">#</span>
<span class="c1">#        pyplot.imshow(self.hdu[&#39;STELLAR_SIGMA&#39;].data, origin=&#39;lower&#39;, interpolation=&#39;nearest&#39;)</span>
<span class="c1">#        pyplot.show()</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># TEMPORARY FLAGS:</span>
        <span class="c1"># Flag the Gaussian-fitted flux as unreliable if the summed flux</span>
        <span class="c1"># is not within the factor below</span>
<span class="c1">#        if emission_line_moments is not None and emission_line_model is not None \</span>
<span class="c1">#                    and self.hdu[&#39;EMLINE_GFLUX&#39;].data.shape != self.hdu[&#39;EMLINE_SFLUX&#39;].data.shape:</span>
<span class="c1">#            warnings.warn(&#39;Cannot compare emission-line moment and model fluxes!&#39;)</span>
<span class="c1">#        elif emission_line_moments is not None and emission_line_model is not None \</span>
<span class="c1">#                    and self.hdu[&#39;EMLINE_GFLUX&#39;].data.shape == self.hdu[&#39;EMLINE_SFLUX&#39;].data.shape:</span>
<span class="c1">#            factor = 5.0</span>
<span class="c1">#            indx = (self.hdu[&#39;EMLINE_GFLUX_MASK&#39;].data == 0) \</span>
<span class="c1">#                    &amp; (self.hdu[&#39;EMLINE_SFLUX_MASK&#39;].data == 0) \</span>
<span class="c1">#                    &amp; ( (self.hdu[&#39;EMLINE_GFLUX&#39;].data &lt; self.hdu[&#39;EMLINE_SFLUX&#39;].data/factor)</span>
<span class="c1">#                        | (self.hdu[&#39;EMLINE_GFLUX&#39;].data &gt; self.hdu[&#39;EMLINE_SFLUX&#39;].data*factor) ) \</span>
<span class="c1">#                    &amp; ( (emission_line_moments[&#39;BINID&#39;].data &gt; -1)</span>
<span class="c1">#                        &amp; (emission_line_model[&#39;BINID&#39;].data &gt; -1) )[:,:,None]</span>
<span class="c1">#            print(&#39;unreliable Gaussian flux compared to summed flux: &#39;, numpy.sum(indx))</span>
<span class="c1">#            if numpy.sum(indx) &gt; 0:</span>
<span class="c1">#                self.hdu[&#39;EMLINE_GFLUX_MASK&#39;].data[indx] \</span>
<span class="c1">#                    = self.bitmask.turn_on(self.hdu[&#39;EMLINE_GFLUX_MASK&#39;].data[indx], &#39;UNRELIABLE&#39;)</span>
<span class="c1">#                self.hdu[&#39;EMLINE_GVEL_MASK&#39;].data[indx] \</span>
<span class="c1">#                    = self.bitmask.turn_on(self.hdu[&#39;EMLINE_GVEL_MASK&#39;].data[indx], &#39;UNRELIABLE&#39;)</span>
<span class="c1">#                self.hdu[&#39;EMLINE_GSIGMA_MASK&#39;].data[indx] \</span>
<span class="c1">#                    = self.bitmask.turn_on(self.hdu[&#39;EMLINE_GSIGMA_MASK&#39;].data[indx], &#39;UNRELIABLE&#39;)</span>

            <span class="c1"># TODO: Add if EMLINE_GSIGMA &lt; EMLINE_INSTSIGMA !!</span>

        <span class="c1"># Flag the stellar velocity dispersions measured in spectra with</span>
        <span class="c1"># S/N&lt;10 as unreliable</span>
<span class="c1">#        indx = (binned_spectra[&#39;BINID&#39;].data &gt; -1) &amp; (self.hdu[&#39;BIN_SNR&#39;].data &lt; 10) \</span>
<span class="c1">#                    &amp; (stellar_continuum[&#39;BINID&#39;].data &gt; -1) \</span>
<span class="c1">#                    &amp; (self.hdu[&#39;STELLAR_SIGMA_MASK&#39;].data == 0)</span>
<span class="c1">#        print(&#39;unreliable sigma because of low S/N: &#39;, numpy.sum(indx))</span>
<span class="c1">#        if numpy.sum(indx):</span>
<span class="c1">#            self.hdu[&#39;STELLAR_SIGMA_MASK&#39;].data[indx] \</span>
<span class="c1">#                    = self.bitmask.turn_on(self.hdu[&#39;STELLAR_SIGMA_MASK&#39;].data[indx], &#39;UNRELIABLE&#39;)</span>

        <span class="c1"># Flag any inverse variances that are not positive as DONOTUSE</span>
        <span class="c1"># and MATHERROR</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;BIN_MFLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;STELLAR_VEL&#39;</span><span class="p">,</span> <span class="s1">&#39;STELLAR_SIGMA&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_SFLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_SEW&#39;</span><span class="p">,</span>
                <span class="s1">&#39;EMLINE_GFLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GEW&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GVEL&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GSIGMA&#39;</span><span class="p">,</span> <span class="s1">&#39;SPECINDEX&#39;</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ext</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_MASK&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extensions</span> \
                    <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_IVAR&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extensions</span> \
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_MASK&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> \
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_IVAR&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_MASK&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span><span class="p">))</span> \
                            <span class="o">&amp;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_IVAR&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_MASK&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> \
                    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_MASK&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;MATHERROR&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_MASK&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> \
                    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_MASK&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;DONOTUSE&#39;</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>

        <span class="c1"># Check that the path exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">)</span>
        <span class="c1"># Write the maps file</span>
        <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">loggers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span>
                          <span class="n">quiet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span>
        <span class="c1"># End</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>


<div class="viewcode-block" id="construct_maps_file._set_paths"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file._set_paths">[docs]</a>    <span class="k">def</span> <span class="nf">_set_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory_path</span><span class="p">,</span> <span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span>
                   <span class="n">stellar_continuum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the paths relevant to the map file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The output method directory is, for now, the combination of</span>
        <span class="c1"># the binned_spectrum and stellar_continuum method keys</span>
        <span class="k">if</span> <span class="n">directory_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">binned_spectra</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">stellar_continuum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not define output directory path.&#39;</span><span class="p">)</span>

        <span class="c1"># Set the output directory path</span>
        <span class="c1"># TODO: Get DAP version from __version__ string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">default_dap_method</span><span class="p">(</span><span class="n">binned_spectra</span><span class="o">=</span><span class="n">binned_spectra</span><span class="p">,</span>
                                         <span class="n">stellar_continuum</span><span class="o">=</span><span class="n">stellar_continuum</span><span class="p">)</span> \
                                <span class="k">if</span> <span class="n">directory_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span> <span class="o">=</span> <span class="n">default_dap_method_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">plate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span>
                                                      <span class="n">ifudesign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span>
                                                      <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="n">dapver</span><span class="p">,</span>
                                                      <span class="n">analysis_path</span><span class="o">=</span><span class="n">analysis_path</span><span class="p">)</span> \
                                                <span class="k">if</span> <span class="n">directory_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)</span>

        <span class="c1"># Set the output file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">default_dap_file_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;MAPS&#39;</span><span class="p">)</span> \
                                    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_maps_file._consolidate_donotuse"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file._consolidate_donotuse">[docs]</a>    <span class="k">def</span> <span class="nf">_consolidate_donotuse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">consolidate</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;NOCOV&#39;</span><span class="p">,</span> <span class="s1">&#39;LOWCOV&#39;</span><span class="p">,</span> <span class="s1">&#39;DEADFIBER&#39;</span><span class="p">,</span> <span class="s1">&#39;FORESTAR&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;NOVALUE&#39;</span><span class="p">,</span> <span class="s1">&#39;MATHERROR&#39;</span><span class="p">,</span> <span class="s1">&#39;FITFAILED&#39;</span><span class="p">,</span> <span class="s1">&#39;NEARBOUND&#39;</span> <span class="p">],</span>
                                        <span class="s1">&#39;DONOTUSE&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_maps_file._build_binning_mask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file._build_binning_mask">[docs]</a>    <span class="k">def</span> <span class="nf">_build_binning_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">):</span>

        <span class="c1"># Marginalize the DRP mask across wavelengths</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">marginalize_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                            <span class="p">[</span> <span class="s1">&#39;NOCOV&#39;</span><span class="p">,</span> <span class="s1">&#39;LOWCOV&#39;</span><span class="p">,</span> <span class="s1">&#39;DEADFIBER&#39;</span><span class="p">,</span> <span class="s1">&#39;FORESTAR&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;DONOTUSE&#39;</span> <span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">bitmask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="p">)</span>

        <span class="c1"># Add any bits not included in the binning algorithm</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;MAPMASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                              <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;LOW_SPECCOV&#39;</span><span class="p">,</span> <span class="s1">&#39;LOW_SNR&#39;</span><span class="p">])</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;NOVALUE&#39;</span><span class="p">)</span>

        <span class="c1"># Marginalize the binned spectra mask just for NONE_IN_STACK and</span>
        <span class="c1"># convert it to NOVALUE</span>
        <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">marginalize_mask</span><span class="p">(</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;NONE_IN_STACK&#39;</span><span class="p">,</span>
                                                <span class="n">binned_spectra</span><span class="o">.</span><span class="n">bitmask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="p">,</span>
                                                <span class="n">out_flag</span><span class="o">=</span><span class="s1">&#39;NOVALUE&#39;</span><span class="p">,</span> <span class="n">dispaxis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Reconstruct the full mask with just this flag</span>
        <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">reconstruct_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span>
                                               <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">bin_mask</span><span class="p">)</span>
        <span class="c1"># Add these bits to the full mask</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">,</span> <span class="s1">&#39;NOVALUE&#39;</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;NOVALUE&#39;</span><span class="p">)</span>
        
        <span class="c1"># Return the mask after consolidating flags into DONOTUSE</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consolidate_donotuse</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_maps_file._stellar_continuum_mask_to_map_mask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file._stellar_continuum_mask_to_map_mask">[docs]</a>    <span class="k">def</span> <span class="nf">_stellar_continuum_mask_to_map_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="p">,</span> <span class="n">sc_mask</span><span class="p">,</span> <span class="n">for_dispersion</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        sc_mask constains the reconstructed map of the masks in each</span>
<span class="sd">        stellar continuum fit (using the stellar continuum bitmask).</span>

<span class="sd">        Propagate and consolidate the stellar-continuum masks to the map</span>
<span class="sd">        pixel mask.</span>

<span class="sd">        DIDNOTUSE, FORESTAR propagated from already existing mask</span>
<span class="sd">            (self.bin_mask)</span>

<span class="sd">        LOW_SNR, NO_FIT, INSUFFICIENT_DATA propagated to NOVALUE</span>

<span class="sd">        FIT_FAILED, NEAR_BOUND propagated to FITFAILED and NEARBOUND</span>

<span class="sd">        NEGATIVE_WEIGHTS consolidated into UNRELIABLE; if</span>
<span class="sd">            dispersion=True, include BAD_SIGMA in this</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Copy the binning mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Use the stellar continuum map mask to flag low S/N</span>
        <span class="c1"># bins/spaxels as NOVALUE</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">stellar_continuum</span><span class="p">[</span><span class="s1">&#39;MAPMASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;LOW_SNR&#39;</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;NOVALUE&#39;</span><span class="p">)</span>

        <span class="c1"># Consolidate to NOVALUE</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">sc_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NO_FIT&#39;</span><span class="p">,</span> <span class="s1">&#39;INSUFFICIENT_DATA&#39;</span> <span class="p">])</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;NOVALUE&#39;</span><span class="p">)</span>

        <span class="c1"># Copy FIT_FAILED</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">sc_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;FIT_FAILED&#39;</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;FITFAILED&#39;</span><span class="p">)</span>

        <span class="c1"># Copy NEAR_BOUND</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">sc_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;NEAR_BOUND&#39;</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;NEARBOUND&#39;</span><span class="p">)</span>

        <span class="c1"># Consolidate to UNRELIABLE</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">sc_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;NEGATIVE_WEIGHTS&#39;</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;UNRELIABLE&#39;</span><span class="p">)</span>

        <span class="c1"># Convert MIN_SIGMA into a NEARBOUND for the dispersion</span>
        <span class="k">if</span> <span class="n">for_dispersion</span><span class="p">:</span>
            <span class="n">flgd</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">sc_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;BAD_SIGMA&#39;</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;UNRELIABLE&#39;</span><span class="p">)</span>

            <span class="n">flgd</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">sc_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;MIN_SIGMA&#39;</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;NEARBOUND&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consolidate_donotuse</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_maps_file._emission_line_moment_mask_to_map_mask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file._emission_line_moment_mask_to_map_mask">[docs]</a>    <span class="k">def</span> <span class="nf">_emission_line_moment_mask_to_map_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emission_line_moments</span><span class="p">,</span> <span class="n">elm_mask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate and consolidate the emission-line moment masks to the map</span>
<span class="sd">        pixel mask.</span>

<span class="sd">        DIDNOTUSE, FORESTAR propagated from already existing mask (self.bin_mask)</span>

<span class="sd">        MAIN_EMPTY, BLUE_EMPTY, RED_EMPTY, UNDEFINED_BANDS propagated to NOVALUE</span>

<span class="sd">        MAIN_JUMP, BLUE_JUMP, RED_JUMP, JUMP_BTWN_SIDEBANDS propagated to FITFAILED</span>

<span class="sd">        MAIN_INCOMP, BLUE_INCOMP, RED_INCOMP propagated to UNRELIABLE</span>

<span class="sd">        NO_ABSORPTION_CORRECTION propagated to NOCORRECTION</span>

<span class="sd">        DIVBYZERO propagated to MATHERROR</span>

<span class="sd">        Second moments not provided so no need to include UNDEFINED_MOM2</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Copy the binning mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Use the emission-line moments map mask to flag low S/N</span>
        <span class="c1"># bins/spaxels as NOVALUE</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">emission_line_moments</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">emission_line_moments</span><span class="p">[</span><span class="s1">&#39;MAPMASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                     <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;LOW_SNR&#39;</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;NOVALUE&#39;</span><span class="p">)</span>

        <span class="c1"># Reshape the mask to include all emission lines</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">emission_line_moments</span><span class="o">.</span><span class="n">nmom</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Consolidate to NOVALUE</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">emission_line_moments</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">elm_mask</span><span class="p">,</span>
                                                     <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAIN_EMPTY&#39;</span><span class="p">,</span> <span class="s1">&#39;BLUE_EMPTY&#39;</span><span class="p">,</span> <span class="s1">&#39;RED_EMPTY&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;UNDEFINED_BANDS&#39;</span> <span class="p">])</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;NOVALUE&#39;</span><span class="p">)</span>

        <span class="c1"># Consolidate to FITFAILED</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">emission_line_moments</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">elm_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAIN_JUMP&#39;</span><span class="p">,</span> <span class="s1">&#39;BLUE_JUMP&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;RED_JUMP&#39;</span><span class="p">,</span> <span class="s1">&#39;JUMP_BTWN_SIDEBANDS&#39;</span><span class="p">])</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;FITFAILED&#39;</span><span class="p">)</span>

        <span class="c1"># Consolidate to UNRELIABLE</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">emission_line_moments</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">elm_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAIN_INCOMP&#39;</span><span class="p">,</span> <span class="s1">&#39;BLUE_INCOMP&#39;</span><span class="p">,</span>
                                                                     <span class="s1">&#39;RED_INCOMP&#39;</span> <span class="p">])</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;UNRELIABLE&#39;</span><span class="p">)</span>

        <span class="c1"># Consolidate to NOCORRECTION</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">emission_line_moments</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">elm_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NO_ABSORPTION_CORRECTION&#39;</span><span class="p">])</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;NOCORRECTION&#39;</span><span class="p">)</span>

        <span class="c1"># Consolidate to MATHERROR</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">emission_line_moments</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">elm_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DIVBYZERO&#39;</span><span class="p">])</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;MATHERROR&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consolidate_donotuse</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_maps_file._emission_line_model_mask_to_map_mask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file._emission_line_model_mask_to_map_mask">[docs]</a>    <span class="k">def</span> <span class="nf">_emission_line_model_mask_to_map_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emission_line_model</span><span class="p">,</span> <span class="n">elf_mask</span><span class="p">,</span>
                                              <span class="n">for_dispersion</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate and consolidate the emission-line moment masks to the map</span>
<span class="sd">        pixel mask.</span>

<span class="sd">        INSUFFICIENT_DATA propagated to NOVALUE</span>

<span class="sd">        FIT_FAILED, UNDEFINED_COVAR propagated to FITFAILED</span>

<span class="sd">        NEAR_BOUND copied to NEARBOUND</span>

<span class="sd">        UNDEFINED_SIGMA propagated to UNRELIABLE</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Copy the common mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Use the emission-line model map mask to flag low S/N</span>
        <span class="c1"># bins/spaxels as NOVALUE</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;MAPMASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                   <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;LOW_SNR&#39;</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;NOVALUE&#39;</span><span class="p">)</span>

        <span class="c1"># Reshape the mask to include all emission lines</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Consolidate to NOVALUE</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">elf_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;INSUFFICIENT_DATA&#39;</span><span class="p">])</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;NOVALUE&#39;</span><span class="p">)</span>

        <span class="c1"># Consolidate to FITFAILED</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">elf_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FIT_FAILED&#39;</span><span class="p">,</span> <span class="s1">&#39;UNDEFINED_COVAR&#39;</span><span class="p">])</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;FITFAILED&#39;</span><span class="p">)</span>

        <span class="c1"># Copy NEAR_BOUND</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">elf_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;NEAR_BOUND&#39;</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;NEARBOUND&#39;</span><span class="p">)</span>

        <span class="c1"># Consolidate dispersion flags to NEARBOUND and UNRELIABLE</span>
        <span class="k">if</span> <span class="n">for_dispersion</span><span class="p">:</span>
            <span class="n">flgd</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">elf_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;MIN_SIGMA&#39;</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;NEARBOUND&#39;</span><span class="p">)</span>

            <span class="n">flgd</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">elf_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;UNDEFINED_SIGMA&#39;</span><span class="p">,</span>
                                                                       <span class="s1">&#39;BAD_SIGMA&#39;</span><span class="p">])</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;UNRELIABLE&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consolidate_donotuse</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_maps_file._spectral_index_mask_to_map_mask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file._spectral_index_mask_to_map_mask">[docs]</a>    <span class="k">def</span> <span class="nf">_spectral_index_mask_to_map_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectral_indices</span><span class="p">,</span> <span class="n">si_mask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate and consolidate the spectral index masks to the map</span>
<span class="sd">        pixel mask.</span>

<span class="sd">        DIDNOTUSE, FORESTAR propagated from already existing mask (self.bin_mask)</span>

<span class="sd">        MAIN_EMPTY, BLUE_EMPTY, RED_EMPTY, UNDEFINED_BANDS propagated to NOVALUE</span>

<span class="sd">        MAIN_INCOMP, BLUE_INCOMP, RED_INCOMP propagated to UNRELIABLE</span>

<span class="sd">        NO_DISPERSION_CORRECTION propagated to NOCORRECTION</span>

<span class="sd">        DIVBYZERO propagated to MATHERROR</span>

<span class="sd">        Need to further assess \*_INCOMP to see if these lead to bad values (BADVALUE).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Copy the common mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Use the spectral index map mask to flag low S/N bins/spaxels</span>
        <span class="c1"># as NOVALUE</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">spectral_indices</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">spectral_indices</span><span class="p">[</span><span class="s1">&#39;MAPMASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;LOW_SNR&#39;</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;NOVALUE&#39;</span><span class="p">)</span>

        <span class="c1"># Reshape the mask to include all the spectral indices</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mask</span><span class="p">]</span><span class="o">*</span><span class="n">spectral_indices</span><span class="o">.</span><span class="n">nindx</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Consolidate to NOVALUE</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">spectral_indices</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">si_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAIN_EMPTY&#39;</span><span class="p">,</span> <span class="s1">&#39;BLUE_EMPTY&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;RED_EMPTY&#39;</span><span class="p">,</span> <span class="s1">&#39;UNDEFINED_BANDS&#39;</span> <span class="p">])</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;NOVALUE&#39;</span><span class="p">)</span>

        <span class="c1"># Consolidate to UNRELIABLE</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">spectral_indices</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">si_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MAIN_INCOMP&#39;</span><span class="p">,</span> <span class="s1">&#39;BLUE_INCOMP&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;RED_INCOMP&#39;</span> <span class="p">])</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;UNRELIABLE&#39;</span><span class="p">)</span>

        <span class="c1"># Consolidate to NOCORRECTION</span>
        <span class="c1"># TODO: What do I do about this!</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">spectral_indices</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">si_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NO_DISPERSION_CORRECTION&#39;</span><span class="p">])</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;NOCORRECTION&#39;</span><span class="p">)</span>

        <span class="c1"># Consolidate to MATHERROR</span>
        <span class="n">flgd</span> <span class="o">=</span> <span class="n">spectral_indices</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">si_mask</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DIVBYZERO&#39;</span><span class="p">])</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">flgd</span><span class="p">],</span> <span class="s1">&#39;MATHERROR&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consolidate_donotuse</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_maps_file.reduction_assessment_maps"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file.reduction_assessment_maps">[docs]</a>    <span class="k">def</span> <span class="nf">reduction_assessment_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prihdr</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">rdxqa</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the &#39;SPX_SKYCOO&#39;, &#39;SPX_ELLCOO&#39;, &#39;SPX_MFLUX&#39;,</span>
<span class="sd">        &#39;SPX_MFLUX_IVAR&#39;, and &#39;SPX_SNR&#39; map extensions.</span>

<span class="sd">        .. todo::</span>
<span class="sd">            Add the spaxel correlation data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Extensions filled from the reduction assessments</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPX_SKYCOO&#39;</span><span class="p">,</span> <span class="s1">&#39;SPX_ELLCOO&#39;</span><span class="p">,</span> <span class="s1">&#39;SPX_MFLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;SPX_MFLUX_IVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;SPX_SNR&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">rdxqa</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Construct and return the empty hdus</span>
            <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">empty_hdus</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Add data to the primary header</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">rdxqa</span><span class="o">.</span><span class="n">_initialize_primary_header</span><span class="p">(</span><span class="n">hdr</span><span class="o">=</span><span class="n">prihdr</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the extension headers</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multichannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;SPX_SKYCOO&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;arcsec&#39;</span><span class="p">,</span> <span class="n">multichannel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">channel_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;On-sky X&#39;</span><span class="p">,</span> <span class="s1">&#39;On-sky Y&#39;</span><span class="p">]),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multichannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;SPX_ELLCOO&#39;</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">channel_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Elliptical radius&#39;</span><span class="p">,</span> <span class="s1">&#39;R/Re&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;Elliptical azimuth&#39;</span><span class="p">],</span>
                                                <span class="n">channel_units</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;arcsec&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;degrees&#39;</span><span class="p">]),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;SPX_MFLUX&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;1E-17 erg/s/cm^2/ang/spaxel&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;SPX_MFLUX&#39;</span><span class="p">,</span>
                                                <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;(1E-17 erg/s/cm^2/ang/spaxel)^{-2}&#39;</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;SPX_SNR&#39;</span><span class="p">)</span>
              <span class="p">]</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the data arrays</span>
        <span class="c1"># On-sky coordinates</span>
        <span class="n">minimum_value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
        <span class="n">spx_skycoo</span> <span class="o">=</span> <span class="n">rdxqa</span><span class="p">[</span><span class="s1">&#39;SPECTRUM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SKY_COO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">spx_skycoo</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">spx_skycoo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minimum_value</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># Elliptical coordinates</span>
        <span class="n">spx_ellcoo</span> <span class="o">=</span> <span class="n">rdxqa</span><span class="p">[</span><span class="s1">&#39;SPECTRUM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ELL_COO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">spx_ellcoo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">spx_ellcoo</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spx_ellcoo</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;reff&#39;</span><span class="p">]</span>
        <span class="n">spx_ellcoo</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">spx_ellcoo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minimum_value</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Bin signal</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">rdxqa</span><span class="p">[</span><span class="s1">&#39;SPECTRUM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SIGNAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>
        <span class="n">signal</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minimum_value</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># Bin inverse variance</span>
        <span class="n">ivar</span> <span class="o">=</span> <span class="n">rdxqa</span><span class="p">[</span><span class="s1">&#39;SPECTRUM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;VARIANCE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>
        <span class="n">ivar</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">ivar</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">ivar</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">ivar</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minimum_value</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># Bin S/N</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="n">rdxqa</span><span class="p">[</span><span class="s1">&#39;SPECTRUM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SNR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>
        <span class="n">snr</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minimum_value</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Organize the extension data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="n">spx_skycoo</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span> <span class="n">spx_ellcoo</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="n">signal</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span> <span class="n">ivar</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="n">snr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">)</span> <span class="p">]</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Return the map hdus</span>
        <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">list_of_image_hdus</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="construct_maps_file.binned_spectra_maps"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file.binned_spectra_maps">[docs]</a>    <span class="k">def</span> <span class="nf">binned_spectra_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prihdr</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the &#39;BIN_LWSKYCOO&#39;, &#39;BIN_LWELLCOO&#39;, &#39;BIN_AREA&#39;,</span>
<span class="sd">        &#39;BIN_FAREA&#39;, &#39;BIN_MFLUX&#39;, &#39;BIN_MFLUX_IVAR&#39;, &#39;BIN_MFLUX_MASK&#39;,</span>
<span class="sd">        and &#39;BIN_SNR&#39; map extensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#---------------------------------------------------------------</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BIN_LWSKYCOO&#39;</span><span class="p">,</span> <span class="s1">&#39;BIN_LWELLCOO&#39;</span><span class="p">,</span> <span class="s1">&#39;BIN_AREA&#39;</span><span class="p">,</span> <span class="s1">&#39;BIN_FAREA&#39;</span><span class="p">,</span> <span class="s1">&#39;BIN_MFLUX&#39;</span><span class="p">,</span>
               <span class="s1">&#39;BIN_MFLUX_IVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;BIN_MFLUX_MASK&#39;</span><span class="p">,</span> <span class="s1">&#39;BIN_SNR&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">binned_spectra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Construct and return the empty hdus</span>
            <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">empty_hdus</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Add data to the primary header</span>
        <span class="c1"># TODO: Apply this to each extension instead of the primary</span>
        <span class="c1"># header to allow for extension specific binning?</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">_initialize_primary_header</span><span class="p">(</span><span class="n">hdr</span><span class="o">=</span><span class="n">prihdr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">is_unbinned</span><span class="p">:</span>
            <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;BINTYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;Binning method&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prihdr</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">_add_method_header</span><span class="p">(</span><span class="n">prihdr</span><span class="p">)</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">_add_reddening_header</span><span class="p">(</span><span class="n">prihdr</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the extension headers</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multichannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;BIN_LWSKYCOO&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;arcsec&#39;</span><span class="p">,</span> <span class="n">multichannel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">channel_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Lum. weighted on-sky X&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;Lum. weighted on-sky Y&#39;</span><span class="p">]),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multichannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;BIN_LWELLCOO&#39;</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">channel_names</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lum. weighted elliptical radius&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;R/Re&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;Lum. weighted elliptical azimuth&#39;</span><span class="p">],</span>
                                                <span class="n">channel_units</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;arcsec&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;degrees&#39;</span><span class="p">]),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;BIN_AREA&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;arcsec^2&#39;</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;BIN_FAREA&#39;</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;BIN_MFLUX&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;1E-17 erg/s/cm^2/ang/spaxel&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;BIN_MFLUX&#39;</span><span class="p">,</span>
                                                <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;(1E-17 erg/s/cm^2/ang/spaxel)^{-2}&#39;</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;BIN_MFLUX&#39;</span><span class="p">,</span>
                                                <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">bit_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">()),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;BIN_SNR&#39;</span><span class="p">)</span>
               <span class="p">]</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the data arrays</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;LW_SKY_COO&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;LW_SKY_COO&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;LW_ELL_COO&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;LW_ELL_COO&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;LW_ELL_COO&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;AREA&#39;</span><span class="p">],</span>
                <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;AREA_FRAC&#39;</span><span class="p">],</span>
                <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SIGNAL&#39;</span><span class="p">],</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;VARIANCE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
                <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SNR&#39;</span><span class="p">]</span>
              <span class="p">]</span>

        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>

        <span class="c1"># Bin index</span>
        <span class="n">bin_indx</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Remap the data to the DRP spatial shape</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">reconstruct_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">bin_indx</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">))</span>

        <span class="c1"># Get the normalized radius</span>
        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;reff&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">)</span>

        <span class="c1"># Organize the extension data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">]</span> \
                    <span class="o">+</span> <span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Return the map hdus</span>
        <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">list_of_image_hdus</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_maps_file.stellar_continuum_maps"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file.stellar_continuum_maps">[docs]</a>    <span class="k">def</span> <span class="nf">stellar_continuum_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prihdr</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the &#39;STELLAR_VEL&#39;, &#39;STELLAR_VEL_IVAR&#39;,</span>
<span class="sd">        &#39;STELLAR_VEL_MASK&#39;, &#39;STELLAR_SIGMA&#39;, &#39;STELLAR_SIGMA_IVAR&#39;,</span>
<span class="sd">        &#39;STELLAR_SIGMA_MASK&#39;, &#39;STELLAR_SIGMACORR&#39;,</span>
<span class="sd">        &#39;STELLAR_CONT_FRESID&#39;, and &#39;STELLAR_CONT_RCHI2&#39; maps extensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#---------------------------------------------------------------</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;STELLAR_VEL&#39;</span><span class="p">,</span> <span class="s1">&#39;STELLAR_VEL_IVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;STELLAR_VEL_MASK&#39;</span><span class="p">,</span> <span class="s1">&#39;STELLAR_SIGMA&#39;</span><span class="p">,</span>
                <span class="s1">&#39;STELLAR_SIGMA_IVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;STELLAR_SIGMA_MASK&#39;</span><span class="p">,</span> <span class="s1">&#39;STELLAR_SIGMACORR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;STELLAR_CONT_FRESID&#39;</span><span class="p">,</span> <span class="s1">&#39;STELLAR_CONT_RCHI2&#39;</span> <span class="p">]</span>

        <span class="k">if</span> <span class="n">stellar_continuum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Construct and return the empty hdus</span>
            <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">empty_hdus</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Add data to the primary header</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">_initialize_primary_header</span><span class="p">(</span><span class="n">hdr</span><span class="o">=</span><span class="n">prihdr</span><span class="p">)</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">_add_method_header</span><span class="p">(</span><span class="n">prihdr</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the extension headers</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;STELLAR_VEL&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;km/s&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;STELLAR_VEL&#39;</span><span class="p">,</span>
                                                <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;(km/s)^{-2}&#39;</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;STELLAR_VEL&#39;</span><span class="p">,</span>
                                                <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">bit_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">()),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;STELLAR_SIGMA&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;km/s&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;STELLAR_SIGMA&#39;</span><span class="p">,</span>
                                                <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;(km/s)^{-2}&#39;</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;STELLAR_SIGMA&#39;</span><span class="p">,</span>
                                                <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">bit_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">()),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;STELLAR_SIGMACORR&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;km/s&#39;</span><span class="p">),</span>
<span class="c1">#                DAPFitsUtil.finalize_dap_header(self.multichannel_maphdr, &#39;STELLAR_SIGMACORR&#39;,</span>
<span class="c1">#                                                multichannel=True, bunit=&#39;km/s&#39;,</span>
<span class="c1">#                                                channel_names=[&#39;resolution difference&#39;, &#39;fit&#39;]),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multichannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;STELLAR_CONT_FRESID&#39;</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">channel_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;68th percentile&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;99th percentile&#39;</span><span class="p">]),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="s1">&#39;STELLAR_CONT_RCHI2&#39;</span><span class="p">)</span>
              <span class="p">]</span>


        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the data arrays</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">redshift_to_Newtonian_velocity</span><span class="p">(</span>
                                    <span class="n">stellar_continuum</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;KIN&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsa_redshift</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">redshift_to_Newtonian_velocity</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">power</span><span class="p">(</span>
                                                    <span class="n">stellar_continuum</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;KINERR&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsa_redshift</span><span class="p">,</span> <span class="n">ivar</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">stellar_continuum</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;KIN&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">stellar_continuum</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;KINERR&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
<span class="c1"># Error in empirical correction, only output difference in resolution</span>
<span class="c1"># vectors</span>
<span class="c1">#                stellar_continuum[&#39;PAR&#39;].data[&#39;SIGMACORR_EMP&#39;],</span>
                <span class="n">stellar_continuum</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SIGMACORR_SRES&#39;</span><span class="p">],</span>
                <span class="n">stellar_continuum</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;FABSRESID&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">stellar_continuum</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;FABSRESID&#39;</span><span class="p">][:,</span><span class="mi">3</span><span class="p">],</span>
                <span class="n">stellar_continuum</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;RCHI2&#39;</span><span class="p">],</span>
                <span class="n">stellar_continuum</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span>
              <span class="p">]</span>

        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># Bin index</span>
        <span class="n">bin_indx</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="c1">##        pyplot.imshow(bin_indx.reshape(self.drpf.spatial_shape), origin=&#39;lower&#39;, interpolation=&#39;nearest&#39;)</span>
<span class="c1">##        pyplot.show()</span>
<span class="c1">#</span>
<span class="c1">#        pyplot.imshow(DAPFitsUtil.reconstruct_map(self.spatial_shape, bin_indx, stellar_continuum[&#39;PAR&#39;].data[&#39;KIN&#39;][:,0]), origin=&#39;lower&#39;, interpolation=&#39;nearest&#39;)</span>
<span class="c1">#        pyplot.show()</span>
<span class="c1">#</span>
<span class="c1">#        print(stellar_continuum[&#39;PAR&#39;].data[&#39;KIN&#39;][:,0])</span>
<span class="c1">#</span>
<span class="c1">#        print(&#39;nbin: {0}&#39;.format(numpy.sum(bin_indx &gt; -1)))    </span>
<span class="c1">#        exit()</span>

        <span class="c1"># Remap the data to the DRP spatial shape</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">reconstruct_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">bin_indx</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">))</span>
        
        <span class="c1"># Get the masks</span>
        <span class="n">vel_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stellar_continuum_mask_to_map_mask</span><span class="p">(</span><span class="n">stellar_continuum</span><span class="p">,</span> <span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">sig_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stellar_continuum_mask_to_map_mask</span><span class="p">(</span><span class="n">stellar_continuum</span><span class="p">,</span> <span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                                            <span class="n">for_dispersion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Organize the extension data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="n">vel_mask</span> <span class="p">]</span> <span class="o">+</span> <span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="n">sig_mask</span> <span class="p">]</span> \
                    <span class="o">+</span> <span class="p">[</span> <span class="n">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">arr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="p">]</span>
<span class="c1">#        data = arr[0:2] + [ vel_mask ] + arr[2:4] + [ sig_mask ] \</span>
<span class="c1">#                    + [ numpy.array(arr[4:6]).transpose(1,2,0),</span>
<span class="c1">#                        numpy.array(arr[6:8]).transpose(1,2,0), arr[8] ]</span>

<span class="c1">#        for i,d in enumerate(data):</span>
<span class="c1">#            if len(d.shape) == 2:</span>
<span class="c1">#                print(i+1)</span>
<span class="c1">#                pyplot.imshow(d, origin=&#39;lower&#39;, interpolation=&#39;nearest&#39;)</span>
<span class="c1">#                pyplot.show()</span>
<span class="c1">#        exit()</span>

<span class="c1">#        print(data, hdr, ext)</span>
<span class="c1">#        print(len(data), len(hdr), len(ext))</span>
<span class="c1">#        exit()</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Return the map hdus</span>
        <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">list_of_image_hdus</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_maps_file.emission_line_moment_maps"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file.emission_line_moment_maps">[docs]</a>    <span class="k">def</span> <span class="nf">emission_line_moment_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prihdr</span><span class="p">,</span> <span class="n">emission_line_moments</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the &#39;EMLINE_SFLUX&#39;, &#39;EMLINE_SFLUX_IVAR&#39;,</span>
<span class="sd">        &#39;EMLINE_SFLUX_MASK&#39;, &#39;EMLINE_SEW&#39;, &#39;EMLINE_SEW_IVAR&#39;, and</span>
<span class="sd">        &#39;EMLINE_SEW_MASK&#39; maps extensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#---------------------------------------------------------------</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;EMLINE_SFLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_SFLUX_IVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_SFLUX_MASK&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_SEW&#39;</span><span class="p">,</span>
                <span class="s1">&#39;EMLINE_SEW_IVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_SEW_MASK&#39;</span> <span class="p">]</span>

        <span class="k">if</span> <span class="n">emission_line_moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Construct and return the empty hdus</span>
            <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">empty_hdus</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Add data to the primary header</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">emission_line_moments</span><span class="o">.</span><span class="n">_initialize_primary_header</span><span class="p">(</span><span class="n">hdr</span><span class="o">=</span><span class="n">prihdr</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the extension headers</span>

        <span class="c1"># Need multichannel map header if more than one moment</span>
        <span class="n">multichannel</span> <span class="o">=</span> <span class="n">emission_line_moments</span><span class="o">.</span><span class="n">nmom</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="c1"># Build the channel names</span>
<span class="c1">#        names = [ &#39;{0}-{1}&#39;.format(n,int(w)) \</span>
<span class="c1">#                        for n,w in zip(emission_line_moments[&#39;ELMBAND&#39;].data[&#39;NAME&#39;],</span>
<span class="c1">#                                       emission_line_moments[&#39;ELMBAND&#39;].data[&#39;RESTWAVE&#39;]) ]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">emission_line_moments</span><span class="o">.</span><span class="n">channel_names</span><span class="p">()</span>
        <span class="c1"># Create the basic header for all extensions</span>
        <span class="n">base_hdr</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">add_channel_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multichannel_maphdr</span> <span class="k">if</span> <span class="n">multichannel</span>
                                                 <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>

        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_SFLUX&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;1E-17 erg/s/cm^2/spaxel&#39;</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_SFLUX&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span>
                                                <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;(1E-17 erg/s/cm^2/spaxel)^{-2}&#39;</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_SFLUX&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span>
                                                <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bit_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">(),</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_SEW&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;ang&#39;</span><span class="p">,</span> <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_SEW&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;(ang)^{-2}&#39;</span><span class="p">,</span> <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_SEW&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span>
                                                <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bit_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">(),</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">)</span>
              <span class="p">]</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the data arrays</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">emission_line_moments</span><span class="p">[</span><span class="s1">&#39;ELMMNTS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_moments</span><span class="o">.</span><span class="n">nmom</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">emission_line_moments</span><span class="p">[</span><span class="s1">&#39;ELMMNTS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;FLUXERR&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">],</span>
                                <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_moments</span><span class="o">.</span><span class="n">nmom</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">emission_line_moments</span><span class="p">[</span><span class="s1">&#39;ELMMNTS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;EW&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_moments</span><span class="o">.</span><span class="n">nmom</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">emission_line_moments</span><span class="p">[</span><span class="s1">&#39;ELMMNTS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;EWERR&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">],</span>
                                <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_moments</span><span class="o">.</span><span class="n">nmom</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">emission_line_moments</span><span class="p">[</span><span class="s1">&#39;ELMMNTS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_moments</span><span class="o">.</span><span class="n">nmom</span><span class="p">)</span> <span class="p">]</span>

        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">-</span><span class="n">emission_line_moments</span><span class="o">.</span><span class="n">nmom</span><span class="p">)</span> \
                        <span class="o">+</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="n">emission_line_moments</span><span class="o">.</span><span class="n">nmom</span><span class="p">:]]</span>

        <span class="c1"># Bin index</span>
        <span class="n">bin_indx</span> <span class="o">=</span> <span class="n">emission_line_moments</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Remap the data to the DRP spatial shape</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">reconstruct_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">bin_indx</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">))</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">emission_line_moments</span><span class="o">.</span><span class="n">nmom</span><span class="o">*</span><span class="n">i</span><span class="p">:</span>
                                 <span class="n">emission_line_moments</span><span class="o">.</span><span class="n">nmom</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> 
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">]</span>
        
        <span class="c1"># Get the mask</span>
        <span class="n">elm_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emission_line_moment_mask_to_map_mask</span><span class="p">(</span><span class="n">emission_line_moments</span><span class="p">,</span>
                                                               <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Organize the extension data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">elm_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">elm_mask</span><span class="p">]</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Return the map hdus</span>
        <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">list_of_image_hdus</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_maps_file.emission_line_model_maps"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file.emission_line_model_maps">[docs]</a>    <span class="k">def</span> <span class="nf">emission_line_model_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prihdr</span><span class="p">,</span> <span class="n">emission_line_model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the &#39;EMLINE_GFLUX&#39;, &#39;EMLINE_GFLUX_IVAR&#39;,</span>
<span class="sd">        &#39;EMLINE_GFLUX_MASK&#39;, &#39;EMLINE_GEW&#39;, &#39;EMLINE_GEW_IVAR&#39;,</span>
<span class="sd">        &#39;EMLINE_GEW_MASK&#39;, &#39;EMLINE_GVEL&#39;, &#39;EMLINE_GVEL_IVAR&#39;,</span>
<span class="sd">        &#39;EMLINE_GVEL_MASK&#39;, &#39;EMLINE_GSIGMA&#39;, &#39;EMLINE_GSIGMA_IVAR&#39;,</span>
<span class="sd">        &#39;EMLINE_GSIGMA_MASK&#39;, &#39;EMLINE_INSTSIGMA&#39;, &#39;EMLINE_TPLSIGMA&#39; map extensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#---------------------------------------------------------------</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;EMLINE_GFLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GFLUX_IVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GFLUX_MASK&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GEW&#39;</span><span class="p">,</span>
                <span class="s1">&#39;EMLINE_GEW_IVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GEW_MASK&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GVEL&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GVEL_IVAR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;EMLINE_GVEL_MASK&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GSIGMA&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GSIGMA_IVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GSIGMA_MASK&#39;</span><span class="p">,</span>
                <span class="s1">&#39;EMLINE_INSTSIGMA&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_TPLSIGMA&#39;</span> <span class="p">]</span>

        <span class="k">if</span> <span class="n">emission_line_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Construct and return the empty hdus</span>
            <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">empty_hdus</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Add data to the primary header</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">_initialize_primary_header</span><span class="p">(</span><span class="n">hdr</span><span class="o">=</span><span class="n">prihdr</span><span class="p">)</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">_add_method_header</span><span class="p">(</span><span class="n">prihdr</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the extension headers</span>

        <span class="c1"># Need multichannel map header if more than one moment</span>
        <span class="n">multichannel</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="c1"># Create the basic header for all extensions</span>
        <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">names</span><span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> \
                        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">],</span>
                                       <span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;RESTWAVE&#39;</span><span class="p">])</span> <span class="p">]</span>
            <span class="n">base_hdr</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">add_channel_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multichannel_maphdr</span> <span class="k">if</span> <span class="n">multichannel</span>
                                                     <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: This should throw a ValueError, not just a warning</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Emission-line model does not include channel names!&#39;</span><span class="p">)</span>
            <span class="n">base_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel_maphdr</span> <span class="k">if</span> <span class="n">multichannel</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span>
       
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GFLUX&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;1E-17 erg/s/cm^2/spaxel&#39;</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GFLUX&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span>
                                                <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;(1E-17 erg/s/cm^2/spaxel)^{-2}&#39;</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GFLUX&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span>
                                                <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bit_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">(),</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GEW&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;ang&#39;</span><span class="p">,</span> <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GEW&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;(ang)^{-2}&#39;</span><span class="p">,</span> <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GEW&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span>
                                                <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bit_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">(),</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GVEL&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;km/s&#39;</span><span class="p">,</span> <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GVEL&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span>
                                                <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;(km/s)^{-2}&#39;</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GVEL&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span>
                                                <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bit_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">(),</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GSIGMA&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;km/s&#39;</span><span class="p">,</span> <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GSIGMA&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span>
                                                <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;(km/s)^{-2}&#39;</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GSIGMA&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span>
                                                <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bit_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">(),</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_INSTSIGMA&#39;</span><span class="p">,</span> <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;km/s&#39;</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE_TPLSIGMA&#39;</span><span class="p">,</span> <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;km/s&#39;</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">)</span>
              <span class="p">]</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the data arrays</span>
        <span class="n">narr</span> <span class="o">=</span> <span class="mi">11</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;EMLDATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;EMLDATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;FLUXERR&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">],</span>
                                <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;EMLDATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;EW&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;EMLDATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;EWERR&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">],</span>
                                <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">redshift_to_Newtonian_velocity</span><span class="p">(</span>
                        <span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;EMLDATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;KIN&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsa_redshift</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">redshift_to_Newtonian_velocity</span><span class="p">(</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;EMLDATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;KINERR&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsa_redshift</span><span class="p">,</span> <span class="n">ivar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;EMLDATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;KIN&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;EMLDATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;KINERR&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                                <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;EMLDATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SIGMAINST&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;EMLDATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SIGMATPL&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;EMLDATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">)</span> <span class="p">]</span>

        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">-</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">)</span> \
                        <span class="o">+</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="p">:]]</span>

<span class="c1">##        t = [ numpy.ma.power(emission_line_model[&#39;EMLDATA&#39;].data[&#39;KINERR&#39;][:,m,1],</span>
<span class="c1">##                                -2).filled(0.0) for m in range(emission_line_model.neml) ]</span>
<span class="c1">#        t = [ emission_line_model[&#39;EMLDATA&#39;].data[&#39;KINERR&#39;][:,m,1]</span>
<span class="c1">#                                 for m in range(emission_line_model.neml) ]</span>
<span class="c1">#        for k,_t in enumerate(t):</span>
<span class="c1">##            print(k, numpy.sum(_t &gt; 1e20))</span>
<span class="c1">#            print(k, numpy.amin(_t))</span>
<span class="c1">#</span>
<span class="c1">##        print(&#39;len(arr): &#39;, len(arr))</span>
<span class="c1">##        print(&#39;not finite arr: &#39;, [numpy.sum(numpy.invert(numpy.isfinite(a))) for a in arr])</span>

        <span class="c1"># Bin index</span>
        <span class="n">bin_indx</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Remap the data to the DRP spatial shape</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">reconstruct_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">bin_indx</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">))</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="o">*</span><span class="n">i</span><span class="p">:</span>
                                 <span class="n">emission_line_model</span><span class="o">.</span><span class="n">neml</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> \
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">narr</span><span class="p">)</span> <span class="p">]</span>

<span class="c1">#        print(len(data))</span>
<span class="c1">#        print(data[7].shape)</span>
<span class="c1">#        print([numpy.sum(numpy.invert(numpy.isfinite(d))) for d in data])</span>

        <span class="c1"># Get the masks</span>
        <span class="n">base_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emission_line_model_mask_to_map_mask</span><span class="p">(</span><span class="n">emission_line_model</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">sig_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emission_line_model_mask_to_map_mask</span><span class="p">(</span><span class="n">emission_line_model</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                                              <span class="n">for_dispersion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Organize the extension data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="n">base_mask</span> <span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="n">base_mask</span> <span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="n">base_mask</span> <span class="p">]</span> \
                <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="n">sig_mask</span> <span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Return the map hdus</span>
        <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">list_of_image_hdus</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_maps_file.spectral_index_maps"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_maps_file.spectral_index_maps">[docs]</a>    <span class="k">def</span> <span class="nf">spectral_index_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prihdr</span><span class="p">,</span> <span class="n">spectral_indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the &#39;SPECINDEX&#39;, &#39;SPECINDEX_IVAR&#39;, &#39;SPECINDEX_MASK&#39;,</span>
<span class="sd">        and &#39;SPECINDEX_CORR&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#---------------------------------------------------------------</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;SPECINDEX&#39;</span><span class="p">,</span> <span class="s1">&#39;SPECINDEX_IVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;SPECINDEX_MASK&#39;</span><span class="p">,</span> <span class="s1">&#39;SPECINDEX_CORR&#39;</span> <span class="p">]</span>

        <span class="k">if</span> <span class="n">spectral_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Construct and return the empty hdus</span>
            <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">empty_hdus</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Add data to the primary header</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">spectral_indices</span><span class="o">.</span><span class="n">_initialize_primary_header</span><span class="p">(</span><span class="n">hdr</span><span class="o">=</span><span class="n">prihdr</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the extension headers</span>

        <span class="c1"># Need multichannel map header if more than one index</span>
        <span class="n">multichannel</span> <span class="o">=</span> <span class="n">spectral_indices</span><span class="o">.</span><span class="n">nindx</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="c1"># Create the basic header for all extensions</span>
        <span class="n">base_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multichannel_maphdr</span> <span class="k">if</span> <span class="n">multichannel</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">singlechannel_maphdr</span>

        <span class="n">errunits</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;(</span><span class="si">{0}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;^{-2}&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">spectral_indices</span><span class="p">[</span><span class="s1">&#39;SIPAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;UNIT&#39;</span><span class="p">]</span> <span class="p">]</span>

        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;SPECINDEX&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">,</span>
                                              <span class="n">channel_names</span><span class="o">=</span><span class="n">spectral_indices</span><span class="p">[</span><span class="s1">&#39;SIPAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">],</span>
                                              <span class="n">channel_units</span><span class="o">=</span><span class="n">spectral_indices</span><span class="p">[</span><span class="s1">&#39;SIPAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;UNIT&#39;</span><span class="p">]),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;SPECINDEX&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">,</span>
                                              <span class="n">channel_names</span><span class="o">=</span><span class="n">spectral_indices</span><span class="p">[</span><span class="s1">&#39;SIPAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">],</span>
                                                <span class="n">channel_units</span><span class="o">=</span><span class="n">errunits</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;SPECINDEX&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">bit_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">(),</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">,</span>
                                              <span class="n">channel_names</span><span class="o">=</span><span class="n">spectral_indices</span><span class="p">[</span><span class="s1">&#39;SIPAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">]),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="n">base_hdr</span><span class="p">,</span> <span class="s1">&#39;SPECINDEX_CORR&#39;</span><span class="p">,</span>
                                                <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">,</span>
                                               <span class="n">channel_names</span><span class="o">=</span><span class="n">spectral_indices</span><span class="p">[</span><span class="s1">&#39;SIPAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">])</span>
              <span class="p">]</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the data arrays</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">spectral_indices</span><span class="p">[</span><span class="s1">&#39;SINDX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;INDX&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spectral_indices</span><span class="o">.</span><span class="n">nindx</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">spectral_indices</span><span class="p">[</span><span class="s1">&#39;SINDX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;INDXERR&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">],</span> <span class="o">-</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spectral_indices</span><span class="o">.</span><span class="n">nindx</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">spectral_indices</span><span class="p">[</span><span class="s1">&#39;SINDX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spectral_indices</span><span class="o">.</span><span class="n">nindx</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">spectral_indices</span><span class="p">[</span><span class="s1">&#39;SINDX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;INDX_DISPCORR&#39;</span><span class="p">][:,</span><span class="n">m</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spectral_indices</span><span class="o">.</span><span class="n">nindx</span><span class="p">)</span> <span class="p">]</span>

        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">spectral_indices</span><span class="o">.</span><span class="n">nindx</span><span class="p">)</span> \
                        <span class="o">+</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> 
                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">spectral_indices</span><span class="o">.</span><span class="n">nindx</span><span class="p">:</span><span class="o">-</span><span class="n">spectral_indices</span><span class="o">.</span><span class="n">nindx</span><span class="p">]]</span> \
                        <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">]</span><span class="o">*</span><span class="n">spectral_indices</span><span class="o">.</span><span class="n">nindx</span>

        <span class="c1"># Bin index</span>
        <span class="n">bin_indx</span> <span class="o">=</span> <span class="n">spectral_indices</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Remap the data to the DRP spatial shape</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">reconstruct_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">bin_indx</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">))</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">spectral_indices</span><span class="o">.</span><span class="n">nindx</span><span class="o">*</span><span class="n">i</span><span class="p">:</span>
                                 <span class="n">spectral_indices</span><span class="o">.</span><span class="n">nindx</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> \
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">]</span>
        
        <span class="c1"># Get the mask</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spectral_index_mask_to_map_mask</span><span class="p">(</span><span class="n">spectral_indices</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Return the map hdus</span>
        <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">list_of_image_hdus</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span></div></div>




    

<span class="c1">#-----------------------------------------------------------------------</span>
<div class="viewcode-block" id="construct_cube_file"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_cube_file">[docs]</a><span class="k">class</span> <span class="nc">construct_cube_file</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a DAP cube file based on the input data.</span>

<span class="sd">    Set as a class for coherency reasons, but should not be used as an</span>
<span class="sd">    object!</span>

<span class="sd">    Should force all intermediate objects to be provided.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drpf</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">emission_line_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">directory_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">loggers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">single_precision</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Initialize the reporting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loggers</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">loggers</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">loggers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span> <span class="k">if</span> <span class="n">single_precision</span> <span class="k">else</span> <span class="s1">&#39;float&#39;</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Check input types</span>
        <span class="n">confirm_dap_types</span><span class="p">(</span><span class="n">drpf</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">emission_line_model</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Set the output paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drpf</span> <span class="o">=</span> <span class="n">drpf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_paths</span><span class="p">(</span><span class="n">directory_path</span><span class="p">,</span> <span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span>
                        <span class="n">stellar_continuum</span><span class="p">)</span>

        <span class="c1"># Save input for reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">spatial_shape</span>
<span class="c1">#        self.cube_arrays = None</span>
<span class="c1">#        self._assign_cube_arrays()</span>

        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0:^50}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;CONSTRUCTING OUTPUT MODEL CUBE&#39;</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Output path: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Output file: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Output cubes have shape </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Check if the file already exists</span>
        <span class="n">ofile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="c1"># TODO: Perform some checks to make sure the existing file</span>
            <span class="c1"># has the correct content?</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Output file exists!  Set clobber=True to overwrite.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Construct the 3D data arrays</span>
        <span class="n">binned_spectra_3d_hdu</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">binned_spectra</span> <span class="ow">is</span> <span class="kc">None</span> \
                                        <span class="k">else</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">construct_3d_hdu</span><span class="p">()</span>
        <span class="n">stellar_continuum_3d_hdu</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">stellar_continuum</span> <span class="ow">is</span> <span class="kc">None</span> \
                                        <span class="k">else</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">construct_3d_hdu</span><span class="p">()</span>
        <span class="n">emission_line_model_3d_hdu</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">emission_line_model</span> <span class="ow">is</span> <span class="kc">None</span> \
                                        <span class="k">else</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">construct_3d_hdu</span><span class="p">()</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Initialize the primary header</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">initialize_dap_primary_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span> <span class="n">maskname</span><span class="o">=</span><span class="s1">&#39;MANGA_DAPSPECMASK&#39;</span><span class="p">)</span>
        <span class="c1"># Add the DAP method</span>
        <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;DAPTYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">default_dap_method</span><span class="p">(</span><span class="n">binned_spectra</span><span class="o">=</span><span class="n">binned_spectra</span><span class="p">,</span>
                                                <span class="n">stellar_continuum</span><span class="o">=</span><span class="n">stellar_continuum</span><span class="p">),</span>
                             <span class="s1">&#39;DAP analysis method&#39;</span><span class="p">)</span>
        <span class="c1"># Add the format of this file</span>
        <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;DAPFRMT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;LOGCUBE&#39;</span><span class="p">,</span> <span class="s1">&#39;DAP data file format&#39;</span><span class="p">)</span>

        <span class="c1"># Get the base map header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_cubehdr</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">build_cube_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span>
                                <span class="s1">&#39;K Westfall &amp; B Andrews &lt;westfall@ucolick.org, andrewsb@pitt.edu&gt;&#39;</span><span class="p">,</span>
                                                        <span class="n">maskname</span><span class="o">=</span><span class="s1">&#39;MANGA_DAPSPECMASK&#39;</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Initialize the pixel mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">DAPCubeBitMask</span><span class="p">(</span><span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bin_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_mask</span><span class="p">(</span><span class="n">binned_spectra</span><span class="p">,</span> <span class="n">binned_spectra_3d_hdu</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Construct the hdu list for each input object.</span>
        <span class="c1"># Binned spectra: [&#39;FLUX&#39;, &#39;IVAR&#39;, &#39;WAVE&#39;, &#39;REDCORR&#39;]</span>
        <span class="n">prihdr</span><span class="p">,</span> <span class="n">binlist</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_data_cube</span><span class="p">(</span><span class="n">prihdr</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">binned_spectra_3d_hdu</span><span class="p">)</span>

        <span class="c1"># Model spectra: [ &#39;MODEL&#39;, &#39;EMLINE&#39;, &#39;EMLINE_BASE&#39;,</span>
        <span class="c1"># &#39;EMLINE_MASK&#39;]</span>
        <span class="n">prihdr</span><span class="p">,</span> <span class="n">modlist</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_cubes</span><span class="p">(</span><span class="n">prihdr</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="p">,</span>
                                                 <span class="n">stellar_continuum_3d_hdu</span><span class="p">,</span> <span class="n">emission_line_model</span><span class="p">,</span>
                                                 <span class="n">emission_line_model_3d_hdu</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

        <span class="c1"># Finalize the (stellar-continuum) mask</span>
        <span class="n">masklist</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">list_of_image_hdus</span><span class="p">([</span><span class="n">mask</span><span class="p">],</span>
                        <span class="p">[</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_cubehdr</span><span class="p">,</span> <span class="s1">&#39;FLUX&#39;</span><span class="p">,</span>
                                                          <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                          <span class="n">bit_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">(),</span>
                                                          <span class="n">prepend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">],</span> <span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">])</span>

        <span class="c1"># Get the BINIDs</span>
        <span class="n">binidlist</span> <span class="o">=</span> <span class="n">combine_binid_extensions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">emission_line_model</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Save the data to the hdu attribute</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">finalize_dap_primary_header</span><span class="p">(</span><span class="n">prihdr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span>
                                             <span class="n">stellar_continuum</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">,</span>
                                             <span class="n">loggers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span>

        <span class="c1"># Ensure extensions are in the correct order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">prihdr</span><span class="p">),</span>
                                  <span class="o">*</span><span class="p">(</span><span class="n">binlist</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span>
                                  <span class="o">*</span><span class="n">masklist</span><span class="p">,</span>
                                  <span class="o">*</span><span class="p">(</span><span class="n">binlist</span><span class="p">[</span><span class="mi">2</span><span class="p">:]),</span>
                                  <span class="o">*</span><span class="n">modlist</span><span class="p">,</span>
                                  <span class="o">*</span><span class="n">binidlist</span>
                                <span class="p">])</span>
        <span class="c1">#---------------------------------------------------------------</span>

        <span class="c1"># Check that the path exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">)</span>
        <span class="c1"># Write the model cube file</span>
        <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">loggers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span>
                          <span class="n">quiet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span>
        <span class="c1"># End</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>


<div class="viewcode-block" id="construct_cube_file._set_paths"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_cube_file._set_paths">[docs]</a>    <span class="k">def</span> <span class="nf">_set_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory_path</span><span class="p">,</span> <span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span>
                   <span class="n">stellar_continuum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the paths relevant to the map file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The output method directory is, for now, the combination of</span>
        <span class="c1"># the binned_spectrum and stellar_continuum method keys</span>
        <span class="k">if</span> <span class="n">directory_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">binned_spectra</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">stellar_continuum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not define output directory path.&#39;</span><span class="p">)</span>

        <span class="c1"># Set the output directory path</span>
        <span class="c1"># TODO: Get DAP version from __version__ string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">default_dap_method</span><span class="p">(</span><span class="n">binned_spectra</span><span class="o">=</span><span class="n">binned_spectra</span><span class="p">,</span>
                                         <span class="n">stellar_continuum</span><span class="o">=</span><span class="n">stellar_continuum</span><span class="p">)</span> \
                                <span class="k">if</span> <span class="n">directory_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span> <span class="o">=</span> <span class="n">default_dap_method_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">plate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span>
                                                      <span class="n">ifudesign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span>
                                                      <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="n">dapver</span><span class="p">,</span>
                                                      <span class="n">analysis_path</span><span class="o">=</span><span class="n">analysis_path</span><span class="p">)</span> \
                                                <span class="k">if</span> <span class="n">directory_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)</span>

        <span class="c1"># Set the output file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">default_dap_file_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;LOGCUBE&#39;</span><span class="p">)</span> \
                                    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_cube_file._initialize_mask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_cube_file._initialize_mask">[docs]</a>    <span class="k">def</span> <span class="nf">_initialize_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">binned_spectra_3d_hdu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the mask based on the DRP cube mask.</span>

<span class="sd">        Set IVARINVALID by testing for invalid inverse variance data.</span>
<span class="sd">        THIS SHOULD BE A TEST THAT IS INCLUDED IN THE BINNED_SPECTRA</span>
<span class="sd">        OBJECT.  This should match the flags from the stellar continuum</span>
<span class="sd">        model object.</span>

<span class="sd">        Copy the FORESTAR flags from the DRP file to the this one</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">binned_spectra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mask</span>

        <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">binned_spectra_3d_hdu</span><span class="p">[</span><span class="s1">&#39;IVAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> \
                    <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">binned_spectra_3d_hdu</span><span class="p">[</span><span class="s1">&#39;IVAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;IVARINVALID&#39;</span><span class="p">)</span>

        <span class="n">indx</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">binned_spectra_3d_hdu</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;FORESTAR&#39;</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;FORESTAR&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mask</span></div>


<span class="c1">#    def _assign_cube_arrays(self):</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        Set :attr:`cube_arrays`, which contains the list of extensions in</span>
<span class="c1">#        :attr:`hdu` that contain spectral data.</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        self.cube_arrays = [ &#39;FLUX&#39;, &#39;IVAR&#39;, &#39;MASK&#39;, &#39;MODEL&#39;, &#39;EMLINE&#39;, &#39;EMLINE_BASE&#39;,</span>
<span class="c1">#                             &#39;EMLINE_MASK&#39;, &#39;BINID&#39; ]</span>


<div class="viewcode-block" id="construct_cube_file._get_data_mask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_cube_file._get_data_mask">[docs]</a>    <span class="k">def</span> <span class="nf">_get_data_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">binned_spectra_3d_hdu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For the binned spectra:</span>
<span class="sd">            - consolidate DIDNOTUSE, LOW_SPECCOV, LOW_SNR from</span>
<span class="sd">              binned_spectra into IGNORED</span>
<span class="sd">            - consolidate NONE_IN_STACK from binned_spectra into</span>
<span class="sd">              FLUXINVALID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Copy the base-level mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Draw from binned_spectra</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;DIDNOTUSE&#39;</span><span class="p">,</span> <span class="s1">&#39;LOW_SPECCOV&#39;</span><span class="p">,</span> <span class="s1">&#39;LOW_SNR&#39;</span> <span class="p">]</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">binned_spectra_3d_hdu</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;IGNORED&#39;</span><span class="p">)</span>

        <span class="n">indx</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">binned_spectra_3d_hdu</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                              <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;NONE_IN_STACK&#39;</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;FLUXINVALID&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="construct_cube_file._get_stellar_continuum_mask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_cube_file._get_stellar_continuum_mask">[docs]</a>    <span class="k">def</span> <span class="nf">_get_stellar_continuum_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="p">,</span> <span class="n">stellar_continuum_3d_hdu</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For the stellar continuum models:</span>
<span class="sd">            - copy INVALID_ERROR into IVARINVALID</span>
<span class="sd">            - copy ARTIFACTs</span>
<span class="sd">            - consolidate DIDNOTUSE, LOW_SNR, OUTSIDE_RANGE, EML_REGION, TPL_PIXELS, TRUNCATED,</span>
<span class="sd">              PPXF_REJECT, INVALID_ERROR, ARTIFACT into FITIGNORED</span>
<span class="sd">            - consolidate FIT_FAILED and NEAR_BOUND into FITFAILED</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Copy the base-level mask</span>
        <span class="n">_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Flag invalid errors and artifacts</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">stellar_continuum_3d_hdu</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                 <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;INVALID_ERROR&#39;</span><span class="p">)</span>
        <span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;IVARINVALID&#39;</span><span class="p">)</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">stellar_continuum_3d_hdu</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                 <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;ARTIFACT&#39;</span><span class="p">)</span>
        <span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;ARTIFACT&#39;</span><span class="p">)</span>

        <span class="c1"># Set which pixel were ignored in the fit</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;DIDNOTUSE&#39;</span><span class="p">,</span> <span class="s1">&#39;LOW_SNR&#39;</span><span class="p">,</span> <span class="s1">&#39;OUTSIDE_RANGE&#39;</span><span class="p">,</span> <span class="s1">&#39;EML_REGION&#39;</span><span class="p">,</span> <span class="s1">&#39;TPL_PIXELS&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;TRUNCATED&#39;</span><span class="p">,</span> <span class="s1">&#39;PPXF_REJECT&#39;</span><span class="p">,</span> <span class="s1">&#39;INVALID_ERROR&#39;</span><span class="p">,</span> <span class="s1">&#39;ARTIFACT&#39;</span> <span class="p">]</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">stellar_continuum_3d_hdu</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span>
        <span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;FITIGNORED&#39;</span><span class="p">)</span>

        <span class="c1"># Set which pixels failed during the fit</span>
        <span class="c1"># TODO: What do I do with BAD_SIGMA?</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">stellar_continuum_3d_hdu</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                 <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FIT_FAILED&#39;</span><span class="p">,</span> <span class="s1">&#39;NEAR_BOUND&#39;</span><span class="p">])</span>
        <span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;FITFAILED&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_no_model_mask</span><span class="p">(</span><span class="n">_mask</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_cube_file._get_emission_line_model_mask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_cube_file._get_emission_line_model_mask">[docs]</a>    <span class="k">def</span> <span class="nf">_get_emission_line_model_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emission_line_model</span><span class="p">,</span> <span class="n">emission_line_model_3d_hdu</span><span class="p">,</span>
                                      <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For the emission-line models:</span>
<span class="sd">            - copy INVALID_ERROR into IVARINVALID</span>
<span class="sd">            - copy ARTIFACTs</span>
<span class="sd">            - consolidate DIDNOTUSE, LOW_SNR, OUTSIDE_RANGE, EML_REGION, TPL_PIXELS, TRUNCATED,</span>
<span class="sd">              PPXF_REJECT, INVALID_ERROR, ARTIFACT into ELIGNORED</span>
<span class="sd">            - consolidate FIT_FAILED and NEAR_BOUND into ELFAILED</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Copy the base-level mask</span>
        <span class="n">_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Flag invalid errors and artifacts</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">emission_line_model_3d_hdu</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                   <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;INVALID_ERROR&#39;</span><span class="p">)</span>
        <span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;IVARINVALID&#39;</span><span class="p">)</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">emission_line_model_3d_hdu</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                   <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;ARTIFACT&#39;</span><span class="p">)</span>
        <span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;ARTIFACT&#39;</span><span class="p">)</span>

        <span class="c1"># Set which pixel were ignored in the fit</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;DIDNOTUSE&#39;</span><span class="p">,</span> <span class="s1">&#39;LOW_SNR&#39;</span><span class="p">,</span> <span class="s1">&#39;OUTSIDE_RANGE&#39;</span><span class="p">,</span> <span class="s1">&#39;TPL_PIXELS&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;TRUNCATED&#39;</span><span class="p">,</span> <span class="s1">&#39;PPXF_REJECT&#39;</span><span class="p">,</span> <span class="s1">&#39;INVALID_ERROR&#39;</span><span class="p">,</span> <span class="s1">&#39;ARTIFACT&#39;</span> <span class="p">]</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">emission_line_model_3d_hdu</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                   <span class="n">flag</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span>
        <span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;ELIGNORED&#39;</span><span class="p">)</span>

        <span class="c1"># Set which pixels failed during the fit</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">emission_line_model_3d_hdu</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                   <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FIT_FAILED&#39;</span><span class="p">,</span> <span class="s1">&#39;NEAR_BOUND&#39;</span><span class="p">])</span>
        <span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;ELFAILED&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_no_model_mask</span><span class="p">(</span><span class="n">_mask</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_cube_file.binned_data_cube"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_cube_file.binned_data_cube">[docs]</a>    <span class="k">def</span> <span class="nf">binned_data_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prihdr</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">binned_spectra_3d_hdu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the &#39;FLUX&#39;, &#39;IVAR&#39;, &#39;WAVE&#39;, and &#39;REDCORR&#39; model cube</span>
<span class="sd">        extensions, and begins the construction of the &#39;MASK&#39;.</span>

<span class="sd">        Returns the primary header, a list of ImageHDUs, and the mask</span>
<span class="sd">        array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#---------------------------------------------------------------</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;IVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;WAVE&#39;</span><span class="p">,</span> <span class="s1">&#39;REDCORR&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">binned_spectra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Construct and return the empty hdus</span>
            <span class="k">return</span> <span class="n">prihdr</span><span class="p">,</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">empty_hdus</span><span class="p">(</span><span class="n">ext</span><span class="p">),</span> <span class="kc">None</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Add data to the primary header</span>
        <span class="c1"># TODO: Just copy header from maps file?</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">rdxqa</span><span class="o">.</span><span class="n">_initialize_primary_header</span><span class="p">(</span><span class="n">hdr</span><span class="o">=</span><span class="n">prihdr</span><span class="p">)</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">_initialize_primary_header</span><span class="p">(</span><span class="n">hdr</span><span class="o">=</span><span class="n">prihdr</span><span class="p">)</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">_add_method_header</span><span class="p">(</span><span class="n">prihdr</span><span class="p">)</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">_add_reddening_header</span><span class="p">(</span><span class="n">prihdr</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the extension headers; The WAVE and REDCORR extensions</span>
        <span class="c1"># have no header.</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_cubehdr</span><span class="p">,</span> <span class="s1">&#39;FLUX&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;1E-17 erg/s/cm^2/ang/spaxel&#39;</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_cubehdr</span><span class="p">,</span> <span class="s1">&#39;FLUX&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;(1E-17 erg/s/cm^2/ang/spaxel)^{-2}&#39;</span><span class="p">,</span>
                                                <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span>
              <span class="p">]</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the data arrays</span>
        <span class="c1"># Reddened flux data</span>
        <span class="n">flux</span><span class="p">,</span> <span class="n">ivar</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">galext</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">binned_spectra_3d_hdu</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                 <span class="n">deredden</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                 <span class="n">ivar</span><span class="o">=</span><span class="n">binned_spectra_3d_hdu</span><span class="p">[</span><span class="s1">&#39;IVAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Return the primary header, the list of ImageHDUs, and the mask</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="n">flux</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span> <span class="n">ivar</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;WAVE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;REDCORR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">prihdr</span><span class="p">,</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">list_of_image_hdus</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ext</span><span class="p">),</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_mask</span><span class="p">(</span><span class="n">binned_spectra</span><span class="p">,</span> <span class="n">binned_spectra_3d_hdu</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_cube_file.model_cubes"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_cube_file.model_cubes">[docs]</a>    <span class="k">def</span> <span class="nf">model_cubes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prihdr</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="p">,</span> <span class="n">stellar_continuum_3d_hdu</span><span class="p">,</span>
                    <span class="n">emission_line_model</span><span class="p">,</span> <span class="n">emission_line_model_3d_hdu</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the &#39;MODEL&#39;, &#39;EMLINE&#39;, &#39;EMLINE_BASE&#39;, and</span>
<span class="sd">        &#39;EMLINE_MASK&#39; model cube extensions, adds the model information</span>
<span class="sd">        to the header, and construct the stellar-continuum mask.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#---------------------------------------------------------------</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MODEL&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_BASE&#39;</span><span class="p">,</span> <span class="s1">&#39;EMLINE_MASK&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">binned_spectra</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">stellar_continuum</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">emission_line_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Construct and return empty hdus</span>
            <span class="k">return</span> <span class="n">prihdr</span><span class="p">,</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">empty_hdus</span><span class="p">(</span><span class="n">ext</span><span class="p">),</span> <span class="n">mask</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Add the model data to the primary header</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">_initialize_primary_header</span><span class="p">(</span><span class="n">hdr</span><span class="o">=</span><span class="n">prihdr</span><span class="p">)</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">_add_method_header</span><span class="p">(</span><span class="n">prihdr</span><span class="p">)</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">_initialize_primary_header</span><span class="p">(</span><span class="n">hdr</span><span class="o">=</span><span class="n">prihdr</span><span class="p">)</span>
        <span class="n">prihdr</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">_add_method_header</span><span class="p">(</span><span class="n">prihdr</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the extension headers</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_cubehdr</span><span class="p">,</span> <span class="s1">&#39;MODEL&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;1E-17 erg/s/cm^2/ang/spaxel&#39;</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">prepend</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_cubehdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;1E-17 erg/s/cm^2/ang/spaxel&#39;</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_cubehdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE&#39;</span><span class="p">,</span>
                                                <span class="n">bunit</span><span class="o">=</span><span class="s1">&#39;1E-17 erg/s/cm^2/ang/spaxel&#39;</span><span class="p">,</span> <span class="n">qual</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_cubehdr</span><span class="p">,</span> <span class="s1">&#39;EMLINE&#39;</span><span class="p">,</span> <span class="n">hduclas2</span><span class="o">=</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span>
                                                 <span class="n">bit_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">())</span>
              <span class="p">]</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the data arrays</span>
        <span class="c1"># Best-fitting composite model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">stellar_continuum_3d_hdu</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">emission_line_model_3d_hdu</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> \
                    <span class="o">+</span> <span class="n">emission_line_model_3d_hdu</span><span class="p">[</span><span class="s1">&#39;BASE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="c1"># with reddening</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">galext</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">deredden</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">galext</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">emission_line_model_3d_hdu</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">deredden</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">galext</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">emission_line_model_3d_hdu</span><span class="p">[</span><span class="s1">&#39;BASE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">deredden</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Stellar continuum mask</span>
        <span class="n">scmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stellar_continuum_mask</span><span class="p">(</span><span class="n">stellar_continuum</span><span class="p">,</span> <span class="n">stellar_continuum_3d_hdu</span><span class="p">,</span>
                                                  <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="c1"># Emission-line Mask</span>
        <span class="n">elmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_emission_line_model_mask</span><span class="p">(</span><span class="n">emission_line_model</span><span class="p">,</span>
                                                    <span class="n">emission_line_model_3d_hdu</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span> <span class="n">line</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                <span class="n">base</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span> <span class="n">elmask</span><span class="p">]</span>

        <span class="c1"># Return the primary header and the list of HDUs</span>
        <span class="k">return</span> <span class="n">prihdr</span><span class="p">,</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">list_of_image_hdus</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ext</span><span class="p">),</span> <span class="n">scmask</span></div>


<div class="viewcode-block" id="construct_cube_file._set_no_model"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_cube_file._set_no_model">[docs]</a>    <span class="k">def</span> <span class="nf">_set_no_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">))[</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mask</span>
        <span class="n">mask</span><span class="p">[:</span><span class="n">indx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[:</span><span class="n">indx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;NOMODEL&#39;</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:],</span> <span class="s1">&#39;NOMODEL&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="construct_cube_file._include_no_model_mask"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.construct_cube_file._include_no_model_mask">[docs]</a>    <span class="k">def</span> <span class="nf">_include_no_model_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign the NOMODEL bit to spectral regions outside of the fitted</span>
<span class="sd">        spectral range.</span>

<span class="sd">        Modeled off of StellarContiuumModel.reset_continuum_mask_window.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># No pixels are masked!</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mask</span>

        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_no_model</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span></div></div>


<span class="c1">#-----------------------------------------------------------------------</span>
<div class="viewcode-block" id="combine_binid_extensions"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.combine_binid_extensions">[docs]</a><span class="k">def</span> <span class="nf">combine_binid_extensions</span><span class="p">(</span><span class="n">drpf</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="p">,</span> <span class="n">emission_line_moments</span><span class="p">,</span>
                             <span class="n">emission_line_model</span><span class="p">,</span> <span class="n">spectral_indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine the bin IDs from the different analysis steps into a single</span>
<span class="sd">    multichannel extension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">drpf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;DRP file must be provided.&#39;</span><span class="p">)</span>

    <span class="n">hdr</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">finalize_dap_header</span><span class="p">(</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">build_map_header</span><span class="p">(</span><span class="n">drpf</span><span class="p">,</span>
                                <span class="s1">&#39;K Westfall &amp; B Andrews &lt;westfall@ucolick.org, andrewsb@pitt.edu&gt;&#39;</span><span class="p">,</span>
                                                    <span class="n">multichannel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maskname</span><span class="o">=</span><span class="s1">&#39;MANGA_DAPPIXMASK&#39;</span><span class="p">),</span>
                                          <span class="s1">&#39;BINID&#39;</span><span class="p">,</span> <span class="n">multichannel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">channel_names</span><span class="o">=</span><span class="p">[</span> <span class="s1">&#39;Binned spectra&#39;</span><span class="p">,</span> <span class="s1">&#39;Stellar continua&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;Em. line moments&#39;</span><span class="p">,</span> <span class="s1">&#39;Em. line models&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;Spectral indices&#39;</span> <span class="p">])</span>

    <span class="c1"># Build the ID data for each analysis product</span>
    <span class="n">binid</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">drpf</span><span class="o">.</span><span class="n">spatial_shape</span><span class="o">+</span><span class="p">(</span><span class="mi">5</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">binned_spectra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">binid</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">if</span> <span class="n">stellar_continuum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">binid</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">if</span> <span class="n">emission_line_moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">binid</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">emission_line_moments</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">if</span> <span class="n">emission_line_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">binid</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">emission_line_model</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">if</span> <span class="n">spectral_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">binid</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectral_indices</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="n">_dtype</span> <span class="o">=</span> <span class="s1">&#39;int&#39;</span> <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dtype</span>

    <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">list_of_image_hdus</span><span class="p">([</span> <span class="n">binid</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">)</span> <span class="p">],</span> <span class="p">[</span> <span class="n">hdr</span> <span class="p">],</span> <span class="p">[</span> <span class="s1">&#39;BINID&#39;</span> <span class="p">])</span></div>


<div class="viewcode-block" id="confirm_dap_types"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.confirm_dap_types">[docs]</a><span class="k">def</span> <span class="nf">confirm_dap_types</span><span class="p">(</span><span class="n">drpf</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">rdxqa</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="p">,</span> <span class="n">emission_line_moments</span><span class="p">,</span>
                      <span class="n">emission_line_model</span><span class="p">,</span> <span class="n">spectral_indices</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drpf</span><span class="p">,</span> <span class="n">DRPFits</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input must have type DRPFits.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">ObsInputPar</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input must have type ObsInputPar.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rdxqa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rdxqa</span><span class="p">,</span> <span class="n">ReductionAssessment</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input must have type ReductionAssessment.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">binned_spectra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binned_spectra</span><span class="p">,</span> <span class="n">SpatiallyBinnedSpectra</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input must have type SpatiallyBinnedSpectra.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stellar_continuum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stellar_continuum</span><span class="p">,</span>
                                                        <span class="n">StellarContinuumModel</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input must have type StellarContinuumModel.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">emission_line_moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emission_line_moments</span><span class="p">,</span>
                                                            <span class="n">EmissionLineMoments</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input must have type EmissionLineMoments.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">emission_line_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emission_line_model</span><span class="p">,</span>
                                                          <span class="n">EmissionLineModel</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input must have type EmissionLineModel.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spectral_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectral_indices</span><span class="p">,</span> <span class="n">SpectralIndices</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input must have type SpectralIndices.&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="finalize_dap_primary_header"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.finalize_dap_primary_header">[docs]</a><span class="k">def</span> <span class="nf">finalize_dap_primary_header</span><span class="p">(</span><span class="n">prihdr</span><span class="p">,</span> <span class="n">drpf</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">loggers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="c1"># Initialize the DAP quality flag</span>
    <span class="n">dapqualbm</span> <span class="o">=</span> <span class="n">DAPQualityBitMask</span><span class="p">(</span><span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>
    <span class="n">drp3qualbm</span> <span class="o">=</span> <span class="n">DRPQuality3DBitMask</span><span class="p">()</span>
    <span class="n">dapqual</span> <span class="o">=</span> <span class="n">dapqualbm</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">()(</span><span class="mi">0</span><span class="p">)</span>          <span class="c1"># Type casting original flag to 0</span>
    <span class="k">if</span> <span class="n">drp3qualbm</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">drpf</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DRP3QUAL&#39;</span><span class="p">],</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;CRITICAL&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;DRP File is flagged CRITICAL!&#39;</span><span class="p">)</span>
        <span class="n">dapqual</span> <span class="o">=</span> <span class="n">dapqualbm</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">dapqual</span><span class="p">,</span> <span class="s1">&#39;CRITICAL&#39;</span><span class="p">)</span>
        <span class="n">dapqual</span> <span class="o">=</span> <span class="n">dapqualbm</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">dapqual</span><span class="p">,</span> <span class="s1">&#39;DRPCRIT&#39;</span><span class="p">)</span>

    <span class="c1"># Flag the file as CRITICAL if the stellar continuum fits are bad</span>
    <span class="c1"># for all spectra</span>
    <span class="k">if</span> <span class="n">stellar_continuum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">stellar_continuum</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">],</span>
                                                 <span class="p">[</span><span class="s1">&#39;NO_FIT&#39;</span><span class="p">,</span> <span class="s1">&#39;FIT_FAILED&#39;</span><span class="p">,</span> <span class="s1">&#39;INSUFFICIENT_DATA&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;NEAR_BOUND&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">dapqual</span> <span class="o">=</span> <span class="n">dapqualbm</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">dapqual</span><span class="p">,</span> <span class="s1">&#39;CRITICAL&#39;</span><span class="p">)</span>

    <span class="c1"># Signify that the Voronoi binning resulted in a single bin</span>
    <span class="k">if</span> <span class="n">binned_spectra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;binclass&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
            <span class="ow">and</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;binclass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bintype</span> <span class="o">==</span> <span class="s1">&#39;voronoi&#39;</span> \
            <span class="ow">and</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">nbins</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dapqual</span> <span class="o">=</span> <span class="n">dapqualbm</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">dapqual</span><span class="p">,</span> <span class="s1">&#39;SINGLEBIN&#39;</span><span class="p">)</span>

    <span class="c1"># Input photometric geometry and scale were invalid</span>
    <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">valid_ell</span> <span class="ow">and</span> <span class="n">obs</span><span class="o">.</span><span class="n">valid_pa</span> <span class="ow">and</span> <span class="n">obs</span><span class="o">.</span><span class="n">valid_reff</span><span class="p">):</span>
        <span class="n">dapqual</span> <span class="o">=</span> <span class="n">dapqualbm</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">dapqual</span><span class="p">,</span> <span class="s1">&#39;BADGEOM&#39;</span><span class="p">)</span>

    <span class="c1"># Determine if there&#39;s a foreground star</span>
    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">drpf</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">drpf</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;FORESTAR&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dapqual</span> <span class="o">=</span> <span class="n">dapqualbm</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">dapqual</span><span class="p">,</span> <span class="s1">&#39;FORESTAR&#39;</span><span class="p">)</span>

    <span class="c1"># Commit the quality flag to the header</span>
    <span class="k">if</span> <span class="n">dapqualbm</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">dapqual</span><span class="p">,</span> <span class="s1">&#39;CRITICAL&#39;</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;DAP files are flagged CRITICAL.&#39;</span><span class="p">)</span>
    <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;DAPQUAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dapqual</span><span class="p">,</span> <span class="s1">&#39;DAP quality bitmask&#39;</span><span class="p">)</span>

    <span class="c1"># Finalize authors</span>
    <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;AUTHOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;K Westfall, B Andrews &lt;westfall@ucolick.org, andrewsb@pitt.edu&gt;&#39;</span>

    <span class="k">return</span> <span class="n">prihdr</span></div>


<div class="viewcode-block" id="add_snr_metrics_to_header"><a class="viewcode-back" href="../../mangadap.dapfits.html#mangadap.dapfits.add_snr_metrics_to_header">[docs]</a><span class="k">def</span> <span class="nf">add_snr_metrics_to_header</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">drpf</span><span class="p">,</span> <span class="n">r_re</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For all valid spaxels within 1 Re &lt; R &lt; 1.5 Re calculate the median</span>
<span class="sd">    S/N and combined S/N (including covariance) in the griz bands.</span>

<span class="sd">    Adds the following keywords (8) to the header:</span>
<span class="sd">        - SNR?MED: Median S/N within 1-1.5 Re in each of the griz bands.</span>
<span class="sd">        - SNR?RING: The combined S/N of all spaxels within 1-1.5 Re in</span>
<span class="sd">          the griz bands, incuding covariance</span>

<span class="sd">    The inclusion of covariance is based on the exact calculation of the</span>
<span class="sd">    correlation matrix at the flux-weighted center of each band, and</span>
<span class="sd">    assuming no change in the correlation between the response-weighted</span>
<span class="sd">    correlation within the broad band.</span>

<span class="sd">    Args:</span>
<span class="sd">        hdr (`astropy.io.fits.Header`_): Header object to edit</span>
<span class="sd">        drpf (:class:`mangadap.drpfits.DRPFits`): DRP fits cube</span>
<span class="sd">        r_re (numpy.ndarray): *Flattened* array with the semi-major axis</span>
<span class="sd">            radius in units of the effective radius for all spaxels in</span>
<span class="sd">            the datacube.  Shape should be (Nx*Ny,), where the shape of</span>
<span class="sd">            the datacube is (Nx,Ny,Nwave).</span>

<span class="sd">    Returns:</span>
<span class="sd">        `astropy.io.fits.Header`_: The edited header object.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: Raised if any of the response function files</span>
<span class="sd">            cannot be found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_dapsrc</span> <span class="o">=</span> <span class="n">dap_source_dir</span><span class="p">()</span> <span class="k">if</span> <span class="n">dapsrc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">)</span>
    <span class="n">filter_response_file</span> <span class="o">=</span> <span class="p">[</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_dapsrc</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;filter_response&#39;</span><span class="p">,</span>
                                           <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;gunn_2001_g_response.db&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;gunn_2001_r_response.db&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;gunn_2001_i_response.db&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;gunn_2001_z_response.db&#39;</span><span class="p">]</span> <span class="p">]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filter_response_file</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> does not exist!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

    <span class="c1"># Set the header keywords</span>
    <span class="n">key_med</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SNRGMED&#39;</span><span class="p">,</span> <span class="s1">&#39;SNRRMED&#39;</span><span class="p">,</span> <span class="s1">&#39;SNRIMED&#39;</span><span class="p">,</span> <span class="s1">&#39;SNRZMED&#39;</span> <span class="p">]</span>
    <span class="n">com_med</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Median g-band SNR from 1-1.5 Re&#39;</span><span class="p">,</span> <span class="s1">&#39;Median r-band SNR from 1-1.5 Re&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Median i-band SNR from 1-1.5 Re&#39;</span><span class="p">,</span> <span class="s1">&#39;Median z-band SNR from 1-1.5 Re&#39;</span> <span class="p">]</span>
                    
    <span class="n">key_ring</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SNRGRING&#39;</span><span class="p">,</span> <span class="s1">&#39;SNRRRING&#39;</span><span class="p">,</span> <span class="s1">&#39;SNRIRING&#39;</span><span class="p">,</span> <span class="s1">&#39;SNRZRING&#39;</span> <span class="p">]</span>
    <span class="n">com_ring</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;g-band SNR in 1-1.5 Re bin&#39;</span><span class="p">,</span> <span class="s1">&#39;r-band SNR in 1-1.5 Re bin&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;i-band SNR in 1-1.5 Re bin&#39;</span><span class="p">,</span> <span class="s1">&#39;z-band SNR in 1-1.5 Re bin&#39;</span> <span class="p">]</span>

    <span class="c1"># Run the S/N calculation; this is the same calculation as done in</span>
    <span class="c1"># mangadap.proc.spatialbinning.VoronoiBinning.sn_calculation_covariance_matrix</span>
    <span class="n">nfilter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filter_response_file</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfilter</span><span class="p">):</span>
        <span class="n">response_func</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">filter_response_file</span><span class="p">[</span><span class="n">i</span><span class="p">])[:,:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">signal</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> <span class="n">snr</span><span class="p">,</span> <span class="n">covar</span> <span class="o">=</span> <span class="n">drpf</span><span class="o">.</span><span class="n">flux_stats</span><span class="p">(</span><span class="n">response_func</span><span class="o">=</span><span class="n">response_func</span><span class="p">,</span>
                                                       <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DONOTUSE&#39;</span><span class="p">,</span> <span class="s1">&#39;FORESTAR&#39;</span><span class="p">],</span>
                                                       <span class="n">covar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#, correlation=True)</span>
        <span class="c1"># Get the spaxels within the radius limits</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">r_re</span><span class="o">.</span><span class="n">size</span><span class="p">)[(</span><span class="n">r_re</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">r_re</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">mask</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hdr</span><span class="p">[</span><span class="n">key_med</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">com_med</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">hdr</span><span class="p">[</span><span class="n">key_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">com_ring</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">covar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Covariance not available!  Continuing without it.&#39;</span><span class="p">)</span>
            <span class="n">covar</span> <span class="o">=</span> <span class="n">Covariance</span><span class="o">.</span><span class="n">from_variance</span><span class="p">(</span><span class="n">variance</span><span class="p">,</span> <span class="n">correlation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="c1"># Get the appropriate covariance pixels to select</span>
        <span class="n">ci</span><span class="p">,</span> <span class="n">cj</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">indx</span><span class="p">,</span> <span class="n">indx</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># Use the covariance matrix from the single wavelength channel</span>
        <span class="c1"># calculation, but renormalize it to the mean variance over the</span>
        <span class="c1"># response function</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">variance</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="k">if</span> <span class="n">covar</span> <span class="ow">is</span> <span class="kc">None</span> \
                        <span class="k">else</span> <span class="n">covar</span><span class="o">.</span><span class="n">apply_new_variance</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="c1"># Set the median S/N ...</span>
        <span class="n">hdr</span><span class="p">[</span><span class="n">key_med</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">snr</span><span class="p">[</span><span class="n">indx</span><span class="p">]),</span> <span class="n">com_med</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="c1"># ... and the combined S/N</span>
        <span class="n">hdr</span><span class="p">[</span><span class="n">key_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="n">indx</span><span class="p">])</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">covar</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span><span class="n">cj</span><span class="p">])),</span>
                            <span class="n">com_ring</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">hdr</span></div>






</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, SDSS-IV/MaNGA Pipeline Group.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'2.2.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>