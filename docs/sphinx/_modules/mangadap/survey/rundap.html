

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mangadap.survey.rundap &mdash; mangadap 2.2.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="mangadap 2.2.2 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> mangadap
          

          
          </a>

          
            
            
              <div class="version">
                2.2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mangadap.html">mangadap package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mangadap</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>mangadap.survey.rundap</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mangadap.survey.rundap</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Defines the class used to automate the execution of the MaNGA DAP at</span>
<span class="sd">Utah.</span>

<span class="sd">*License*:</span>
<span class="sd">    Copyright (c) 2015, SDSS-IV/MaNGA Pipeline Group</span>
<span class="sd">        Licensed under BSD 3-clause license - see LICENSE.rst</span>

<span class="sd">*Source location*:</span>
<span class="sd">    $MANGADAP_DIR/python/mangadap/survey/rundap.py</span>

<span class="sd">*Imports and python version compliance*:</span>
<span class="sd">    ::</span>

<span class="sd">        from __future__ import division</span>
<span class="sd">        from __future__ import print_function</span>
<span class="sd">        from __future__ import absolute_import</span>
<span class="sd">        from __future__ import unicode_literals</span>

<span class="sd">        import sys</span>
<span class="sd">        if sys.version &gt; &#39;3&#39;:</span>
<span class="sd">            long = int</span>

<span class="sd">        import subprocess</span>
<span class="sd">        import time</span>
<span class="sd">        import shutil</span>
<span class="sd">        import os</span>
<span class="sd">        import glob</span>
<span class="sd">        import warnings</span>
<span class="sd">        from argparse import ArgumentParser</span>

<span class="sd">        try:</span>
<span class="sd">            import pbs.queue</span>
<span class="sd">        except:</span>
<span class="sd">            warnings.warn(&#39;Could not import pbs.queue!  Any cluster submission will fail!&#39;, ImportWarning)</span>

<span class="sd">        from .drpcomplete import DRPComplete</span>
<span class="sd">        from ..drpfits import DRPFits</span>
<span class="sd">        from ..config.defaults import default_redux_path, default_drp_directory_path</span>
<span class="sd">        from ..config.defaults import default_analysis_path, default_dap_common_path</span>
<span class="sd">        from ..config.defaults import default_dap_method, default_dap_method_path, default_dap_file_root</span>
<span class="sd">        from ..config.defaults import default_dap_par_file, default_dap_plan_file</span>
<span class="sd">        from ..util.exception_tools import print_frame</span>
<span class="sd">        from ..util.parser import arginp_to_list</span>
<span class="sd">        from ..util.fileio import create_symlink</span>
<span class="sd">        from .mangampl import MaNGAMPL</span>
<span class="sd">        from ..par.analysisplan import AnalysisPlanSet</span>
<span class="sd">        from . import util</span>

<span class="sd">*Class usage examples*:</span>
<span class="sd">    Add some usage comments here!</span>

<span class="sd">.. todo::</span>
<span class="sd">    Add verbosity level</span>

<span class="sd">*Revision history*:</span>
<span class="sd">    | **?? Nov 2014**: Architecture setup by J. Brownstein</span>
<span class="sd">        &lt;joelbrownstein@astro.utah.edu&gt;</span>
<span class="sd">    | **18 Nov 2014**: Handover to K. Westfall (KBW) for development.</span>
<span class="sd">        (Attempt to) conform style to `PEP 8`_, except that lines are 99</span>
<span class="sd">        characters long (docstrings still limited to 72 characters).</span>
<span class="sd">        Also (attempt to) conform to docstrings style according to `PEP</span>
<span class="sd">        257`_.</span>
<span class="sd">    | **01 Dec 2014**: (KBW) Committed to SVN</span>
<span class="sd">    | **02 Dec 2014**: (KBW) Changed drpver and idlutilsver to mangaver</span>
<span class="sd">    | **13 Jan 2015**: (KBW) Changed it back, added platetargets</span>
<span class="sd">    | **05 Feb 2015**: (KBW) Change to load module based on MPL</span>
<span class="sd">    | **19 Mar 2015**: (KBW) Major changes to allow for more control</span>
<span class="sd">        over the directory structure containing the DRP data and for the</span>
<span class="sd">        DAP results; following changed in the drpfile and drpcomplete</span>
<span class="sd">        classes.</span>
<span class="sd">    | **27 Aug 2015**: (KBW) Sphinx documentation; prep for MPL-4;</span>
<span class="sd">        accommodate changes in drpcomplete; removed arg as an attribute</span>
<span class="sd">        because it was only used in</span>
<span class="sd">        :func:`mangadap.survey.rundap._read_arg`; despite not doing</span>
<span class="sd">        anything before, commented out _write_module_commands for the</span>
<span class="sd">        time-being; removed file_root() and parameter_file() functions</span>
<span class="sd">        in favor of adding/using functions from</span>
<span class="sd">        :mod:`mangadap.config.defaults`; version number set to 1_1_0.</span>
<span class="sd">    | **06 Oct 2015**: (KBW) Added functionality to select the types of</span>
<span class="sd">        additional output.  Minor changes to allow for DR13 QA plots.</span>
<span class="sd">    | **22 Oct 2015**: (KBW) Added check that the selected MPL versions match</span>
<span class="sd">        the current environmental versions.  Includes edit to</span>
<span class="sd">        :class:`mangadap.survey.mangampl.MaNGAMPL` to include</span>
<span class="sd">        MANGACORE_VER.  Changed default number of nodes to 9.  Added</span>
<span class="sd">        definition of idl command for use on sciama cluster at the ICG,</span>
<span class="sd">        Portsmouth.</span>
<span class="sd">    | **04 Nov 2015**: (KBW) Added capability to turn off main DAP</span>
<span class="sd">        processing call so that :class:`rundap` can be used to, e.g.,</span>
<span class="sd">        just create the plots for existing data.</span>
<span class="sd">    | **17 Feb 2016**: (KBW) Added try/except block for importing</span>
<span class="sd">        pbs.queue; converted old drpfile to new</span>
<span class="sd">        :class:`mangadap.drpfits.DRPFits`, and drpcomplete to new</span>
<span class="sd">        :class:`mangadap.survey.drpcomplete.DRPComplete`.</span>
<span class="sd">    | **13 May 2016**: (KBW) Substantial changes to accommodate</span>
<span class="sd">        conversion of DAP from IDL to python</span>
<span class="sd">    | **19 May 2016**: (KBW) Added command-line options for including</span>
<span class="sd">        log file</span>
<span class="sd">    | **11 Oct 2016**: (KBW) Version checking moved to</span>
<span class="sd">        :class:`mangadap.survey.mangampl.MaNGAMPL`.</span>
<span class="sd">    | **23 Aug 2017**: (KBW) Include ppxffit QA plots.</span>
<span class="sd">    | **29 Aug 2017**: (KBW) Include DAPall post-processing.</span>

<span class="sd">.. _PEP 8: https://www.python.org/dev/peps/pep-0008</span>
<span class="sd">.. _PEP 257: https://www.python.org/dev/peps/pep-0257</span>
<span class="sd">.. _argparse.Namespace: https://docs.python.org/3/library/argparse.html#argparse.Namespace</span>
<span class="sd">.. _argparse.ArgumentParser: https://docs.python.org/3/library/argparse.html#argparse.ArgumentParser</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
    <span class="n">long</span> <span class="o">=</span> <span class="nb">int</span>

<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="k">import</span> <span class="n">ArgumentParser</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pbs.queue</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Could not import pbs.queue!  Any cluster submission will fail!&#39;</span><span class="p">,</span> <span class="ne">ImportWarning</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">.drpcomplete</span> <span class="k">import</span> <span class="n">DRPComplete</span>
<span class="kn">from</span> <span class="nn">..drpfits</span> <span class="k">import</span> <span class="n">DRPFits</span>
<span class="kn">from</span> <span class="nn">..config.defaults</span> <span class="k">import</span> <span class="n">default_redux_path</span><span class="p">,</span> <span class="n">default_drp_directory_path</span>
<span class="kn">from</span> <span class="nn">..config.defaults</span> <span class="k">import</span> <span class="n">default_analysis_path</span><span class="p">,</span> <span class="n">default_dap_common_path</span>
<span class="kn">from</span> <span class="nn">..config.defaults</span> <span class="k">import</span> <span class="n">default_dap_method</span><span class="p">,</span> <span class="n">default_dap_method_path</span><span class="p">,</span> <span class="n">default_dap_file_root</span>
<span class="kn">from</span> <span class="nn">..config.defaults</span> <span class="k">import</span> <span class="n">default_dap_par_file</span><span class="p">,</span> <span class="n">default_dap_plan_file</span>
<span class="kn">from</span> <span class="nn">..util.exception_tools</span> <span class="k">import</span> <span class="n">print_frame</span>
<span class="kn">from</span> <span class="nn">..util.parser</span> <span class="k">import</span> <span class="n">arginp_to_list</span>
<span class="kn">from</span> <span class="nn">..util.fileio</span> <span class="k">import</span> <span class="n">create_symlink</span>
<span class="kn">from</span> <span class="nn">..util.version</span> <span class="k">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">.mangampl</span> <span class="k">import</span> <span class="n">MaNGAMPL</span>
<span class="kn">from</span> <span class="nn">..par.analysisplan</span> <span class="k">import</span> <span class="n">AnalysisPlanSet</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">util</span>

<div class="viewcode-block" id="rundap"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap">[docs]</a><span class="k">class</span> <span class="nc">rundap</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class used for automated execution of the MaNGA DAP via submission</span>
<span class="sd">    of scripts to a cluster.</span>

<span class="sd">    [ More complete explanation of the class here. ]</span>

<span class="sd">    .. note::</span>
<span class="sd">    </span>
<span class="sd">        This is purely a survey-level utility for running the DAP at</span>
<span class="sd">        Utah, including submitting jobs to the cluster.  No user-level</span>
<span class="sd">        usage of the DAP should be considered here, apart from not</span>
<span class="sd">        hindering such usage of the primary python programs!</span>

<span class="sd">    .. todo::</span>

<span class="sd">        - Have :func:`_read_arg` return the boolean for :attr:`version`</span>
<span class="sd">          instead of keeping it as an attribute.</span>

<span class="sd">    Args:</span>
<span class="sd">        daily (bool): (**Optional**) Execute daily update of analyses</span>
<span class="sd">        all (bool): (**Optional**) Analyze all existing DRP data.</span>
<span class="sd">        clobber (bool): (**Optional**) **Only used with :attr:`all`**.</span>
<span class="sd">            Clobber and redo any existing analysis.</span>
<span class="sd">        redo (bool): (**Optional**) Redo an existing set of analyses;</span>
<span class="sd">            must be accompanied by a list of plates, ifus, and modes to</span>
<span class="sd">            analyze.  **clobber** is implicitly true.</span>
<span class="sd">        console (bool): (**Optional**) The class has been executed from</span>
<span class="sd">            the terminal with command-line arguments that should be</span>
<span class="sd">            parsed.</span>
<span class="sd">        quiet (bool): (**Optional**) Suppress output</span>
<span class="sd">        print_version (bool): (**Optional**) Print the class version and</span>
<span class="sd">            return</span>
<span class="sd">        strictver (bool): (**Optional**) Strictly check the version</span>
<span class="sd">            requirements for this version of the dap.  Default is True,</span>
<span class="sd">            meaning the code will raise an exception if the expected</span>
<span class="sd">            version are not the same as the environment.</span>
<span class="sd">        mplver (str): (**Optional**) MPL version to analyze.  Used with</span>
<span class="sd">            :class:`mangadap.survey.mangampl.MaNGAMPL` to set the</span>
<span class="sd">            idlutils version and the DRP version.  Ideally, this</span>
<span class="sd">            controls the modules that are loaded before execution of the</span>
<span class="sd">            DAP.  The default version (selected if mplver=None) is</span>
<span class="sd">            defined by :class:`mangadap.survey.mangampl.MaNGAMPL`.</span>

<span class="sd">            .. warning::</span>

<span class="sd">                This functionality is **NOT** actually implemented.</span>
<span class="sd">                Currently, the DAP will run with whatever set of modules</span>
<span class="sd">                are currently loaded when the jobs are submitted to the</span>
<span class="sd">                cluster.</span>
<span class="sd">                </span>
<span class="sd">        redux_path (str): (**Optional**) The top-level path with the DRP</span>
<span class="sd">            files used to override the default defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_redux_path`.</span>
<span class="sd">        dapver (str): (**Optional**) The DAP version to use for the</span>
<span class="sd">            analysis, used to override the default defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_dap_version`.</span>
<span class="sd">        analysis_path (str): (**Optional**) The top-level path for the</span>
<span class="sd">            DAP output files, used to override the default defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_analysis_path`.</span>
<span class="sd">        plan_file (str): (**Optional**) Name of the plan file to use for</span>
<span class="sd">            *all* DRP data in this run, used to override the default</span>
<span class="sd">            defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_dap_plan_file`.</span>
<span class="sd">        platelist (int, str): (**Optional**) List of plates to analyze;</span>
<span class="sd">            default is to search the :attr:`redux_path` for any DRP</span>
<span class="sd">            files; see :class:`mangadap.survey.drpcomplete.DRPComplete`.</span>
<span class="sd">        ifudesignlist (int, str): (**Optional**) List of ifudesigns to</span>
<span class="sd">            analyze: default is to search the :attr:`redux_path` for any</span>
<span class="sd">            DRP files; see</span>
<span class="sd">            :class:`mangadap.survey.drpcomplete.DRPComplete`.</span>
<span class="sd">        modelist (str): (**Optional**) DRP 3D modes (&#39;RSS&#39; or &#39;CUBE&#39;) to</span>
<span class="sd">            analyze; default is to analyze both.</span>
<span class="sd">        combinatorics (bool): (**Optional**) Use all unique combinations</span>
<span class="sd">            of the entered plate/ifudesign/mode lists to create the full</span>
<span class="sd">            list of DRP files to analyze.  See</span>
<span class="sd">            :func:`mangadap.drpfits.drpfits_list`.</span>
<span class="sd">        prior_mode (str): (**Optional**) Used to construct a plate-ifu</span>
<span class="sd">            specific prior fits file name to replace an existing value</span>
<span class="sd">            in the plan file.  This sets the mode (&#39;RSS&#39; or &#39;CUBE&#39;) of</span>
<span class="sd">            the fits file.</span>
<span class="sd">        prior_bin (str): (**Optional**) Used to construct a plate-ifu</span>
<span class="sd">            specific prior fits file name to replace an existing value</span>
<span class="sd">            in the plan file.  This sets the binning type of the fits</span>
<span class="sd">            file.</span>
<span class="sd">        prior_iter (int): (**Optional**) Used to construct a plate-ifu</span>
<span class="sd">            specific prior fits file name to replace an existing value</span>
<span class="sd">            in the plan file.  This sets the iteration number of the</span>
<span class="sd">            fits file.</span>
<span class="sd">        prior_old (str): (**Optional**) The value of the existing prior</span>
<span class="sd">            in the plan file that should be replaced by the prior fits</span>
<span class="sd">            file constructed using the other &quot;prior_*&quot; attributes.</span>
<span class="sd">        platetargets (str, list): (**Optional**) List of platetargets</span>
<span class="sd">            files to search through to find any given plate-ifudesign</span>
<span class="sd">            combination.  Default is returned as the first element in</span>
<span class="sd">            :func:`mangadap.config.defaults.default_plate_target_files`.</span>
<span class="sd">        dapproc (bool): (**Optional**) Flag to execute the main DAP</span>
<span class="sd">            processing. Default is True.</span>
<span class="sd">        plots (bool): (**Optional**) Create the QA plots. Default is</span>
<span class="sd">            True.</span>
<span class="sd">        label (str): (**Optional**) Label to use in cluster queue.</span>
<span class="sd">            Default is mangadap and the run mode (daily, etc).</span>
<span class="sd">        nodes (int): (**Optional**) Number of cluster nodes to use.</span>
<span class="sd">            Default is 9.</span>
<span class="sd">        qos (str): (**Optional**) Select a specific processor (only None</span>
<span class="sd">            for daily run).  This option is ignored if :attr:`q` is set.</span>
<span class="sd">        umask (str): (**Optional**) umask to set for output. Default is</span>
<span class="sd">            0027.</span>
<span class="sd">        walltime (str): (**Optional**) Maximum wall time for cluster</span>
<span class="sd">            job.  Default is 10 days (&#39;240:00:00&#39;).</span>
<span class="sd">        hard (bool): (**Optional**) Same as hard keyword in cluster</span>
<span class="sd">            submission; see :func:`pbs.queue.commit`.</span>

<span class="sd">            .. note::</span>

<span class="sd">                This keyword is in the **opposite** sense of the</span>
<span class="sd">                &quot;--toughness&quot; command-line options; i.e. including</span>
<span class="sd">                --toughness on the command line sets hard=False.</span>

<span class="sd">        create (bool): (**Optional**) Use the pbs package to create the</span>
<span class="sd">            scripts. Default is False.</span>
<span class="sd">        submit (bool): (**Optional**) Submit all jobs to the cluster.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        queue (str): (**Optional**) Name of the destination queue.  When</span>
<span class="sd">            submitting jobs at Utah, this should **not** be set (leaving</span>
<span class="sd">            it at the default of None).  When submitting jobs at</span>
<span class="sd">            Portsmouth, this can be used to select either sciama1.q,</span>
<span class="sd">            cluster.q (default), or sciama3.q.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        daily (bool): Execute daily update of analyses</span>
<span class="sd">        all (bool): Analyze all existing DRP data.</span>
<span class="sd">        clobber (bool): **Only used with :attr:`all`**.  Clobber and</span>
<span class="sd">            redo any existing analysis.</span>
<span class="sd">        redo (bool): Redo an existing set of analyses; must be</span>
<span class="sd">            accompanied by a list of plates, ifus, and modes to analyze.</span>
<span class="sd">            In this case, :attr:`clobber` is implicitly true.</span>
<span class="sd">        quiet (bool): Suppress output</span>
<span class="sd">        print_version (bool): Print the version and then return</span>
<span class="sd">        strictver (bool): Strictly check the version requirements for</span>
<span class="sd">            this version of the dap.  If True, an exception is raised if</span>
<span class="sd">            the expected version are not the same as the environment.</span>
<span class="sd">        mpl (:class:`mangadap.survey.mangampl.MaNGAMPL`): MPL version;</span>
<span class="sd">            see above.</span>
<span class="sd">        redux_path (str): The top-level path with the DRP files.</span>
<span class="sd">        dapver (str): The DAP version.</span>
<span class="sd">        analysis_path (str): The top-level path for the DAP output</span>
<span class="sd">            files.</span>
<span class="sd">        plan_file (str): Name of the plan file to use for ALL DRP data</span>
<span class="sd">            in this run.</span>
<span class="sd">        platelist (list): List of plates to analyze.</span>
<span class="sd">        ifudesignlist (list): List of ifudesigns to analyze.</span>
<span class="sd">        modelist (list): DRP 3D modes (&#39;RSS&#39; and/or &#39;CUBE&#39;) to analyze.</span>
<span class="sd">        combinatorics (bool): Use all unique combinations of the entered</span>
<span class="sd">            plate/ifudesign/mode lists to create the full list of DRP</span>
<span class="sd">            files to analyze.</span>
<span class="sd">        prior_mode (str): Used to construct a plate-ifu specific prior</span>
<span class="sd">            fits file name to replace an existing value in the plan</span>
<span class="sd">            file.  This sets the mode (&#39;RSS&#39; or &#39;CUBE&#39;) of the fits</span>
<span class="sd">            file.</span>
<span class="sd">        prior_bin (str): Used to construct a plate-ifu specific prior</span>
<span class="sd">            fits file name to replace an existing value in the plan</span>
<span class="sd">            file.  This sets the binning type of the fits file.</span>
<span class="sd">        prior_iter (int): Used to construct a plate-ifu specific prior</span>
<span class="sd">            fits file name to replace an existing value in the plan</span>
<span class="sd">            file.  This sets the iteration number of the fits file.</span>
<span class="sd">        prior_old (str): The value of the existing prior in the plan</span>
<span class="sd">            file that should be replaced by the prior fits file</span>
<span class="sd">            constructed using the other &quot;prior_*&quot; attributes.</span>
<span class="sd">        platetargets (list): List of platetargets files to search</span>
<span class="sd">            through to find any given plate-ifudesign combination.</span>
<span class="sd">        dapproc (bool): Flag to execute the main DAP processing</span>
<span class="sd">        plots (bool): Create the QA plots</span>
<span class="sd">        label (str): Label to use in cluster queue.</span>
<span class="sd">        nodes (int): Number of cluster nodes to use.</span>
<span class="sd">        qos (str): Specific processor to use (Utah specific)</span>
<span class="sd">        umask (str): umask to set for output.</span>
<span class="sd">        walltime (str): Maximum wall time for cluster job.</span>
<span class="sd">        hard (bool): Same as hard keyword in cluster submission; see</span>
<span class="sd">            :func:`pbs.queue.commit`.</span>
<span class="sd">        create (bool): Use the pbs package to create the submission</span>
<span class="sd">            scripts.</span>
<span class="sd">        submit (bool): Submit all jobs to the cluster.</span>
<span class="sd">        q (str): Queue destination (Portsmouth specific)</span>
<span class="sd">        drpc (:class:`mangadap.survey.drpcomplete.DRPComplete`):</span>
<span class="sd">            Database of the available DRP files and the parameters</span>
<span class="sd">            necessary to write the DAP par files.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: Raised if a plate-ifu list file is provided</span>
<span class="sd">            but it does not exist, or if the plan file does not exist.</span>
<span class="sd">        ValueError: Raised if all processing steps are turned off, if</span>
<span class="sd">            the selected MPL is undefined; if the fast node is selected</span>
<span class="sd">            with nodes &gt; 1; if multiple run modes are selected; or if</span>
<span class="sd">            the plate list, ifudesign list, or mode list are not</span>
<span class="sd">            provided during a redo mode or if they are provided with any</span>
<span class="sd">            other mode.</span>

<span class="sd">    .. todo::</span>
<span class="sd">        Prior allocation is out-of-date.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="c1"># Run mode options</span>
                 <span class="n">daily</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">redo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="c1"># STDIO options</span>
                 <span class="n">console</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_version</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="c1"># Override default environmental variables</span>
                 <span class="n">strictver</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mplver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">redux_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="c1"># Definitions used to set files to process</span>
                 <span class="n">plan_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">platelist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ifudesignlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modelist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">combinatorics</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">list_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">prior_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prior_bin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prior_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prior_old</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="c1"># Databases with input parameter information</span>
                 <span class="n">platetargets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="c1"># Flags for script contents</span>
                 <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dapproc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="c1"># Include the postprocessing script to create the</span>
                 <span class="c1"># DAPall file</span>
                 <span class="n">build_dapall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">report_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="c1"># Cluster options</span>
                 <span class="n">label</span><span class="o">=</span><span class="s1">&#39;mangadap&#39;</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">cpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">umask</span><span class="o">=</span><span class="s1">&#39;0027&#39;</span><span class="p">,</span><span class="n">walltime</span><span class="o">=</span><span class="s1">&#39;240:00:00&#39;</span><span class="p">,</span>
                 <span class="n">hard</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">submit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Save run-mode options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily</span> <span class="o">=</span> <span class="n">daily</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all</span> <span class="o">=</span> <span class="nb">all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clobber</span> <span class="o">=</span> <span class="n">clobber</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redo</span> <span class="o">=</span> <span class="n">redo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_version</span> <span class="o">=</span> <span class="n">print_version</span>

        <span class="c1"># Override environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strictver</span> <span class="o">=</span> <span class="n">strictver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpl</span> <span class="o">=</span> <span class="n">mplver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span> <span class="o">=</span> <span class="n">redux_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dapver</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">product_version</span><span class="p">(</span><span class="n">simple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">product</span><span class="o">=</span><span class="s1">&#39;mangadap&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">dapver</span> <span class="ow">is</span> <span class="kc">None</span> \
                                                                            <span class="k">else</span> <span class="n">dapver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span> <span class="o">=</span> <span class="n">analysis_path</span>

        <span class="c1"># List of files to analyze</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span> <span class="o">=</span> <span class="n">plan_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_mode</span> <span class="o">=</span> <span class="n">prior_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_bin</span> <span class="o">=</span> <span class="n">prior_bin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_iter</span> <span class="o">=</span> <span class="n">prior_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_old</span> <span class="o">=</span> <span class="n">prior_old</span>

        <span class="k">if</span> <span class="n">list_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">list_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;No file: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">list_file</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">list_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platelist</span> <span class="o">=</span> <span class="n">arginp_to_list</span><span class="p">(</span><span class="n">platelist</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ifudesignlist</span> <span class="o">=</span> <span class="n">arginp_to_list</span><span class="p">(</span><span class="n">ifudesignlist</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modelist</span> <span class="o">=</span> <span class="n">arginp_to_list</span><span class="p">(</span><span class="n">modelist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">platelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ifudesignlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">modelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Provided file with list of files supercedes other input.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platelist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifudesignlist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file_list</span><span class="p">(</span><span class="n">list_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combinatorics</span> <span class="o">=</span> <span class="n">combinatorics</span>

        <span class="c1"># plateTargets file(s) to be used by the DRPComplete class,</span>
        <span class="c1"># which can be None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platetargets</span> <span class="o">=</span> <span class="n">arginp_to_list</span><span class="p">(</span><span class="n">platetargets</span><span class="p">)</span>

        <span class="c1"># Set the options for output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dapproc</span> <span class="o">=</span> <span class="n">dapproc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plots</span> <span class="o">=</span> <span class="n">plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="c1"># Build the DAPall file (and any QA plots)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_dapall</span> <span class="o">=</span> <span class="n">build_dapall</span>

        <span class="c1"># Report the progess of the cluster, otherwise just finish</span>
        <span class="c1"># script</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_progress</span> <span class="o">=</span> <span class="n">report_progress</span>

        <span class="c1"># Cluster queue keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="n">cpus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qos</span> <span class="o">=</span> <span class="n">qos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">umask</span> <span class="o">=</span> <span class="n">umask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="n">walltime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hard</span> <span class="o">=</span> <span class="n">hard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submit</span> <span class="o">=</span> <span class="n">submit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">queue</span>

        <span class="c1"># Read and parse command-line arguments</span>
        <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_arg</span><span class="p">()</span>

        <span class="c1"># Make sure there&#39;s something to be done</span>
        <span class="n">nproc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dapproc</span><span class="p">:</span>
            <span class="n">nproc</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">processes</span> <span class="o">+=</span> <span class="p">[</span> <span class="s1">&#39;Main DAP blocks&#39;</span> <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plots</span><span class="p">:</span>
            <span class="n">nproc</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">processes</span> <span class="o">+=</span> <span class="p">[</span> <span class="s1">&#39;QA plots&#39;</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">nproc</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No processing steps requested!&#39;</span><span class="p">)</span>

        <span class="c1"># Only print the version of the DAP</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_version</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DAP Version: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__version__</span><span class="p">))</span>
            <span class="k">return</span>

<span class="c1">#        print(&#39;Plates:&#39;)</span>
<span class="c1">#        print(self.platelist)</span>
<span class="c1">#        print(&#39;IFUs:&#39;)</span>
<span class="c1">#        print(self.ifudesignlist)</span>
<span class="c1">#        print(&#39;Modes:&#39;)</span>
<span class="c1">#        print(self.modelist)</span>
<span class="c1">#        print(len(self.platelist), len(self.ifudesignlist), len(self.modelist))</span>

        <span class="c1"># Make sure the selected MPL version is available</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mpl</span> <span class="o">=</span> <span class="n">MaNGAMPL</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="p">,</span> <span class="n">strictver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strictver</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">print_frame</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;MPL is undefined: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># Set the output paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span> <span class="o">=</span> <span class="n">default_redux_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span> <span class="ow">is</span> <span class="kc">None</span> \
                                                              <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span> <span class="o">=</span> <span class="n">default_analysis_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">)</span> \
                             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">)</span>

        <span class="c1"># Set the subdirectory from which the scripts are sourced and</span>
        <span class="c1"># the various log files are written.  Currently based on start</span>
        <span class="c1"># UTC; e.g., analysis_path/log/19May2016T09.17.42UTC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calling_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span>
                                         <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">%b%YT%H.%M.%SUTC&#39;</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">()))</span>

        <span class="c1"># Make sure there is an analysis plan</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span> <span class="o">=</span> <span class="n">default_dap_plan_file</span><span class="p">(</span><span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span>
                                                   <span class="n">analysis_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;No file: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span><span class="p">))</span>

        <span class="c1"># Create the calling path and copy the plan file into the top</span>
        <span class="c1"># level of that directory; existence tests are run, even though</span>
        <span class="c1"># time stamp should mean that calling_path never exists</span>
        <span class="c1"># TODO: allow argument to set calling_path directly?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calling_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calling_path</span><span class="p">)</span>
        <span class="n">_plan_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calling_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">_plan_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span><span class="p">)</span>

        <span class="c1"># Alert the user of the versions to be used</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Attempting to submit to queue: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Versions: DAP:</span><span class="si">{0}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">mplver</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">verify_versions</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Paths:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      REDUX: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   ANALYSIS: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    CALLING: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calling_path</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  PLAN FILE: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing steps added to scripts:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">processes</span><span class="p">))</span>

        <span class="c1"># If submitting to the cluster, make sure that scripts will be</span>
        <span class="c1"># created!</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># If setting qos, the number of nodes must be 1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;When selecting the fast node, must have nodes=1!&#39;</span><span class="p">)</span>

        <span class="c1"># Check that something is to be done</span>
        <span class="n">nrun</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily</span><span class="p">:</span> <span class="n">nrun</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span><span class="p">:</span> <span class="n">nrun</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">redo</span><span class="p">:</span> <span class="n">nrun</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">nrun</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nrun</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must request one (and only one) run mode!&#39;</span><span class="p">)</span>

        <span class="c1"># Check argument combination makes sense</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobber</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Clobber keyword can only be set if all specified (-a,--all)!&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clobber</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># If redo, platelist and ifudesignlist MUST be provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">redo</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">platelist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifudesignlist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must provide platelist, ifudesignlist, and modelist for redo!&#39;</span><span class="p">)</span>

        <span class="c1"># If not redo, platelist, ifudesignlist, and modelist should be</span>
        <span class="c1"># ignored</span>
        <span class="c1"># TODO: Does an error need to be thrown here, or just warn user.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">redo</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">platelist</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifudesignlist</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelist</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;platelist/ifudesignlist/modelist only allowed for redo!&#39;</span><span class="p">)</span>

<span class="c1">#        # If a plan file is provided, make sure it exists</span>
<span class="c1">#        if self.plan_file is not None and not os.path.exists(self.plan_file):</span>
<span class="c1">#            raise ValueError(&#39;Provided plan file does not exist.&#39;)</span>

        <span class="c1"># If the prior is to be replaced, make sure all four arguments</span>
        <span class="c1"># are provided</span>
        <span class="n">npri</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">npri</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">npri</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">npri</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">npri</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">npri</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">npri</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;To define prior, must provided mode, bin, iter, and old value!&#39;</span><span class="p">)</span>
        <span class="c1"># From now on can decide if prior exists by just testing one of</span>
        <span class="c1"># the four options</span>

        <span class="k">if</span> <span class="n">npri</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;To define prior, must provide a plan file to edit.&#39;</span><span class="p">)</span>

        <span class="c1"># If running all or daily, make sure lists are set to None such</span>
        <span class="c1"># that DRPComplete will search for all available DRP files and</span>
        <span class="c1"># make sure that the needed information is up-to-date</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platelist</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ifudesignlist</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modelist</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create and update the DRPComplete file if necessary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span> <span class="o">=</span> <span class="n">DRPComplete</span><span class="p">(</span><span class="n">platetargets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">platetargets</span><span class="p">,</span> <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span>
                                <span class="n">redux_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span>
                                <span class="n">analysis_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">)</span>
        
        <span class="c1"># Update the DRPComplete list; force an update if platetarget</span>
        <span class="c1"># files are provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">platelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">platelist</span><span class="p">,</span> <span class="n">ifudesignlist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ifudesignlist</span><span class="p">,</span>
                         <span class="n">combinatorics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">combinatorics</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">platetargets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>

        <span class="c1"># Hereafter, self.platelist and self.ifuplatelist are the INPUT</span>
        <span class="c1"># values, whereas self.drpc.platelist and self.drpc.ifuplatelist</span>
        <span class="c1"># are the actual DRP reductions to analyze (including</span>
        <span class="c1"># combinatorics and file existence tests).  These should be</span>
        <span class="c1"># combined with self.modelist to get the DRP files to analyze.</span>
        <span class="c1"># See, e.g., selected_drpfile_list().</span>

        <span class="c1"># Prep the verbosity of the queue if submitting</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">pbs</span><span class="o">.</span><span class="n">queue</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span>

        <span class="c1"># Run the selected mode by filling the queue</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_daily</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_all</span><span class="p">(</span><span class="n">clobber</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clobber</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">redo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_redo</span><span class="p">()</span>

        <span class="c1"># Submit the queue to the cluster</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">hard</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hard</span><span class="p">,</span> <span class="n">submit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">)</span>

        <span class="c1"># Construct the DAPall script</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_dapall</span><span class="p">:</span>
            <span class="n">dapall_scr</span><span class="p">,</span> <span class="n">dapall_out</span><span class="p">,</span> <span class="n">dapall_err</span> \
                        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_dapall_script</span><span class="p">(</span><span class="n">plots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plots</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clobber</span><span class="p">)</span>

        <span class="c1"># If nothing has been submitted, nothing left to do</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_progress</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Wait until the queue is finished</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">running</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span> 
            <span class="n">percent_complete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get_percent_complete</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Percent complete ... </span><span class="si">{0:.1f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent_complete</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">percent_complete</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Percent complete ... </span><span class="si">{0:.1f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent_complete</span><span class="p">))</span>

        <span class="c1"># No DAPall script, so finish</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_dapall</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Set the ready status file for the DAPall script</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">dapall_scr</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready&#39;</span><span class="p">)</span>

        <span class="c1"># Execute the DAPall script; if it makes it here, create and</span>
        <span class="c1"># submit should be true</span>
        <span class="n">dapall_queue</span> <span class="o">=</span> <span class="n">pbs</span><span class="o">.</span><span class="n">queue</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_queue</span><span class="p">(</span><span class="n">dapall_queue</span><span class="p">)</span>
        <span class="n">dapall_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;source </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dapall_scr</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">dapall_out</span><span class="p">,</span> <span class="n">errfile</span><span class="o">=</span><span class="n">dapall_err</span><span class="p">)</span>
        <span class="n">dapall_queue</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">hard</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hard</span><span class="p">,</span> <span class="n">submit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">)</span>


    <span class="c1"># ******************************************************************</span>
    <span class="c1">#  UTILITY FUNCTIONS</span>
    <span class="c1"># ******************************************************************</span>
<div class="viewcode-block" id="rundap._read_file_list"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap._read_file_list">[docs]</a>    <span class="k">def</span> <span class="nf">_read_file_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_file</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">list_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input file should contain 3 columns.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">db</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> \
                    <span class="n">db</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div>


<div class="viewcode-block" id="rundap._read_arg"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap._read_arg">[docs]</a>    <span class="k">def</span> <span class="nf">_read_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read and interpret the terminal command-line arguments.</span>

<span class="sd">        Function uses the argparse module, which provide a --help option</span>
<span class="sd">        to list all available arguments.  The arguments mimic those</span>
<span class="sd">        required by the class constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Declare the ArgumentParser object</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">()</span>

        <span class="c1"># Set the run mode to be mutually exclusive</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Read the mode aruments</span>
        <span class="n">mode</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--daily&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;runs dap for next mjd (as an after burner to drp)&quot;</span><span class="p">,</span>
                          <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
        <span class="n">mode</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--all&quot;</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="s2">&quot;runs dap for all plates/ifudesigns/modes not currently running &quot;</span>
                          <span class="s2">&quot;or done&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
        <span class="n">mode</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--redo&quot;</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="s2">&quot;runs dap for specified platelist/ifudesignlist/modelist &quot;</span>
                          <span class="s2">&quot;regardless of state&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>

        <span class="c1"># Read the optional run-mode arguments</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--clobber&quot;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;if all selected, will run dap for all plates/ifudesigns/modes &quot;</span>
                            <span class="s2">&quot; regardless of state&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set verbosity level for manga_dap; can be omitted and set up &#39;</span>
                                 <span class="s1">&#39;to -vv&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--quiet&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;suppress screen output&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--print_version&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;print DAP version and stop&quot;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
       
        <span class="c1"># These arguments are used to override default behavior</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--loose&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Only throw warnings if the versioning is &quot;</span>
                            <span class="s2">&quot;not identically as it should be for the designated MPL&quot;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mplver&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;select MPL version to analyze&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--redux_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;main DRP output path&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--dapver&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;optional output version, different from product version&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--analysis_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;main DAP output path&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--plan_file&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;parameter file with the MaNGA DAP &quot;</span>
                            <span class="s2">&quot;execution plan to use instead of the default&quot;</span> <span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--prior_mode&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;mode type to use for prior&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--prior_bin&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;bin type to use for prior&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--prior_iter&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;iteration to use for prior&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--prior_old&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;old value to replace in existing plan file&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--platelist&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;set list of plates to reduce&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ifudesignlist&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;set list of ifus to reduce&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--modelist&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;set list of DRP output modes to reduce&quot;</span>
                            <span class="s2">&quot; (CUBE or RSS)&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--list_file&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;a file with the list of plates, ifudesigns, and modes to analyze&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--combinatorics&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;force execution of all permutations of the &quot;</span>
                            <span class="s2">&quot;provided lists&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--plttargets&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;path to plateTargets file(s); &quot;</span>
                            <span class="s2">&quot;if provided will force update to drpcomplete fits file&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--log&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Have the main DAP executable produce a log file&quot;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--no_proc&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do NOT perform the main DAP processing steps&quot;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--no_plots&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do NOT create QA plots&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--dapall&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Wait for any individual plate-ifu processes to finish and then&#39;</span>
                                 <span class="s1">&#39;update the DAPall file&#39;</span><span class="p">)</span>

        <span class="c1"># Read arguments specific to the cluster submission behavior</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--label&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;label for cluster job&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;mangadap&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--nodes&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of nodes to use in cluster&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--cpus&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of cpus to use per node.  Default is to use all available&#39;</span>
                                 <span class="s1">&#39;; otherwise, set to minimum of provided number and number of &#39;</span>
                                 <span class="s1">&#39;processors per node&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--fast&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;qos&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;qos state&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--umask&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;umask bit for cluster job&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;0027&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--walltime&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;walltime for cluster job&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="s1">&#39;240:00:00&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--toughness&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;hard&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;turn off hard keyword for cluster submission&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--create&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;use the pbs package to create the cluster scripts&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--submit&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;submit the scripts to the cluster&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--progress&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;instead of closing the script, report the progress of the &#39;</span>
                                 <span class="s1">&#39;analysis on the cluster; this is required if you want to submit &#39;</span>
                                 <span class="s1">&#39;the DAPall script immediately after completing the individual &#39;</span>
                                 <span class="s1">&#39;cube analysis&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--queue&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;queue&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;set the destination queue&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        
        <span class="c1"># Finally parse the full set and set it to its own container</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

        <span class="c1">################################################################</span>
        <span class="c1"># Assign properties based on arguments; the suitability of these</span>
        <span class="c1"># arguments is checked in __init__()</span>

        <span class="c1"># Run-mode</span>
        <span class="c1"># Will OVERWRITE existing input from __init__()</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">daily</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">daily</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">all</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">redo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redo</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">redo</span>

        <span class="c1"># Run-mode options</span>
        <span class="c1"># Will OVERWRITE existing input from __init__()</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">clobber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clobber</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">clobber</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">quiet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">quiet</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">print_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_version</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">print_version</span>

        <span class="c1"># Set the versions to use</span>
        <span class="c1"># Will OVERWRITE existing input from __init__()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strictver</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">loose</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">mplver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mpl</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">mplver</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">redux_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">redux_path</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">dapver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dapver</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">dapver</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">analysis_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">analysis_path</span>

        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">plan_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">plan_file</span>

        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">prior_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prior_mode</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">prior_mode</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">prior_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prior_bin</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">prior_bin</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">prior_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prior_iter</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">prior_iter</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">prior_old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prior_old</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">prior_old</span>

        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">list_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">list_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;No file: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">list_file</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">list_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">platelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">platelist</span> <span class="o">=</span> <span class="n">arginp_to_list</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">platelist</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">ifudesignlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ifudesignlist</span> <span class="o">=</span> <span class="n">arginp_to_list</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">ifudesignlist</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">modelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">modelist</span> <span class="o">=</span> <span class="n">arginp_to_list</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">modelist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">platelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">arg</span><span class="o">.</span><span class="n">ifudesignlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                    <span class="ow">or</span> <span class="n">arg</span><span class="o">.</span><span class="n">modelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Provided file with list of files supercedes other input.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platelist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifudesignlist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file_list</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">list_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combinatorics</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">combinatorics</span>
   
        <span class="c1"># Set the plateTargets and NSA catalog path</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">plttargets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platetargets</span> <span class="o">=</span> <span class="n">arginp_to_list</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">plttargets</span><span class="p">)</span>

        <span class="c1"># Overwrite any existing output options</span>
        <span class="c1"># NOTE: This execution means that all 4 steps will default to</span>
        <span class="c1"># True if not specified on the command line.  This matches the</span>
        <span class="c1"># default set by __init__()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dapproc</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">no_proc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plots</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">no_plots</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&lt;</span> <span class="n">arg</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">verbose</span>

        <span class="c1"># Set to construct the dapall file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_dapall</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">dapall</span>

        <span class="c1"># Set to report the progress of the cluster.  This is needed if</span>
        <span class="c1"># waiting to submit the DAPall construction script</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_progress</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">progress</span>

        <span class="c1"># Set queue keywords</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">umask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">umask</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">umask</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">nodes</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">cpus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">cpus</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">walltime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">walltime</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">qos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qos</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">qos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="mi">1</span>          <span class="c1"># Force the number of nodes to be 1</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">umask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">umask</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">umask</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">hard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hard</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">hard</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">create</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">create</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">submit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submit</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">submit</span>

        <span class="c1"># Specify the destination queue</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">queue</span></div>

<span class="c1">#       print(self.q)</span>
<span class="c1">#       print(&#39;QOS: {0}&#39;.format(self.qos))</span>


<div class="viewcode-block" id="rundap._check_paths"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap._check_paths">[docs]</a>    <span class="k">def</span> <span class="nf">_check_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the output paths exists for a given plate and ifudesign.</span>
<span class="sd">        If not, create them.  The necessary output paths are:</span>

<span class="sd">            - The callind path that contains a copy of the plan, the</span>
<span class="sd">              script input and output files, and the touch files</span>
<span class="sd">            - The main common path defined by</span>
<span class="sd">              :func:`mangadap.config.defaults.default_dap_common_path`.</span>
<span class="sd">            - The plan-based subdirectories based on the plan file</span>

<span class="sd">        Args:</span>
<span class="sd">            plate (int): Plate number</span>
<span class="sd">            ifudesign (int): ifudesign number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate the calling path for this plate/ifudesign</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calling_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">plate</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ifudesign</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># Generate the main common path</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">default_dap_common_path</span><span class="p">(</span><span class="n">plate</span><span class="o">=</span><span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="o">=</span><span class="n">ifudesign</span><span class="p">,</span> <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span>
                                       <span class="n">dapver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># Read the analysis plan</span>
        <span class="n">plan</span> <span class="o">=</span> <span class="n">AnalysisPlanSet</span><span class="o">.</span><span class="n">from_par_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">nplans</span><span class="p">):</span>
            <span class="c1"># Generate the ref subdirectory for this plan</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">default_dap_method_path</span><span class="p">(</span><span class="n">default_dap_method</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">plate</span><span class="o">=</span><span class="n">plate</span><span class="p">,</span>
                                           <span class="n">ifudesign</span><span class="o">=</span><span class="n">ifudesign</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span>
                                           <span class="n">dapver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="rundap._create_queue"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap._create_queue">[docs]</a>    <span class="k">def</span> <span class="nf">_create_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a queue instance.</span>
<span class="sd">        </span>
<span class="sd">        This function is written to be functional for submission to the</span>
<span class="sd">        cluster queues both at Utah and using the sciama cluster at</span>
<span class="sd">        Portsmouth.  The available queues are:</span>

<span class="sd">        +-----------+--------+------+-----------+</span>
<span class="sd">        |     Queue |  Nodes |  PPN |   GB/core |</span>
<span class="sd">        +===========+========+======+===========+</span>
<span class="sd">        | sciama1.q |     80 |   12 |         2 |</span>
<span class="sd">        +-----------+--------+------+-----------+</span>
<span class="sd">        | sciama2.q |     96 |   16 |         4 |</span>
<span class="sd">        +-----------+--------+------+-----------+</span>
<span class="sd">        | sciama3.q |     48 |   20 |       3.2 |</span>
<span class="sd">        +-----------+--------+------+-----------+</span>

<span class="sd">        One should **not** submit to sciama3.q without permission from</span>
<span class="sd">        Will Percival.  The default queue is cluster.q (sciama2.q); so</span>
<span class="sd">        basically only use :attr:`q` to select sciama1.q.</span>

<span class="sd">        Submissions to Utah should have their queue destination set to</span>
<span class="sd">        None.  However, the fast node can be selected using :attr:`qos`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Expect to select the queue only when submitting to the</span>
            <span class="c1"># Portsmouth cluster, sciama.  In this case, the number of</span>
            <span class="c1"># nodes is queue dependent, and qos is not set</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">==</span> <span class="s1">&#39;sciama1.q&#39;</span><span class="p">:</span>
                <span class="n">ppn</span> <span class="o">=</span> <span class="mi">12</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">==</span> <span class="s1">&#39;sciama3.q&#39;</span><span class="p">:</span>
                <span class="n">ppn</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ppn</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="n">cpus</span> <span class="o">=</span> <span class="n">ppn</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">,</span> <span class="n">ppn</span><span class="p">)</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">umask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">umask</span><span class="p">,</span>
                         <span class="n">walltime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">walltime</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">ppn</span><span class="o">=</span><span class="n">ppn</span><span class="p">,</span> <span class="n">cpus</span><span class="o">=</span><span class="n">cpus</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># self.q can be None when submitting to both the Portsmouth</span>
            <span class="c1"># and Utah clusters.  In this case, the default queue</span>
            <span class="c1"># destination and ppn is correct.  qos is also set, but this</span>
            <span class="c1"># should only be used when submitting to Utah.</span>
            <span class="n">ppn</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="n">cpus</span> <span class="o">=</span> <span class="n">ppn</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">,</span> <span class="n">ppn</span><span class="p">)</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">qos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qos</span><span class="p">,</span> <span class="n">umask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">umask</span><span class="p">,</span>
                         <span class="n">walltime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">walltime</span><span class="p">,</span> <span class="n">ppn</span><span class="o">=</span><span class="n">ppn</span><span class="p">,</span> <span class="n">cpus</span><span class="o">=</span><span class="n">cpus</span><span class="p">)</span></div>


    <span class="c1"># Files:</span>
    <span class="c1">#       - mangadap-{plate}-{ifudesign}-LOG{mode} = script file = *</span>
    <span class="c1">#       - *.ready = script/directory is ready for queue submission</span>
    <span class="c1">#       - *.queued = script submitted to queue</span>
    <span class="c1">#       - *.started = script assigned a node/processor and has started running</span>
    <span class="c1">#       - *.done = completed execution of the full script</span>
    <span class="c1"># Other:</span>
    <span class="c1">#       - *.par = parameter file</span>
    <span class="c1">#       - *.out, *.err = stdout and stderr output from the script</span>
<div class="viewcode-block" id="rundap._fill_queue"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap._fill_queue">[docs]</a>    <span class="k">def</span> <span class="nf">_fill_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drpfiles</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a queue instance, write the script files for all CPUs</span>
<span class="sd">        using :func:`prepare_for_analysis` and append the job to the</span>
<span class="sd">        queue, and then submit the jobs to the cluster queue.  If</span>
<span class="sd">        :attr:`submit` is False, this is essentially a wrapper for</span>
<span class="sd">        :func:`prepare_for_analysis`.</span>

<span class="sd">        This function is written to be functional for submission to the</span>
<span class="sd">        cluster queues both at Utah and using the sciama cluster at</span>
<span class="sd">        Portsmouth.  The available queues are:</span>

<span class="sd">        +-----------+--------+------+-----------+</span>
<span class="sd">        |     Queue |  Nodes |  PPN |   GB/core |</span>
<span class="sd">        +===========+========+======+===========+</span>
<span class="sd">        | sciama1.q |     80 |   12 |         2 |</span>
<span class="sd">        +-----------+--------+------+-----------+</span>
<span class="sd">        | sciama2.q |     96 |   16 |         4 |</span>
<span class="sd">        +-----------+--------+------+-----------+</span>
<span class="sd">        | sciama3.q |     48 |   20 |       3.2 |</span>
<span class="sd">        +-----------+--------+------+-----------+</span>

<span class="sd">        One should **not** submit to sciama3.q without permission from</span>
<span class="sd">        Will Percival.  The default queue is cluster.q (sciama2.q); so</span>
<span class="sd">        basically only use :attr:`q` to select sciama1.q.</span>

<span class="sd">        Submissions to Utah should have their queue destination set to</span>
<span class="sd">        None.  However, the fast node can be selected using :attr:`qos`.</span>

<span class="sd">        .. todo::</span>
<span class="sd">            - This algorithm is slow because it has to search through</span>
<span class="sd">              the drpcomplete fits file each time to find the</span>
<span class="sd">              plate/ifudesign combo.  Should make this more efficient.</span>

<span class="sd">        Args:</span>
<span class="sd">            drpfiles (list): The list of DRP file objects that define</span>
<span class="sd">                the DRP fits files to analyze.</span>
<span class="sd">            clobber (bool): (**Optional**) Overwrite any existing script</span>
<span class="sd">                files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If submitting to the queue, create the queue object.  The</span>
        <span class="c1"># creation of the queue object is system dependent; however,</span>
        <span class="c1"># once created, the queue object is treated identically for both</span>
        <span class="c1"># the Utah and Portsmouth clusters.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>
       
        <span class="c1"># Create the script files, regardless of whether or not they are</span>
        <span class="c1"># submitted to the queue, appending the scripts to the queue if</span>
        <span class="c1"># they are to be submitted</span>
        <span class="n">ndrp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">drpfiles</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">drpf</span> <span class="ow">in</span> <span class="n">drpfiles</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="p">,</span> <span class="n">stdoutfile</span><span class="p">,</span> <span class="n">stderrfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_for_analysis</span><span class="p">(</span><span class="n">drpf</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;source </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">stdoutfile</span><span class="p">,</span>
                                  <span class="n">errfile</span><span class="o">=</span><span class="n">stderrfile</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_pltifu_status</span><span class="p">(</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span> <span class="n">drpf</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;queued&#39;</span><span class="p">)</span>
                                        <span class="c1">#, mode=drpf.mode</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Preparing for analysis...</span><span class="si">{0:.1f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">ndrp</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Preparing for analysis...</span><span class="si">{0:.1f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span></div>
        

    <span class="c1"># ******************************************************************</span>
    <span class="c1">#  MaNGA DAP RUN-MODE ROUTINES</span>
    <span class="c1"># ******************************************************************</span>
<div class="viewcode-block" id="rundap.run_daily"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.run_daily">[docs]</a>    <span class="k">def</span> <span class="nf">run_daily</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check for and analyze DRP files that have been produced through</span>
<span class="sd">        the 3D stage.  Ideally, this is automatically run by crontab.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: *Always* raised because daily mode is currently</span>
<span class="sd">                unavailable for the DAP.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Until correctly implemented, raise an exception if this mode</span>
        <span class="c1"># is called.</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Daily mode (-d,--daily) not yet implemented.&#39;</span><span class="p">)</span>

        <span class="c1"># Daily analyses forced to use the sdss-fast node and only that</span>
        <span class="c1"># node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qos</span><span class="o">=</span><span class="s1">&#39;sdss-fast&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_daily&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># Select the daily DRP files and write the script files (do not</span>
        <span class="c1"># clobber)</span>
        <span class="n">drpfiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_daily</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of DRP files to process: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">drpfiles</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drpfiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Create the script files for the set of drpfiles, and </span>
        <span class="c1"># submit the scripts to the queue if self.submit is true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill_queue</span><span class="p">(</span><span class="n">drpfiles</span><span class="p">)</span></div>


<div class="viewcode-block" id="rundap.run_all"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.run_all">[docs]</a>    <span class="k">def</span> <span class="nf">run_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze all existing DRP files.  This mode is called manually.</span>
<span class="sd">   </span>
<span class="sd">        Args:</span>
<span class="sd">            clobber (bool): (**Optional**) If True, all analyses will be</span>
<span class="sd">                run, regardless of their current state.  If false, only</span>
<span class="sd">                those analyses not currently running or done will be</span>
<span class="sd">                performed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Raised if qos is requested; this mode is only</span>
<span class="sd">                allowed for the daily run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_clobber&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span> <span class="k">if</span> <span class="n">clobber</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_all&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># In here, qos should never be anything but None; always set in daily</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;This qos is reserved for single-node usage.&#39;</span><span class="p">)</span>

        <span class="n">drpfiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_all</span><span class="p">(</span><span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of DRP files to process: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">drpfiles</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drpfiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Create the script files for the set of drpfiles, and </span>
        <span class="c1"># submit the scripts to the queue if self.submit is true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill_queue</span><span class="p">(</span><span class="n">drpfiles</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">)</span></div>


<div class="viewcode-block" id="rundap.run_redo"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.run_redo">[docs]</a>    <span class="k">def</span> <span class="nf">run_redo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redo a selected set of analyses using the input plate,</span>
<span class="sd">        ifudesign, and mode lists.  This mode **automatically** clobbers</span>
<span class="sd">        any existing results and is called manually.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Raised if qos is requested; this mode is only</span>
<span class="sd">                allowed for the daily run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_redo&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
<span class="c1">#        # In here, qos should never be anything but None; always set in daily</span>
<span class="c1">#        if self.qos is not None:</span>
<span class="c1">#            raise ValueError(&#39;This qos is reserved for single-node usage.&#39;)</span>

        <span class="n">drpfiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_redo</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of DRP files to process: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">drpfiles</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drpfiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>       <span class="c1"># If coded correctly, this function should never return here.</span>

        <span class="c1"># Create the script files for the set of drpfiles, and </span>
        <span class="c1"># submit the scripts to the queue if self.submit is true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill_queue</span><span class="p">(</span><span class="n">drpfiles</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


    <span class="c1"># ******************************************************************</span>
    <span class="c1"># Management</span>
    <span class="c1"># ******************************************************************</span>
<div class="viewcode-block" id="rundap.set_pltifu_status"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.set_pltifu_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_pltifu_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;queued&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a touch file that signifies the status for a given</span>
<span class="sd">        plate/ifudesign/mode.  The root of the touch file is set by</span>
<span class="sd">        :func:`mangadap.config.defaults.default_dap_file_root`.</span>

<span class="sd">        Args:</span>
<span class="sd">            plate (int): Plate number</span>
<span class="sd">            ifudesign (int): IFU design number</span>
<span class="sd">            mode (str): (**Optional**) DRP 3D mode, &#39;RSS&#39; or &#39;CUBE&#39;</span>
<span class="sd">            status (str): (**Optional**) That status signifier for the</span>
<span class="sd">                touch file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the name of the status file        </span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">default_dap_file_root</span><span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calling_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">plate</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ifudesign</span><span class="p">),</span> <span class="n">root</span><span class="p">),</span>
                        <span class="n">status</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="rundap.set_status"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.set_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;queued&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a general touch file.</span>

<span class="sd">        Args:</span>
<span class="sd">            root (str): Full path and root name of the touch file</span>
<span class="sd">            status (str): (**Optional**) That status signifier for the</span>
<span class="sd">                touch file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Touch the file by opening and closing it</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">status</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="rundap.dap_complete"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.dap_complete">[docs]</a>    <span class="k">def</span> <span class="nf">dap_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drpf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the DAP has finished working on a given DRP file.</span>

<span class="sd">        Conditions that the DAP has completes its processing of the</span>
<span class="sd">        given DRP file:</span>

<span class="sd">            - the output path for the DAP file exists</span>
<span class="sd">            - within the path, the \*.done touch file exits</span>

<span class="sd">        .. todo::</span>

<span class="sd">            - Add whether or not the DAP ended in error</span>

<span class="sd">        Args:</span>
<span class="sd">            drpf (:class:`mangadap.drpfits.DRPFits`) : DRP file object</span>
<span class="sd">                used to pass the plate, ifudesign, and mode values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Flag that the DAP has finished (True) or not (False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">default_dap_common_path</span><span class="p">(</span><span class="n">plate</span><span class="o">=</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span> <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span>
                                       <span class="n">dapver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">root</span> <span class="o">=</span> <span class="n">default_dap_file_root</span><span class="p">(</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span> <span class="n">drpf</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span> <span class="n">drpf</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
<span class="c1">#        print(root)</span>
        <span class="n">donefile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.done&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">root</span><span class="p">))</span>
<span class="c1">#        print(donefile)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">donefile</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="rundap.select_daily"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.select_daily">[docs]</a>    <span class="k">def</span> <span class="nf">select_daily</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select the drp files created today.</span>
<span class="sd">       </span>
<span class="sd">        .. todo::</span>

<span class="sd">            - This selection is correctly implemented.  It should not</span>
<span class="sd">              just look for DRP files created in the same day as the</span>
<span class="sd">              execution of the script.  It should look for anything</span>
<span class="sd">              created based on newly created DRP files.  This could be</span>
<span class="sd">              very close to the combination of all=True, clobber=False.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: **Always** raised because function is not</span>
<span class="sd">                correctly implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: This selection is incorrectly implemented!</span>
        <span class="c1"># &quot;created_today&quot; is not the correct selection criterion</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;select_daily() routine not correctly implemented yet.&#39;</span><span class="p">)</span>

        <span class="n">drplist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_drpfile_list</span><span class="p">()</span>
        <span class="n">n_drp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">drplist</span><span class="p">)</span>
<span class="c1">#       print(n_drp)</span>
<span class="c1">#       for i in range(0,n_drp):</span>
<span class="c1">#           print(drplist[i].file_name())</span>
<span class="c1">#           print(drplist[i].created_today())</span>

        <span class="c1"># Select the files created today</span>
        <span class="k">return</span> <span class="p">[</span> <span class="n">drplist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_drp</span><span class="p">)</span> <span class="k">if</span> <span class="n">drplist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">created_today</span><span class="p">()</span> <span class="p">]</span></div>


<div class="viewcode-block" id="rundap.select_all"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.select_all">[docs]</a>    <span class="k">def</span> <span class="nf">select_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select all the DRP files.  If clobber=False, omit files that</span>
<span class="sd">        have completed a run of DAP analysis.</span>

<span class="sd">        Args:</span>
<span class="sd">            clobber (bool): (**Optional**) Overwrite any existing</span>
<span class="sd">                analysis output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of :class:`mangadap.drpfits.DRPFits` objects</span>
<span class="sd">            defining the DRP files that should be analyzed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get the full list of available DRP files that can be processed</span>
        <span class="c1"># by the DAP</span>
        <span class="n">drplist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_drpfile_list</span><span class="p">()</span>

        <span class="n">n_drp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">drplist</span><span class="p">)</span>
<span class="c1">#       print(n_drp)</span>
<span class="c1">#       for i in range(0,n_drp):</span>
<span class="c1">#           print(drplist[i].file_path())</span>
<span class="c1">#           print(self.dap_complete(drplist[i]))</span>

        <span class="c1"># If clobbering, just return the full list</span>
        <span class="k">if</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">drplist</span>

        <span class="c1"># If clobbering is off, only return those that are not complete</span>
        <span class="k">return</span> <span class="p">[</span> <span class="n">drplist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_drp</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dap_complete</span><span class="p">(</span><span class="n">drplist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">]</span></div>


<div class="viewcode-block" id="rundap.select_redo"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.select_redo">[docs]</a>    <span class="k">def</span> <span class="nf">select_redo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of the DRP selected using the provided plates,</span>
<span class="sd">        ifudesigns, and modes.  By using this function, clobber is</span>
<span class="sd">        implicitly True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of :class:`mangadap.drpfits.DRPFits` objects</span>
<span class="sd">            defining the DRP files that should be analyzed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_drpfile_list</span><span class="p">()</span></div>


<div class="viewcode-block" id="rundap.full_drpfile_list"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.full_drpfile_list">[docs]</a>    <span class="k">def</span> <span class="nf">full_drpfile_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a list of all the DRP files based on the</span>
<span class="sd">        :class:`mangadap.survey.drpcomplete.DRPComplete` database.  DRP</span>
<span class="sd">        files constructed based on the</span>
<span class="sd">        :class:`mangadap.survey.drpcomplete.DRPComplete` database are</span>
<span class="sd">        expected to exist.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of :class:`mangadap.drpfits.DRPFits` objects</span>
<span class="sd">            defining the available DRP files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Number of plates (CUBE only)</span>
        <span class="n">n_plates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">nobs</span>
<span class="c1">#        for i in range(n_plates):</span>
<span class="c1">#            print(&#39;{0:&gt;5} {1:&gt;5} {2:&gt;10} {3:&gt;10} {4:&gt;10} {5:9.1f}&#39;.format(self.drpc[&#39;PLATE&#39;][i],</span>
<span class="c1">#                                                            self.drpc[&#39;IFUDESIGN&#39;][i],</span>
<span class="c1">#                                                            self.drpc[&#39;MANGAID&#39;][i],</span>
<span class="c1">#                                                            self.drpc[&#39;MANGA_TARGET1&#39;][i],</span>
<span class="c1">#                                                            self.drpc[&#39;MANGA_TARGET3&#39;][i],</span>
<span class="c1">#                                                            self.drpc[&#39;VEL&#39;][i]))</span>

        <span class="c1"># Create the list of CUBE DRP files</span>
        <span class="n">drplist</span> <span class="o">=</span> <span class="p">[</span> <span class="n">DRPFits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="p">[</span><span class="s1">&#39;PLATE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="p">[</span><span class="s1">&#39;IFUDESIGN&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;CUBE&#39;</span><span class="p">,</span>
                            <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="n">redux_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span><span class="p">)</span> \
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_plates</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">can_analyze</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">i</span><span class="p">)</span> <span class="p">]</span>

        <span class="c1"># Add the list of RSS DRP files</span>
        <span class="n">drplist</span> <span class="o">=</span> <span class="n">drplist</span> <span class="o">+</span> <span class="p">[</span> <span class="n">DRPFits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="p">[</span><span class="s1">&#39;PLATE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="p">[</span><span class="s1">&#39;IFUDESIGN&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                      <span class="s1">&#39;RSS&#39;</span><span class="p">,</span> <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="n">redux_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_plates</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">can_analyze</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="p">[</span><span class="s1">&#39;MODES&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">drplist</span></div>


<div class="viewcode-block" id="rundap.selected_drpfile_list"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.selected_drpfile_list">[docs]</a>    <span class="k">def</span> <span class="nf">selected_drpfile_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a list of all the DRP files based on the provided</span>
<span class="sd">        plates, ifudesigns, and modes, using the</span>
<span class="sd">        :class:`mangadap.survey.drpcomplete.DRPComplete` database.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of :class:`mangadap.drpfits.DRPFits` objects</span>
<span class="sd">            defining the selected DRP files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Number of plates (CUBE only); self.drpc.platelist and</span>
        <span class="c1"># self.drpc.ifudesignlist should be the same size!</span>
        <span class="n">n_plates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">platelist</span><span class="p">)</span>

        <span class="c1"># Get the list of CUBE DRP files, if requested (implicitly or</span>
        <span class="c1"># otherwise)</span>
        <span class="n">getcube</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;CUBE&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c1"># as e:</span>
                <span class="n">getcube</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">drplist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">getcube</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_plates</span><span class="p">):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">entry_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">platelist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">ifudesignlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">can_analyze</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">j</span><span class="p">):</span>
                    <span class="n">drplist</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">DRPFits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">platelist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">ifudesignlist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;CUBE&#39;</span><span class="p">,</span>
                                 <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="n">redux_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span><span class="p">)</span> <span class="p">]</span>

        <span class="c1"># Add the list of RSS DRP files, if requested (implicitly or</span>
        <span class="c1"># otherwise)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;RSS&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c1">#as e:</span>
                <span class="k">return</span> <span class="n">drplist</span>                  <span class="c1"># List complete</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_plates</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">entry_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">platelist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">ifudesignlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">can_analyze</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">j</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="p">[</span><span class="s1">&#39;MODES&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">drplist</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">DRPFits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">platelist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">ifudesignlist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;RSS&#39;</span><span class="p">,</span>
                             <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="n">redux_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span><span class="p">)</span> <span class="p">]</span>

        <span class="k">return</span> <span class="n">drplist</span></div>


<div class="viewcode-block" id="rundap.write_compute_script"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.write_compute_script">[docs]</a>    <span class="k">def</span> <span class="nf">write_compute_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dapproc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">relative_symlink</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the MaNGA DAP script file that is sent to a single CPU to</span>
<span class="sd">        analyze a single DRP file with a given plate, ifudesign, and</span>
<span class="sd">        mode.</span>

<span class="sd">        Args:</span>
<span class="sd">            plate (int): Plate number</span>
<span class="sd">            ifudesign (int): IFU design number</span>
<span class="sd">            mode (int): DRP 3D mode (&#39;RSS&#39; or &#39;CUBE&#39;)</span>
<span class="sd">            dapproc (bool): (**Optional**) Flag to execute the main DAP</span>
<span class="sd">                processing. Default is True.</span>
<span class="sd">            plots (bool): (**Optional**) Create the QA plots. Default is</span>
<span class="sd">                True.</span>
<span class="sd">            clobber (bool): (**Optional**) Flag to clobber any existing</span>
<span class="sd">                files.</span>
<span class="sd">            relative_symlink (bool): (**Optional**) Set the symlink to</span>
<span class="sd">                the par file to be a relative path instead of the</span>
<span class="sd">                absolute path.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Three strings with the name of the written script file,</span>
<span class="sd">            the file for the output sent to STDOUT, and the file for the</span>
<span class="sd">            output sent to STDERR.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Raised if DAP version is not correctly defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check that the path exists, creating it if not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_paths</span><span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="p">)</span>

        <span class="c1"># Create the parameter file</span>
        <span class="n">parfile</span> <span class="o">=</span> <span class="n">default_dap_par_file</span><span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span>
                                       <span class="n">dapver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">)</span>
        <span class="c1"># Write the par file if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">parfile</span><span class="p">)</span> <span class="ow">or</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="c1"># clobber defaults to True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drpc</span><span class="o">.</span><span class="n">write_par</span><span class="p">(</span><span class="n">parfile</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">plate</span><span class="o">=</span><span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="o">=</span><span class="n">ifudesign</span><span class="p">)</span>
            <span class="c1"># and create symlinks to it</span>
            <span class="n">plan</span> <span class="o">=</span> <span class="n">AnalysisPlanSet</span><span class="o">.</span><span class="n">from_par_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span><span class="p">)</span>
            <span class="n">nplan</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">nplans</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nplan</span><span class="p">):</span>
                <span class="c1"># Generate the ref subdirectory for this plan</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">default_dap_method_path</span><span class="p">(</span><span class="n">default_dap_method</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">plan</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">plate</span><span class="o">=</span><span class="n">plate</span><span class="p">,</span>
                                               <span class="n">ifudesign</span><span class="o">=</span><span class="n">ifudesign</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                               <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span>
                                               <span class="n">analysis_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">)</span>
                <span class="n">create_symlink</span><span class="p">(</span><span class="n">parfile</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">relative_symlink</span><span class="o">=</span><span class="n">relative_symlink</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">,</span>
                               <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#        # Generate the DRP input and DAP output paths, and the DAP</span>
<span class="c1">#        # source path</span>
<span class="c1">#        drppath = default_drp_directory_path(plate, drpver=self.mpl.drpver,</span>
<span class="c1">#                                             redux_path=self.redux_path)</span>
<span class="c1">#        output_path = default_dap_common_path(plate=plate, ifudesign=ifudesign,</span>
<span class="c1">#                                              drpver=self.mpl.drpver, dapver=self.dapver,</span>
<span class="c1">#                                              analysis_path=self.analysis_path)</span>
<span class="c1">#        dap_source = default_dap_source()</span>

        <span class="c1"># Set the root path for the scripts, inputs, outputs, and logs</span>
        <span class="n">_calling_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calling_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">plate</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ifudesign</span><span class="p">))</span>

        <span class="n">scr_file_root</span> <span class="o">=</span> <span class="n">default_dap_file_root</span><span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="p">)</span><span class="c1">#, mode)</span>

        <span class="c1"># TODO: Why is this check here?!?</span>
        <span class="c1"># Get module name and fault if no module version is available</span>
        <span class="n">module_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dapver</span>
        <span class="k">if</span> <span class="n">module_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No DAP module version!&#39;</span><span class="p">)</span>
        
        <span class="c1"># Set the names for the script, stdout, and stderr files</span>
        <span class="n">scriptfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_calling_path</span><span class="p">,</span> <span class="n">scr_file_root</span><span class="p">)</span>
        <span class="n">stdoutfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.out&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">)</span>
        <span class="n">stderrfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.err&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">)</span>

        <span class="c1">################################################################</span>
        <span class="c1"># Script file already exists, so just return</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">scriptfile</span><span class="p">,</span> <span class="n">stdoutfile</span><span class="p">,</span> <span class="n">stderrfile</span>

        <span class="c1"># Main script components are:</span>
        <span class="c1">#   - (dapproc) Run the DAP processing code:</span>
        <span class="c1">#       - copy/create the plan file</span>
        <span class="c1">#       - execute the manga_dap via IDL</span>
        <span class="c1">#   - (plots) Run the plotting scripts to plot the output</span>
        <span class="c1"># ONE OF THESE 2 MUST BE TRUE</span>

        <span class="c1">################################################################</span>
        <span class="c1"># Open the script file and write the date as a commented header</span>
        <span class="c1"># line</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Auto-generated batch file</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S&quot;</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Create the started touch file</span>
        <span class="n">startfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.started&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;touch </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">startfile</span><span class="p">))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Command that runs the DAP</span>
        <span class="k">if</span> <span class="n">dapproc</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;manga_dap </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> -r </span><span class="si">{2}</span><span class="s1"> -a </span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span><span class="p">,</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; --log </span><span class="si">{0}</span><span class="s1">.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; -&#39;</span><span class="o">+</span><span class="s1">&#39;v&#39;</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>

<span class="c1">#            # Create/Copy the plan file</span>
<span class="c1">#            if self.plan_file is None:</span>
<span class="c1">#                # Will create and use the default plan</span>
<span class="c1">#                file.write(&#39;echo \&quot; manga_dap, par=\&#39;{0}\&#39;, drppath=\&#39;{1}\&#39;, dappath=\&#39;{2}\&#39;, &#39; \</span>
<span class="c1">#                           &#39;/nolog\&quot; | {3} \n&#39;.format(parfile, drppath, self.analysis_path,</span>
<span class="c1">#                           self.idl_cmnd))</span>
<span class="c1">#            else:</span>
<span class="c1">#                # Will use the provided plan file, but first copy it for</span>
<span class="c1">#                # documentation purposes</span>
<span class="c1">#                default_plan_file = default_dap_plan_file(self.mpl.drpver, self.dapver,</span>
<span class="c1">#                                                          self.analysis_path, None, plate,</span>
<span class="c1">#                                                          ifudesign, mode)</span>
<span class="c1">#                file.write(&#39;\cp -rf {0} {1}\n&#39;.format(self.plan_file, default_plan_file))</span>
<span class="c1">#                file.write(&#39;\n&#39;)</span>
<span class="c1">#                # Change the prior if requested</span>
<span class="c1">#                if self.prior_mode is not None:</span>
<span class="c1">#                    prior_file = default_dap_file_name(plate, ifudesign, self.prior_mode,</span>
<span class="c1">#                                                       self.prior_bin, self.prior_iter)</span>
<span class="c1">#                    prior_file = os.path.join(output_path, prior_file)</span>
<span class="c1">#                    scr = os.path.join(dap_source, &#39;bin&#39;, &#39;edit_dap_plan&#39;)</span>
<span class="c1">#                    file.write(&#39;{0} {1} analysis_prior {2} {3}\n&#39;.format(scr, default_plan_file,</span>
<span class="c1">#                                                                        self.prior_old, prior_file))</span>
<span class="c1">#                    file.write(&#39;\n&#39;)</span>
<span class="c1">#</span>
<span class="c1">#                file.write(&#39;echo \&quot; resolve_all, resolve_procedure=\&#39;manga_dap\&#39; &amp; manga_dap, &#39; \</span>
<span class="c1">#                           &#39;par=\&#39;{0}\&#39;, plan=\&#39;{1}\&#39;, drppath=\&#39;{2}\&#39;, dappath=\&#39;{3}\&#39;, /nolog \&quot;&#39;</span>
<span class="c1">#                           &#39; | {4} \n&#39;.format(parfile, default_plan_file, drppath,</span>
<span class="c1">#                                              self.analysis_path, self.idl_cmnd))</span>
<span class="c1">#</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Plotting scripts</span>
        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
<span class="c1">#            file.write(&#39;# No plotting scripts yet\n&#39;)</span>
<span class="c1">#            pylist_path = os.path.join(dap_source, &#39;python&#39;, &#39;mangadap&#39;, &#39;plot&#39;,</span>
<span class="c1">#                                       &#39;make_qa_file_list.py&#39;)</span>
<span class="c1">#            file.write(&#39;python3 {0} {1} {2} {3}_files_to_plot.txt -overwrite \n&#39;.format(pylist_path,</span>
<span class="c1">#                       output_path, mode, mode))</span>
<span class="c1">#            file.write(&#39;\n&#39;)</span>
<span class="c1">#</span>
<span class="c1">#            pyplot_path = os.path.join(dap_source, &#39;python&#39;, &#39;mangadap&#39;, &#39;plot&#39;, &#39;plotqa.py&#39;)</span>
<span class="c1">#            file.write(&#39;python3 {0} {1}/{2}_files_to_plot.txt dapqa_plottypes.ini \n&#39;.format(</span>
<span class="c1">#                                    pyplot_path, output_path, mode))</span>
            
            <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;ppxffit_qa </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> --analysis_path </span><span class="si">{2}</span><span class="s1"> --plan_file </span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;spotcheck_dap_maps </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> --analysis_path </span><span class="si">{2}</span><span class="s1"> --plan_file </span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Touch the done file</span>
        <span class="n">donefile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.done&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;touch </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">donefile</span><span class="p">))</span>

        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1">################################################################</span>

        <span class="c1"># Return the script file, file for stdout, and file for stderr</span>
        <span class="k">return</span> <span class="n">scriptfile</span><span class="p">,</span> <span class="n">stdoutfile</span><span class="p">,</span> <span class="n">stderrfile</span></div>
    

<div class="viewcode-block" id="rundap.prepare_for_analysis"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.prepare_for_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_for_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drpf</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the provided DRP file for analysis by setting up the</span>
<span class="sd">        output path, writing the input parameter file, writing the</span>
<span class="sd">        compute script, and setting the status to &quot;ready&quot;, assuming the</span>
<span class="sd">        above steps are completed successfully.</span>

<span class="sd">        Args:</span>
<span class="sd">            drpf (:class:`mangadap.drpfits.DRPFits`): Object defining</span>
<span class="sd">                the DRP file to analyze.</span>
<span class="sd">            clobber (bool): (**Optional**) Flag to overwrite any</span>
<span class="sd">                existing files.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Three strings with the name of the written script file,</span>
<span class="sd">            the file for the output sent to STDOUT, and the file for the</span>
<span class="sd">            output sent to STDERR, as provided by the call to</span>
<span class="sd">            :func:`write_compute_script`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Check that *.ready file exists?</span>
        
        <span class="c1"># Write the compute script (write_compute_script also checks the</span>
        <span class="c1"># path exists!)</span>
        <span class="n">sf</span><span class="p">,</span> <span class="n">of</span><span class="p">,</span> <span class="n">ef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_compute_script</span><span class="p">(</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span> <span class="n">drpf</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span> <span class="n">drpf</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                                               <span class="n">dapproc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapproc</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plots</span><span class="p">,</span>
                                               <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">)</span>
<span class="c1">#        try:</span>
<span class="c1">#            sf, of, ef = self.write_compute_script(drpf.plate, drpf.ifudesign, drpf.mode,</span>
<span class="c1">#                                                   dapproc=self.dapproc, plots=self.plots,</span>
<span class="c1">#                                                   clobber=clobber)</span>
<span class="c1">#        except:</span>
<span class="c1">#            e = sys.exc_info()</span>
<span class="c1">#            print_frame(e[0])</span>
<span class="c1">#            warnings.warn(&#39;Problem writing compute script:: {0}: {1}.  Continuing...&#39;.format(</span>
<span class="c1">#                                                                                        e[1], e[2]))</span>
<span class="c1">#            return None, None, None</span>

        <span class="c1"># Set the status to ready</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_pltifu_status</span><span class="p">(</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span> <span class="n">drpf</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ready&#39;</span><span class="p">)</span> <span class="c1">#, mode=drpf.mode</span>

        <span class="c1"># Return the list of script, stdout, and stderr files</span>
        <span class="k">return</span> <span class="n">sf</span><span class="p">,</span> <span class="n">of</span><span class="p">,</span> <span class="n">ef</span></div>


<div class="viewcode-block" id="rundap.write_dapall_script"><a class="viewcode-back" href="../../../mangadap.survey.rundap.html#mangadap.survey.rundap.rundap.write_dapall_script">[docs]</a>    <span class="k">def</span> <span class="nf">write_dapall_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the script used to construct the DAPall file and its</span>
<span class="sd">        associated quality assessment plots.</span>

<span class="sd">        Args:</span>
<span class="sd">            plots (bool): (**Optional**) Create the QA plots. Default is</span>
<span class="sd">                True.</span>
<span class="sd">            clobber (bool): (**Optional**) Flag to clobber any existing</span>
<span class="sd">                files.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Three strings with the name of the written script file,</span>
<span class="sd">            the file for the output sent to STDOUT, and the file for the</span>
<span class="sd">            output sent to STDERR.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Raised if DAP version is not correctly defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check that the path exists, creating it if not</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calling_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calling_path</span><span class="p">)</span>
        
        <span class="c1"># Set the names for the script, stdout, and stderr files</span>
        <span class="n">scriptfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calling_path</span><span class="p">,</span> <span class="s1">&#39;dapall&#39;</span><span class="p">)</span>
        <span class="n">stdoutfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.out&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">)</span>
        <span class="n">stderrfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.err&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">)</span>

        <span class="c1"># Script file already exists, so just return</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">scriptfile</span><span class="p">,</span> <span class="n">stdoutfile</span><span class="p">,</span> <span class="n">stderrfile</span>

        <span class="c1"># Open the script file and write the date as a commented header</span>
        <span class="c1"># line</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Auto-generated batch file</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S&quot;</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Create the started touch file</span>
        <span class="n">startfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.started&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;touch </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">startfile</span><span class="p">))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Command that constructs the DAPall file</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;construct_dapall </span><span class="si">{0}</span><span class="s1"> --drpver </span><span class="si">{1}</span><span class="s1"> -r </span><span class="si">{2}</span><span class="s1"> --dapver </span><span class="si">{3}</span><span class="s1"> -a </span><span class="si">{4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">plan_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; -&#39;</span><span class="o">+</span><span class="s1">&#39;v&#39;</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">#        # Add the plotting commands</span>
<span class="c1">#        if plots:</span>
<span class="c1">#            command = &#39;ppxffit_qa {0} {1} --analysis_path {2} --plan_file {3}&#39;.format(</span>
<span class="c1">#                            plate, ifudesign, self.analysis_path, self.plan_file)</span>
<span class="c1">#            file.write(&#39;{0}\n&#39;.format(command))</span>
<span class="c1">#            file.write(&#39;\n&#39;)</span>
<span class="c1">#</span>
<span class="c1">#            command = &#39;spotcheck_dap_maps {0} {1} --analysis_path {2} --plan_file {3}&#39;.format(</span>
<span class="c1">#                            plate, ifudesign, self.analysis_path, self.plan_file)</span>
<span class="c1">#            file.write(&#39;{0}\n&#39;.format(command))</span>
<span class="c1">#            file.write(&#39;\n&#39;)</span>

        <span class="c1"># Touch the done file</span>
        <span class="n">donefile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.done&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;touch </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">donefile</span><span class="p">))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1">################################################################</span>

        <span class="c1"># Return the script file, file for stdout, and file for stderr</span>
        <span class="k">return</span> <span class="n">scriptfile</span><span class="p">,</span> <span class="n">stdoutfile</span><span class="p">,</span> <span class="n">stderrfile</span></div></div>
    



</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, SDSS-IV/MaNGA Pipeline Group.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'2.2.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>