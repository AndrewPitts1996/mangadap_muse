

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mangadap.survey.dapall &mdash; mangadap 2.2.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="mangadap 2.2.2 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> mangadap
          

          
          </a>

          
            
            
              <div class="version">
                2.2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mangadap.html">mangadap package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mangadap</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>mangadap.survey.dapall</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mangadap.survey.dapall</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Defines the class that constructs the DAPall summary table.</span>

<span class="sd">This is a post processing script that **must** be run after the DRPall</span>
<span class="sd">file is created.</span>

<span class="sd">*License*:</span>
<span class="sd">    Copyright (c) 2017, SDSS-IV/MaNGA Pipeline Group</span>
<span class="sd">        Licensed under BSD 3-clause license - see LICENSE.rst</span>

<span class="sd">*Source location*:</span>
<span class="sd">    $MANGADAP_DIR/python/mangadap/dapall.py</span>

<span class="sd">*Imports and python version compliance*:</span>
<span class="sd">    ::</span>

<span class="sd">        from __future__ import division</span>
<span class="sd">        from __future__ import print_function</span>
<span class="sd">        from __future__ import absolute_import</span>
<span class="sd">        from __future__ import unicode_literals</span>

<span class="sd">        import sys</span>
<span class="sd">        if sys.version &gt; &#39;3&#39;:</span>
<span class="sd">            long = int</span>

<span class="sd">        import numpy</span>
<span class="sd">        import logging</span>
<span class="sd">        import time</span>
<span class="sd">        import os</span>

<span class="sd">        from scipy import interpolate</span>

<span class="sd">        from astropy.io import fits</span>
<span class="sd">        import astropy.constants</span>
<span class="sd">        from astropy.cosmology import FlatLambdaCDM</span>
<span class="sd">        import astropy.units</span>
<span class="sd">        from astropy.stats import sigma_clip</span>

<span class="sd">        from ..drpfits import DRPFits, DRPQuality3DBitMask</span>
<span class="sd">        from ..dapfits import DAPMapsBitMask, DAPQualityBitMask</span>
<span class="sd">        from ..par.analysisplan import AnalysisPlanSet</span>
<span class="sd">        from .drpcomplete import DRPComplete</span>
<span class="sd">        from ..config import defaults</span>
<span class="sd">        from ..util.fileio import init_record_array, rec_to_fits_type, channel_dictionary</span>
<span class="sd">        from ..proc.util import select_proc_method</span>
<span class="sd">        from ..par.absorptionindexdb import AbsorptionIndexDB</span>
<span class="sd">        from ..par.bandheadindexdb import BandheadIndexDB</span>
<span class="sd">        from ..par.emissionlinedb import EmissionLineDB</span>
<span class="sd">        from ..proc.spectralindices import SpectralIndicesDef, available_spectral_index_databases</span>
<span class="sd">        from ..proc.emissionlinemodel import EmissionLineModelDef</span>
<span class="sd">        from ..proc.emissionlinemodel import available_emission_line_modeling_methods</span>

<span class="sd">*Class usage examples*:</span>
<span class="sd">    Add some usage comments here!</span>

<span class="sd">*Revision history*:</span>
<span class="sd">    | **19 Aug 2016**: Original Implementation by K. Westfall (KBW)</span>
<span class="sd">    | **29 Sep 2017**: (KBW) Force the number of emission-line</span>
<span class="sd">        passbands, emission-lines to fit, and spectral indices to be the</span>
<span class="sd">        same for all analysis methods.</span>

<span class="sd">.. _astropy.io.fits.open: http://docs.astropy.org/en/stable/io/fits/api/files.html#astropy.io.fits.open</span>
<span class="sd">.. _astropy.io.fits.hdu.hdulist.HDUList: http://docs.astropy.org/en/v1.0.2/io/fits/api/hdulists.html</span>
<span class="sd">.. _astropy.cosmology.FlatLambdaCDM: http://docs.astropy.org/en/stable/api/astropy.cosmology.FlatLambdaCDM.html#flatlambdacdm</span>
<span class="sd">.. _logging.Logger: https://docs.python.org/3/library/logging.html</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
    <span class="n">long</span> <span class="o">=</span> <span class="nb">int</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">astropy.constants</span>
<span class="kn">from</span> <span class="nn">astropy.cosmology</span> <span class="k">import</span> <span class="n">FlatLambdaCDM</span>
<span class="kn">import</span> <span class="nn">astropy.units</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="k">import</span> <span class="n">sigma_clip</span>

<span class="kn">from</span> <span class="nn">.drpcomplete</span> <span class="k">import</span> <span class="n">DRPComplete</span>
<span class="kn">from</span> <span class="nn">..drpfits</span> <span class="k">import</span> <span class="n">DRPFits</span><span class="p">,</span> <span class="n">DRPQuality3DBitMask</span>
<span class="kn">from</span> <span class="nn">..dapfits</span> <span class="k">import</span> <span class="n">DAPMapsBitMask</span><span class="p">,</span> <span class="n">DAPQualityBitMask</span>
<span class="kn">from</span> <span class="nn">..config</span> <span class="k">import</span> <span class="n">defaults</span>
<span class="kn">from</span> <span class="nn">..util.fileio</span> <span class="k">import</span> <span class="n">init_record_array</span><span class="p">,</span> <span class="n">rec_to_fits_type</span><span class="p">,</span> <span class="n">channel_dictionary</span><span class="p">,</span> <span class="n">channel_units</span>
<span class="kn">from</span> <span class="nn">..util.fitsutil</span> <span class="k">import</span> <span class="n">DAPFitsUtil</span>
<span class="kn">from</span> <span class="nn">..util.log</span> <span class="k">import</span> <span class="n">init_DAP_logging</span><span class="p">,</span> <span class="n">module_logging</span><span class="p">,</span> <span class="n">log_output</span>
<span class="kn">from</span> <span class="nn">..par.analysisplan</span> <span class="k">import</span> <span class="n">AnalysisPlanSet</span>
<span class="kn">from</span> <span class="nn">..par.absorptionindexdb</span> <span class="k">import</span> <span class="n">AbsorptionIndexDB</span>
<span class="kn">from</span> <span class="nn">..par.bandheadindexdb</span> <span class="k">import</span> <span class="n">BandheadIndexDB</span>
<span class="kn">from</span> <span class="nn">..par.emissionlinedb</span> <span class="k">import</span> <span class="n">EmissionLineDB</span>
<span class="kn">from</span> <span class="nn">..par.emissionmomentsdb</span> <span class="k">import</span> <span class="n">EmissionMomentsDB</span>
<span class="kn">from</span> <span class="nn">..proc.util</span> <span class="k">import</span> <span class="n">select_proc_method</span><span class="p">,</span> <span class="n">sample_growth</span>
<span class="kn">from</span> <span class="nn">..proc.emissionlinemoments</span> <span class="k">import</span> <span class="n">EmissionLineMomentsDef</span>
<span class="kn">from</span> <span class="nn">..proc.emissionlinemoments</span> <span class="k">import</span> <span class="n">available_emission_line_moment_databases</span>
<span class="kn">from</span> <span class="nn">..proc.emissionlinemodel</span> <span class="k">import</span> <span class="n">EmissionLineModelDef</span>
<span class="kn">from</span> <span class="nn">..proc.emissionlinemodel</span> <span class="k">import</span> <span class="n">available_emission_line_modeling_methods</span>
<span class="kn">from</span> <span class="nn">..proc.spectralindices</span> <span class="k">import</span> <span class="n">SpectralIndicesDef</span><span class="p">,</span> <span class="n">available_spectral_index_databases</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

<div class="viewcode-block" id="DAPall"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall">[docs]</a><span class="k">class</span> <span class="nc">DAPall</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct the summary table information for the DAP.</span>

<span class="sd">    Any observation in the DRPComplete file with:</span>

<span class="sd">        - MaNGAID != &#39;NULL&#39;</span>
<span class="sd">        - MANGA_TARGET1 &gt; 0 or MANGA_TARGET3 &gt; 0</span>
<span class="sd">        - VEL &gt; 0</span>

<span class="sd">    are assumed to have been analyzed by the DAP.  The success flag only</span>
<span class="sd">    checks that the appropriate maps file exists. </span>

<span class="sd">    Args:</span>
<span class="sd">        plan (:class:`mangadap.par.analysisplan.AnalysisPlanSet`): The</span>
<span class="sd">            plan object used by the DAP.</span>
<span class="sd">        methods (str,list): (**Optional**) Specify a set of methods in</span>
<span class="sd">            the DAP plan file to include in the DAPall file.  If not</span>
<span class="sd">            provided, all methods in the plan file are included.</span>
<span class="sd">        drpver (str): (**Optional**) DRP version.  Default determined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_drp_version`.</span>
<span class="sd">        redux_path (str) : (**Optional**) Top-level directory with the</span>
<span class="sd">            DRP products; default is defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_redux_path`.</span>
<span class="sd">        dapver (str): (**Optional**) DAP version.  Default determined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_dap_version`.</span>
<span class="sd">        dapsrc (str): (**Optional**) Source directory of the DAP.</span>
<span class="sd">            Default determined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_dap_source`.</span>
<span class="sd">        analysis_path (str) : (**Optional**) Top-level directory for the DAP</span>
<span class="sd">            output data; default is defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_analysis_path`.</span>
<span class="sd">        readonly(bool): (**Optional**) If it exists, open any existing</span>
<span class="sd">            file and disallow any modifications of the database.</span>
<span class="sd">            Default is to automatically check for any need to update the</span>
<span class="sd">            file.</span>
<span class="sd">        loggers (list): List of `logging.Logger`_ objects used to log</span>
<span class="sd">            progress.</span>
<span class="sd">        quiet (bool): Suppress all terminal and logging output.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: Raised if the input plan is not a</span>
<span class="sd">            :class:`mangadap.par.analysisplan.AnalysisPlanSet` object.</span>
<span class="sd">        FileNotFoundError: Raise if the DRPall or the DRPComplete file</span>
<span class="sd">            are not available.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        drpver (str): DRP version</span>
<span class="sd">        redux_path (str): Path to top-level redux directory</span>
<span class="sd">        dapsrc (str): Path to DAP source distribution</span>
<span class="sd">        dapver (str): DAP version</span>
<span class="sd">        analysis_path (str): Path to top-level analysis directory</span>
<span class="sd">        drpall_file (str): Path to the DRPall file</span>
<span class="sd">        h (float): The Hubble parameter (currently always set to unity)</span>
<span class="sd">        H0 (float): Hubbles constant (km/s/Mpc)</span>
<span class="sd">        cosmo (`astropy.cosmology.FlatLambdaCDM`_): Object used for</span>
<span class="sd">            distance calculations</span>
<span class="sd">        maps_bm (:class:`mangadap.dapfits.DAPMapsBitMask`): Bitmask used</span>
<span class="sd">            to mask map pixels.</span>
<span class="sd">        neml (int): Number of emission lines included in each method.</span>
<span class="sd">        nindx (int): Number of spectral indices included in each method.</span>
<span class="sd">        str_len (dict): Dictionary with the number of characters used</span>
<span class="sd">            for each string entry in the database.</span>
<span class="sd">        hdu (`astropy.io.fits.hdu.hdulist.HDUList`_): Object with the</span>
<span class="sd">            table data.</span>
<span class="sd">        ndap (int): Number of rows in the data table; equivalent to the</span>
<span class="sd">            number of processed MAPS files.</span>
<span class="sd">        plate (numpy.ndarray): Array of the plate numbers</span>
<span class="sd">        ifudesign (numpy.ndarray): Array of the ifudesigns</span>
<span class="sd">        methods (numpy.ndarray): Array of the methods included in the</span>
<span class="sd">            DAPall file.</span>
<span class="sd">        readonly (bool): Object is prohibited from updating the</span>
<span class="sd">            database.</span>
<span class="sd">        loggers (list): List of `logging.Logger`_ objects</span>
<span class="sd">            to log progress; ignored if quiet=True.  Logging is done</span>
<span class="sd">            using :func:`mangadap.util.log.log_output`.  Default is no</span>
<span class="sd">            logging.</span>
<span class="sd">        quiet (bool): Suppress all terminal and logging output.</span>
<span class="sd">        float_dtype (str): Sets precision for floating-point numbers.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drpver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">redux_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">analysis_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loggers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">single_precision</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># Initialize the reporting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loggers</span> <span class="o">=</span> <span class="n">loggers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span> <span class="k">if</span> <span class="n">single_precision</span> <span class="k">else</span> <span class="s1">&#39;float&#39;</span>

        <span class="c1"># Path definitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drpver</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">default_drp_version</span><span class="p">()</span> <span class="k">if</span> <span class="n">drpver</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">drpver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">default_redux_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpver</span><span class="p">)</span> <span class="k">if</span> <span class="n">redux_path</span> <span class="ow">is</span> <span class="kc">None</span> \
                                                                  <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">redux_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dapsrc</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">default_dap_source</span><span class="p">()</span> <span class="k">if</span> <span class="n">dapsrc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dapver</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">default_dap_version</span><span class="p">()</span> <span class="k">if</span> <span class="n">dapver</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">dapver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">default_analysis_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">)</span> \
                             <span class="k">if</span> <span class="n">analysis_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">analysis_path</span><span class="p">)</span>

        <span class="c1"># Set the name of the DRPall file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drpall_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span><span class="p">,</span> <span class="s1">&#39;drpall-</span><span class="si">{0}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpver</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpall_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> does not exist!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpall_file</span><span class="p">))</span>

        <span class="c1"># Initialize the bitmask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maps_bm</span> <span class="o">=</span> <span class="n">DAPMapsBitMask</span><span class="p">()</span>

        <span class="c1"># Set the length for the string elements of the table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">str_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_string_lengths</span><span class="p">()</span>

        <span class="c1"># Initialize the cosmology object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H0</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">astropy</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">km</span> <span class="o">/</span> <span class="n">astropy</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">s</span> <span class="o">/</span> <span class="n">astropy</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Mpc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span> <span class="o">=</span> <span class="n">FlatLambdaCDM</span><span class="p">(</span><span class="n">H0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">H0</span><span class="p">,</span> <span class="n">Om0</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Declare the other attributes for use later on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmom</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elmom_channels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neml</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elfit_channels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nindx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spindx_channels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spindx_units</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ifudesign</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Give an initial report</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="n">readonly</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0:^50}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;DAPALL DATABASE&#39;</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;DRPall file: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpall_file</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Output path: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Output file: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">()))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
                <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;READ-ONLY MODE&#39;</span><span class="p">)</span>

        <span class="c1"># If the output file already exists, read it</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">()</span>

        <span class="c1"># Check the combination of read-only and the read data makes</span>
        <span class="c1"># sense</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Selected read-only, but no database can be read.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;DAPall file already exists!  Update will overwrite existing data.&#39;</span><span class="p">)</span>

        <span class="c1"># Automatically attempt to update the database if no database</span>
        <span class="c1"># exists or if the database is not meant to be read-only</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">methods</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;DAPALL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


<div class="viewcode-block" id="DAPall._emission_line_moment_db_info"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._emission_line_moment_db_info">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_emission_line_moment_db_info</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">select_proc_method</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">EmissionLineMomentsDef</span><span class="p">,</span>
                                <span class="n">available_func</span><span class="o">=</span><span class="n">available_emission_line_moment_databases</span><span class="p">,</span>
                                <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;passbands&#39;</span><span class="p">],</span> <span class="n">EmissionMomentsDB</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;passbands&#39;</span><span class="p">],</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span><span class="o">.</span><span class="n">channel_names</span><span class="p">()</span></div>


<div class="viewcode-block" id="DAPall._emission_line_db_info"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._emission_line_db_info">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_emission_line_db_info</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">select_proc_method</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">EmissionLineModelDef</span><span class="p">,</span>
                                <span class="n">available_func</span><span class="o">=</span><span class="n">available_emission_line_modeling_methods</span><span class="p">,</span>
                                <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;emission_lines&#39;</span><span class="p">],</span> \
                    <span class="n">EmissionLineDB</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;emission_lines&#39;</span><span class="p">],</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span><span class="o">.</span><span class="n">channel_names</span><span class="p">()</span></div>


<div class="viewcode-block" id="DAPall._spectral_index_db_info"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._spectral_index_db_info">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_spectral_index_db_info</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">select_proc_method</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">SpectralIndicesDef</span><span class="p">,</span>
                                <span class="n">available_func</span><span class="o">=</span><span class="n">available_spectral_index_databases</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>
        <span class="n">absdb</span> <span class="o">=</span> <span class="n">AbsorptionIndexDB</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;absindex&#39;</span><span class="p">],</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>
        <span class="n">bhddb</span> <span class="o">=</span> <span class="n">BandheadIndexDB</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;bandhead&#39;</span><span class="p">],</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>
        <span class="n">nindx</span> <span class="o">=</span> <span class="n">absdb</span><span class="o">.</span><span class="n">nindx</span> <span class="o">+</span> <span class="n">bhddb</span><span class="o">.</span><span class="n">nindx</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">absdb</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">bhddb</span><span class="o">.</span><span class="n">nindx</span><span class="p">)</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="n">absdb</span><span class="o">.</span><span class="n">channel_names</span><span class="p">()</span>
        <span class="n">channels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bhddb</span><span class="o">.</span><span class="n">channel_names</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="n">absdb</span><span class="o">.</span><span class="n">nindx</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nindx</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Spectral index channel names not unique!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;absindex&#39;</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;bandhead&#39;</span><span class="p">],</span> <span class="n">channels</span><span class="p">,</span> <span class="n">units</span></div>


<div class="viewcode-block" id="DAPall._read"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._read">[docs]</a>    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the data in the existing file at :func:`file_path`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Close the HDUList if it&#39;s already open</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Read the file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Reading exiting file&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ndap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;DAPALL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span>

        <span class="c1"># Find the methods in the file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;DAPALL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DAPTYPE&#39;</span><span class="p">])</span>

        <span class="c1"># Find the plate-IFU combinations in the file</span>
        <span class="n">pltifu</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;DAPALL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;PLATEIFU&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifudesign</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                         <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span> 
                                                        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="n">pltifu</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># Set the number of emission lines and spectral indices</span>
        <span class="c1"># TODO: Get this from the number of header keywords?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;DAPALL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;EMLINE_SFLUX_1RE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;DAPALL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;EMLINE_GFLUX_1RE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nindx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;DAPALL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SPECINDEX_1RE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Rows: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndap</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Methods: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                       <span class="s1">&#39;Number of observations: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plate</span><span class="p">)))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                       <span class="s1">&#39;Number of emission-line moments: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmom</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                       <span class="s1">&#39;Number of emission lines: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neml</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                       <span class="s1">&#39;Number of spectral indices: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nindx</span><span class="p">))</span></div>


<div class="viewcode-block" id="DAPall._init_string_lengths"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._init_string_lengths">[docs]</a>    <span class="k">def</span> <span class="nf">_init_string_lengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span> <span class="s1">&#39;PLATEIFU&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span> 
                 <span class="s1">&#39;MANGAID&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
                 <span class="s1">&#39;MODE&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                 <span class="s1">&#39;DAPTYPE&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span>
                 <span class="s1">&#39;VERSDRP2&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
                 <span class="s1">&#39;VERSDRP3&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
                 <span class="s1">&#39;VERSCORE&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
                 <span class="s1">&#39;VERSUTIL&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
                 <span class="s1">&#39;VERSDAP&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
                 <span class="s1">&#39;RDXQAKEY&#39;</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span>
                 <span class="s1">&#39;BINKEY&#39;</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span>
                 <span class="s1">&#39;SCKEY&#39;</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span>
                 <span class="s1">&#39;ELMKEY&#39;</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span>
                 <span class="s1">&#39;ELFKEY&#39;</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span>
                 <span class="s1">&#39;SIKEY&#39;</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span>
                 <span class="s1">&#39;BINTYPE&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
                 <span class="s1">&#39;TPLKEY&#39;</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span>
                 <span class="s1">&#39;DATEDAP&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
                 <span class="s1">&#39;EMLMOM_NAME&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span>
                 <span class="s1">&#39;EMLINE_NAME&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span>
                 <span class="s1">&#39;SPECINDEX_NAME&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span>
                 <span class="s1">&#39;SPECINDEX_UNIT&#39;</span><span class="p">:</span><span class="mi">5</span>
               <span class="p">}</span></div>

    
<div class="viewcode-block" id="DAPall._table_dtype"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._table_dtype">[docs]</a>    <span class="k">def</span> <span class="nf">_table_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nmom</span><span class="p">,</span> <span class="n">neml</span><span class="p">,</span> <span class="n">nindx</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;PLATE&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;IFUDESIGN&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;PLATEIFU&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;PLATEIFU&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;MANGAID&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;MANGAID&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;DRPALLINDX&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;MODE&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;MODE&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;DAPTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;DAPTYPE&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;DAPDONE&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;OBJRA&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;OBJDEC&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;IFURA&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;IFUDEC&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;MNGTARG1&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;MNGTARG2&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;MNGTARG3&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;LDIST_Z&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;ADIST_Z&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;NSA_Z&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;NSA_ZDIST&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;LDIST_NSA_Z&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;ADIST_NSA_Z&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;NSA_ELPETRO_BA&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;NSA_ELPETRO_PHI&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;NSA_ELPETRO_TH50_R&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;NSA_SERSIC_BA&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;NSA_SERSIC_PHI&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;NSA_SERSIC_TH50&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;NSA_SERSIC_N&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;VERSDRP2&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;VERSDRP2&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;VERSDRP3&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;VERSDRP3&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;VERSCORE&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;VERSCORE&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;VERSUTIL&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;VERSUTIL&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;VERSDAP&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;VERSDAP&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;DRP3QUAL&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;DAPQUAL&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;RDXQAKEY&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;RDXQAKEY&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;BINKEY&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;BINKEY&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;SCKEY&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;SCKEY&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;ELMKEY&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;ELMKEY&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;ELFKEY&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;ELFKEY&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;SIKEY&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;SIKEY&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;BINTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;BINTYPE&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;BINSNR&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;TPLKEY&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;TPLKEY&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;DATEDAP&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">str_len</span><span class="p">[</span><span class="s1">&#39;DATEDAP&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="s1">&#39;DAPBINS&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;RCOV90&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;SNR_MED&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;SNR_RING&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;SB_1RE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;BIN_RMAX&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;BIN_R_N&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;BIN_R_SNR&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;STELLAR_Z&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;STELLAR_VEL_LO&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;STELLAR_VEL_HI&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;STELLAR_VEL_LO_CLIP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;STELLAR_VEL_HI_CLIP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;STELLAR_SIGMA_1RE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;STELLAR_CONT_RCHI2_1RE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;HA_Z&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;HA_GVEL_LO&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;HA_GVEL_HI&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;HA_GVEL_LO_CLIP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;HA_GVEL_HI_CLIP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;HA_GSIGMA_1RE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;HA_GSIGMA_HI&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;HA_GSIGMA_HI_CLIP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
<span class="c1">#                 (&#39;EMLMOM_NAME&#39;, &#39;&lt;U{0:d}&#39;.format(self.str_len[&#39;EMLMOM_NAME&#39;]*nmom)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_SFLUX_CEN&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_SFLUX_1RE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_SFLUX_TOT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_SSB_1RE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_SSB_PEAK&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_SEW_1RE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_SEW_PEAK&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
<span class="c1">#                 (&#39;EMLINE_NAME&#39;, &#39;&lt;U{0:d}&#39;.format(self.str_len[&#39;EMLINE_NAME&#39;]*neml)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_GFLUX_CEN&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">neml</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_GFLUX_1RE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">neml</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_GFLUX_TOT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">neml</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_GSB_1RE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">neml</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_GSB_PEAK&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">neml</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_GEW_1RE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">neml</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;EMLINE_GEW_PEAK&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">neml</span><span class="p">,)),</span>
<span class="c1">#                 (&#39;SPECINDEX_NAME&#39;, &#39;&lt;U{0:d}&#39;.format(self.str_len[&#39;SPECINDEX_NAME&#39;]*nindx)),</span>
<span class="c1">#                 (&#39;SPECINDEX_UNIT&#39;, &#39;&lt;U{0:d}&#39;.format(self.str_len[&#39;SPECINDEX_UNIT&#39;]*nindx)),</span>
                 <span class="p">(</span><span class="s1">&#39;SPECINDEX_LO&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">nindx</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;SPECINDEX_HI&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">nindx</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;SPECINDEX_LO_CLIP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">nindx</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;SPECINDEX_HI_CLIP&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">nindx</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;SPECINDEX_1RE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">nindx</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;SFR_1RE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;SFR_TOT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_dtype</span><span class="p">)</span>
               <span class="p">]</span></div>


<div class="viewcode-block" id="DAPall._get_completed_observations"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._get_completed_observations">[docs]</a>    <span class="k">def</span> <span class="nf">_get_completed_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of DRP completed (and prospectively DAP analyzed)</span>
<span class="sd">        observations.</span>

<span class="sd">        .. todo:</span>
<span class="sd">            Save drpc as an attribute of the class?</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Two arrays listing the plate and ifudesign</span>
<span class="sd">            numbers of the available observations that the DAP should</span>
<span class="sd">            have analyzed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: Raised if the DRPComplete file is not</span>
<span class="sd">                available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize the DRP complete file (read-only)</span>
        <span class="n">drpc</span> <span class="o">=</span> <span class="n">DRPComplete</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="n">redux_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redux_path</span><span class="p">,</span>
                           <span class="n">dapver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">drpc</span><span class="o">.</span><span class="n">file_path</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Could not access DRP complete file: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                                <span class="n">drpc</span><span class="o">.</span><span class="n">file_path</span><span class="p">()))</span>
    
        <span class="c1"># Find the list of file that should have been analyzed</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drpc</span><span class="o">.</span><span class="n">can_analyze</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">drpc</span><span class="p">[</span><span class="s1">&#39;PLATE&#39;</span><span class="p">][</span><span class="n">indx</span><span class="p">],</span> <span class="n">drpc</span><span class="p">[</span><span class="s1">&#39;IFUDESIGN&#39;</span><span class="p">][</span><span class="n">indx</span><span class="p">]</span></div>


<div class="viewcode-block" id="DAPall._combine_plateifu_methods"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._combine_plateifu_methods">[docs]</a>    <span class="k">def</span> <span class="nf">_combine_plateifu_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plt</span><span class="p">,</span> <span class="n">ifu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the combinatorics to create the full list of plates,</span>
<span class="sd">        ifudesigns, and methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nmethods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">)</span>
        <span class="n">ncomplete</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plt</span><span class="p">)</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">)</span> <span class="p">]</span><span class="o">*</span><span class="n">ncomplete</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">plates</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plt</span><span class="p">)</span> <span class="p">]</span><span class="o">*</span><span class="n">nmethods</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="c1">#.astype(str)</span>
        <span class="n">ifudesigns</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ifu</span><span class="p">)</span> <span class="p">]</span><span class="o">*</span><span class="n">nmethods</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="c1">#.astype(str)</span>

        <span class="k">return</span> <span class="n">methods</span><span class="p">,</span> <span class="n">plates</span><span class="p">,</span> <span class="n">ifudesigns</span></div>


<div class="viewcode-block" id="DAPall._construct_maps_file_list"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._construct_maps_file_list">[docs]</a>    <span class="k">def</span> <span class="nf">_construct_maps_file_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodlist</span><span class="p">,</span> <span class="n">platelist</span><span class="p">,</span> <span class="n">ifulist</span><span class="p">):</span> <span class="c1"># plt, ifu):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the list of MAPS files that should be in/added to the</span>
<span class="sd">        DAPall file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Construct the file names</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">/</span><span class="si">{2}</span><span class="s1">/</span><span class="si">{3}</span><span class="s1">/manga-</span><span class="si">{2}</span><span class="s1">-</span><span class="si">{3}</span><span class="s1">-MAPS-</span><span class="si">{1}</span><span class="s1">.fits.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> 
                                    <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">methodlist</span><span class="p">,</span> <span class="n">platelist</span><span class="p">,</span> <span class="n">ifulist</span><span class="p">)</span> <span class="p">])</span></div>

    
<div class="viewcode-block" id="DAPall._add_channels_to_header"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._add_channels_to_header">[docs]</a>    <span class="k">def</span> <span class="nf">_add_channels_to_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        units is supposed to be a list or numpy array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">channels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">srt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">[</span><span class="n">srt</span><span class="p">]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">()))[</span><span class="n">srt</span><span class="p">]</span>
        <span class="n">ndig</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">keys</span><span class="p">):</span>
            <span class="n">hdr</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">ndig</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hdr</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;U&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">ndig</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">comment</span><span class="o">+</span><span class="s1">&#39; unit&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hdr</span></div>


<div class="viewcode-block" id="DAPall._srd_snr_metric"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._srd_snr_metric">[docs]</a>    <span class="k">def</span> <span class="nf">_srd_snr_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dapmaps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Grab the SNR metrics from the MAPS headers.&quot;&quot;&quot;</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SNR</span><span class="si">{0}</span><span class="s1">MED&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">]),</span> \
                <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SNR</span><span class="si">{0}</span><span class="s1">RING&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">])</span></div>


<div class="viewcode-block" id="DAPall._radial_coverage_metric"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._radial_coverage_metric">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_radial_coverage_metric</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ell</span><span class="p">):</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mf">2.5</span>
        <span class="n">pixelscale</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">coverage_limit</span> <span class="o">=</span> <span class="mf">0.9</span>

        <span class="n">maxr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">binr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">maxr</span><span class="o">+</span><span class="n">width</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">width</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">coverage</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binr</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">coverage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">binr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ell</span><span class="p">)</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">binr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">binr</span><span class="p">)):</span>
            <span class="n">binrl</span> <span class="o">=</span> <span class="n">binr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">binru</span> <span class="o">=</span> <span class="n">binrl</span> <span class="o">+</span> <span class="n">width</span>
            <span class="n">ellipse_area</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ell</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">binru</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">binrl</span><span class="p">))</span>
            <span class="n">coverage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">r</span> <span class="o">&gt;</span> <span class="n">binrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">binru</span><span class="p">))</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">pixelscale</span><span class="p">)</span> \
                                <span class="o">/</span> <span class="n">ellipse_area</span>

        <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binr</span><span class="p">))[</span><span class="n">coverage</span> <span class="o">&gt;</span> <span class="n">coverage_limit</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No ring had larger than 90</span><span class="si">% c</span><span class="s1">overage!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">0.</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">coverage</span><span class="p">[</span><span class="n">indx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:],</span> <span class="n">binr</span><span class="p">[</span><span class="n">indx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:])</span>
        <span class="k">return</span> <span class="n">interp</span><span class="p">(</span><span class="n">coverage_limit</span><span class="p">)</span></div>


<div class="viewcode-block" id="DAPall._binning_metrics"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._binning_metrics">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_binning_metrics</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return binning metrics:</span>
<span class="sd">            - Maximum radius of any valid bin</span>
<span class="sd">            - Number and median S/N of bins between 0-1, 0.5-1.5, and</span>
<span class="sd">              1.5-2.5 Re</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Unique bins</span>
        <span class="c1"># TODO: Select the BINID channel using the channel dictionary</span>
        <span class="n">unique</span><span class="p">,</span> <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">unique_indx</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Get the radii (in units of Re) of the unmasked, unique</span>
        <span class="c1"># bins constructed during the spatial binning</span>
        <span class="n">r_re</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;BIN_LWELLCOO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>

        <span class="c1"># Get the S/N metric resulting from the spatial binning</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;BIN_SNR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>

        <span class="c1"># Get the number of bins and median S/N between 0-1,</span>
        <span class="c1"># 0.5-1.5, and 1.5-2.5 Re</span>
        <span class="n">rlim</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span><span class="mf">2.5</span><span class="p">]])</span>
        <span class="n">bin_r_n</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rlim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">bin_r_snr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rlim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rlim</span><span class="p">)):</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_re</span> <span class="o">&gt;</span> <span class="n">rlim</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">r_re</span> <span class="o">&lt;</span> <span class="n">rlim</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bin_r_n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">bin_r_snr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>
            <span class="n">bin_r_n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span>
            <span class="n">bin_r_snr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">snr</span><span class="p">[</span><span class="n">indx</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">r_re</span><span class="p">),</span> <span class="n">bin_r_n</span><span class="p">,</span> <span class="n">bin_r_snr</span></div>


<div class="viewcode-block" id="DAPall._stellar_kinematics_metrics"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._stellar_kinematics_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">_stellar_kinematics_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dapmaps</span><span class="p">,</span> <span class="n">redshift</span><span class="p">):</span>

        <span class="c1"># Unique bins</span>
        <span class="c1"># TODO: Select the BINID channel using the channel dictionary</span>
        <span class="n">unique</span><span class="p">,</span> <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">unique_indx</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Pull the data from the maps file</span>
        <span class="n">r_re</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;BIN_LWELLCOO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>

        <span class="n">bin_flux</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;BIN_MFLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                        <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maps_bm</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;BIN_MFLUX_MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                                 <span class="s1">&#39;DONOTUSE&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>

        <span class="n">svel</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;STELLAR_VEL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                    <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maps_bm</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;STELLAR_VEL_MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                             <span class="s1">&#39;DONOTUSE&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>

        <span class="n">ssig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;STELLAR_SIGMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                    <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maps_bm</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;STELLAR_SIGMA_MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                              <span class="s1">&#39;DONOTUSE&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>

        <span class="n">ssig2corr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ssig</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span>
                                    <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;STELLAR_SIGMACORR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">])</span>
<span class="c1">#                                    dapmaps[&#39;STELLAR_SIGMACORR&#39;].data[1,:,:].ravel()[unique_indx])</span>
        <span class="n">scchi</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;STELLAR_CONT_RCHI2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>

        <span class="c1"># Convert velocities to redshift</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">svel</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">redshift</span><span class="p">)</span> <span class="o">+</span> <span class="n">astropy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">redshift</span><span class="p">)</span> \
                                    <span class="o">/</span> <span class="n">astropy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># Get the bins within an on-sky circular aperture of 2.5 arcsec</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;BIN_LWSKYCOO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">d2</span> <span class="o">&lt;</span> <span class="mf">1.25</span><span class="o">*</span><span class="mf">1.25</span>

        <span class="c1"># Get the flux-weighted mean velocity at the center</span>
        <span class="n">wsum</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_flux</span><span class="p">[</span><span class="n">center</span><span class="p">])</span>
        <span class="n">stellar_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span> <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">bin_flux</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">center</span><span class="p">]</span> <span class="o">|</span> <span class="n">z</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">center</span><span class="p">])</span> \
                                <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">wsum</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> \
                            <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_flux</span><span class="p">[</span><span class="n">center</span><span class="p">]</span><span class="o">*</span><span class="n">z</span><span class="p">[</span><span class="n">center</span><span class="p">])</span><span class="o">/</span><span class="n">wsum</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">stellar_z</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Stellar_z is not finite: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stellar_z</span><span class="p">))</span>

        <span class="c1"># Get the growth ranges of the stellar velocity</span>
        <span class="n">stellar_vel_lo</span><span class="p">,</span> <span class="n">stellar_vel_hi</span> <span class="o">=</span> <span class="n">sample_growth</span><span class="p">(</span><span class="n">svel</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="p">[</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.975</span><span class="p">])</span>
        <span class="n">stellar_vel_lo_clip</span><span class="p">,</span> <span class="n">stellar_vel_hi_clip</span> <span class="o">=</span> <span class="n">sample_growth</span><span class="p">(</span><span class="n">sigma_clip</span><span class="p">(</span><span class="n">svel</span><span class="p">)</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span>
                                                                 <span class="p">[</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.975</span><span class="p">])</span>

        <span class="c1"># Get the flux-weighted, corrected sigma within 1 Re</span>
        <span class="n">within_1re</span> <span class="o">=</span> <span class="n">r_re</span> <span class="o">&lt;</span> <span class="mf">1.</span>
        <span class="n">wsum</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_flux</span><span class="p">[</span><span class="n">within_1re</span><span class="p">])</span>
        <span class="n">stellar_sigma2_1re</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span> <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">bin_flux</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">within_1re</span><span class="p">])</span> \
                                            <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">wsum</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> \
                                <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_flux</span><span class="p">[</span><span class="n">within_1re</span><span class="p">]</span><span class="o">*</span><span class="n">ssig2corr</span><span class="p">[</span><span class="n">within_1re</span><span class="p">])</span><span class="o">/</span><span class="n">wsum</span>
        <span class="n">stellar_sigma_1re</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">stellar_sigma2_1re</span><span class="p">)</span> <span class="k">if</span> <span class="n">stellar_sigma2_1re</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">999.</span>

        <span class="c1"># Get the median reduced chi-square</span>
        <span class="n">stellar_cont_rchi2_1re</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span> <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">within_1re</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> \
                                        <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">scchi</span><span class="p">[</span><span class="n">within_1re</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">stellar_z</span><span class="p">,</span> <span class="n">stellar_vel_lo</span><span class="p">,</span> <span class="n">stellar_vel_hi</span><span class="p">,</span> \
                        <span class="n">stellar_vel_lo_clip</span><span class="p">,</span> <span class="n">stellar_vel_hi_clip</span><span class="p">,</span> <span class="n">stellar_sigma_1re</span><span class="p">,</span> \
                        <span class="n">stellar_cont_rchi2_1re</span></div>


<div class="viewcode-block" id="DAPall._halpha_kinematics_metrics"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._halpha_kinematics_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">_halpha_kinematics_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dapmaps</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span> <span class="n">spx_coo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># Unique bins</span>
        <span class="c1"># TODO: Select the BINID channel using the channel dictionary</span>
        <span class="n">unique</span><span class="p">,</span> <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">unique_indx</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Channel dictionary</span>
        <span class="n">emline</span> <span class="o">=</span> <span class="n">channel_dictionary</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">,</span> <span class="s1">&#39;EMLINE_GFLUX&#39;</span><span class="p">)</span>

        <span class="c1"># Pull the data from the maps file</span>
        <span class="n">cooext</span> <span class="o">=</span> <span class="s1">&#39;SPX_ELLCOO&#39;</span> <span class="k">if</span> <span class="n">spx_coo</span> <span class="k">else</span> <span class="s1">&#39;BIN_LWELLCOO&#39;</span>
        <span class="n">r_re</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="n">cooext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;EMLINE_GFLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">emline</span><span class="p">[</span><span class="s1">&#39;Ha-6564&#39;</span><span class="p">],:,:],</span>
                                        <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maps_bm</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span>
                                        <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;EMLINE_GFLUX_MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">emline</span><span class="p">[</span><span class="s1">&#39;Ha-6564&#39;</span><span class="p">],:,:],</span>
                                                              <span class="s1">&#39;DONOTUSE&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No halpha-data will be available.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mf">999.</span><span class="p">,)</span><span class="o">*</span><span class="mi">8</span>

        <span class="n">vel</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;EMLINE_GVEL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">emline</span><span class="p">[</span><span class="s1">&#39;Ha-6564&#39;</span><span class="p">],:,:],</span>
                                   <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maps_bm</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span>
                                        <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;EMLINE_GVEL_MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">emline</span><span class="p">[</span><span class="s1">&#39;Ha-6564&#39;</span><span class="p">],:,:],</span>
                                                             <span class="s1">&#39;DONOTUSE&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>

        <span class="n">sig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;EMLINE_GSIGMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">emline</span><span class="p">[</span><span class="s1">&#39;Ha-6564&#39;</span><span class="p">],:,:],</span>
                                   <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maps_bm</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span>
                                        <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;EMLINE_GSIGMA_MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">emline</span><span class="p">[</span><span class="s1">&#39;Ha-6564&#39;</span><span class="p">],:,:],</span>
                                                             <span class="s1">&#39;DONOTUSE&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>

        <span class="n">sig2corr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span>
                    <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;EMLINE_INSTSIGMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">emline</span><span class="p">[</span><span class="s1">&#39;Ha-6564&#39;</span><span class="p">],:,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">])</span>


        <span class="c1"># Convert velocities to redshift</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">redshift</span><span class="p">)</span> <span class="o">+</span> <span class="n">astropy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">redshift</span><span class="p">)</span> \
                                    <span class="o">/</span> <span class="n">astropy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># Get the bins within an on-sky circular aperture of 2.5 arcsec</span>
        <span class="n">cooext</span> <span class="o">=</span> <span class="s1">&#39;SPX_SKYCOO&#39;</span> <span class="k">if</span> <span class="n">spx_coo</span> <span class="k">else</span> <span class="s1">&#39;BIN_LWSKYCOO&#39;</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="n">cooext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">d2</span> <span class="o">&lt;</span> <span class="mf">1.25</span><span class="o">*</span><span class="mf">1.25</span>

        <span class="c1"># Get the flux-weighted mean velocity at the center</span>
        <span class="n">wsum</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">center</span><span class="p">])</span>

        <span class="n">halpha_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span> <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">flux</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">center</span><span class="p">]</span> <span class="o">|</span> <span class="n">z</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">center</span><span class="p">])</span> \
                                <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">wsum</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> \
                            <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">center</span><span class="p">]</span><span class="o">*</span><span class="n">z</span><span class="p">[</span><span class="n">center</span><span class="p">])</span><span class="o">/</span><span class="n">wsum</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">halpha_z</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;H-alpha z is not finite: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">halpha_z</span><span class="p">))</span>

<span class="c1">#        halpha_z = -999. if numpy.all(flux.mask[center]) or numpy.isclose(wsum, 0.) \</span>
<span class="c1">#                            else numpy.ma.sum(flux[center]*z[center])/wsum</span>

        <span class="c1"># Get the growth ranges of the H-alpha velocity</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">vel</span><span class="o">.</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">halpha_gvel_lo</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span>
            <span class="n">halpha_gvel_hi</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span>
            <span class="n">halpha_gvel_lo_clip</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span>
            <span class="n">halpha_gvel_hi_clip</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">halpha_gvel_lo</span><span class="p">,</span> <span class="n">halpha_gvel_hi</span> <span class="o">=</span> <span class="n">sample_growth</span><span class="p">(</span><span class="n">vel</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="p">[</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.975</span><span class="p">])</span>
            <span class="n">halpha_gvel_lo_clip</span><span class="p">,</span> <span class="n">halpha_gvel_hi_clip</span> <span class="o">=</span> <span class="n">sample_growth</span><span class="p">(</span><span class="n">sigma_clip</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span>
                                                                     <span class="p">[</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.975</span><span class="p">])</span>

        <span class="c1"># Get the flux-weighted, corrected sigma within 1 Re</span>
        <span class="n">within_1re</span> <span class="o">=</span> <span class="n">r_re</span> <span class="o">&lt;</span> <span class="mf">1.</span>
        <span class="n">wsum</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">within_1re</span><span class="p">])</span>
        <span class="n">halpha_gsigma2_1re</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span> <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">flux</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">within_1re</span><span class="p">]</span> <span class="o">|</span> <span class="n">sig2corr</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">within_1re</span><span class="p">])</span> \
                                        <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">wsum</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> \
                                    <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">within_1re</span><span class="p">]</span><span class="o">*</span><span class="n">sig2corr</span><span class="p">[</span><span class="n">within_1re</span><span class="p">])</span><span class="o">/</span><span class="n">wsum</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">halpha_gsigma2_1re</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;H-alpha gsigma^2 is not finite: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">halpha_gsigma2_1re</span><span class="p">))</span>
        <span class="n">halpha_gsigma_1re</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">halpha_gsigma2_1re</span><span class="p">)</span> <span class="k">if</span> <span class="n">halpha_gsigma2_1re</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">999.</span>

        <span class="c1"># Get the high-growth of the H-alpha velocity dispersion</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sig2corr</span><span class="o">.</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">halpha_gsigma2_hi</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span>
            <span class="n">halpha_gsigma2_hi_clip</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">halpha_gsigma2_hi</span> <span class="o">=</span> <span class="n">sample_growth</span><span class="p">(</span><span class="n">sig2corr</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="mf">0.975</span><span class="p">)</span>
            <span class="n">halpha_gsigma2_hi_clip</span> <span class="o">=</span> <span class="n">sample_growth</span><span class="p">(</span><span class="n">sigma_clip</span><span class="p">(</span><span class="n">sig2corr</span><span class="p">)</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="mf">0.975</span><span class="p">)</span>

        <span class="n">halpha_gsigma_hi</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">halpha_gsigma2_hi</span><span class="p">)</span> <span class="k">if</span> <span class="n">halpha_gsigma2_hi</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">999.</span>
        <span class="n">halpha_gsigma_hi_clip</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">halpha_gsigma2_hi_clip</span><span class="p">)</span> \
                                        <span class="k">if</span> <span class="n">halpha_gsigma2_hi_clip</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">999.</span>

        <span class="k">return</span> <span class="n">halpha_z</span><span class="p">,</span> <span class="n">halpha_gvel_lo</span><span class="p">,</span> <span class="n">halpha_gvel_hi</span><span class="p">,</span> <span class="n">halpha_gvel_lo_clip</span><span class="p">,</span> <span class="n">halpha_gvel_hi_clip</span><span class="p">,</span> \
                        <span class="n">halpha_gsigma_1re</span><span class="p">,</span> <span class="n">halpha_gsigma_hi</span><span class="p">,</span> <span class="n">halpha_gsigma_hi_clip</span></div>


<div class="viewcode-block" id="DAPall._emission_line_metrics"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._emission_line_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">_emission_line_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dapmaps</span><span class="p">,</span> <span class="n">moment0</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spx_coo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># Unique bins</span>
        <span class="c1"># TODO: Select the BINID channel using the channel dictionary</span>
        <span class="n">unique</span><span class="p">,</span> <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">unique_indx</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">neml</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;EMLINE_GFLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Pull the data from the maps file</span>
        <span class="n">cooext</span> <span class="o">=</span> <span class="s1">&#39;SPX_ELLCOO&#39;</span> <span class="k">if</span> <span class="n">spx_coo</span> <span class="k">else</span> <span class="s1">&#39;BIN_LWELLCOO&#39;</span>
        <span class="n">r_re</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="n">cooext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>
        <span class="n">flux_ext</span> <span class="o">=</span> <span class="s1">&#39;EMLINE_SFLUX&#39;</span> <span class="k">if</span> <span class="n">moment0</span> <span class="k">else</span> <span class="s1">&#39;EMLINE_GFLUX&#39;</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="n">flux_ext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                    <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maps_bm</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="n">flux_ext</span><span class="o">+</span><span class="s1">&#39;_MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                    <span class="s1">&#39;DONOTUSE&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">neml</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">unique_indx</span><span class="p">]</span>
        <span class="n">ew_ext</span> <span class="o">=</span> <span class="s1">&#39;EMLINE_SEW&#39;</span> <span class="k">if</span> <span class="n">moment0</span> <span class="k">else</span> <span class="s1">&#39;EMLINE_GEW&#39;</span>
        <span class="n">ew</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="n">ew_ext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                  <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maps_bm</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="n">ew_ext</span><span class="o">+</span><span class="s1">&#39;_MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                    <span class="s1">&#39;DONOTUSE&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">neml</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">unique_indx</span><span class="p">]</span>

        <span class="c1"># Get the total flux at the center</span>
        <span class="n">cooext</span> <span class="o">=</span> <span class="s1">&#39;SPX_SKYCOO&#39;</span> <span class="k">if</span> <span class="n">spx_coo</span> <span class="k">else</span> <span class="s1">&#39;BIN_LWSKYCOO&#39;</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="n">cooext</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">d2</span> <span class="o">&lt;</span> <span class="mf">1.25</span><span class="o">*</span><span class="mf">1.25</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">center</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No data near center!&#39;</span><span class="p">)</span>
            <span class="n">emline_flux_cen</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">neml</span><span class="p">,</span> <span class="o">-</span><span class="mf">999.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">emline_flux_cen</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flux</span><span class="p">[:,</span><span class="n">center</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="o">-</span><span class="mf">999.</span><span class="p">)</span>
            
        <span class="c1"># Get the total flux, mean surface-brightness, and mean</span>
        <span class="c1"># equivalent width within 1 Re</span>
        <span class="n">within_1re</span> <span class="o">=</span> <span class="n">r_re</span> <span class="o">&lt;</span> <span class="mf">1.</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">within_1re</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No data within 1 Re!&#39;</span><span class="p">)</span>
            <span class="n">emline_flux_1re</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">neml</span><span class="p">,</span> <span class="o">-</span><span class="mf">999.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="n">emline_sb_1re</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">neml</span><span class="p">,</span> <span class="o">-</span><span class="mf">999.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="n">emline_ew_1re</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">neml</span><span class="p">,</span> <span class="o">-</span><span class="mf">999.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">emline_flux_1re</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flux</span><span class="p">[:,</span><span class="n">within_1re</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="o">-</span><span class="mf">999.</span><span class="p">)</span>
            <span class="n">emline_sb_1re</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flux</span><span class="p">[:,</span><span class="n">within_1re</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="o">-</span><span class="mf">999.</span><span class="p">)</span>
            <span class="n">emline_ew_1re</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ew</span><span class="p">[:,</span><span class="n">within_1re</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="o">-</span><span class="mf">999.</span><span class="p">)</span>

        <span class="c1"># Get the total flux within the full field-of-fiew</span>
        <span class="n">emline_flux_tot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="o">-</span><span class="mf">999.</span><span class="p">)</span>

        <span class="c1"># Get the peak surface-brightness and equivalent width within</span>
        <span class="c1"># the full field-of-fiew</span>
        <span class="n">emline_sb_peak</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="o">-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="n">emline_ew_peak</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">ew</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="o">-</span><span class="mf">999.</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">emline_flux_cen</span><span class="p">,</span> <span class="n">emline_flux_1re</span><span class="p">,</span> <span class="n">emline_flux_tot</span><span class="p">,</span> <span class="n">emline_sb_1re</span><span class="p">,</span> \
                        <span class="n">emline_sb_peak</span><span class="p">,</span> <span class="n">emline_ew_1re</span><span class="p">,</span> <span class="n">emline_ew_peak</span></div>


<div class="viewcode-block" id="DAPall._spectral_index_metrics"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall._spectral_index_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">_spectral_index_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dapmaps</span><span class="p">,</span> <span class="n">specindex_units</span><span class="p">):</span>

        <span class="c1"># Unique bins</span>
        <span class="c1"># TODO: Select the BINID channel using the channel dictionary</span>
        <span class="n">unique</span><span class="p">,</span> <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">unique_indx</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">nindx</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;SPECINDEX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Pull the data from the maps file</span>
        <span class="n">r_re</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;BIN_LWELLCOO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">unique_indx</span><span class="p">]</span>
        <span class="n">specindex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;SPECINDEX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                         <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maps_bm</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;SPECINDEX_MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                    <span class="s1">&#39;DONOTUSE&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nindx</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">unique_indx</span><span class="p">]</span>
        <span class="n">specindex_corr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span>
                            <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;SPECINDEX_CORR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nindx</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">unique_indx</span><span class="p">],</span>
                                              <span class="n">mask</span><span class="o">=</span><span class="n">specindex</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Get the corrected indices</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">specindex_units</span> <span class="o">==</span> <span class="s1">&#39;ang&#39;</span>
        <span class="n">mag</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
        <span class="n">specindex_corr</span><span class="p">[</span><span class="n">ang</span><span class="p">]</span> <span class="o">=</span> <span class="n">specindex</span><span class="p">[</span><span class="n">ang</span><span class="p">]</span><span class="o">*</span><span class="n">specindex_corr</span><span class="p">[</span><span class="n">ang</span><span class="p">]</span>
        <span class="n">specindex_corr</span><span class="p">[</span><span class="n">mag</span><span class="p">]</span> <span class="o">=</span> <span class="n">specindex</span><span class="p">[</span><span class="n">mag</span><span class="p">]</span><span class="o">+</span><span class="n">specindex_corr</span><span class="p">[</span><span class="n">mag</span><span class="p">]</span>

        <span class="c1"># Get the growth limits</span>
        <span class="n">specindex_lo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nindx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">specindex_hi</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nindx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">specindex_lo_clip</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nindx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">specindex_hi_clip</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nindx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nindx</span><span class="p">):</span> 
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">specindex_corr</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,:]):</span>
                <span class="n">specindex_lo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span>
                <span class="n">specindex_hi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span>
                <span class="n">specindex_lo_clip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span>
                <span class="n">specindex_hi_clip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span>
                <span class="k">continue</span>
            <span class="n">specindex_lo</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">specindex_hi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_growth</span><span class="p">(</span><span class="n">specindex_corr</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span>
                                                             <span class="p">[</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.975</span><span class="p">])</span>
            <span class="n">specindex_lo_clip</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">specindex_hi_clip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> \
                        <span class="o">=</span> <span class="n">sample_growth</span><span class="p">(</span><span class="n">sigma_clip</span><span class="p">(</span><span class="n">specindex_corr</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="p">[</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.975</span><span class="p">])</span>

        <span class="c1"># Get the median within 1 Re</span>
        <span class="n">specindex_1re</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">specindex</span><span class="p">[:,</span><span class="n">r_re</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="o">-</span><span class="mf">999.</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">specindex_lo</span><span class="p">,</span> <span class="n">specindex_hi</span><span class="p">,</span> <span class="n">specindex_lo_clip</span><span class="p">,</span> <span class="n">specindex_hi_clip</span><span class="p">,</span> <span class="n">specindex_1re</span></div>


<div class="viewcode-block" id="DAPall.file_name"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall.file_name">[docs]</a>    <span class="k">def</span> <span class="nf">file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of the DRP complete database.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;dapall-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">))</span></div>


<div class="viewcode-block" id="DAPall.file_path"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall.file_path">[docs]</a>    <span class="k">def</span> <span class="nf">file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the full pat to the DRP complete database.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">())</span></div>


<div class="viewcode-block" id="DAPall.update"><a class="viewcode-back" href="../../../mangadap.survey.dapall.html#mangadap.survey.dapall.DAPall.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the DAPall file</span>
<span class="sd">        </span>
<span class="sd">        If clobber is True, the entire DAPall file is reconstructed from</span>
<span class="sd">        scratch.  Otherwise, any additional data is appended to the end</span>
<span class="sd">        of the file.</span>

<span class="sd">        Args:</span>
<span class="sd">            plan (:class:`mangadap.par.analysisplan.AnalysisPlanSet`):</span>
<span class="sd">                The plan object used by the DAP.</span>
<span class="sd">            methods (str,list): (**Optional**) Specify a set of methods</span>
<span class="sd">                in the DAP plan file to include in the DAPall file.  If</span>
<span class="sd">                not provided, all methods in the plan file are included.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Raised if a provided method is not in the provided</span>
<span class="sd">                set of analysis plans, or if the methods do not all have</span>
<span class="sd">                the same number of emission-line bandpasses,</span>
<span class="sd">                emission-lines to fit, and number of spectral indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Object is read-only.&#39;</span><span class="p">)</span>

        <span class="c1"># Check the input type</span>
        <span class="c1"># TODO: Plan isn&#39;t really needed.  Could just troll the</span>
        <span class="c1"># analysis_path for the directory names...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">AnalysisPlanSet</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input plan must have type AnalysisPlanSet.&#39;</span><span class="p">)</span>

        <span class="c1"># Get the full list of available plan methods</span>
        <span class="n">plan_methods</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">defaults</span><span class="o">.</span><span class="n">default_dap_method</span><span class="p">(</span><span class="n">plan</span><span class="o">=</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plan</span> <span class="p">])</span>

        <span class="c1"># Check that the plan methods are unique.  This should never be</span>
        <span class="c1"># raised, unless it also causes problems in the DAP itself.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">plan_methods</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plan_methods</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All of the plan methods must be unique!&#39;</span><span class="p">)</span>

        <span class="c1"># Get the list of methods to look for</span>
        <span class="k">if</span> <span class="n">methods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="n">plan_methods</span>
            <span class="n">use_plans</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plan_methods</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span>
            <span class="c1"># Make sure the provided list is unique</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must provide unique list of methods.&#39;</span><span class="p">)</span>
            <span class="c1"># All the methods to use must be in the provided plan</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span> <span class="p">[</span><span class="n">m</span> <span class="ow">in</span> <span class="n">plan_methods</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All provided methods must be in provided plan file.&#39;</span><span class="p">)</span>
            <span class="c1"># Find the index of the plans to use</span>
            <span class="n">use_plans</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plan_methods</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plan_methods</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">:</span>
                    <span class="n">use_plans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Check that all the plans to use have the same emission-line</span>
        <span class="c1"># bandpass channels, ...</span>
        <span class="n">elmom_keys</span><span class="p">,</span> <span class="n">elmom_channels</span> \
                    <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">DAPall</span><span class="o">.</span><span class="n">_emission_line_moment_db_info</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;elmom_key&#39;</span><span class="p">],</span>
                                                                         <span class="n">dapsrc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapsrc</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">[</span><span class="n">use_plans</span><span class="p">]</span> <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">([</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elmom_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">elmom_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">elmom_channels</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All plans must provide the same emission-line bandpass channels.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elmom_channels</span> <span class="o">=</span> <span class="n">elmom_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">elmom_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elmom_channels</span><span class="p">)</span>

        <span class="c1"># ..., emission-line fit channels, and...</span>
        <span class="n">elfit_keys</span><span class="p">,</span> <span class="n">elfit_channels</span> \
                    <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">DAPall</span><span class="o">.</span><span class="n">_emission_line_db_info</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;elfit_key&#39;</span><span class="p">],</span>
                                                                  <span class="n">dapsrc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapsrc</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">[</span><span class="n">use_plans</span><span class="p">]</span> <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">([</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elfit_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">elfit_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">elfit_channels</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All plans must provide the same emission-line fit channels.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elfit_channels</span> <span class="o">=</span> <span class="n">elfit_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">elfit_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neml</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elfit_channels</span><span class="p">)</span>

        <span class="c1"># ..., and spectral-index channels</span>
        <span class="n">abs_keys</span><span class="p">,</span> <span class="n">bhd_keys</span><span class="p">,</span> <span class="n">spindx_channels</span><span class="p">,</span> <span class="n">spindx_units</span> \
                    <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">DAPall</span><span class="o">.</span><span class="n">_spectral_index_db_info</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;spindex_key&#39;</span><span class="p">],</span>
                                                                   <span class="n">dapsrc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dapsrc</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">[</span><span class="n">use_plans</span><span class="p">]</span> <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">([</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spindx_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">spindx_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">spindx_channels</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All plans must provide the same emission-line fit channels.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spindx_channels</span> <span class="o">=</span> <span class="n">spindx_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spindx_units</span> <span class="o">=</span> <span class="n">spindx_units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">spindx_channels</span><span class="p">,</span> <span class="n">spindx_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nindx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spindx_channels</span><span class="p">)</span>

        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0:^50}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;RUNNING DAPALL UPDATE&#39;</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Available methods: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plan_methods</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                       <span class="s1">&#39;Methods for output: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">methods</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                       <span class="s1">&#39;Emission line moments: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmom</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                       <span class="s1">&#39;Emission lines fit: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neml</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                       <span class="s1">&#39;Spectral indices: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nindx</span><span class="p">))</span>

        <span class="c1"># Construct the list of files to look for</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifudesign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_completed_observations</span><span class="p">()</span>
        <span class="n">methodlist</span><span class="p">,</span> <span class="n">platelist</span><span class="p">,</span> <span class="n">ifulist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_plateifu_methods</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">)</span>
        <span class="n">dapfiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_maps_file_list</span><span class="p">(</span><span class="n">methodlist</span><span class="p">,</span> <span class="n">platelist</span><span class="p">,</span> <span class="n">ifulist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ndap</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dapfiles</span><span class="p">)</span>

        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                       <span class="s1">&#39;Completed observations: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plate</span><span class="p">)))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                       <span class="s1">&#39;Total number of expected DAP MAPS files: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndap</span><span class="p">))</span>

<span class="c1">#        # If the table already exists and not clobbering, remove any</span>
<span class="c1">#        # successfully completed files from the list</span>
<span class="c1">#        if not clobber and self.hdu is not None:</span>
<span class="c1">#</span>
<span class="c1">#            # Check that there&#39;s enough room for the emission lines</span>
<span class="c1">#            self[&#39;EMLINE_NAME&#39;].shape</span>
<span class="c1">#</span>
<span class="c1">#            existing_files = self._construct_maps_file_list(self[&#39;PLATE&#39;][self[&#39;DAPDONE&#39;]],</span>
<span class="c1">#                                                            self[&#39;IFUDESIGN&#39;][self[&#39;DAPDONE&#39;]])</span>
<span class="c1">#            dapfiles = list( set(dapfiles) - set(existing_files) )</span>
<span class="c1">#            # TODO: Need to test this</span>
<span class="c1">#            emptydb = init_record_array(len(dapfiles),</span>
<span class="c1">#                                        self._table_dtype(max(self.neml), max(self.nindx)))</span>

        <span class="c1"># If the HDUList is already initialized, close and reinitialize</span>
        <span class="c1"># it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Open the DRPall file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                       <span class="s1">&#39;Reading DRPall: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpall_file</span><span class="p">))</span>
        <span class="n">hdu_drpall</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpall_file</span><span class="p">)</span>
        <span class="n">drpall</span> <span class="o">=</span> <span class="n">hdu_drpall</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># Initialize the output database</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">init_record_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">neml</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nindx</span><span class="p">))</span>

        <span class="c1"># Add the basic information</span>
        <span class="n">db</span><span class="p">[</span><span class="s1">&#39;PLATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platelist</span>
        <span class="n">db</span><span class="p">[</span><span class="s1">&#39;IFUDESIGN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifulist</span>
        <span class="n">db</span><span class="p">[</span><span class="s1">&#39;PLATEIFU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">platelist</span><span class="p">,</span> <span class="n">ifulist</span><span class="p">)</span> <span class="p">])</span>
        <span class="c1"># For now only analyzing cubes!</span>
        <span class="n">db</span><span class="p">[</span><span class="s1">&#39;MODE&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="s1">&#39;CUBE&#39;</span>
        <span class="n">db</span><span class="p">[</span><span class="s1">&#39;DAPTYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">methodlist</span>

        <span class="c1"># Copy from DRPall</span>
        <span class="n">columns_from_drpall</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;MANGAID&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJRA&#39;</span><span class="p">,</span> <span class="s1">&#39;OBJDEC&#39;</span><span class="p">,</span> <span class="s1">&#39;IFURA&#39;</span><span class="p">,</span> <span class="s1">&#39;IFUDEC&#39;</span><span class="p">,</span> <span class="s1">&#39;MNGTARG1&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;MNGTARG2&#39;</span><span class="p">,</span> <span class="s1">&#39;MNGTARG3&#39;</span><span class="p">,</span> <span class="s1">&#39;NSA_Z&#39;</span><span class="p">,</span> <span class="s1">&#39;NSA_ZDIST&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;NSA_ELPETRO_BA&#39;</span><span class="p">,</span> <span class="s1">&#39;NSA_ELPETRO_PHI&#39;</span><span class="p">,</span> <span class="s1">&#39;NSA_ELPETRO_TH50_R&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;NSA_SERSIC_BA&#39;</span><span class="p">,</span> <span class="s1">&#39;NSA_SERSIC_PHI&#39;</span><span class="p">,</span> <span class="s1">&#39;NSA_SERSIC_TH50&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;NSA_SERSIC_N&#39;</span><span class="p">,</span> <span class="s1">&#39;VERSDRP2&#39;</span><span class="p">,</span> <span class="s1">&#39;VERSDRP3&#39;</span><span class="p">,</span> <span class="s1">&#39;VERSCORE&#39;</span><span class="p">,</span> <span class="s1">&#39;VERSUTIL&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;DRP3QUAL&#39;</span> <span class="p">]</span>

        <span class="n">columns_from_maps_hdr</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;VERSDAP&#39;</span><span class="p">,</span> <span class="s1">&#39;DAPQUAL&#39;</span><span class="p">,</span> <span class="s1">&#39;RDXQAKEY&#39;</span><span class="p">,</span> <span class="s1">&#39;BINKEY&#39;</span><span class="p">,</span> <span class="s1">&#39;SCKEY&#39;</span><span class="p">,</span> <span class="s1">&#39;ELMKEY&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;ELFKEY&#39;</span><span class="p">,</span> <span class="s1">&#39;SIKEY&#39;</span><span class="p">,</span> <span class="s1">&#39;BINTYPE&#39;</span> <span class="p">]</span>

        <span class="c1"># Itereate through each maps file</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndap</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ndap</span><span class="p">))</span><span class="c1">#, end=&#39;\r&#39;)</span>

            <span class="c1"># Find the index in the drpall file</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">drpall</span><span class="p">[</span><span class="s1">&#39;PLATEIFU&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;PLATEIFU&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;More than one entry in DRPall file: </span><span class="si">{0}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;PLATEIFU&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Could not find </span><span class="si">{0}</span><span class="s1"> in DRPall file!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;PLATEIFU&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;DRPALLINDX&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Add data from the DRPall file</span>
            <span class="k">if</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;DRPALLINDX&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns_from_drpall</span><span class="p">:</span>
                    <span class="n">db</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">drpall</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;DRPALLINDX&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>

            <span class="c1"># Set the cosmological distances based on the NSA redshift</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;LDIST_NSA_Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span><span class="o">.</span><span class="n">luminosity_distance</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;NSA_Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">value</span> \
                                        <span class="k">if</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;NSA_Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">999.</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;ADIST_NSA_Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span><span class="o">.</span><span class="n">angular_diameter_distance</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;NSA_Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">value</span> \
                                        <span class="k">if</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;NSA_Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">999.</span>

            <span class="c1"># Open the maps file</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dapfiles</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">db</span><span class="p">[</span><span class="s1">&#39;DAPDONE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># A fault occurred such that the MAPS file was not produced</span>
                <span class="k">continue</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;DAPDONE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>        <span class="c1"># DAP successfully produced the file</span>
            <span class="n">dapmaps</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dapfiles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># Add information from the DAP MAPS file header</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns_from_maps_hdr</span><span class="p">:</span>
                <span class="n">db</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>

            <span class="c1"># Additional elements from the header that need to be handled</span>
            <span class="c1"># or have different names</span>
            <span class="c1"># TODO: REMOVE all of the latter to make sure keywords match</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">db</span><span class="p">[</span><span class="s1">&#39;BINSNR&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BINSNR&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">db</span><span class="p">[</span><span class="s1">&#39;BINSNR&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.0</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;TPLKEY&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PPXFTPLK&#39;</span><span class="p">]</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;DAPBINS&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NBINS&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">db</span><span class="p">[</span><span class="s1">&#39;DATEDAP&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DATEDAP&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">db</span><span class="p">[</span><span class="s1">&#39;DATEDAP&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
                                                 <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">dapfiles</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>

            <span class="c1"># TODO: Add any checks that the DRPall data matches the</span>
            <span class="c1"># header data in the MAPS files?</span>

            <span class="c1"># Basic mask for all maps: mask any spaxel not included</span>
            <span class="c1"># in any bin</span>
            <span class="n">basic_map_mask</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">&lt;</span> <span class="mi">0</span>

            <span class="c1"># Set input redshift and cosmological distances based on</span>
            <span class="c1"># this redshift</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SCINPVEL&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">astropy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;LDIST_Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span><span class="o">.</span><span class="n">luminosity_distance</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;ADIST_Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span><span class="o">.</span><span class="n">angular_diameter_distance</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>

            <span class="c1"># Determine the coverage of the datacube (independent of the</span>
            <span class="c1"># DAP method)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;SPX_ELLCOO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="mi">0</span><span class="p">,:,:],</span> <span class="n">mask</span><span class="o">=</span><span class="n">basic_map_mask</span><span class="p">)</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;RCOV90&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radial_coverage_metric</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span>
                                                           <span class="mi">1</span><span class="o">-</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;NSA_ELPETRO_BA&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># Get the SRD-based S/N metric (independent of the DAP</span>
            <span class="c1"># method)</span>
            <span class="n">r_re</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;SPX_ELLCOO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="mi">1</span><span class="p">,:,:],</span>
                                        <span class="n">mask</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;SPX_SNR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;SNR_MED&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;SNR_RING&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srd_snr_metric</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">)</span>

            <span class="c1"># Get the mean surface brightness within 1 Re used by the</span>
            <span class="c1"># stellar-continuum fitting (independent of the DAP method)</span>
            <span class="n">mflux</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;SPX_MFLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                         <span class="n">mask</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">[</span><span class="s1">&#39;SPX_SNR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">within_1re</span> <span class="o">=</span> <span class="n">r_re</span> <span class="o">&lt;</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">within_1re</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No data within 1 Re!&#39;</span><span class="p">)</span>
                <span class="n">db</span><span class="p">[</span><span class="s1">&#39;SB_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">999.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">db</span><span class="p">[</span><span class="s1">&#39;SB_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mflux</span><span class="p">[</span><span class="n">within_1re</span><span class="p">])</span>

            <span class="c1"># Get the spatial binning metrics</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;BIN_RMAX&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;BIN_R_N&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;BIN_R_SNR&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> \
                            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binning_metrics</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">)</span>

            <span class="c1"># Get the metrics for the stellar kinematics</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;STELLAR_Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;STELLAR_VEL_LO&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;STELLAR_VEL_HI&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> \
                    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;STELLAR_VEL_LO_CLIP&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;STELLAR_VEL_HI_CLIP&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> \
                    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;STELLAR_SIGMA_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;STELLAR_CONT_RCHI2_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> \
                            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stellar_kinematics_metrics</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">,</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># Get the metrics for the emission-line kinematics</span>
            <span class="c1"># TODO: Check for hybrid binning method, then use</span>
            <span class="c1"># spx_coo=True if emission lines measured on individual</span>
            <span class="c1"># spaxels</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;HA_Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;HA_GVEL_LO&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;HA_GVEL_HI&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;HA_GVEL_LO_CLIP&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> \
                    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;HA_GVEL_HI_CLIP&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;HA_GSIGMA_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;HA_GSIGMA_HI&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> \
                    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;HA_GSIGMA_HI_CLIP&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_halpha_kinematics_metrics</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">,</span>
                                                                                 <span class="n">db</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># Get the moment-based emission-line metrics</span>
            <span class="c1"># TODO: Check for hybrid binning method, then use</span>
            <span class="c1"># spx_coo=True if emission lines measured on individual</span>
            <span class="c1"># spaxels</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_SFLUX_CEN&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_SFLUX_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_SFLUX_TOT&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> \
                    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_SSB_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_SSB_PEAK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_SEW_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> \
                    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_SEW_PEAK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emission_line_metrics</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">,</span> <span class="n">moment0</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Get the Gaussian-based emission-line metrics</span>
            <span class="c1"># TODO: Check for hybrid binning method, then use</span>
            <span class="c1"># spx_coo=True if emission lines measured on individual</span>
            <span class="c1"># spaxels</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_GFLUX_CEN&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_GFLUX_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_GFLUX_TOT&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> \
                    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_GSB_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_GSB_PEAK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_GEW_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> \
                    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_GEW_PEAK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emission_line_metrics</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">)</span>

            <span class="c1"># Get the spectral-index metrics</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;SPECINDEX_LO&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;SPECINDEX_HI&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;SPECINDEX_LO_CLIP&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> \
                    <span class="n">db</span><span class="p">[</span><span class="s1">&#39;SPECINDEX_HI_CLIP&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;SPECINDEX_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> \
                            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spectral_index_metrics</span><span class="p">(</span><span class="n">dapmaps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spindx_units</span><span class="p">)</span>

            <span class="c1"># Estimate the star-formation rate</span>
            <span class="n">log_Mpc_in_cm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">astropy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span>
            <span class="n">log_halpha_luminosity_1re</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> \
                        <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_GFLUX_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">elfit_channels</span><span class="p">[</span><span class="s1">&#39;Ha-6564&#39;</span><span class="p">]])</span> \
                        <span class="o">-</span> <span class="mi">17</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;LDIST_Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">log_Mpc_in_cm</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;SFR_1RE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">log_halpha_luminosity_1re</span> <span class="o">-</span> <span class="mf">41.27</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="o">-</span><span class="mf">999.</span><span class="p">)</span>
            <span class="n">log_halpha_luminosity_tot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> \
                        <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;EMLINE_GFLUX_TOT&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">elfit_channels</span><span class="p">[</span><span class="s1">&#39;Ha-6564&#39;</span><span class="p">]])</span> \
                        <span class="o">-</span> <span class="mi">17</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;LDIST_Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">log_Mpc_in_cm</span>
            <span class="n">db</span><span class="p">[</span><span class="s1">&#39;SFR_TOT&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">log_halpha_luminosity_tot</span> <span class="o">-</span> <span class="mf">41.27</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="o">-</span><span class="mf">999.</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndap</span><span class="p">))</span>

        <span class="c1"># Check that all the data is finite.</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span> \
                        <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="n">name</span><span class="p">])):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All values not finite in column </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All values not finite in DAPall table.&#39;</span><span class="p">)</span>

        <span class="c1"># Create the primary header</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">()),</span> <span class="s1">&#39;UTC date created&#39;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;VERSDRP3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span> <span class="s1">&#39;DRP version&#39;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;VERSDAP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dapver</span><span class="p">,</span> <span class="s1">&#39;DAP version&#39;</span><span class="p">)</span>

        <span class="c1"># Add the emission-line moment channel header</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_channels_to_header</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elmom_channels</span><span class="p">,</span> <span class="s1">&#39;ELS&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;Summed emission-line element&#39;</span><span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_channels_to_header</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elfit_channels</span><span class="p">,</span> <span class="s1">&#39;ELG&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;Gaussian fit emission-line element&#39;</span><span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_channels_to_header</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spindx_channels</span><span class="p">,</span> <span class="s1">&#39;SPI&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;Spectral-indx element&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spindx_units</span><span class="p">)</span>

        <span class="c1"># Set the fits HDU list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">hdr</span><span class="p">),</span>
                                  <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span>
                                    <span class="p">[</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">rec_to_fits_type</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="n">n</span><span class="p">]),</span>
                                      <span class="n">array</span><span class="o">=</span><span class="n">db</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="p">],</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;DAPALL&#39;</span><span class="p">)</span> <span class="p">])</span>

        <span class="c1"># Write the file (this function is probably overkill)</span>
        <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(),</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">loggers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">)</span></div></div>
        

</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, SDSS-IV/MaNGA Pipeline Group.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'2.2.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>