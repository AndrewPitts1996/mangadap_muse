

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mangadap.proc.emissionlinemoments &mdash; mangadap 2.2.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="mangadap 2.2.2 documentation" href="../../../index.html"/>
        <link rel="up" title="mangadap" href="../../mangadap.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> mangadap
          

          
          </a>

          
            
            
              <div class="version">
                2.2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mangadap.html">mangadap package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mangadap</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../mangadap.html">mangadap</a> &raquo;</li>
        
      <li>mangadap.proc.emissionlinemoments</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mangadap.proc.emissionlinemoments</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A class hierarchy that measures moments of the observed emission lines.</span>

<span class="sd">*License*:</span>
<span class="sd">    Copyright (c) 2015, SDSS-IV/MaNGA Pipeline Group</span>
<span class="sd">        Licensed under BSD 3-clause license - see LICENSE.rst</span>

<span class="sd">*Source location*:</span>
<span class="sd">    $MANGADAP_DIR/python/mangadap/proc/emissionlinemoments.py</span>

<span class="sd">*Imports and python version compliance*:</span>
<span class="sd">    ::</span>

<span class="sd">        from __future__ import division</span>
<span class="sd">        from __future__ import print_function</span>
<span class="sd">        from __future__ import absolute_import</span>
<span class="sd">        from __future__ import unicode_literals</span>

<span class="sd">        import sys</span>
<span class="sd">        import warnings</span>
<span class="sd">        if sys.version &gt; &#39;3&#39;:</span>
<span class="sd">            long = int</span>

<span class="sd">        import glob</span>
<span class="sd">        import os</span>
<span class="sd">        import logging</span>
<span class="sd">        import numpy</span>

<span class="sd">        from astropy.io import fits</span>
<span class="sd">        import astropy.constants</span>

<span class="sd">        from ..config.defaults import dap_source_dir, default_dap_file_name</span>
<span class="sd">        from ..config.defaults import default_dap_method, default_dap_method_path</span>
<span class="sd">        from ..util.fileio import init_record_array, rec_to_fits_type</span>
<span class="sd">        from ..util.bitmask import BitMask</span>
<span class="sd">        from ..util.pixelmask import SpectralPixelMask</span>
<span class="sd">        from ..util.log import log_output</span>
<span class="sd">        from ..util.parser import DefaultConfig</span>
<span class="sd">        from ..par.parset import ParSet</span>
<span class="sd">        from ..par.artifactdb import ArtifactDB</span>
<span class="sd">        from ..par.emissionmomentsdb import EmissionMomentsDB</span>
<span class="sd">        from .spatiallybinnedspectra import SpatiallyBinnedSpectra</span>
<span class="sd">        from .stellarcontinuummodel import StellarContinuumModel</span>
<span class="sd">        from .bandpassfilter import passband_integral, passband_integrated_width, passband_median</span>
<span class="sd">        from .bandpassfilter import passband_integrated_mean, passband_weighted_mean</span>
<span class="sd">        from .util import select_proc_method</span>

<span class="sd">*Class usage examples*:</span>
<span class="sd">    Add examples!</span>

<span class="sd">*Revision history*:</span>
<span class="sd">    | **25 Apr 2016**: Implementation begun by K. Westfall (KBW)</span>
<span class="sd">    | **20 May 2016**: (KBW) Added loggers and quiet keyword arguments</span>
<span class="sd">        to :class:`EmissionLineMoments`, removed verbose </span>
<span class="sd">    | **28 Jul 2016**: (KBW) Fixed error in initialization of guess</span>
<span class="sd">        redshift when stellar continuum is provided.</span>
<span class="sd">    | **09 Jan 2017**: (KBW) Generalized so that it no longer reads in</span>
<span class="sd">        StellarContinuumModel object.</span>
<span class="sd">    | **23 Feb 2017**: (KBW) Use DAPFitsUtil read and write functions.</span>
<span class="sd">    | **27 Feb 2017**: (KBW) Use DefaultConfig for ini files.</span>
<span class="sd">    | **31 May 2017**: (KBW) Revert to using</span>
<span class="sd">        :class:`mangadap.proc.stellarcontinuummodel.StellarContinuumModel`</span>
<span class="sd">        on input</span>
<span class="sd">    | **02 Feb 2018**: (KBW) Adjust for change to</span>
<span class="sd">        :func:`mangadap.proc.stellarcontinuummodel.StellarContinuumModel.fill_to_match`.</span>
<span class="sd">    | **15 Feb 2018**: (KBW) Add parameter that will set whether or not</span>
<span class="sd">        the moments should be remeasured after the emission-line</span>
<span class="sd">        modeling.  Allow to pass an emission-line model for setting up</span>
<span class="sd">        the continuum and the velocities to measure.</span>

<span class="sd">.. _astropy.io.fits.hdu.hdulist.HDUList: http://docs.astropy.org/en/v1.0.2/io/fits/api/hdulists.html</span>
<span class="sd">.. _glob.glob: https://docs.python.org/3.4/library/glob.html</span>
<span class="sd">.. _logging.Logger: https://docs.python.org/3/library/logging.html</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
    <span class="n">long</span> <span class="o">=</span> <span class="nb">int</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">astropy.constants</span>

<span class="kn">from</span> <span class="nn">..config.defaults</span> <span class="k">import</span> <span class="n">dap_source_dir</span><span class="p">,</span> <span class="n">default_dap_file_name</span>
<span class="kn">from</span> <span class="nn">..config.defaults</span> <span class="k">import</span> <span class="n">default_dap_method</span><span class="p">,</span> <span class="n">default_dap_method_path</span>
<span class="kn">from</span> <span class="nn">..util.fitsutil</span> <span class="k">import</span> <span class="n">DAPFitsUtil</span>
<span class="kn">from</span> <span class="nn">..util.fileio</span> <span class="k">import</span> <span class="n">init_record_array</span><span class="p">,</span> <span class="n">rec_to_fits_type</span>
<span class="kn">from</span> <span class="nn">..util.bitmask</span> <span class="k">import</span> <span class="n">BitMask</span>
<span class="kn">from</span> <span class="nn">..util.pixelmask</span> <span class="k">import</span> <span class="n">SpectralPixelMask</span>
<span class="kn">from</span> <span class="nn">..util.log</span> <span class="k">import</span> <span class="n">log_output</span>
<span class="kn">from</span> <span class="nn">..util.parser</span> <span class="k">import</span> <span class="n">DefaultConfig</span>
<span class="kn">from</span> <span class="nn">..par.parset</span> <span class="k">import</span> <span class="n">ParSet</span>
<span class="kn">from</span> <span class="nn">..par.artifactdb</span> <span class="k">import</span> <span class="n">ArtifactDB</span>
<span class="kn">from</span> <span class="nn">..par.emissionmomentsdb</span> <span class="k">import</span> <span class="n">EmissionMomentsDB</span>
<span class="kn">from</span> <span class="nn">.spatiallybinnedspectra</span> <span class="k">import</span> <span class="n">SpatiallyBinnedSpectra</span>
<span class="kn">from</span> <span class="nn">.stellarcontinuummodel</span> <span class="k">import</span> <span class="n">StellarContinuumModel</span>
<span class="kn">from</span> <span class="nn">.bandpassfilter</span> <span class="k">import</span> <span class="n">passband_integral</span><span class="p">,</span> <span class="n">passband_integrated_width</span>
<span class="kn">from</span> <span class="nn">.bandpassfilter</span> <span class="k">import</span> <span class="n">passband_weighted_mean</span><span class="p">,</span> <span class="n">passband_weighted_sdev</span><span class="p">,</span> <span class="n">pseudocontinuum</span>
<span class="kn">from</span> <span class="nn">.bandpassfilter</span> <span class="k">import</span> <span class="n">emission_line_equivalent_width</span>
<span class="kn">from</span> <span class="nn">.spectralfitting</span> <span class="k">import</span> <span class="n">EmissionLineFit</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="k">import</span> <span class="n">select_proc_method</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>
<span class="c1">#from memory_profiler import profile</span>

<span class="c1"># Add strict versioning</span>
<span class="c1"># from distutils.version import StrictVersion</span>


<div class="viewcode-block" id="EmissionLineMomentsDef"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMomentsDef">[docs]</a><span class="k">class</span> <span class="nc">EmissionLineMomentsDef</span><span class="p">(</span><span class="n">ParSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that holds the parameters necessary to perform the</span>
<span class="sd">    emission-line moment measurements.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (str): Keyword used to distinguish between different</span>
<span class="sd">            emission-line moment databases.</span>
<span class="sd">        minimum_snr (bool): Minimum S/N of spectrum to fit</span>
<span class="sd">        artifacts (str): String identifying the artifact database to use</span>
<span class="sd">        passbands (str): String identifying the emission-line bandpass</span>
<span class="sd">            filter database to use</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">minimum_snr</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">,</span> <span class="n">passbands</span><span class="p">,</span> <span class="n">redo_postmodeling</span><span class="p">,</span> <span class="n">fit_vel_name</span><span class="p">):</span>
        <span class="n">in_fl</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span> <span class="p">]</span>

        <span class="n">pars</span> <span class="o">=</span>     <span class="p">[</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;minimum_snr&#39;</span><span class="p">,</span> <span class="s1">&#39;artifacts&#39;</span><span class="p">,</span> <span class="s1">&#39;passbands&#39;</span><span class="p">,</span> <span class="s1">&#39;redo_postmodeling&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;fit_vel_name&#39;</span> <span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span>   <span class="p">[</span> <span class="n">key</span><span class="p">,</span> <span class="n">minimum_snr</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">,</span> <span class="n">passbands</span><span class="p">,</span> <span class="n">redo_postmodeling</span><span class="p">,</span> <span class="n">fit_vel_name</span> <span class="p">]</span>
        <span class="n">dtypes</span> <span class="o">=</span>   <span class="p">[</span> <span class="nb">str</span><span class="p">,</span> <span class="n">in_fl</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span> <span class="p">]</span>

        <span class="n">ParSet</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="n">dtypes</span><span class="p">)</span></div>


<div class="viewcode-block" id="validate_emission_line_moments_config"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.validate_emission_line_moments_config">[docs]</a><span class="k">def</span> <span class="nf">validate_emission_line_moments_config</span><span class="p">(</span><span class="n">cnfg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Validate the :class:`mangadap.util.parser.DefaultConfig` with the</span>
<span class="sd">    emission-line moment measurement parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        cnfg (:class:`mangadap.util.parser.DefaultConfig`): Object meant</span>
<span class="sd">            to contain defining parameters of the emission-line moments</span>
<span class="sd">            as needed by :class:`EmissionLineMomentsDef`</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: Raised if any required keywords do not exist.</span>
<span class="sd">        ValueError: Raised if keys have unacceptable values.</span>
<span class="sd">        FileNotFoundError: Raised if a file is specified but could not</span>
<span class="sd">            be found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check for required keywords</span>
    <span class="n">required_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;emission_passbands&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cnfg</span><span class="o">.</span><span class="n">all_required</span><span class="p">(</span><span class="n">required_keywords</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Keywords </span><span class="si">{0}</span><span class="s1"> must all have valid values.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_keywords</span><span class="p">))</span></div>


<div class="viewcode-block" id="available_emission_line_moment_databases"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.available_emission_line_moment_databases">[docs]</a><span class="k">def</span> <span class="nf">available_emission_line_moment_databases</span><span class="p">(</span><span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the list of available emission-line moment databases.</span>

<span class="sd">    Available database combinations:</span>

<span class="sd">    .. todo::</span>
<span class="sd">        Fill in</span>

<span class="sd">    Args:</span>
<span class="sd">        dapsrc (str): (**Optional**) Root path to the DAP source</span>
<span class="sd">            directory.  If not provided, the default is defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.dap_source_dir`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of :func:`EmissionLineMomentsDef` objects, each</span>
<span class="sd">        defining an emission-line moment database to measure.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotADirectoryError: Raised if the provided or default</span>
<span class="sd">            *dapsrc* is not a directory.</span>
<span class="sd">        OSError/IOError: Raised if no emission-line moment configuration</span>
<span class="sd">            files could be found.</span>
<span class="sd">        KeyError: Raised if the emission-line moment database keywords</span>
<span class="sd">            are not all unique.</span>

<span class="sd">    .. todo::</span>
<span class="sd">        - Somehow add a python call that reads the databases and</span>
<span class="sd">          constructs the table for presentation in sphinx so that the</span>
<span class="sd">          text above doesn&#39;t have to be edited with changes in the</span>
<span class="sd">          available databases.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check the source directory exists</span>
    <span class="n">dapsrc</span> <span class="o">=</span> <span class="n">dap_source_dir</span><span class="p">()</span> <span class="k">if</span> <span class="n">dapsrc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> does not exist!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">))</span>

    <span class="c1"># Check the configuration files exist</span>
    <span class="n">search_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">,</span> <span class="s1">&#39;python/mangadap/config/emission_line_moments&#39;</span><span class="p">)</span>
    <span class="n">ini_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">search_dir</span><span class="p">,</span> <span class="s1">&#39;*.ini&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ini_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Could not find any configuration files in </span><span class="si">{0}</span><span class="s1"> !&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">search_dir</span><span class="p">))</span>

    <span class="c1"># Build the list of library definitions</span>
    <span class="n">moment_set_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ini_files</span><span class="p">:</span>
        <span class="c1"># Read the config file</span>
        <span class="n">cnfg</span> <span class="o">=</span> <span class="n">DefaultConfig</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c1"># Ensure it has the necessary elements to define the template</span>
        <span class="c1"># library</span>
        <span class="n">validate_emission_line_moments_config</span><span class="p">(</span><span class="n">cnfg</span><span class="p">)</span>

        <span class="n">moment_set_list</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">EmissionLineMomentsDef</span><span class="p">(</span><span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span>
                                                    <span class="n">cnfg</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;minimum_snr&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.</span><span class="p">),</span>
                                                    <span class="n">cnfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;artifact_mask&#39;</span><span class="p">),</span>
                                                    <span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;emission_passbands&#39;</span><span class="p">],</span>
                                                    <span class="n">cnfg</span><span class="o">.</span><span class="n">getbool</span><span class="p">(</span><span class="s1">&#39;redo_postmodeling&#39;</span><span class="p">,</span>
                                                                 <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                                    <span class="n">cnfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fit_vel_name&#39;</span><span class="p">))</span> <span class="p">]</span>

    <span class="c1"># Check the keywords of the libraries are all unique</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">moment</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">moment</span> <span class="ow">in</span> <span class="n">moment_set_list</span><span class="p">])))</span> \
                <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">moment_set_list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Emission-line moment database keywords are not all unique!&#39;</span><span class="p">)</span>

    <span class="c1"># Return the default list of assessment methods</span>
    <span class="k">return</span> <span class="n">moment_set_list</span></div>


<div class="viewcode-block" id="EmissionLineMomentsBitMask"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMomentsBitMask">[docs]</a><span class="k">class</span> <span class="nc">EmissionLineMomentsBitMask</span><span class="p">(</span><span class="n">BitMask</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Derived class that specifies the mask bits for the emission-line</span>
<span class="sd">    moment measurements.  See :class:`mangadap.util.bitmask.BitMask` for</span>
<span class="sd">    attributes.</span>

<span class="sd">    A list of the bits and meanings are provided by the base class</span>
<span class="sd">    function :func:`mangadap.util.bitmask.BitMask.info`; i.e.,::</span>

<span class="sd">        from mangadap.proc.emissionlinemoments import EmissionLineMomentsBitMask</span>
<span class="sd">        bm = EmissionLineMomentsBitMask()</span>
<span class="sd">        bm.info()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dapsrc</span> <span class="o">=</span> <span class="n">dap_source_dir</span><span class="p">()</span> <span class="k">if</span> <span class="n">dapsrc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">)</span>
        <span class="n">BitMask</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ini_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;mangadap&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;bitmasks&#39;</span><span class="p">,</span> <span class="s1">&#39;emission_line_moments_bits.ini&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="EmissionLineMoments"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments">[docs]</a><span class="k">class</span> <span class="nc">EmissionLineMoments</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Class that holds the emission-line moment measurements.</span>

<span class="sd">    Args:</span>
<span class="sd">        loggers (list): (**Optional**) List of `logging.Logger`_ objects</span>
<span class="sd">            to log progress; ignored if quiet=True.  Logging is done</span>
<span class="sd">            using :func:`mangadap.util.log.log_output`.  Default is no</span>
<span class="sd">            logging.</span>
<span class="sd">        quiet (bool): (**Optional**) Suppress all terminal and logging</span>
<span class="sd">            output.  Default is False.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        loggers (list): List of `logging.Logger`_ objects to log</span>
<span class="sd">            progress; ignored if quiet=True.  Logging is done using</span>
<span class="sd">            :func:`mangadap.util.log.log_output`.</span>
<span class="sd">        quiet (bool): Suppress all terminal and logging output.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#    @profile</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_key</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">emission_line_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">redshift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">database_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">artifact_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">bandpass_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">directory_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hardcopy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">checksum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loggers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loggers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Define the database properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixelmask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artdb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">momdb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_define_databases</span><span class="p">(</span><span class="n">database_key</span><span class="p">,</span> <span class="n">database_list</span><span class="o">=</span><span class="n">database_list</span><span class="p">,</span>
                               <span class="n">artifact_list</span><span class="o">=</span><span class="n">artifact_list</span><span class="p">,</span> <span class="n">bandpass_list</span><span class="o">=</span><span class="n">bandpass_list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nmom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momdb</span><span class="o">.</span><span class="n">nsets</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stellar_continuum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Define the output directory and file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># Set in _set_paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hardcopy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Initialize the objects used in the assessments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">EmissionLineMomentsBitMask</span><span class="p">(</span><span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="n">checksum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nspec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_arrays</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_image_arrays</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_bins</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Run the assessments of the DRP file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">binned_spectra</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="o">=</span><span class="n">stellar_continuum</span><span class="p">,</span>
                     <span class="n">emission_line_model</span><span class="o">=</span><span class="n">emission_line_model</span><span class="p">,</span> <span class="n">redshift</span><span class="o">=</span><span class="n">redshift</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">,</span>
                     <span class="n">dapver</span><span class="o">=</span><span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="n">analysis_path</span><span class="p">,</span> <span class="n">directory_path</span><span class="o">=</span><span class="n">directory_path</span><span class="p">,</span>
                     <span class="n">output_file</span><span class="o">=</span><span class="n">output_file</span><span class="p">,</span> <span class="n">hardcopy</span><span class="o">=</span><span class="n">hardcopy</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">,</span> <span class="n">loggers</span><span class="o">=</span><span class="n">loggers</span><span class="p">,</span>
                     <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


<div class="viewcode-block" id="EmissionLineMoments._define_databases"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments._define_databases">[docs]</a>    <span class="k">def</span> <span class="nf">_define_databases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_key</span><span class="p">,</span> <span class="n">database_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">artifact_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">bandpass_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select the database of bandpass filters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Grab the specific database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">select_proc_method</span><span class="p">(</span><span class="n">database_key</span><span class="p">,</span> <span class="n">EmissionLineMomentsDef</span><span class="p">,</span>
                                           <span class="n">method_list</span><span class="o">=</span><span class="n">database_list</span><span class="p">,</span>
                                           <span class="n">available_func</span><span class="o">=</span><span class="n">available_emission_line_moment_databases</span><span class="p">,</span>
                                           <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>

        <span class="c1"># Instantiate the artifact and bandpass filter database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artdb</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;artifacts&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                    <span class="n">ArtifactDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;artifacts&#39;</span><span class="p">],</span> <span class="n">artdb_list</span><span class="o">=</span><span class="n">artifact_list</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixelmask</span> <span class="o">=</span> <span class="n">SpectralPixelMask</span><span class="p">(</span><span class="n">artdb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">artdb</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">momdb</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;passbands&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                <span class="n">EmissionMomentsDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;passbands&#39;</span><span class="p">],</span> <span class="n">emldb_list</span><span class="o">=</span><span class="n">bandpass_list</span><span class="p">,</span>
                                  <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span></div>


<div class="viewcode-block" id="EmissionLineMoments._set_paths"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments._set_paths">[docs]</a>    <span class="k">def</span> <span class="nf">_set_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory_path</span><span class="p">,</span> <span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the :attr:`directory_path` and :attr:`output_file`.  If not</span>
<span class="sd">        provided, the defaults are set using, respectively,</span>
<span class="sd">        :func:`mangadap.config.defaults.default_dap_method_path` and</span>
<span class="sd">        :func:`mangadap.config.defaults.default_dap_file_name`.</span>

<span class="sd">        ..warning::</span>

<span class="sd">            File name is different if an emission-line model is</span>
<span class="sd">            provided!</span>

<span class="sd">        Args:</span>
<span class="sd">            directory_path (str): The exact path to the DAP</span>
<span class="sd">                emission-line moments file.  See :attr:`directory_path`.</span>
<span class="sd">            dapver (str): DAP version.</span>
<span class="sd">            analysis_path (str): The path to the top-level directory</span>
<span class="sd">                containing the DAP output files for a given DRP and DAP</span>
<span class="sd">                version.</span>
<span class="sd">            output_file (str): The name of the file with emission-line</span>
<span class="sd">                moment measurements.  See :func:`measure`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the output directory path</span>
        <span class="n">continuum_method</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stellar_continuum</span> <span class="ow">is</span> <span class="kc">None</span> \
                                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">stellar_continuum</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">default_dap_method</span><span class="p">(</span><span class="n">binned_spectra</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">,</span>
                                    <span class="n">continuum_method</span><span class="o">=</span><span class="n">continuum_method</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span> <span class="o">=</span> <span class="n">default_dap_method_path</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">plate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span>
                                                      <span class="n">ifudesign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span>
                                                      <span class="n">ref</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                      <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span>
                                                      <span class="n">dapver</span><span class="o">=</span><span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="n">analysis_path</span><span class="p">)</span> \
                                        <span class="k">if</span> <span class="n">directory_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)</span>

        <span class="c1"># Set the output file</span>
        <span class="n">ref_method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">rdxqa</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">continuum_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref_method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref_method</span><span class="p">,</span> <span class="n">continuum_method</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref_method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref_method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
        <span class="n">ref_method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref_method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">default_dap_file_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span> <span class="n">ref_method</span><span class="p">)</span> \
                                        <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="EmissionLineMoments._initialize_primary_header"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments._initialize_primary_header">[docs]</a>    <span class="k">def</span> <span class="nf">_initialize_primary_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">measurements_binid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the header of :attr:`hdu`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            astropy.io.fits.Header : Edited header object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Copy the from the DRP and clean it</span>
        <span class="k">if</span> <span class="n">hdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">clean_dap_primary_header</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
        
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;AUTHOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Kyle B. Westfall &lt;westfall@ucolick.org&gt;&#39;</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ELMKEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> <span class="s1">&#39;Emission-line moments database keyword&#39;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ELMMINSN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;minimum_snr&#39;</span><span class="p">],</span> <span class="s1">&#39;Minimum S/N of spectrum to include&#39;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ARTDB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;artifacts&#39;</span><span class="p">],</span> <span class="s1">&#39;Artifact database keyword&#39;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;MOMDB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;passbands&#39;</span><span class="p">],</span> <span class="s1">&#39;Emission-line moments database keyword&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stellar_continuum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;SCKEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stellar_continuum</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> <span class="s1">&#39;Stellar-continuum model keyword&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ELFKEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;Emission-line modeling method keyword&#39;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NBINS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span> <span class="s1">&#39;Number of unique spectra for measurements&#39;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;ELMREBIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">measurements_binid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Bin IDs disconnected from SC binning&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hdr</span></div>


<div class="viewcode-block" id="EmissionLineMoments._moments_database_dtype"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments._moments_database_dtype">[docs]</a>    <span class="k">def</span> <span class="nf">_moments_database_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_len</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the record array data type for the output fits</span>
<span class="sd">        extension.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;U</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_len</span><span class="p">)),</span>
                 <span class="p">(</span><span class="s1">&#39;RESTWAVE&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;PASSBAND&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;BLUEBAND&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;REDBAND&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,))</span>
               <span class="p">]</span></div>

    
<div class="viewcode-block" id="EmissionLineMoments._compile_database"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments._compile_database">[docs]</a>    <span class="k">def</span> <span class="nf">_compile_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compile the database with the specifications of each index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">momdb</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">name_len</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">name_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># Instatiate the table data that will be saved defining the set</span>
        <span class="c1"># of emission-line moments measured</span>
        <span class="n">passband_database</span> <span class="o">=</span> <span class="n">init_record_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moments_database_dtype</span><span class="p">(</span><span class="n">name_len</span><span class="p">))</span>

        <span class="n">hk</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;RESTWAVE&#39;</span><span class="p">,</span> <span class="s1">&#39;PASSBAND&#39;</span><span class="p">,</span> <span class="s1">&#39;BLUEBAND&#39;</span><span class="p">,</span> <span class="s1">&#39;REDBAND&#39;</span> <span class="p">]</span>
        <span class="n">mk</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;restwave&#39;</span><span class="p">,</span> <span class="s1">&#39;primary&#39;</span><span class="p">,</span> <span class="s1">&#39;blueside&#39;</span><span class="p">,</span> <span class="s1">&#39;redside&#39;</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">_hk</span><span class="p">,</span> <span class="n">_mk</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hk</span><span class="p">,</span><span class="n">mk</span><span class="p">):</span>
            <span class="n">passband_database</span><span class="p">[</span><span class="n">_hk</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momdb</span><span class="p">[</span><span class="n">_mk</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">passband_database</span></div>


<div class="viewcode-block" id="EmissionLineMoments._assign_image_arrays"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments._assign_image_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">_assign_image_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set :attr:`image_arrays`, which contains the list of extensions</span>
<span class="sd">        in :attr:`hdu` that are on-sky image data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_arrays</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;BINID&#39;</span> <span class="p">]</span></div>


<div class="viewcode-block" id="EmissionLineMoments._get_missing_bins"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments._get_missing_bins">[docs]</a>    <span class="k">def</span> <span class="nf">_get_missing_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_bins</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">unique_bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">good_snr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">above_snr_limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;minimum_snr&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">missing_bins</span> <span class="o">+</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">][</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">good_snr</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">SpatiallyBinnedSpectra</span><span class="o">.</span><span class="n">_get_missing_bins</span><span class="p">(</span><span class="n">unique_bins</span><span class="p">)</span></div>


<div class="viewcode-block" id="EmissionLineMoments._assign_redshifts"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments._assign_redshifts">[docs]</a>    <span class="k">def</span> <span class="nf">_assign_redshifts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span> <span class="n">measure_on_unbinned_spaxels</span><span class="p">,</span> <span class="n">good_snr</span><span class="p">,</span>
                          <span class="n">default_redshift</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the redshift to use for each spectrum for the emission-line</span>
<span class="sd">        moments.</span>
<span class="sd">        </span>
<span class="sd">        In terms of precedence, directly provided redshifts override</span>
<span class="sd">        those in any available EmissionLineModel.</span>

<span class="sd">        If self.emission_line_model and redshift are None, the default</span>
<span class="sd">        redshift is used (or 0.0 if this is also None).</span>

<span class="sd">        To get the emission_line stellar kinematics, the function calls</span>
<span class="sd">        :func:`mangadap.proc.emissionlinemodel.EmissionLineModel.matched_kinematics`.</span>
<span class="sd">        The method must have a fit_vel_name define for this use!</span>

<span class="sd">        In this function, the provided redshift must be a single value</span>
<span class="sd">        or None; therefore, the means of any vectors should be provided</span>
<span class="sd">        instead of the full vector.</span>

<span class="sd">        Args:</span>

<span class="sd">            redshift (float, numpy.ndarray): Redshifts (:math:`z`) to</span>
<span class="sd">                use for each spectrum.  If None, the default</span>

<span class="sd">            measure_on_unbinned_spaxels (bool): Flag that method expects</span>
<span class="sd">                to measure moments on unbinned spaxels.</span>

<span class="sd">            good_snr (numpy.ndarray): Boolean array setting which</span>
<span class="sd">                spectra have sufficient S/N for the measurements.</span>

<span class="sd">            default_redshift (float): (**Optional**) Only used if there</span>
<span class="sd">                are stellar kinematics available.  Provides the default</span>
<span class="sd">                redshift to use for spectra without stellar</span>
<span class="sd">                measurements; see :arg:`redshift` in</span>
<span class="sd">                :func:`mangadap.proc.stellarcontinuummodel.StellarContinuumModel.matched_kinematics`.</span>
<span class="sd">                If None (default), the median of the unmasked stellar</span>
<span class="sd">                velocities will be used.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Construct the binid matrix if measuring on unbinned spaxels</span>
        <span class="k">if</span> <span class="n">measure_on_unbinned_spaxels</span><span class="p">:</span>
            <span class="n">binid</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">binid</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">good_snr</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">)</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">nspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">nspec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">binid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">missing_bins</span>
            <span class="n">nspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">nbins</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the redshifts measured for the selected emission line and</span>
        <span class="c1"># use them if no default value is provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;fit_vel_name&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                <span class="ow">and</span> <span class="n">redshift</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">matched_kinematics</span><span class="p">(</span>
                                        <span class="n">binid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;fit_vel_name&#39;</span><span class="p">],</span>
                                        <span class="n">redshift</span><span class="o">=</span><span class="n">default_redshift</span><span class="p">,</span> <span class="n">nearest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="n">missing</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">measure_on_unbinned_spaxels</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nspec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">[</span><span class="n">good_snr</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
            <span class="k">return</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Use the default value(s)</span>
        <span class="n">_redshift</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_redshift</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspec</span> <span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Provided redshift must be either a single value or match the &#39;</span>
                             <span class="s1">&#39;number of binned spectra or the number of unbinned spaxels.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nspec</span><span class="p">,</span> <span class="n">redshift</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> \
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_redshift</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">_redshift</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="EmissionLineMoments._flag_good_spectra"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments._flag_good_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">_flag_good_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measure_on_unbinned_spaxels</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">measure_on_unbinned_spaxels</span><span class="p">:</span>
            <span class="n">fgoodpix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">check_fgoodpix</span><span class="p">()</span>
            <span class="n">good_snr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">rdxqa</span><span class="p">[</span><span class="s1">&#39;SPECTRUM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SNR&#39;</span><span class="p">]</span> \
                                <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;minimum_snr&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">fgoodpix</span> <span class="o">&amp;</span> <span class="n">good_snr</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">above_snr_limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;minimum_snr&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="EmissionLineMoments.output_dtype"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments.output_dtype">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">output_dtype</span><span class="p">(</span><span class="n">nmom</span><span class="p">,</span> <span class="n">bitmask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the record array data type for the output fits</span>
<span class="sd">        extension.</span>

<span class="sd">        Returned columns are:</span>

<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |      Column | Description                                |</span>
<span class="sd">        +=============+============================================+</span>
<span class="sd">        |       BINID | Bin ID of the fitted spectrum              |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        | BINID_INDEX | Index of the bin ID of the fitted spectrum |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |    REDSHIFT | Redshift used for setting the passbands    |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |        MASK | Bit mask value for the measurements        |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |        BCEN | Blueband center for moments                |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |       BCONT | Blueband pseudocontinuum for moments       |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |    BCONTERR | Error in the above                         |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |        RCEN | Redband center for moments                 |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |       RCONT | Redband pseudocontinuum for moments        |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |    RCONTERR | Error in the above                         |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |    CNTSLOPE | Continuum slope used for the moments       |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |        FLUX | Zeroth moment                              |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |     FLUXERR | Zeroth moment error                        |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |        MOM1 | First velocity moment                      |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |     MOM1ERR | First velocity moment error                |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |        MOM2 | Second velocity moment                     |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |     MOM2ERR | Second velocity moment error               |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |       SINST | Instrumental dispersion at mom1            |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |        BMED | Median flux in the blue band used for EW   |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |        RMED | Median flux in the red band used for EW    |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |      EWCONT | Continuum value used for EW                |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |          EW | Equivalenth width (FLUX/pseudo continuum)  |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        |       EWERR | Error in the above                         |</span>
<span class="sd">        +-------------+--------------------------------------------+</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;BINID&#39;</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;BINID_INDEX&#39;</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;REDSHIFT&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;MASK&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">bool</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">(),</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;BCEN&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span> 
                 <span class="p">(</span><span class="s1">&#39;BCONT&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span> 
                 <span class="p">(</span><span class="s1">&#39;BCONTERR&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;RCEN&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span> 
                 <span class="p">(</span><span class="s1">&#39;RCONT&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span> 
                 <span class="p">(</span><span class="s1">&#39;RCONTERR&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span> 
                 <span class="p">(</span><span class="s1">&#39;CNTSLOPE&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;FLUX&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span> 
                 <span class="p">(</span><span class="s1">&#39;FLUXERR&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;MOM1&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span> 
                 <span class="p">(</span><span class="s1">&#39;MOM1ERR&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;MOM2&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span> 
                 <span class="p">(</span><span class="s1">&#39;MOM2ERR&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;SINST&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span>
                 <span class="p">(</span><span class="s1">&#39;BMED&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span> 
                 <span class="p">(</span><span class="s1">&#39;RMED&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span> 
                 <span class="p">(</span><span class="s1">&#39;EWCONT&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span> 
                 <span class="p">(</span><span class="s1">&#39;EW&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,)),</span> 
                 <span class="p">(</span><span class="s1">&#39;EWERR&#39;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="p">(</span><span class="n">nmom</span><span class="p">,))</span>
               <span class="p">]</span></div>


<div class="viewcode-block" id="EmissionLineMoments.sideband_pseudocontinua"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments.sideband_pseudocontinua">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sideband_pseudocontinua</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">sidebands</span><span class="p">,</span> <span class="n">spec_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">weighted_center</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the side-band integrals.</span>

<span class="sd">        err is a single vector that is the same for all spec!</span>

<span class="sd">        Returns:</span>
<span class="sd">            float, numpy.ndarray: Return five arrays or floats: (1) The</span>
<span class="sd">            center of each passband, (2) the mean continuum level, (3)</span>
<span class="sd">            the propagated error in the continuum level (will be None if</span>
<span class="sd">            no errors are provided), (4) flag that part of the passband</span>
<span class="sd">            was masked, (5) flag that the passband was fully masked or</span>
<span class="sd">            empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pseudocontinuum</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">passband</span><span class="o">=</span><span class="n">sidebands</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span>
                                   <span class="n">weighted_center</span><span class="o">=</span><span class="n">weighted_center</span><span class="p">)</span>

        <span class="c1"># Calculate the pseudo-continua in the sidebands</span>
        <span class="n">nspec</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nbands</span> <span class="o">=</span> <span class="n">sidebands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># More than one spectrum entered, use spec_n to decide which</span>
        <span class="c1"># spectrum to use for the integrals.  If spec_n is None and</span>
        <span class="c1"># there is more than one spectrum (improper use of the code!),</span>
        <span class="c1"># allow the code to continue but issue a warning</span>
        <span class="k">if</span> <span class="n">spec_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Multiple spectra entered, but no designation for which to use!&#39;</span><span class="p">)</span>
            <span class="n">_spec_n</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_spec_n</span> <span class="o">=</span> <span class="n">spec_n</span>
        
        <span class="c1"># TODO: Change this to a warning?</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">_spec_n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nspec</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Selected spectrum not provided!&#39;</span><span class="p">)</span>

        <span class="c1"># Instantiate the arrays</span>
        <span class="n">continuum</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">continuum_error</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">band_center</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">band_incomplete</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">band_empty</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspec</span><span class="p">):</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">_spec_n</span><span class="o">==</span><span class="n">i</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">band_center</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">continuum</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">_continuum_error</span><span class="p">,</span> <span class="n">band_incomplete</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> \
                    <span class="n">band_empty</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pseudocontinuum</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">spec</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">passband</span><span class="o">=</span><span class="n">sidebands</span><span class="p">[</span><span class="n">indx</span><span class="p">,:],</span>
                                                       <span class="n">err</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span>
                                                       <span class="n">weighted_center</span><span class="o">=</span><span class="n">weighted_center</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">continuum_error</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_continuum_error</span>
        <span class="k">return</span> <span class="n">band_center</span><span class="p">,</span> <span class="n">continuum</span><span class="p">,</span> <span class="n">continuum_error</span><span class="p">,</span> <span class="n">band_incomplete</span><span class="p">,</span> <span class="n">band_empty</span></div>


<div class="viewcode-block" id="EmissionLineMoments.single_band_moments"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments.single_band_moments">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">single_band_moments</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">passband</span><span class="p">,</span> <span class="n">restwave</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure the moments for a single band.</span>

<span class="sd">        If spectrum errors are not provided, moment errors are returned</span>
<span class="sd">        as 0.0.</span>

<span class="sd">        Args:</span>
<span class="sd">            wave (numpy.ndarray):</span>
<span class="sd">                Wavelengths in angstroms</span>
<span class="sd">            spec (numpy.ndarray):</span>
<span class="sd">                Flux in flux density (per angstrom)</span>
<span class="sd">            restwave (float):</span>
<span class="sd">                The rest wavelength of the line.</span>
<span class="sd">            err (numpy.ndarray):</span>
<span class="sd">                The 1-sigma errors in the flux density.</span>

<span class="sd">        Returns:</span>
<span class="sd">            flux</span>
<span class="sd">            fluxerr</span>
<span class="sd">            mom1</span>
<span class="sd">            mom1err</span>
<span class="sd">            mom2</span>
<span class="sd">            mom2err</span>
<span class="sd">            incomplete band</span>
<span class="sd">            empty band</span>
<span class="sd">            division by zero</span>
<span class="sd">            undefined 1st moment</span>
<span class="sd">            undefined 2nd moment</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the fraction of the passband that is unmasked</span>
        <span class="n">interval_frac</span> <span class="o">=</span> <span class="n">passband_integrated_width</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">passband</span><span class="o">=</span><span class="n">passband</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
                                <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">passband</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">incomplete</span> <span class="o">=</span> <span class="n">interval_frac</span> <span class="o">&lt;</span> <span class="mf">1.0</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">interval_frac</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">incomplete</span><span class="p">,</span> <span class="n">empty</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>

        <span class="c1"># Get the redshift vector</span>
        <span class="n">cz</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="p">(</span><span class="n">wave</span><span class="o">/</span><span class="n">restwave</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Get the integrated flux</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">passband_integral</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">passband</span><span class="o">=</span><span class="n">passband</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fluxerr</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                    <span class="n">passband_integral</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">passband</span><span class="o">=</span><span class="n">passband</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># No flux in the passband, meaning division by zero will occur!</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">flux</span><span class="p">,</span> <span class="n">fluxerr</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">incomplete</span><span class="p">,</span> <span class="n">empty</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>

        <span class="c1"># Get the first and second moments:</span>
        <span class="n">mom1</span><span class="p">,</span> <span class="n">mom1err</span> <span class="o">=</span> <span class="n">passband_weighted_mean</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">cz</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">passband</span><span class="o">=</span><span class="n">passband</span><span class="p">,</span>
                                               <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mom2</span><span class="p">,</span> <span class="n">mom2err</span> <span class="o">=</span> <span class="n">passband_weighted_sdev</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">cz</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">passband</span><span class="o">=</span><span class="n">passband</span><span class="p">,</span>
                                               <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># If no errors provided, set errors to 0</span>
        <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mom1err</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">mom2err</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Set masked values to 0.0</span>
        <span class="n">undefined_mom1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mom1</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mom1</span><span class="o">.</span><span class="n">mask</span><span class="p">:</span>
            <span class="n">mom1</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">undefined_mom1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">undefined_mom2</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mom2</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mom2</span><span class="o">.</span><span class="n">mask</span><span class="p">:</span>
            <span class="n">mom2</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">undefined_mom2</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="n">flux</span><span class="p">,</span> <span class="n">fluxerr</span><span class="p">,</span> <span class="n">mom1</span><span class="p">,</span> <span class="n">mom1err</span><span class="p">,</span> <span class="n">mom2</span><span class="p">,</span> <span class="n">mom2err</span><span class="p">,</span> <span class="n">incomplete</span><span class="p">,</span> <span class="n">empty</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> \
                    <span class="n">undefined_mom1</span><span class="p">,</span> <span class="n">undefined_mom2</span></div>


<div class="viewcode-block" id="EmissionLineMoments.continuum_subtracted_moments"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments.continuum_subtracted_moments">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">continuum_subtracted_moments</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">mainbands</span><span class="p">,</span> <span class="n">restwave</span><span class="p">,</span> <span class="n">bcen</span><span class="p">,</span> <span class="n">bcont</span><span class="p">,</span> <span class="n">rcen</span><span class="p">,</span> <span class="n">rcont</span><span class="p">,</span>
                                     <span class="n">spec_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sres</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the continuum-subtracted moments</span>
<span class="sd">        </span>
<span class="sd">        err and sres are single vectors that are the same for all spec!</span>

<span class="sd">        Returns:</span>
<span class="sd">            cntm</span>
<span class="sd">            cntb</span>
<span class="sd">            flux</span>
<span class="sd">            fluxerr</span>
<span class="sd">            mom1</span>
<span class="sd">            mom1err</span>
<span class="sd">            mom2</span>
<span class="sd">            mom2err</span>
<span class="sd">            sinst</span>
<span class="sd">            incomplete</span>
<span class="sd">            empty</span>
<span class="sd">            divbyzero</span>
<span class="sd">            undefined_mom2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the parameters for the linear continuum across the</span>
        <span class="c1"># primary passband</span>
        <span class="n">nbands</span> <span class="o">=</span> <span class="n">mainbands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">fluxerr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">mom1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">mom1err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">mom2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">mom2err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">incomplete</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">divbyzero</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">undefined_mom1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">undefined_mom2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">rcen</span><span class="o">-</span><span class="n">bcen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;band centers are the same!&#39;</span><span class="p">)</span>
        <span class="n">cntm</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcont</span> <span class="o">-</span> <span class="n">bcont</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rcen</span> <span class="o">-</span> <span class="n">bcen</span><span class="p">)</span>
        <span class="n">cntb</span> <span class="o">=</span> <span class="n">bcont</span> <span class="o">-</span> <span class="n">bcen</span><span class="o">*</span><span class="n">cntm</span>

        <span class="c1"># If more than one spectrum entered, use spec_n to decide which</span>
        <span class="c1"># spectrum to use for the integrals</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># In this case, spec_n should always be provided, but allow</span>
            <span class="c1"># the code to continue with a warning</span>
            <span class="k">if</span> <span class="n">spec_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Multiple spectra entered, but no designation for which to use!&#39;</span><span class="p">)</span>
                <span class="n">_spec_n</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmom</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_spec_n</span> <span class="o">=</span> <span class="n">spec_n</span>

        <span class="c1"># Get the moments for all the main passbands</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mainbands</span><span class="p">):</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="n">cntb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">cntm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">wave</span>
            <span class="n">_spec</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">cont</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">spec</span><span class="p">[</span><span class="n">_spec_n</span><span class="p">[</span><span class="n">i</span><span class="p">],:]</span> <span class="o">-</span> <span class="n">cont</span>

            <span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fluxerr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mom1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mom1err</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mom2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mom2err</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">incomplete</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> \
                    <span class="n">empty</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">divbyzero</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">undefined_mom1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">undefined_mom2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> \
                        <span class="o">=</span> <span class="n">EmissionLineMoments</span><span class="o">.</span><span class="n">single_band_moments</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">_spec</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">restwave</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                  <span class="n">err</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>

        <span class="c1"># Get the instrumental dispersion at the position of the line</span>
        <span class="c1"># center</span>
        <span class="n">sinst</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="k">if</span> <span class="n">sres</span> <span class="ow">is</span> <span class="kc">None</span> \
                        <span class="k">else</span> <span class="n">EmissionLineFit</span><span class="o">.</span><span class="n">instrumental_dispersion</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">sres</span><span class="p">,</span> <span class="n">restwave</span><span class="p">,</span> <span class="n">mom1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cntm</span><span class="p">,</span> <span class="n">cntb</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">fluxerr</span><span class="p">,</span> <span class="n">mom1</span><span class="p">,</span> <span class="n">mom1err</span><span class="p">,</span> <span class="n">mom2</span><span class="p">,</span> <span class="n">mom2err</span><span class="p">,</span> <span class="n">sinst</span><span class="p">,</span> <span class="n">incomplete</span><span class="p">,</span> <span class="n">empty</span><span class="p">,</span> \
                    <span class="n">divbyzero</span><span class="p">,</span> <span class="n">undefined_mom1</span><span class="p">,</span> <span class="n">undefined_mom2</span></div>


<div class="viewcode-block" id="EmissionLineMoments.measure_moments"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments.measure_moments">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">measure_moments</span><span class="p">(</span><span class="n">momdb</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">ivar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">continuum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">redshift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bitmask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure the emission-line moments.</span>

<span class="sd">        If not input as masked arrays, flux is converted to one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check the input moment database</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">momdb</span><span class="p">,</span> <span class="n">EmissionMomentsDB</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input database must have type EmissionMomentsDB.&#39;</span><span class="p">)</span>

        <span class="c1"># Check the bitmask if provided</span>
        <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bitmask</span><span class="p">,</span> <span class="n">BitMask</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input bitmask must have type BitMask.&#39;</span><span class="p">)</span>

        <span class="c1"># Prepare the spectra for the measurements</span>
        <span class="n">_flux</span><span class="p">,</span> <span class="n">_err</span><span class="p">,</span> <span class="n">_sres</span><span class="p">,</span> <span class="n">_continuum</span><span class="p">,</span> <span class="n">_redshift</span><span class="p">,</span> <span class="n">_</span> \
                    <span class="o">=</span> <span class="n">EmissionLineFit</span><span class="o">.</span><span class="n">check_and_prep_input</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">ivar</span><span class="o">=</span><span class="n">ivar</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                                                           <span class="n">sres</span><span class="o">=</span><span class="n">sres</span><span class="p">,</span> <span class="n">continuum</span><span class="o">=</span><span class="n">continuum</span><span class="p">,</span>
                                                           <span class="n">redshift</span><span class="o">=</span><span class="n">redshift</span><span class="p">)</span>

        <span class="c1"># Subtract the continuum and determine where the continuum is</span>
        <span class="c1"># undefined.  If _continuum is None, this just returns _fluxnc =</span>
        <span class="c1"># _flux and no_continuum = None.</span>
        <span class="n">_fluxnc</span><span class="p">,</span> <span class="n">no_continuum</span> <span class="o">=</span> <span class="n">EmissionLineFit</span><span class="o">.</span><span class="n">subtract_continuum</span><span class="p">(</span><span class="n">_flux</span><span class="p">,</span> <span class="n">_continuum</span><span class="p">)</span>

        <span class="c1"># Initialize the output data</span>
        <span class="n">nspec</span> <span class="o">=</span> <span class="n">_flux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nmom</span> <span class="o">=</span> <span class="n">momdb</span><span class="o">.</span><span class="n">nsets</span>
        <span class="n">measurements</span> <span class="o">=</span> <span class="n">init_record_array</span><span class="p">(</span><span class="n">nspec</span><span class="p">,</span> <span class="n">EmissionLineMoments</span><span class="o">.</span><span class="n">output_dtype</span><span class="p">(</span><span class="n">nmom</span><span class="p">,</span>
                                                                                 <span class="n">bitmask</span><span class="o">=</span><span class="n">bitmask</span><span class="p">))</span>

        <span class="c1"># Save the redshift used</span>
        <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;REDSHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_redshift</span>

        <span class="c1"># Mask dummy lines</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">):</span>
            <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][:,</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                    <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][:,</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">],</span> <span class="s1">&#39;UNDEFINED_BANDS&#39;</span><span class="p">)</span>
        
        <span class="c1"># No valid lines</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">measurements</span>

        <span class="c1"># Common arrays used for each spectrum</span>
        <span class="n">blue_fraction</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmom</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">red_fraction</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmom</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">incomplete</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmom</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmom</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">divbyzero</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmom</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">undefined_mom1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmom</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">undefined_mom2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmom</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Perform the measurements for each spectrum</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspec</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Measuring emission-line moments in spectrum: </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nspec</span><span class="p">),</span>
                  <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">incomplete</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">empty</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">divbyzero</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">undefined_mom1</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">undefined_mom2</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Shift the sidebands to the appropriate redshift</span>
            <span class="n">_bluebands</span> <span class="o">=</span> <span class="n">momdb</span><span class="p">[</span><span class="s1">&#39;blueside&#39;</span><span class="p">][</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">_redshift</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">_redbands</span> <span class="o">=</span> <span class="n">momdb</span><span class="p">[</span><span class="s1">&#39;redside&#39;</span><span class="p">][</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">_redshift</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">__err</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">_err</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_err</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">__sres</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">_sres</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_sres</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>

            <span class="c1"># Check if the model was subtracted over the full range of</span>
            <span class="c1"># the sidebands, or if the model was subtracted in one</span>
            <span class="c1"># sideband but not the other</span>
            <span class="k">if</span> <span class="n">no_continuum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">_flux</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
                <span class="n">spec_n</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Flag moment calculations without a stellar-absorption</span>
                <span class="c1"># correction</span>
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                                                <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span>
                                                                     <span class="s1">&#39;NO_ABSORPTION_CORRECTION&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">blue_fraction</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)]</span> \
                        <span class="o">=</span> <span class="n">passband_integrated_width</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">no_continuum</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">passband</span><span class="o">=</span><span class="n">_bluebands</span><span class="p">,</span>
                                                <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">_bluebands</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">blue_fraction</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">blue_fraction</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                            <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;BLUE_JUMP&#39;</span><span class="p">)</span>

                <span class="n">red_fraction</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)]</span> \
                        <span class="o">=</span> <span class="n">passband_integrated_width</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">no_continuum</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">passband</span><span class="o">=</span><span class="n">_redbands</span><span class="p">,</span>
                                                <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">_redbands</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">red_fraction</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">red_fraction</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                            <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;RED_JUMP&#39;</span><span class="p">)</span>
                
                <span class="n">indx</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">blue_fraction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">red_fraction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> \
                            <span class="o">|</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">red_fraction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">blue_fraction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                            <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span><span class="s1">&#39;JUMP_BTWN_SIDEBANDS&#39;</span><span class="p">)</span>

                <span class="c1"># Only use model-subtracted measurements if there are no</span>
                <span class="c1"># jumps in the bands or between the bands</span>
                <span class="n">jumps</span> <span class="o">=</span> <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:]</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                            <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span>
                                                 <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;BLUE_JUMP&#39;</span><span class="p">,</span> <span class="s1">&#39;RED_JUMP&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;JUMP_BTWN_SIDEBANDS&#39;</span><span class="p">])</span>

                <span class="n">spec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_flux</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">_fluxnc</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">spec_n</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmom</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">spec_n</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">jumps</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># Flag moment calculations as having not been corrected</span>
                <span class="c1"># for stellar absorption</span>
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">spec_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                            <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">spec_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span>
                                                 <span class="s1">&#39;NO_ABSORPTION_CORRECTION&#39;</span><span class="p">)</span>

            <span class="c1"># Get the blue pseudo continuum</span>
            <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;BCEN&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)],</span> \
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;BCONT&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)],</span> <span class="n">conterr</span><span class="p">,</span> \
                <span class="n">incomplete</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)],</span> <span class="n">empty</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)]</span> \
                    <span class="o">=</span> <span class="n">EmissionLineMoments</span><span class="o">.</span><span class="n">sideband_pseudocontinua</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">_bluebands</span><span class="p">,</span>
                                                                  <span class="n">spec_n</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">spec_n</span> <span class="ow">is</span> <span class="kc">None</span>
                                                            <span class="k">else</span> <span class="n">spec_n</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)],</span>
                                                                  <span class="n">err</span><span class="o">=</span><span class="n">__err</span><span class="p">,</span> <span class="n">weighted_center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">__err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;BCONTERR&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)]</span> <span class="o">=</span> <span class="n">conterr</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">incomplete</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">incomplete</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                            <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">incomplete</span><span class="p">],</span> <span class="s1">&#39;BLUE_INCOMP&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">empty</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                            <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">empty</span><span class="p">],</span> <span class="s1">&#39;BLUE_EMPTY&#39;</span><span class="p">)</span>

            <span class="c1"># Get the red pseudo continuum</span>
            <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;RCEN&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)],</span> \
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;RCONT&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)],</span> <span class="n">conterr</span><span class="p">,</span> \
                <span class="n">incomplete</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)],</span> <span class="n">empty</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)]</span> \
                    <span class="o">=</span> <span class="n">EmissionLineMoments</span><span class="o">.</span><span class="n">sideband_pseudocontinua</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">_redbands</span><span class="p">,</span>
                                                                  <span class="n">spec_n</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">spec_n</span> <span class="ow">is</span> <span class="kc">None</span>
                                                            <span class="k">else</span> <span class="n">spec_n</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)],</span>
                                                                  <span class="n">err</span><span class="o">=</span><span class="n">__err</span><span class="p">,</span> <span class="n">weighted_center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">__err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;RCONTERR&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)]</span> <span class="o">=</span> <span class="n">conterr</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">incomplete</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">incomplete</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                            <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">incomplete</span><span class="p">],</span> <span class="s1">&#39;RED_INCOMP&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">empty</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                            <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">empty</span><span class="p">],</span> <span class="s1">&#39;RED_EMPTY&#39;</span><span class="p">)</span>

            <span class="c1"># Get the main passband integral after subtracting the</span>
            <span class="c1"># continuum</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)</span> \
                        <span class="o">&amp;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:]</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span>
                                        <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span>
                                                             <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;BLUE_EMPTY&#39;</span><span class="p">,</span> <span class="s1">&#39;RED_EMPTY&#39;</span><span class="p">,</span>
                                                                   <span class="s1">&#39;BLUE_JUMP&#39;</span><span class="p">,</span> <span class="s1">&#39;RED_JUMP&#39;</span><span class="p">]))</span>

            <span class="n">_mainbands</span> <span class="o">=</span> <span class="n">momdb</span><span class="p">[</span><span class="s1">&#39;primary&#39;</span><span class="p">][</span><span class="n">indx</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">_redshift</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;CNTSLOPE&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span> <span class="n">cntb</span><span class="p">,</span> <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span> \
                    <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;FLUXERR&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span> <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MOM1&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span> \
                    <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MOM1ERR&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span> <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MOM2&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span> \
                    <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MOM2ERR&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span> <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;SINST&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span> \
                    <span class="n">incomplete</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">empty</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">divbyzero</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">undefined_mom1</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> \
                    <span class="n">undefined_mom2</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">EmissionLineMoments</span><span class="o">.</span><span class="n">continuum_subtracted_moments</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span>
                                                               <span class="n">_mainbands</span><span class="p">,</span> <span class="n">momdb</span><span class="p">[</span><span class="s1">&#39;restwave&#39;</span><span class="p">][</span><span class="n">indx</span><span class="p">],</span>
                                                               <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;BCEN&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span>
                                                               <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;BCONT&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span>
                                                               <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;RCEN&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span>
                                                               <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;RCONT&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">indx</span><span class="p">],</span>
                                                               <span class="n">spec_n</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">spec_n</span> <span class="ow">is</span> <span class="kc">None</span> 
                                                                    <span class="k">else</span> <span class="n">spec_n</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">err</span><span class="o">=</span><span class="n">__err</span><span class="p">,</span>
                                                               <span class="n">sres</span><span class="o">=</span><span class="n">__sres</span><span class="p">)</span> 

            <span class="c1"># Turn on any necessary bits</span>
            <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">incomplete</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                        <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">incomplete</span><span class="p">],</span> <span class="s1">&#39;MAIN_INCOMP&#39;</span><span class="p">)</span>
            <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">empty</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                        <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">empty</span><span class="p">],</span> <span class="s1">&#39;MAIN_EMPTY&#39;</span><span class="p">)</span>
            <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">divbyzero</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                        <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">divbyzero</span><span class="p">],</span> <span class="s1">&#39;DIVBYZERO&#39;</span><span class="p">)</span>
            <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">undefined_mom1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                        <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">undefined_mom1</span><span class="p">],</span>
                                             <span class="s1">&#39;UNDEFINED_MOM1&#39;</span><span class="p">)</span>
            <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">undefined_mom2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">bitmask</span> <span class="ow">is</span> <span class="kc">None</span> \
                        <span class="k">else</span> <span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">undefined_mom2</span><span class="p">],</span>
                                             <span class="s1">&#39;UNDEFINED_MOM2&#39;</span><span class="p">)</span>

<span class="c1">#        if len(spec.shape) &gt; 1:</span>
<span class="c1">#            pyplot.step(wave, spec[0], where=&#39;mid&#39;, color=&#39;k&#39;, lw=0.5, zorder=1)</span>
<span class="c1">#            pyplot.step(wave, spec[1], where=&#39;mid&#39;, color=&#39;g&#39;, lw=0.5, zorder=2)</span>
<span class="c1">#        else:</span>
<span class="c1">#            pyplot.step(wave, spec, where=&#39;mid&#39;, color=&#39;k&#39;, lw=0.5, zorder=1)</span>
<span class="c1">#        pyplot.scatter(measurements[&#39;BCEN&#39;], measurements[&#39;BCONT&#39;], marker=&#39;.&#39;, s=50,</span>
<span class="c1">#                       color=&#39;b&#39;, lw=0, zorder=3)</span>
<span class="c1">#        pyplot.scatter(measurements[&#39;RCEN&#39;], measurements[&#39;RCONT&#39;], marker=&#39;.&#39;, s=50,</span>
<span class="c1">#                       color=&#39;r&#39;, lw=0, zorder=3)</span>
<span class="c1">#        pyplot.show()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Measuring emission-line moments in spectrum: </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nspec</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">measurements</span></div>
        

<div class="viewcode-block" id="EmissionLineMoments.file_name"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments.file_name">[docs]</a>    <span class="k">def</span> <span class="nf">file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of the output file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span></div>


<div class="viewcode-block" id="EmissionLineMoments.file_path"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments.file_path">[docs]</a>    <span class="k">def</span> <span class="nf">file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the full path to the output file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="EmissionLineMoments.measure"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments.measure">[docs]</a>    <span class="k">def</span> <span class="nf">measure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">stellar_continuum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">emission_line_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">redshift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directory_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hardcopy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loggers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure the emission-line moments using the binned spectra.</span>

<span class="sd">        If neither stellar-continuum nor emission-line models are provided:</span>
<span class="sd">            - Moments are measure on the binned spectra</span>
<span class="sd">            - No continuum subtraction is performed</span>

<span class="sd">        If a stellar-continuum model is provided without an</span>
<span class="sd">        emission-line model:</span>
<span class="sd">            - Moments are measured on the binned spectra</span>
<span class="sd">            - The best-fitting stellar continuum is subtracted</span>

<span class="sd">        If an emission-line model is provided without a</span>
<span class="sd">        stellar-continuum model:</span>
<span class="sd">            - Moments are measured on the relevant (binned or unbinned)</span>
<span class="sd">              spectra</span>
<span class="sd">            - If the emission-line model includes data regarding the</span>
<span class="sd">              stellar-continuum fit (template spectra and template</span>
<span class="sd">              weights), the continuum is subtracted before the</span>
<span class="sd">              measurements are made; otherwise, no continuum is</span>
<span class="sd">              subtracted</span>

<span class="sd">        If both stellar-continuum and emission-line models are provided,</span>
<span class="sd">        and if the stellar-continuum and emission-line fits are</span>
<span class="sd">        performed on the same spectra:</span>
<span class="sd">            - Moments are measured on the relevant (binned or unbinned)</span>
<span class="sd">              spectra</span>
<span class="sd">            - If the emission-line model includes data regarding the</span>
<span class="sd">              stellar-continuum fit (template spectra and template</span>
<span class="sd">              weights), the continuum is subtracted before the</span>
<span class="sd">              measurements are made; otherwise, the stellar continuum is</span>
<span class="sd">              used.</span>

<span class="sd">        If both stellar-continuum and emission-line models are provided,</span>
<span class="sd">        and if the stellar-continuum and emission-line fits are</span>
<span class="sd">        performed on different spectra:</span>
<span class="sd">            - The behavior is exactly as if the stellar-continuum model</span>
<span class="sd">              was not provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize the reporting</span>
        <span class="k">if</span> <span class="n">loggers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loggers</span> <span class="o">=</span> <span class="n">loggers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span>
        
        <span class="c1"># SpatiallyBinnedSpectra object always needed</span>
        <span class="k">if</span> <span class="n">binned_spectra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must provide spectra object for fitting.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binned_spectra</span><span class="p">,</span> <span class="n">SpatiallyBinnedSpectra</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Must provide a valid SpatiallyBinnedSpectra object!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Provided SpatiallyBinnedSpectra object is undefined!&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span> <span class="o">=</span> <span class="n">binned_spectra</span>

        <span class="c1"># Check stellar-continuum model object, if provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stellar_continuum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">stellar_continuum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stellar_continuum</span><span class="p">,</span> <span class="n">StellarContinuumModel</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Provided stellar continuum must have StellarContinuumModel type!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stellar_continuum</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Provided StellarContinuumModel is undefined!&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stellar_continuum</span> <span class="o">=</span> <span class="n">stellar_continuum</span>

        <span class="c1"># Check emission-line model object, if provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">emission_line_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="c1">#            if not isinstance(emission_line_model, EmissionLineModel):</span>
<span class="c1">#                raise TypeError(&#39;Provided emission line models must be of type EmissionLineModel.&#39;)</span>
            <span class="k">if</span> <span class="n">emission_line_model</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Provided EmissionLineModel is undefined!&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span> <span class="o">=</span> <span class="n">emission_line_model</span>

        <span class="c1"># What stellar continuum is available?</span>
        <span class="c1">#  - Assume the stellar continuum can always be extracted if a</span>
        <span class="c1">#    StellarContinuumModel object is provided</span>
        <span class="c1">#  - Check if the EmissionLineModel fitter has the appropriate</span>
        <span class="c1">#    function; True for Sasuke, not currently true for Elric</span>
        <span class="n">eml_stellar_continuum_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitclass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">construct_continuum_models</span><span class="p">)</span>

        <span class="c1"># What spectra to use?</span>
        <span class="c1">#  - Assume StellarContinuumModel always fits the binned spectra</span>
        <span class="c1">#  - The EmissionLineModel fits the binned spectra or unbinned</span>
        <span class="c1">#    spaxels as specified by its deconstruct_bins flag</span>
        <span class="n">measure_on_unbinned_spaxels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;deconstruct_bins&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">spatial_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">nspec</span> <span class="k">if</span> <span class="n">measure_on_unbinned_spaxels</span> \
                            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">nbins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">spatial_index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the good spectra</span>
        <span class="n">good_snr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag_good_spectra</span><span class="p">(</span><span class="n">measure_on_unbinned_spaxels</span><span class="p">)</span>

        <span class="c1"># Set the number of bins measured and missing bins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">good_snr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_bins</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">measure_on_unbinned_spaxels</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_missing_bins</span><span class="p">()</span>

        <span class="c1"># Get the redshifts to apply</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_redshifts</span><span class="p">(</span><span class="n">redshift</span><span class="p">,</span> <span class="n">measure_on_unbinned_spaxels</span><span class="p">,</span> <span class="n">good_snr</span><span class="p">)</span>

        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0:^50}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;EMISSION-LINE MOMENTS&#39;</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Measurements for </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s1">&#39;unbinned spaxels&#39;</span> <span class="k">if</span> <span class="n">measure_on_unbinned_spaxels</span> <span class="k">else</span> <span class="s1">&#39;binned spectra&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stellar_continuum</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;No stellar continuum available.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">eml_stellar_continuum_available</span><span class="p">:</span>
                <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                           <span class="s1">&#39;Using stellar continuum from emission-line model fit.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                           <span class="s1">&#39;Using stellar continuum from stellar-continuum model fit.&#39;</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Number of spectra: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">measure_on_unbinned_spaxels</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">missing_bins</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Missing bins: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">missing_bins</span><span class="p">)))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;With good S/N and to measure: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                            <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">good_snr</span><span class="p">)))</span>

        <span class="c1"># Make sure there are good spectra</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">good_snr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No good spectra for measurements!&#39;</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># (Re)Set the output paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_paths</span><span class="p">(</span><span class="n">directory_path</span><span class="p">,</span> <span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Check that the file path is defined</span>
        <span class="n">ofile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ofile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;File path for output file is undefined!&#39;</span><span class="p">)</span>

        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Output path: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Output file: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">))</span>
        
        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># If the file already exists, and not clobbering, just read the</span>
        <span class="c1"># file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hardcopy</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Using existing file&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">checksum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">checksum</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the spectra to use for the measurements</span>
        <span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">ivar</span> <span class="o">=</span> <span class="n">EmissionLineFit</span><span class="o">.</span><span class="n">get_spectra_to_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span>
                                                                <span class="k">if</span> <span class="n">measure_on_unbinned_spaxels</span>
                                                                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">,</span>
                                                              <span class="n">pixelmask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pixelmask</span><span class="p">,</span>
                                                              <span class="n">select</span><span class="o">=</span><span class="n">good_snr</span><span class="p">)</span>
        <span class="c1"># Make sure that the spectra have been corrected for Galactic</span>
        <span class="c1"># extinction</span>
        <span class="k">if</span> <span class="n">measure_on_unbinned_spaxels</span><span class="p">:</span>
            <span class="n">flux</span><span class="p">,</span> <span class="n">ivar</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">galext</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">ivar</span><span class="o">=</span><span class="n">ivar</span><span class="p">,</span> <span class="n">deredden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Get the continuum if there is any</span>
        <span class="k">if</span> <span class="n">eml_stellar_continuum_available</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">measure_on_unbinned_spaxels</span><span class="p">:</span>
                <span class="n">binid</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">binid</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">good_snr</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">)</span>
                <span class="n">continuum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">fill_continuum_to_match</span><span class="p">(</span><span class="n">binid</span><span class="p">)</span>
                <span class="n">specres_ext</span><span class="o">=</span><span class="s1">&#39;SPECRES&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;spec_res&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cube&#39;</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">sres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">spectral_resolution</span><span class="p">(</span><span class="n">ext</span><span class="o">=</span><span class="n">specres_ext</span><span class="p">,</span> <span class="n">toarray</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">pre</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;prepixel_sres&#39;</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">sres</span> <span class="o">=</span> <span class="n">sres</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">good_snr</span><span class="p">,:]</span>    <span class="c1"># spectral_resolution returns a masked array</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">continuum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_line_model</span><span class="o">.</span><span class="n">fill_continuum_to_match</span><span class="p">(</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                <span class="n">missing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">missing_bins</span><span class="p">)</span>
                <span class="n">sres</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;SPECRES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">good_snr</span><span class="p">,:]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stellar_continuum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">continuum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stellar_continuum</span><span class="o">.</span><span class="n">fill_to_match</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">missing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">missing_bins</span><span class="p">)</span>
            <span class="n">sres</span> <span class="o">=</span> <span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;SPECRES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">good_snr</span><span class="p">,:]</span>
        <span class="n">_redshift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">[</span><span class="n">good_snr</span><span class="p">]</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Perform the moment measurements</span>
        <span class="n">measurements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_moments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">momdb</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">ivar</span><span class="o">=</span><span class="n">ivar</span><span class="p">,</span> <span class="n">sres</span><span class="o">=</span><span class="n">sres</span><span class="p">,</span>
                                            <span class="n">continuum</span><span class="o">=</span><span class="n">continuum</span><span class="p">,</span> <span class="n">redshift</span><span class="o">=</span><span class="n">_redshift</span><span class="p">,</span>
                                            <span class="n">bitmask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Perform the equivalent width measurements</span>
        <span class="n">include_band</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">momdb</span><span class="o">.</span><span class="n">dummy</span><span class="p">)]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">)</span> \
                        <span class="o">&amp;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">],</span>
                                                            <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;BLUE_EMPTY&#39;</span><span class="p">,</span> <span class="s1">&#39;RED_EMPTY&#39;</span><span class="p">]))</span>

        <span class="c1"># Set the line center at the center of the primary passband</span>
<span class="c1">#        line_center = (1.0+_redshift)[:,None]*numpy.mean(self.momdb[&#39;primary&#39;], axis=1)[None,:]</span>
        <span class="n">line_center</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">_redshift</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">momdb</span><span class="p">[</span><span class="s1">&#39;restwave&#39;</span><span class="p">][</span><span class="kc">None</span><span class="p">,:]</span>
<span class="c1">#        line_center = (1.0+measurements[&#39;MOM1&#39;]/astropy.constants.c.to(&#39;km/s&#39;).value) \</span>
<span class="c1">#                            * self.momdb[&#39;restwave&#39;][None,:]</span>

<span class="c1">#        pyplot.scatter(line_center_1, line_center_2, marker=&#39;.&#39;, s=50, color=&#39;k&#39;, lw=0, zorder=2)</span>
<span class="c1">#        pyplot.plot([0,10000], [0,10000], color=&#39;r&#39;, zorder=1)</span>
<span class="c1">#        pyplot.show()</span>

        <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;BMED&#39;</span><span class="p">],</span> <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;RMED&#39;</span><span class="p">],</span> <span class="n">pos</span><span class="p">,</span> <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;EWCONT&#39;</span><span class="p">],</span> \
                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;EW&#39;</span><span class="p">],</span> <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;EWERR&#39;</span><span class="p">]</span> \
                        <span class="o">=</span> <span class="n">emission_line_equivalent_width</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">momdb</span><span class="p">[</span><span class="s1">&#39;blueside&#39;</span><span class="p">],</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">momdb</span><span class="p">[</span><span class="s1">&#39;redside&#39;</span><span class="p">],</span> <span class="n">line_center</span><span class="p">,</span>
                                                         <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">],</span> <span class="n">redshift</span><span class="o">=</span><span class="n">_redshift</span><span class="p">,</span>
                                                         <span class="n">line_flux_err</span><span class="o">=</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;FLUXERR&#39;</span><span class="p">],</span>
                                                         <span class="n">include_band</span><span class="o">=</span><span class="n">include_band</span><span class="p">)</span>

        <span class="c1"># TODO: This is also now set in measure_moments; remove this?</span>
        <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;REDSHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_redshift</span>

        <span class="c1"># Flag non-positive measurements</span>
        <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">include_band</span> <span class="o">&amp;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">pos</span><span class="p">)]</span> \
                    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">][</span><span class="n">include_band</span> <span class="o">&amp;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">pos</span><span class="p">)],</span>
                                           <span class="s1">&#39;NON_POSITIVE_CONTINUUM&#39;</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Set the number of bins measured, missing bins, and bin IDs</span>
        <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">)</span> <span class="k">if</span> <span class="n">measure_on_unbinned_spaxels</span> \
                                    <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">][</span><span class="n">good_snr</span><span class="p">]</span>
        <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;BINID_INDEX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">)</span> <span class="k">if</span> <span class="n">measure_on_unbinned_spaxels</span> \
                                        <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">nbins</span><span class="p">)[</span><span class="n">good_snr</span><span class="p">]</span>
        <span class="n">measurements_binid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">measure_on_unbinned_spaxels</span><span class="p">:</span>
            <span class="n">measurements_binid</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">measurements_binid</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">good_snr</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">)</span>

<span class="c1">#        # Set the undefined bands</span>
<span class="c1">#        measurements[&#39;MASK&#39;][:,self.momdb.dummy] \</span>
<span class="c1">#                    = self.bitmask.turn_on(measurements[&#39;MASK&#39;][:,self.momdb.dummy],</span>
<span class="c1">#                                           &#39;UNDEFINED_BANDS&#39;)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Initialize the header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hardcopy</span> <span class="o">=</span> <span class="n">hardcopy</span>
        <span class="n">pri_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_primary_header</span><span class="p">(</span><span class="n">measurements_binid</span><span class="o">=</span><span class="n">measurements_binid</span><span class="p">)</span>
        <span class="n">map_hdr</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">build_map_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span>
                                               <span class="s1">&#39;K Westfall &lt;westfall@ucolick.org&gt;&#39;</span><span class="p">)</span>

        <span class="c1"># Get the spatial map mask</span>
        <span class="n">map_mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">())</span>

        <span class="c1"># Account for measurements on individual spaxels</span>
        <span class="k">if</span> <span class="n">measurements_binid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Add any spaxel not used because it was flagged by the</span>
            <span class="c1"># binning step</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;MAPMASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;DIDNOTUSE&#39;</span><span class="p">)</span>
            <span class="c1"># Isolate any spaxels with foreground stars</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;MAPMASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                       <span class="s1">&#39;FORESTAR&#39;</span><span class="p">)</span>
            <span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;FORESTAR&#39;</span><span class="p">)</span>
            <span class="c1"># Get the bins that were below the S/N limit</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">reconstruct_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                                        <span class="n">good_snr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">map_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;LOW_SNR&#39;</span><span class="p">)</span>

            <span class="c1"># Get the bin ids with measured indices</span>
            <span class="n">bin_indx</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">downselect_bins</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                                <span class="n">measurements</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume any model with a binid less than zero is from a</span>
            <span class="c1"># spaxel that was not used</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">measurements_binid</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;DIDNOTUSE&#39;</span><span class="p">)</span>

            <span class="c1"># The number of valid bins MUST match the number of</span>
            <span class="c1"># measurements</span>
            <span class="n">nvalid</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">indx</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nvalid</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">measurements</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Provided id does not match the number of measurements.&#39;</span><span class="p">)</span>

            <span class="c1"># Get the bin ids with fitted models</span>
            <span class="n">bin_indx</span> <span class="o">=</span> <span class="n">measurements_binid</span>

<span class="c1">#        # Add any spaxel not used because it was flagged by the binning</span>
<span class="c1">#        # step</span>
<span class="c1">#        indx = self.binned_spectra[&#39;MAPMASK&#39;].data &gt; 0</span>
<span class="c1">#        map_mask[indx] = self.bitmask.turn_on(map_mask[indx], &#39;DIDNOTUSE&#39;)</span>
<span class="c1">#        # Isolate any spaxels with foreground stars</span>
<span class="c1">#        indx = self.binned_spectra.bitmask.flagged(self.binned_spectra[&#39;MAPMASK&#39;].data, &#39;FORESTAR&#39;)</span>
<span class="c1">#        map_mask[indx] = self.bitmask.turn_on(map_mask[indx], &#39;FORESTAR&#39;)</span>
<span class="c1">#        # Get the bins that were below the S/N limit</span>
<span class="c1">#        indx = numpy.invert(DAPFitsUtil.reconstruct_map(self.spatial_shape,</span>
<span class="c1">#                                                        self.binned_spectra[&#39;BINID&#39;].data.ravel(),</span>
<span class="c1">#                                                        good_snr, dtype=&#39;bool&#39;)) &amp; (map_mask == 0)</span>
<span class="c1">#        map_mask[indx] = self.bitmask.turn_on(map_mask[indx], &#39;LOW_SNR&#39;)</span>
<span class="c1">#</span>
<span class="c1">#        # Get the bin ids with measurements</span>
<span class="c1">#        bin_indx = DAPFitsUtil.downselect_bins(self.binned_spectra[&#39;BINID&#39;].data.ravel(),</span>
<span class="c1">#                                               measurements[&#39;BINID&#39;])</span>

        <span class="c1"># Compile the saved information on the suite of measured indices</span>
        <span class="n">passband_database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_database</span><span class="p">()</span>

        <span class="c1"># Save the data to the hdu attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">pri_hdr</span><span class="p">),</span>
                                  <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">bin_indx</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">map_hdr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;BINID&#39;</span><span class="p">),</span>
                                  <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">map_mask</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">map_hdr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MAPMASK&#39;</span><span class="p">),</span>
                                  <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span>
                                        <span class="p">[</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                                                      <span class="nb">format</span><span class="o">=</span><span class="n">rec_to_fits_type</span><span class="p">(</span><span class="n">passband_database</span><span class="p">[</span><span class="n">n</span><span class="p">]),</span>
                                                      <span class="n">array</span><span class="o">=</span><span class="n">passband_database</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
                                          <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">passband_database</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ELMBAND&#39;</span><span class="p">),</span>
                                  <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span>
                                        <span class="p">[</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                                                      <span class="nb">format</span><span class="o">=</span><span class="n">rec_to_fits_type</span><span class="p">(</span><span class="n">measurements</span><span class="p">[</span><span class="n">n</span><span class="p">]),</span>
                                                      <span class="n">array</span><span class="o">=</span><span class="n">measurements</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
                                          <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">measurements</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ELMMNTS&#39;</span><span class="p">),</span>
                                <span class="p">])</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Write the data, if requested</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardcopy</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span></div>


<div class="viewcode-block" id="EmissionLineMoments.write"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the hdu object to the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(),</span> <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">loggers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span></div>


<div class="viewcode-block" id="EmissionLineMoments.read"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Read an existing file with a previously binned set of spectra.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ifile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ifile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ifile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;File does not exist!: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ifile</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1">#        self.hdu = fits.open(ifile, checksum=checksum)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="n">checksum</span><span class="p">)</span>

        <span class="c1"># Confirm that the internal method is the same as the method</span>
        <span class="c1"># that was used in writing the file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ELMKEY&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Keywords in header do not match specified method keywords!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Keywords in header do not match specified method keywords!&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: &quot;strict&quot; should also check other aspects of the file to</span>
        <span class="c1"># make sure that the details of the method are also the same,</span>
        <span class="c1"># not just the keyword</span>

<span class="c1">#        if not self.quiet:</span>
<span class="c1">#            log_output(self.loggers, 1, logging.INFO, &#39;Reverting to python-native structure.&#39;)</span>
<span class="c1">#        DAPFitsUtil.restructure_map(self.hdu, ext=self.image_arrays)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NBINS&#39;</span><span class="p">]</span>
        <span class="n">unique_bins</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span> \
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ELMREBIN&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_missing_bins</span><span class="p">(</span><span class="n">unique_bins</span><span class="o">=</span><span class="n">unique_bins</span><span class="p">)</span></div>


    <span class="c1"># TODO: Use the EmissionMomentsDB.channel_names function!</span>
<div class="viewcode-block" id="EmissionLineMoments.channel_names"><a class="viewcode-back" href="../../../mangadap.proc.emissionlinemoments.html#mangadap.proc.emissionlinemoments.EmissionLineMoments.channel_names">[docs]</a>    <span class="k">def</span> <span class="nf">channel_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> \
                        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ELMBAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ELMBAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;RESTWAVE&#39;</span><span class="p">])</span> <span class="p">])</span></div></div>

</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, SDSS-IV/MaNGA Pipeline Group.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'2.2.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>