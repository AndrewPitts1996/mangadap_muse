

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mangadap.proc.stellarcontinuummodel &mdash; mangadap 2.2.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="mangadap 2.2.2 documentation" href="../../../index.html"/>
        <link rel="up" title="mangadap" href="../../mangadap.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> mangadap
          

          
          </a>

          
            
            
              <div class="version">
                2.2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mangadap.html">mangadap package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mangadap</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../mangadap.html">mangadap</a> &raquo;</li>
        
      <li>mangadap.proc.stellarcontinuummodel</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mangadap.proc.stellarcontinuummodel</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A class hierarchy that performs the stellar-continuum fitting.</span>

<span class="sd">*License*:</span>
<span class="sd">    Copyright (c) 2015, SDSS-IV/MaNGA Pipeline Group</span>
<span class="sd">        Licensed under BSD 3-clause license - see LICENSE.rst</span>

<span class="sd">*Source location*:</span>
<span class="sd">    $MANGADAP_DIR/python/mangadap/proc/stellarcontinuummodel.py</span>

<span class="sd">*Class usage examples*:</span>
<span class="sd">        Add examples</span>

<span class="sd">*Revision history*:</span>
<span class="sd">    | **14 Apr 2016**: Implementation begun by K. Westfall (KBW)</span>
<span class="sd">    | **19 Apr 2016**: (KBW) First version</span>
<span class="sd">    | **19 May 2016**: (KBW) Added loggers and quiet keyword arguments</span>
<span class="sd">        to :class:`StellarContinuumModel`, removed verbose </span>
<span class="sd">    | **05 Jul 2016**: (KBW) Removed oversample keyword from instantion</span>
<span class="sd">        of :class:`mangadap.proc.ppxffit.PPXFFit` objects.</span>
<span class="sd">    | **08 Nov 2016**: (KBW) Moved</span>
<span class="sd">        :func:`StellarContinuumModel.reset_continuum_mask_window` from</span>
<span class="sd">        :class:`Elric` to here.  The function allows one to deal with</span>
<span class="sd">        the subtraction of the continuum over the fully viable spectral</span>
<span class="sd">        range, ignoring small spectral regions that were ignored during</span>
<span class="sd">        the stellar continuum fit.  Also added wrapper function,</span>
<span class="sd">        :func:`StellarContinuumModel.emission_line_continuum_model`.</span>
<span class="sd">    | **11 Jan 2017**: (KBW) Changed</span>
<span class="sd">        StellarContinuumModel.emission_line_continuum_model to</span>
<span class="sd">        :func:`StellarContinuumModel.unmasked_continuum_model`.</span>
<span class="sd">    | **23 Feb 2017**: (KBW) Use DAPFitsUtil read and write functions.</span>

<span class="sd">.. _astropy.io.fits.hdu.hdulist.HDUList: http://docs.astropy.org/en/v1.0.2/io/fits/api/hdulists.html</span>
<span class="sd">.. _glob.glob: https://docs.python.org/3.4/library/glob.html</span>
<span class="sd">.. _logging.Logger: https://docs.python.org/3/library/logging.html</span>
<span class="sd">.. _numpy.ma.MaskedArray: http://docs.scipy.org/doc/numpy-1.10.1/reference/maskedarray.baseclass.html#numpy.ma.MaskedArray</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
    <span class="n">long</span> <span class="o">=</span> <span class="nb">int</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">astropy.constants</span>

<span class="kn">from</span> <span class="nn">..drpfits</span> <span class="k">import</span> <span class="n">DRPFits</span>
<span class="kn">from</span> <span class="nn">..par.parset</span> <span class="k">import</span> <span class="n">ParSet</span>
<span class="kn">from</span> <span class="nn">..par.artifactdb</span> <span class="k">import</span> <span class="n">ArtifactDB</span>
<span class="kn">from</span> <span class="nn">..par.emissionlinedb</span> <span class="k">import</span> <span class="n">EmissionLineDB</span>
<span class="kn">from</span> <span class="nn">..util.log</span> <span class="k">import</span> <span class="n">log_output</span>
<span class="kn">from</span> <span class="nn">..util.fitsutil</span> <span class="k">import</span> <span class="n">DAPFitsUtil</span>
<span class="kn">from</span> <span class="nn">..util.fileio</span> <span class="k">import</span> <span class="n">rec_to_fits_type</span>
<span class="kn">from</span> <span class="nn">..util.sampling</span> <span class="k">import</span> <span class="n">spectral_coordinate_step</span><span class="p">,</span> <span class="n">spectrum_velocity_scale</span>
<span class="kn">from</span> <span class="nn">..util.resolution</span> <span class="k">import</span> <span class="n">SpectralResolution</span>
<span class="kn">from</span> <span class="nn">..util.bitmask</span> <span class="k">import</span> <span class="n">BitMask</span>
<span class="kn">from</span> <span class="nn">..util.pixelmask</span> <span class="k">import</span> <span class="n">SpectralPixelMask</span>
<span class="kn">from</span> <span class="nn">..util.parser</span> <span class="k">import</span> <span class="n">DefaultConfig</span>
<span class="kn">from</span> <span class="nn">..config.defaults</span> <span class="k">import</span> <span class="n">dap_source_dir</span><span class="p">,</span> <span class="n">default_dap_file_name</span>
<span class="kn">from</span> <span class="nn">..config.defaults</span> <span class="k">import</span> <span class="n">default_dap_method</span><span class="p">,</span> <span class="n">default_dap_method_path</span>
<span class="kn">from</span> <span class="nn">.spatiallybinnedspectra</span> <span class="k">import</span> <span class="n">SpatiallyBinnedSpectra</span>
<span class="kn">from</span> <span class="nn">.templatelibrary</span> <span class="k">import</span> <span class="n">TemplateLibrary</span>
<span class="kn">from</span> <span class="nn">.ppxffit</span> <span class="k">import</span> <span class="n">PPXFFitPar</span><span class="p">,</span> <span class="n">PPXFFit</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="k">import</span> <span class="n">select_proc_method</span><span class="p">,</span> <span class="n">replace_with_data_from_nearest_coo</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>
<span class="c1">#from memory_profiler import profile</span>

<span class="c1"># Add strict versioning</span>
<span class="c1"># from distutils.version import StrictVersion</span>


<div class="viewcode-block" id="StellarContinuumModelDef"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModelDef">[docs]</a><span class="k">class</span> <span class="nc">StellarContinuumModelDef</span><span class="p">(</span><span class="n">ParSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that holds the parameters necessary to perform the</span>
<span class="sd">    stellar-continuum fitting.</span>

<span class="sd">    The function use to fit the stellar continuum model must have the</span>
<span class="sd">    form::</span>

<span class="sd">        model_wave, model_flux, model_mask, model_par \</span>
<span class="sd">                = fitfunc(self, binned_spectra, par=None)</span>

<span class="sd">    where `binned_spectra` has type</span>
<span class="sd">    :class:`mangadap.proc.spatiallybinnedspetra.SpatiallyBinnedSpectra`,</span>
<span class="sd">    and the returned objects are the wavelength vector, the fitted model</span>
<span class="sd">    flux, a bitmask for the model, and the set of model parameters.  For</span>
<span class="sd">    example, see</span>
<span class="sd">    :func:`mangadap.proc.ppxffit.PPXFFit.fit_SpatiallyBinnedSpectra`.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (str): Keyword used to distinguish between different spatial</span>
<span class="sd">            binning schemes.</span>
<span class="sd">        minimum_snr (bool): Minimum S/N of spectrum to fit</span>
<span class="sd">        fit_type (str): Currently can be anything.  In the DAP, this is</span>
<span class="sd">            used to identify the primary purpose of the fit as either</span>
<span class="sd">            producing stellar kinematics, composition measurements, or</span>
<span class="sd">            emission line fits; see</span>
<span class="sd">            :mod:`mangadap.proc.spectralfitting&#39;.  The purpose for this</span>
<span class="sd">            type is to isolate the expected format of the binary table</span>
<span class="sd">            data; see, e.g.,</span>
<span class="sd">            :func:`mangadap.proc.spectralfitting._per_stellar_kinematics_dtype`.</span>
<span class="sd">        fitpar (:class:`mangadap.par.parset.ParSet` or dict): Any</span>
<span class="sd">            additional parameters, aside from the spectra themselves,</span>
<span class="sd">            required by the fitting function.</span>
<span class="sd">        fitclass (object): Instance of class object to use for the</span>
<span class="sd">            model fitting.  Needed in case fitfunc is a non-static member</span>
<span class="sd">            function of a class.</span>
<span class="sd">        fitfunc (callable): The function that models the spectra</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">minimum_snr</span><span class="p">,</span> <span class="n">fit_type</span><span class="p">,</span> <span class="n">fitpar</span><span class="p">,</span> <span class="n">fitclass</span><span class="p">,</span> <span class="n">fitfunc</span><span class="p">):</span>
        <span class="n">in_fl</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span> <span class="p">]</span>
        <span class="n">par_opt</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ParSet</span><span class="p">,</span> <span class="nb">dict</span> <span class="p">]</span>

        <span class="n">pars</span> <span class="o">=</span>     <span class="p">[</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;minimum_snr&#39;</span><span class="p">,</span> <span class="s1">&#39;fit_type&#39;</span><span class="p">,</span> <span class="s1">&#39;fitpar&#39;</span><span class="p">,</span> <span class="s1">&#39;fitclass&#39;</span><span class="p">,</span> <span class="s1">&#39;fitfunc&#39;</span> <span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span>   <span class="p">[</span>   <span class="n">key</span><span class="p">,</span>   <span class="n">minimum_snr</span><span class="p">,</span>   <span class="n">fit_type</span><span class="p">,</span>   <span class="n">fitpar</span><span class="p">,</span>   <span class="n">fitclass</span><span class="p">,</span>   <span class="n">fitfunc</span> <span class="p">]</span>
        <span class="n">dtypes</span> <span class="o">=</span>   <span class="p">[</span>   <span class="nb">str</span><span class="p">,</span>         <span class="n">in_fl</span><span class="p">,</span>        <span class="nb">str</span><span class="p">,</span>  <span class="n">par_opt</span><span class="p">,</span>       <span class="kc">None</span><span class="p">,</span>      <span class="kc">None</span> <span class="p">]</span>
        <span class="n">can_call</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">False</span><span class="p">,</span>         <span class="kc">False</span><span class="p">,</span>      <span class="kc">False</span><span class="p">,</span>    <span class="kc">False</span><span class="p">,</span>      <span class="kc">False</span><span class="p">,</span>      <span class="kc">True</span> <span class="p">]</span>

        <span class="n">ParSet</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">can_call</span><span class="o">=</span><span class="n">can_call</span><span class="p">)</span></div>


<div class="viewcode-block" id="validate_stellar_continuum_modeling_method_config"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.validate_stellar_continuum_modeling_method_config">[docs]</a><span class="k">def</span> <span class="nf">validate_stellar_continuum_modeling_method_config</span><span class="p">(</span><span class="n">cnfg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Validate the :class:`mangadap.util.parser.DefaultConfig` object with</span>
<span class="sd">    the stellar-continuum-modeling method parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        cnfg (:class:`mangadap.util.parser.DefaultConfig`): Object with</span>
<span class="sd">            the stellar-continuum-modeling method parameters to</span>
<span class="sd">            validate.</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: Raised if any required keywords do not exist.</span>
<span class="sd">        ValueError: Raised if keys have unacceptable values.</span>
<span class="sd">        FileNotFoundError: Raised if a file is specified but could not</span>
<span class="sd">            be found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check for required keywords</span>
    <span class="n">required_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;fit_type&#39;</span><span class="p">,</span> <span class="s1">&#39;fit_method&#39;</span> <span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cnfg</span><span class="o">.</span><span class="n">all_required</span><span class="p">(</span><span class="n">required_keywords</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Keywords </span><span class="si">{0}</span><span class="s1"> must all have valid values.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_keywords</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;fit_method&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;ppxf&#39;</span> <span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown fitting method: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;fit_method&#39;</span><span class="p">]))</span>

    <span class="c1"># Method specific keywords</span>
    <span class="k">if</span> <span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;fit_method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ppxf&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cnfg</span><span class="o">.</span><span class="n">keyword_specified</span><span class="p">(</span><span class="s1">&#39;template_library&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Keyword </span><span class="se">\&#39;</span><span class="s1">template_library</span><span class="se">\&#39;</span><span class="s1"> must be provided for pPXF fitting.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="available_stellar_continuum_modeling_methods"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.available_stellar_continuum_modeling_methods">[docs]</a><span class="k">def</span> <span class="nf">available_stellar_continuum_modeling_methods</span><span class="p">(</span><span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the list of available stellar-continuum modeling methods.</span>

<span class="sd">    pPXF methods:</span>

<span class="sd">    .. todo::</span>
<span class="sd">        Fill in</span>

<span class="sd">    Args:</span>
<span class="sd">        dapsrc (str): (**Optional**) Root path to the DAP source</span>
<span class="sd">            directory.  If not provided, the default is defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.dap_source_dir`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of</span>
<span class="sd">        :func:`mangadap.proc.stellarcontinuummodel.StellarContinuumModelDef`</span>
<span class="sd">        objects, each defining a stellar-continuum modeling approach.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotADirectoryError: Raised if the provided or default</span>
<span class="sd">            *dapsrc* is not a directory.</span>
<span class="sd">        OSError/IOError: Raised if no binning scheme configuration files</span>
<span class="sd">            could be found.</span>
<span class="sd">        KeyError: Raised if the binning method keywords are not all</span>
<span class="sd">            unique.</span>

<span class="sd">    .. todo::</span>
<span class="sd">        - Somehow add a python call that reads the databases and</span>
<span class="sd">          constructs the table for presentation in sphinx so that the</span>
<span class="sd">          text above doesn&#39;t have to be edited with changes in the</span>
<span class="sd">          available databases.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check the source directory exists</span>
    <span class="n">dapsrc</span> <span class="o">=</span> <span class="n">dap_source_dir</span><span class="p">()</span> <span class="k">if</span> <span class="n">dapsrc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> does not exist!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">))</span>

    <span class="c1"># Check the configuration files exist</span>
    <span class="n">search_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">,</span> <span class="s1">&#39;python/mangadap/config/stellar_continuum_modeling&#39;</span><span class="p">)</span>
    <span class="n">ini_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">search_dir</span><span class="p">,</span> <span class="s1">&#39;*.ini&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ini_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Could not find any configuration files in </span><span class="si">{0}</span><span class="s1"> !&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">search_dir</span><span class="p">))</span>

    <span class="c1"># Build the list of library definitions</span>
    <span class="c1"># TODO: Should only read the keywords for the pixel mask so that the</span>
    <span class="c1"># artifact and emission-line databases are not read into memory</span>
    <span class="n">modeling_methods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ini_files</span><span class="p">:</span>
        <span class="c1"># Read and validate the config file</span>
        <span class="n">cnfg</span> <span class="o">=</span> <span class="n">DefaultConfig</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="n">validate_stellar_continuum_modeling_method_config</span><span class="p">(</span><span class="n">cnfg</span><span class="p">)</span>

        <span class="c1"># TODO: Pull this out; shouldn&#39;t be instantiating these already</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;artifact_mask&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                        <span class="n">ArtifactDB</span><span class="p">(</span><span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;artifact_mask&#39;</span><span class="p">],</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>
        <span class="n">emission_lines</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;emission_line_mask&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                            <span class="n">EmissionLineDB</span><span class="p">(</span><span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;emission_line_mask&#39;</span><span class="p">],</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>
        <span class="n">waverange</span> <span class="o">=</span> <span class="n">cnfg</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;waverange&#39;</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">minimum_snr</span> <span class="o">=</span> <span class="n">cnfg</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;minimum_snr&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;fit_method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ppxf&#39;</span><span class="p">:</span>
            <span class="c1"># sky is always none for now</span>
            <span class="n">fitpar</span> <span class="o">=</span> <span class="n">PPXFFitPar</span><span class="p">(</span><span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;template_library&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">iteration_mode</span><span class="o">=</span><span class="n">cnfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fit_iter&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;global_template&#39;</span><span class="p">),</span>
                                <span class="n">reject_boxcar</span><span class="o">=</span><span class="n">cnfg</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;reject_boxcar&#39;</span><span class="p">),</span>
                                <span class="n">filter_boxcar</span><span class="o">=</span><span class="n">cnfg</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;filter_boxcar&#39;</span><span class="p">),</span>
                                <span class="n">filter_operation</span><span class="o">=</span><span class="n">cnfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filter_op&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;subtract&#39;</span><span class="p">),</span>
                                <span class="n">filter_iterations</span><span class="o">=</span><span class="n">cnfg</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;filter_iter&#39;</span><span class="p">),</span>
                                <span class="n">match_resolution</span><span class="o">=</span><span class="n">cnfg</span><span class="o">.</span><span class="n">getbool</span><span class="p">(</span><span class="s1">&#39;match_resolution&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                <span class="n">velscale_ratio</span><span class="o">=</span><span class="n">cnfg</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;velscale_ratio&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                <span class="n">minimum_snr</span><span class="o">=</span><span class="n">minimum_snr</span><span class="p">,</span>
                                <span class="n">pixelmask</span><span class="o">=</span><span class="n">SpectralPixelMask</span><span class="p">(</span><span class="n">artdb</span><span class="o">=</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">emldb</span><span class="o">=</span><span class="n">emission_lines</span><span class="p">,</span>
                                                            <span class="n">waverange</span><span class="o">=</span><span class="n">waverange</span><span class="p">),</span>
                                <span class="n">bias</span><span class="o">=</span><span class="n">cnfg</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;bias&#39;</span><span class="p">),</span> <span class="n">degree</span><span class="o">=</span><span class="n">cnfg</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;degree&#39;</span><span class="p">),</span>
                                <span class="n">mdegree</span><span class="o">=</span><span class="n">cnfg</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;mdegree&#39;</span><span class="p">),</span>
                                <span class="n">filt_degree</span><span class="o">=</span><span class="n">cnfg</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;filter_degree&#39;</span><span class="p">),</span>
                                <span class="n">filt_mdegree</span><span class="o">=</span><span class="n">cnfg</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;filter_mdegree&#39;</span><span class="p">),</span>
                                <span class="n">moments</span><span class="o">=</span><span class="n">cnfg</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;moments&#39;</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">fitclass</span> <span class="o">=</span> <span class="n">PPXFFit</span><span class="p">(</span><span class="n">StellarContinuumModelBitMask</span><span class="p">(</span><span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">))</span>
            <span class="n">fitfunc</span> <span class="o">=</span> <span class="n">fitclass</span><span class="o">.</span><span class="n">fit_SpatiallyBinnedSpectra</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown fitting method: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">][</span><span class="s1">&#39;fit_method&#39;</span><span class="p">]))</span>

        <span class="n">modeling_methods</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">StellarContinuumModelDef</span><span class="p">(</span><span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> 
                                                       <span class="n">cnfg</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;minimum_snr&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">),</span>
                                                       <span class="n">cnfg</span><span class="p">[</span><span class="s1">&#39;fit_type&#39;</span><span class="p">],</span>
                                                       <span class="n">fitpar</span><span class="p">,</span> <span class="n">fitclass</span><span class="p">,</span> <span class="n">fitfunc</span><span class="p">)</span> <span class="p">]</span>

    <span class="c1"># Check the keywords of the libraries are all unique</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">method</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">modeling_methods</span> <span class="p">])</span> <span class="p">))</span> \
            <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modeling_methods</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Stellar-continuum modeling method keywords are not all unique!&#39;</span><span class="p">)</span>

    <span class="c1"># Return the default list of assessment methods</span>
    <span class="k">return</span> <span class="n">modeling_methods</span></div>


<div class="viewcode-block" id="StellarContinuumModelBitMask"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModelBitMask">[docs]</a><span class="k">class</span> <span class="nc">StellarContinuumModelBitMask</span><span class="p">(</span><span class="n">BitMask</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Derived class that specifies the mask bits for the stellar-continuum</span>
<span class="sd">    modeling.  See :class:`mangadap.util.bitmask.BitMask` for</span>
<span class="sd">    attributes.</span>

<span class="sd">    A list of the bits and meanings are provided by the base class</span>
<span class="sd">    function :func:`mangadap.util.bitmask.BitMask.info`; i.e.,::</span>

<span class="sd">        from mangadap.proc.stellarcontinuummodel import StellarContinuumModelBitMask</span>
<span class="sd">        bm = StellarContinuumModelBitMask()</span>
<span class="sd">        bm.info()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dapsrc</span> <span class="o">=</span> <span class="n">dap_source_dir</span><span class="p">()</span> <span class="k">if</span> <span class="n">dapsrc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">)</span>
        <span class="n">BitMask</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ini_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dapsrc</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;mangadap&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;bitmasks&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;stellar_continuum_model_bits.ini&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="StellarContinuumModel"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel">[docs]</a><span class="k">class</span> <span class="nc">StellarContinuumModel</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that holds the stellar-continuum model results.</span>

<span class="sd">    Args:</span>
<span class="sd">        method_key (str): The keyword that designates which method,</span>
<span class="sd">            provided in *method_list*, to use for the continuum-fitting</span>
<span class="sd">            procedure.  </span>
<span class="sd">        binned_spectra</span>
<span class="sd">            (:class:`mangadap.proc.spatiallybinnedspectra.SpatiallyBinnedSpectra`):</span>
<span class="sd">            The binned spectra to fit.</span>
<span class="sd">        guess_vel (float, numpy.ndarray): A single or spectrum-dependent</span>
<span class="sd">            initial estimate of the redshift in km/s (:math:`cz`).</span>
<span class="sd">        guess_sig (float, numpy.ndarray): (**Optional**) A single or</span>
<span class="sd">            spectrum-dependent initial estimate of the velocity</span>
<span class="sd">            dispersion in km/s.  Default is 100 km/s.</span>
<span class="sd">        method_list (list): (**Optional**) List of</span>
<span class="sd">            :class:`StellarContinuumModelDef` objects that define one or</span>
<span class="sd">            more methods to use for the stellar continuum binning.  The</span>
<span class="sd">            default list is provided by the config files in the DAP</span>
<span class="sd">            source directory and compiled into this list using</span>
<span class="sd">            :func:`available_stellar_continuum_modeling_methods`.</span>
<span class="sd">        dapsrc (str): (**Optional**) Root path to the DAP source</span>
<span class="sd">            directory.  If not provided, the default is defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.dap_source_dir`.</span>
<span class="sd">        dapver (str): (**Optional**) The DAP version to use for the</span>
<span class="sd">            analysis, used to override the default defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_dap_version`.</span>
<span class="sd">        analysis_path (str): (**Optional**) The top-level path for the</span>
<span class="sd">            DAP output files, used to override the default defined by</span>
<span class="sd">            :func:`mangadap.config.defaults.default_analysis_path`.</span>
<span class="sd">        directory_path (str): The exact path to the directory with DAP</span>
<span class="sd">            output that is common to number DAP &quot;methods&quot;.  See</span>
<span class="sd">            :attr:`directory_path`.</span>
<span class="sd">        output_file (str): (**Optional**) Exact name for the output</span>
<span class="sd">            file.  The default is to use</span>
<span class="sd">            :func:`mangadap.config.defaults.default_dap_file_name`.</span>
<span class="sd">        hardcopy (bool): (**Optional**) Flag to write the HDUList</span>
<span class="sd">            attribute to disk.  Default is True; if False, the HDUList</span>
<span class="sd">            is only kept in memory and would have to be reconstructed.</span>
<span class="sd">        tpl_symlink_dir (str): (**Optional**) Create a symbolic link to</span>
<span class="sd">            the created template library file in the supplied directory.</span>
<span class="sd">            Default is to produce no symbolic link.</span>
<span class="sd">        clobber (bool): (**Optional**) Overwrite any existing files.</span>
<span class="sd">            Default is to use any existing file instead of redoing the</span>
<span class="sd">            analysis and overwriting the existing output.</span>
<span class="sd">        checksum (bool): (**Optional**) Use the checksum in the fits</span>
<span class="sd">            header to confirm that the data has not been corrupted.  The</span>
<span class="sd">            checksum is **always** written to the fits header when the</span>
<span class="sd">            file is created; this argument does not toggle that</span>
<span class="sd">            functionality.</span>
<span class="sd">        loggers (list): (**Optional**) List of `logging.Logger`_ objects</span>
<span class="sd">            to log progress; ignored if quiet=True.  Logging is done</span>
<span class="sd">            using :func:`mangadap.util.log.log_output`.  Default is no</span>
<span class="sd">            logging.</span>
<span class="sd">        quiet (bool): (**Optional**) Suppress all terminal and logging</span>
<span class="sd">            output.  Default is False.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        loggers (list): List of `logging.Logger`_ objects to log</span>
<span class="sd">            progress; ignored if quiet=True.  Logging is done using</span>
<span class="sd">            :func:`mangadap.util.log.log_output`.</span>
<span class="sd">        quiet (bool): Suppress all terminal and logging output.</span>

<span class="sd">    .. todo::</span>
<span class="sd">        - Allow for a prior?</span>

<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#    @profile</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_key</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">guess_vel</span><span class="p">,</span> <span class="n">guess_sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">method_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">directory_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hardcopy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tpl_symlink_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loggers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loggers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Define the method properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_define_method</span><span class="p">(</span><span class="n">method_key</span><span class="p">,</span> <span class="n">method_list</span><span class="o">=</span><span class="n">method_list</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guess_vel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guess_sig</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Define the output directory and file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># Set in _set_paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hardcopy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Define the bitmask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span> <span class="o">=</span> <span class="n">StellarContinuumModelBitMask</span><span class="p">(</span><span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span>

        <span class="c1"># Initialize the main class attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="n">checksum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nspec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectral_arrays</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_spectral_arrays</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_arrays</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_image_arrays</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispaxis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwave</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nmodels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_models</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># TODO: Include covariance between measured properties</span>

        <span class="c1"># Run the assessments of the DRP file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">binned_spectra</span><span class="p">,</span> <span class="n">guess_vel</span><span class="p">,</span> <span class="n">guess_sig</span><span class="o">=</span><span class="n">guess_sig</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">,</span>
                 <span class="n">dapver</span><span class="o">=</span><span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="n">analysis_path</span><span class="p">,</span> <span class="n">directory_path</span><span class="o">=</span><span class="n">directory_path</span><span class="p">,</span>
                 <span class="n">output_file</span><span class="o">=</span><span class="n">output_file</span><span class="p">,</span> <span class="n">hardcopy</span><span class="o">=</span><span class="n">hardcopy</span><span class="p">,</span> <span class="n">tpl_symlink_dir</span><span class="o">=</span><span class="n">tpl_symlink_dir</span><span class="p">,</span>
                 <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">,</span> <span class="n">loggers</span><span class="o">=</span><span class="n">loggers</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span>


<span class="c1">#    def __del__(self):</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        Deconstruct the data object by ensuring that the fits file is</span>
<span class="c1">#        properly closed.</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        if self.hdu is None:</span>
<span class="c1">#            return</span>
<span class="c1">#        self.hdu.close()</span>
<span class="c1">#        self.hdu = None</span>
<span class="c1">#</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


<div class="viewcode-block" id="StellarContinuumModel._define_method"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel._define_method">[docs]</a>    <span class="k">def</span> <span class="nf">_define_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_key</span><span class="p">,</span> <span class="n">method_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select the method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Grab the specific method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">select_proc_method</span><span class="p">(</span><span class="n">method_key</span><span class="p">,</span> <span class="n">StellarContinuumModelDef</span><span class="p">,</span>
                                         <span class="n">method_list</span><span class="o">=</span><span class="n">method_list</span><span class="p">,</span>
                                       <span class="n">available_func</span><span class="o">=</span><span class="n">available_stellar_continuum_modeling_methods</span><span class="p">,</span>
                                         <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">)</span></div>


<div class="viewcode-block" id="StellarContinuumModel._fill_method_par"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel._fill_method_par">[docs]</a>    <span class="k">def</span> <span class="nf">_fill_method_par</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tpl_symlink_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill in any remaining modeling parameters.</span>

<span class="sd">        This creates a full array for the guess redshifts and guess velocity dispersions.</span>

<span class="sd">        It also creates/reads the template library.</span>

<span class="sd">        .. todo:</span>
<span class="sd">            </span>
<span class="sd">            HARDCODED now to NEVER save the processed template library.</span>
<span class="sd">            Should add this as an option in StellarContinuumModelDef or PPXFFitPar.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Determining initial guess kinematics&#39;</span><span class="p">)</span>

        <span class="c1"># Fill the guess kinematics</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">nbins</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guess_vel</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guess_vel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guess_vel</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nbins</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Incorrect number of guess velocities provided.  Expect one per &#39;</span> \
                                 <span class="s1">&#39;binned spectrum = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nbins</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;guess_redshift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guess_vel</span><span class="o">/</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                                                                                    <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;guess_redshift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_vel</span><span class="o">/</span><span class="n">c</span><span class="p">,</span>
                                                                 <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guess_sig</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guess_sig</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guess_sig</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nbins</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Incorrect number of guess velocity dispersions provided.  &#39;</span> \
                                 <span class="s1">&#39;Expect one per binned spectrum = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nbins</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;guess_dispersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guess_sig</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                                                                                    <span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;guess_dispersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nbins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_sig</span><span class="p">,</span>
                                                                   <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;template_library_key&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Instantiating template library...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;template_library&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template_library</span><span class="p">(</span>
                            <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="n">analysis_path</span><span class="p">,</span>
                            <span class="n">tpl_symlink_dir</span><span class="o">=</span><span class="n">tpl_symlink_dir</span><span class="p">,</span>
                            <span class="n">velocity_offset</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;guess_redshift&#39;</span><span class="p">]),</span>
                            <span class="n">match_to_drp_resolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;match_resolution&#39;</span><span class="p">],</span>
                            <span class="n">hardcopy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="StellarContinuumModel.get_template_library"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.get_template_library">[docs]</a>    <span class="k">def</span> <span class="nf">get_template_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">tpl_symlink_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">velocity_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">match_to_drp_resolution</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">resolution_fwhm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">hardcopy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">resolution_fwhm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TemplateLibrary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;template_library_key&#39;</span><span class="p">],</span>
                                   <span class="n">velocity_offset</span><span class="o">=</span><span class="n">velocity_offset</span><span class="p">,</span> <span class="n">drpf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span>
                                   <span class="n">match_to_drp_resolution</span><span class="o">=</span><span class="n">match_to_drp_resolution</span><span class="p">,</span>
                                   <span class="n">velscale_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;velscale_ratio&#39;</span><span class="p">],</span>
                                   <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="n">analysis_path</span><span class="p">,</span>
                                   <span class="n">hardcopy</span><span class="o">=</span><span class="n">hardcopy</span><span class="p">,</span> <span class="n">symlink_dir</span><span class="o">=</span><span class="n">tpl_symlink_dir</span><span class="p">,</span>
                                   <span class="n">loggers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set the spectral resolution</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;WAVE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="n">sres</span> <span class="o">=</span> <span class="n">SpectralResolution</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">wave</span><span class="o">/</span><span class="n">resolution_fwhm</span><span class="p">,</span> <span class="n">log10</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Set the file designation for this template library.</span>
            <span class="c1"># TODO: Move this to config.default?</span>
            <span class="n">designation</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-FWHM</span><span class="si">{1:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;template_library_key&#39;</span><span class="p">],</span>
                                                   <span class="n">resolution_fwhm</span><span class="p">)</span>
            <span class="c1"># Set the output file name</span>
            <span class="n">processed_file</span> <span class="o">=</span> <span class="n">default_dap_file_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span> <span class="n">designation</span><span class="p">)</span>

            <span class="n">directory_path</span> <span class="o">=</span> <span class="n">default_dap_common_path</span><span class="p">(</span><span class="n">plate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span>
                                                     <span class="n">ifudesign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span>
                                                     <span class="n">drpver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">drpver</span><span class="p">,</span>
                                                     <span class="n">dapver</span><span class="o">=</span><span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="n">analysis_path</span><span class="p">)</span>

            <span class="n">velscale_ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;velscale_ratio&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> \
                                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;velscale_ratio&#39;</span><span class="p">]</span>
            <span class="n">spectral_step</span><span class="o">=</span><span class="n">spectral_coordinate_step</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="n">velscale_ratio</span>

            <span class="k">return</span> <span class="n">TemplateLibrary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;template_library_key&#39;</span><span class="p">],</span> <span class="n">sres</span><span class="o">=</span><span class="n">sres</span><span class="p">,</span>
                                   <span class="n">velocity_offset</span><span class="o">=</span><span class="n">velocity_offset</span><span class="p">,</span> <span class="n">spectral_step</span><span class="o">=</span><span class="n">spectral_step</span><span class="p">,</span>
                                   <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">,</span> <span class="n">directory_path</span><span class="o">=</span><span class="n">directory_path</span><span class="p">,</span>
                                   <span class="n">hardcopy</span><span class="o">=</span><span class="n">hardcopy</span><span class="p">,</span> <span class="n">symlink_dir</span><span class="o">=</span><span class="n">tpl_symlink_dir</span><span class="p">,</span>
                                   <span class="n">processed_file</span><span class="o">=</span><span class="n">processed_file</span><span class="p">,</span> <span class="n">loggers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span>
                                   <span class="n">quiet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span></div>


<div class="viewcode-block" id="StellarContinuumModel._set_paths"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel._set_paths">[docs]</a>    <span class="k">def</span> <span class="nf">_set_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory_path</span><span class="p">,</span> <span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the :attr:`directory_path` and :attr:`output_file`.  If not</span>
<span class="sd">        provided, the defaults are set using, respectively,</span>
<span class="sd">        :func:`mangadap.config.defaults.default_dap_method_path` and</span>
<span class="sd">        :func:`mangadap.config.defaults.default_dap_file_name`.</span>

<span class="sd">        Args:</span>
<span class="sd">            directory_path (str): The exact path to the DAP reduction</span>
<span class="sd">                assessments file.  See :attr:`directory_path`.</span>
<span class="sd">            dapver (str): DAP version.</span>
<span class="sd">            analysis_path (str): The path to the top-level directory</span>
<span class="sd">                containing the DAP output files for a given DRP and DAP</span>
<span class="sd">                version.</span>
<span class="sd">            output_file (str): The name of the file with the reduction assessments.</span>
<span class="sd">                See :func:`compute`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> \
                <span class="o">=</span> <span class="n">StellarContinuumModel</span><span class="o">.</span><span class="n">default_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">plate</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">ifudesign</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">rdxqa</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span>
                                                      <span class="n">directory_path</span><span class="o">=</span><span class="n">directory_path</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="n">dapver</span><span class="p">,</span>
                                                      <span class="n">analysis_path</span><span class="o">=</span><span class="n">analysis_path</span><span class="p">,</span>
                                                      <span class="n">output_file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="StellarContinuumModel._initialize_primary_header"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel._initialize_primary_header">[docs]</a>    <span class="k">def</span> <span class="nf">_initialize_primary_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the header of :attr:`hdu`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            astropy.io.fits.Header : Edited header object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Copy the from the DRP and clean it</span>
        <span class="k">if</span> <span class="n">hdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">clean_dap_primary_header</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
        
        <span class="c1"># Add keywords specific to this object</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;AUTHOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Kyle B. Westfall &lt;westfall@ucolick.org&gt;&#39;</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;VSTEP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spectrum_velocity_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;WAVE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
                        <span class="s1">&#39;Velocity step per spectral channel.&#39;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;SCKEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> <span class="s1">&#39;Stellar-continuum modeling method keyword&#39;</span><span class="p">)</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;SCMINSN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;minimum_snr&#39;</span><span class="p">],</span> <span class="s1">&#39;Minimum S/N of spectrum to include&#39;</span><span class="p">)</span>

        <span class="c1"># Guess kinematics</span>
        <span class="c1"># TODO: These are currently single numbers, but they may</span>
        <span class="c1"># eventually be vectors!  Include guess kinematics as a map?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_vel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;SCINPVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guess_vel</span><span class="p">,</span> <span class="s1">&#39;Initial guess velocity&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_sig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;SCINPSIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guess_sig</span><span class="p">,</span> <span class="s1">&#39;Initial guess velocity dispersion&#39;</span><span class="p">)</span>

        <span class="c1"># Include the number of models</span>
        <span class="c1"># TODO: Is it a problem if missing_models is too long?</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NSCMOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmodels</span><span class="p">,</span> <span class="s1">&#39;Number of unique stellar-continuum models&#39;</span><span class="p">)</span>
<span class="c1">#        if len(self.missing_models) &gt; 0:</span>
<span class="c1">#            hdr[&#39;EMPTYSC&#39;] = (str(self.missing_models), &#39;Bins w/o models&#39;)</span>
        <span class="k">return</span> <span class="n">hdr</span></div>


<div class="viewcode-block" id="StellarContinuumModel._add_method_header"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel._add_method_header">[docs]</a>    <span class="k">def</span> <span class="nf">_add_method_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add fitting method information to the header.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitclass&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;SCTYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitclass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fit_type</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;SCMETH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitclass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fit_method</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardcopy</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Fit class object does not have fit_type and/or fit_method &#39;</span> \
                                  <span class="s1">&#39;attributes.  No parameters written to header.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">toheader</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardcopy</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Fit parameter class has no toheader() function.  No &#39;</span> \
                                  <span class="s1">&#39;parameters written to header.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hdr</span></div>


<div class="viewcode-block" id="StellarContinuumModel._finalize_cube_mask"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel._finalize_cube_mask">[docs]</a>    <span class="k">def</span> <span class="nf">_finalize_cube_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalize the mask by setting the DIDNOTUSE, FORESTAR, and LOW_SNR masks</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray : Bitmask array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Turn on the flag stating that the pixel wasn&#39;t used</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                   <span class="n">flag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">do_not_fit_flags</span><span class="p">())</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;DIDNOTUSE&#39;</span><span class="p">)</span>

        <span class="c1"># Turn on the flag stating that the pixel has a foreground star</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                   <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;FORESTAR&#39;</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;FORESTAR&#39;</span><span class="p">)</span>

        <span class="c1"># Turn on the flag stating that the S/N in the spectrum was</span>
        <span class="c1"># below the requested limit</span>
        <span class="n">low_snr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">low_snr</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwave</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;LOW_SNR&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mask</span></div>


<span class="c1">#    def _check_snr(self):</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        Determine which spectra in :attr:`binned_spectra` have a S/N</span>
<span class="c1">#        greater than the minimum set by :attr:`method`.  Only these</span>
<span class="c1">#        spectra will be analyzed.</span>
<span class="c1">#    </span>
<span class="c1">#        Returns:</span>
<span class="c1">#            numpy.ndarray : Boolean array for the spectra that satisfy</span>
<span class="c1">#            the criterion.</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">##        print(self.binned_spectra[&#39;BINS&#39;].data[&#39;SNR&#39;])</span>
<span class="c1">##        print(self.method[&#39;minimum_snr&#39;])</span>
<span class="c1">#        return self.binned_spectra.above_snr_limit(self.method[&#39;minimum_snr&#39;])</span>


<span class="c1">#    def _bins_to_fit(self):</span>
<span class="c1">#        &quot;&quot;&quot;Return flags for the bins to fit.&quot;&quot;&quot;</span>
<span class="c1">#        return (self._check_snr()) \</span>
<span class="c1">#                    &amp; ~(numpy.array([ b in self.binned_spectra.missing_bins \</span>
<span class="c1">#                                        for b in numpy.arange(self.binned_spectra.nbins)]))</span>


<div class="viewcode-block" id="StellarContinuumModel._assign_spectral_arrays"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel._assign_spectral_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">_assign_spectral_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set :attr:`spectral_arrays`, which contains the list of</span>
<span class="sd">        extensions in :attr:`hdu` that contain spectral data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectral_arrays</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;FLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;MASK&#39;</span> <span class="p">]</span></div>


<div class="viewcode-block" id="StellarContinuumModel._assign_image_arrays"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel._assign_image_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">_assign_image_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set :attr:`image_arrays`, which contains the list of extensions</span>
<span class="sd">        in :attr:`hdu` that are on-sky image data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_arrays</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;BINID&#39;</span> <span class="p">]</span></div>


<div class="viewcode-block" id="StellarContinuumModel._get_missing_models"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel._get_missing_models">[docs]</a>    <span class="k">def</span> <span class="nf">_get_missing_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">good_snr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">above_snr_limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;minimum_snr&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">][</span><span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">good_snr</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">missing_bins</span><span class="p">)</span> </div>


<div class="viewcode-block" id="StellarContinuumModel._construct_2d_hdu"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel._construct_2d_hdu">[docs]</a>    <span class="k">def</span> <span class="nf">_construct_2d_hdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">good_snr</span><span class="p">,</span> <span class="n">model_flux</span><span class="p">,</span> <span class="n">model_mask</span><span class="p">,</span> <span class="n">model_par</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct :attr:`hdu` that is held in memory for manipulation of</span>
<span class="sd">        the object.  See :func:`construct_3d_hdu` if you want to convert</span>
<span class="sd">        the object into a DRP-like datacube.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Constructing hdu ...&#39;</span><span class="p">)</span>

        <span class="c1"># Initialize the headers</span>
        <span class="n">pri_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_primary_header</span><span class="p">()</span>
        <span class="n">pri_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_method_header</span><span class="p">(</span><span class="n">pri_hdr</span><span class="p">)</span>
        <span class="n">map_hdr</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">build_map_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span>
                                               <span class="s1">&#39;K Westfall &lt;westfall@ucolick.org&gt;&#39;</span><span class="p">)</span>

        <span class="c1"># Get the spatial map mask</span>
        <span class="n">map_mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">minimum_dtype</span><span class="p">())</span>
        <span class="c1"># Add any spaxel not used because it was flagged by the binning</span>
        <span class="c1"># step</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;MAPMASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;DIDNOTUSE&#39;</span><span class="p">)</span>
        <span class="c1"># Isolate any spaxels with foreground stars</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;MAPMASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;FORESTAR&#39;</span><span class="p">)</span>
        <span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;FORESTAR&#39;</span><span class="p">)</span>
        <span class="c1"># Get the bins that were blow the S/N limit</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">reconstruct_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                                        <span class="n">good_snr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">map_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">turn_on</span><span class="p">(</span><span class="n">map_mask</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="s1">&#39;LOW_SNR&#39;</span><span class="p">)</span>

        <span class="c1"># Get the bin ids with fitted models</span>
        <span class="n">bin_indx</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">downselect_bins</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                               <span class="n">model_par</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>
<span class="c1">#        vmin = numpy.amin(self.binned_spectra[&#39;BINID&#39;].data)</span>
<span class="c1">#        vmax = numpy.amax(self.binned_spectra[&#39;BINID&#39;].data)</span>
<span class="c1">#        pyplot.imshow(self.binned_spectra[&#39;BINID&#39;].data, origin=&#39;lower&#39;, interpolation=&#39;nearest&#39;,</span>
<span class="c1">#                      vmin=vmin, vmax=vmax)</span>
<span class="c1">#        pyplot.show()</span>
<span class="c1">#        pyplot.imshow(bin_indx.reshape(self.spatial_shape), origin=&#39;lower&#39;, interpolation=&#39;nearest&#39;,</span>
<span class="c1">#                      vmin=vmin, vmax=vmax)</span>
<span class="c1">#        pyplot.show()</span>

        <span class="c1"># Save the data to the hdu attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">pri_hdr</span><span class="p">),</span>
                                  <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">model_flux</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;FLUX&#39;</span><span class="p">),</span>
                                  <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">model_mask</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MASK&#39;</span><span class="p">),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;WAVE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                  <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">bin_indx</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">map_hdr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;BINID&#39;</span><span class="p">),</span>
                                  <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">map_mask</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">map_hdr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MAPMASK&#39;</span><span class="p">),</span>
                                  <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span> <span class="p">[</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                                                             <span class="nb">format</span><span class="o">=</span><span class="n">rec_to_fits_type</span><span class="p">(</span><span class="n">model_par</span><span class="p">[</span><span class="n">n</span><span class="p">]),</span>
                                            <span class="n">array</span><span class="o">=</span><span class="n">model_par</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">model_par</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="p">],</span>
                                                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;PAR&#39;</span><span class="p">)</span>
                                <span class="p">])</span></div>

<div class="viewcode-block" id="StellarContinuumModel.default_paths"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.default_paths">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">default_paths</span><span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="p">,</span> <span class="n">rdxqa_method</span><span class="p">,</span> <span class="n">binning_method</span><span class="p">,</span> <span class="n">method_key</span><span class="p">,</span>
                      <span class="n">directory_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drpver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the default directory and file name for the output file.</span>

<span class="sd">        Args:</span>
<span class="sd">            plate (int): Plate number of the observation.</span>
<span class="sd">            ifudesign (int): IFU design number of the observation.</span>
<span class="sd">            rdxqa_method (str): Keyword designating the method used to</span>
<span class="sd">                construct the reductions assessments.</span>
<span class="sd">            bin_method (str): Keyword designating the method use for the</span>
<span class="sd">                spatial binning.</span>
<span class="sd">            method_key (str): Keyword designating the method used for</span>
<span class="sd">                the stellar-continuum fitting.</span>
<span class="sd">            directory_path (str): (**Optional**) The exact path to the</span>
<span class="sd">                DAP stellar-continuum file.  Default set by</span>
<span class="sd">                :func:`mangadap.config.defaults.default_dap_method_path`.</span>
<span class="sd">            drpver (str): (**Optional**) DRP version.  Default set by</span>
<span class="sd">                :func:`mangadap.config.defaults.default_drp_version`.</span>
<span class="sd">            dapver (str): (**Optional**) DAP version.  Default set by</span>
<span class="sd">                :func:`mangadap.config.defaults.default_dap_version`.</span>
<span class="sd">            analysis_path (str): (**Optional**) The path to the</span>
<span class="sd">                top-level directory containing the DAP output files for</span>
<span class="sd">                a given DRP and DAP version. Default set by</span>
<span class="sd">                :func:`mangadap.config.defaults.default_analysis_path`.</span>
<span class="sd">            output_file (str): (**Optional**) The name of the file with</span>
<span class="sd">                the reduction assessments.  Default set by</span>
<span class="sd">                :func:`mangadap.config.defaults.default_dap_file_name`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Two strings with the path for the output file and the</span>
<span class="sd">            name of the output file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the output directory path</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">default_dap_method</span><span class="p">(</span><span class="n">binning_method</span><span class="o">=</span><span class="n">binning_method</span><span class="p">,</span> <span class="n">continuum_method</span><span class="o">=</span><span class="n">method_key</span><span class="p">)</span>
        <span class="n">directory_path</span> <span class="o">=</span> <span class="n">default_dap_method_path</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">plate</span><span class="o">=</span><span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="o">=</span><span class="n">ifudesign</span><span class="p">,</span>
                                                 <span class="n">ref</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drpver</span><span class="o">=</span><span class="n">drpver</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="n">dapver</span><span class="p">,</span>
                                                 <span class="n">analysis_path</span><span class="o">=</span><span class="n">analysis_path</span><span class="p">)</span> \
                                        <span class="k">if</span> <span class="n">directory_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)</span>

        <span class="c1"># Set the output file</span>
        <span class="n">ref_method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rdxqa_method</span><span class="p">,</span> <span class="n">binning_method</span><span class="p">,</span> <span class="n">method_key</span><span class="p">)</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">default_dap_file_name</span><span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">ifudesign</span><span class="p">,</span> <span class="n">ref_method</span><span class="p">)</span> \
                                        <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">directory_path</span><span class="p">,</span> <span class="n">output_file</span></div>


<div class="viewcode-block" id="StellarContinuumModel.file_name"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.file_name">[docs]</a>    <span class="k">def</span> <span class="nf">file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of the output file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span></div>


<div class="viewcode-block" id="StellarContinuumModel.file_path"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.file_path">[docs]</a>    <span class="k">def</span> <span class="nf">file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the full path to the output file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="StellarContinuumModel.info"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="o">.</span><span class="n">info</span><span class="p">()</span></div>


<div class="viewcode-block" id="StellarContinuumModel.all_spectrum_flags"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.all_spectrum_flags">[docs]</a>    <span class="k">def</span> <span class="nf">all_spectrum_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;DIDNOTUSE&#39;</span><span class="p">,</span> <span class="s1">&#39;FORESTAR&#39;</span><span class="p">,</span> <span class="s1">&#39;LOW_SNR&#39;</span><span class="p">,</span> <span class="s1">&#39;ARTIFACT&#39;</span><span class="p">,</span> <span class="s1">&#39;OUTSIDE_RANGE&#39;</span><span class="p">,</span> <span class="s1">&#39;EML_REGION&#39;</span><span class="p">,</span>
                <span class="s1">&#39;TPL_PIXELS&#39;</span><span class="p">,</span> <span class="s1">&#39;TRUNCATED&#39;</span><span class="p">,</span> <span class="s1">&#39;PPXF_REJECT&#39;</span><span class="p">,</span> <span class="s1">&#39;INVALID_ERROR&#39;</span><span class="p">,</span> <span class="s1">&#39;FIT_FAILED&#39;</span><span class="p">,</span>
                <span class="s1">&#39;NEAR_BOUND&#39;</span> <span class="p">]</span></div>


<div class="viewcode-block" id="StellarContinuumModel.all_except_emission_flags"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.all_except_emission_flags">[docs]</a>    <span class="k">def</span> <span class="nf">all_except_emission_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;DIDNOTUSE&#39;</span><span class="p">,</span> <span class="s1">&#39;FORESTAR&#39;</span><span class="p">,</span> <span class="s1">&#39;LOW_SNR&#39;</span><span class="p">,</span> <span class="s1">&#39;ARTIFACT&#39;</span><span class="p">,</span> <span class="s1">&#39;OUTSIDE_RANGE&#39;</span><span class="p">,</span> <span class="s1">&#39;TPL_PIXELS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;TRUNCATED&#39;</span><span class="p">,</span> <span class="s1">&#39;PPXF_REJECT&#39;</span><span class="p">,</span> <span class="s1">&#39;INVALID_ERROR&#39;</span><span class="p">,</span> <span class="s1">&#39;FIT_FAILED&#39;</span><span class="p">,</span> <span class="s1">&#39;NEAR_BOUND&#39;</span> <span class="p">]</span></div>


<div class="viewcode-block" id="StellarContinuumModel.fit"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">,</span> <span class="n">guess_vel</span><span class="p">,</span> <span class="n">guess_sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapsrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dapver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">analysis_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directory_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hardcopy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">tpl_symlink_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loggers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the binned spectra using the specified method.</span>

<span class="sd">        Args:</span>
<span class="sd">            binned_spectra</span>
<span class="sd">                (:class:`mangadap.proc.spatiallybinnedspectra.SpatiallyBinnedSpectra`):</span>
<span class="sd">                The binned spectra to fit.</span>
<span class="sd">            guess_vel (float, numpy.ndarray): A single or spectrum-dependent</span>
<span class="sd">                initial estimate of the redshift in km/s (:math:`cz`).</span>
<span class="sd">            guess_sig (float, numpy.ndarray): (**Optional**) A single or</span>
<span class="sd">                spectrum-dependent initial estimate of the velocity</span>
<span class="sd">                dispersion in km/s.  Default is 100 km/s.</span>
<span class="sd">            dapsrc (str): (**Optional**) Root path to the DAP source</span>
<span class="sd">                directory.  If not provided, the default is defined by</span>
<span class="sd">                :func:`mangadap.config.defaults.dap_source_dir`.</span>
<span class="sd">            dapver (str): (**Optional**) The DAP version to use for the</span>
<span class="sd">                analysis, used to override the default defined by</span>
<span class="sd">                :func:`mangadap.config.defaults.default_dap_version`.</span>
<span class="sd">            analysis_path (str): (**Optional**) The top-level path for</span>
<span class="sd">                the DAP output files, used to override the default</span>
<span class="sd">                defined by</span>
<span class="sd">                :func:`mangadap.config.defaults.default_analysis_path`.</span>
<span class="sd">            directory_path (str): The exact path to the directory with</span>
<span class="sd">                DAP output that is common to number DAP &quot;methods&quot;.  See</span>
<span class="sd">                :attr:`directory_path`.</span>
<span class="sd">            output_file (str): (**Optional**) Exact name for the output</span>
<span class="sd">                file.  The default is to use</span>
<span class="sd">                :func:`mangadap.config.defaults.default_dap_file_name`.</span>
<span class="sd">            hardcopy (bool): (**Optional**) Flag to write the HDUList</span>
<span class="sd">                attribute to disk.  Default is True; if False, the</span>
<span class="sd">                HDUList is only kept in memory and would have to be</span>
<span class="sd">                reconstructed.</span>
<span class="sd">            tpl_symlink_dir (str): (**Optional**) Create a symbolic link</span>
<span class="sd">                to the created template library file in the supplied</span>
<span class="sd">                directory.  Default is to produce no symbolic link.</span>
<span class="sd">            clobber (bool): (**Optional**) Overwrite any existing files.</span>
<span class="sd">                Default is to use any existing file instead of redoing</span>
<span class="sd">                the analysis and overwriting the existing output.</span>
<span class="sd">            loggers (list): (**Optional**) List of `logging.Logger`_</span>
<span class="sd">                objects to log progress; ignored if quiet=True.  Logging</span>
<span class="sd">                is done using :func:`mangadap.util.log.log_output`.</span>
<span class="sd">                Default is no logging.</span>
<span class="sd">            quiet (bool): (**Optional**) Suppress all terminal and</span>
<span class="sd">                logging output.  Default is False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize the reporting</span>
        <span class="k">if</span> <span class="n">loggers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loggers</span> <span class="o">=</span> <span class="n">loggers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span>

        <span class="c1"># SpatiallyBinnedSpectra object always needed</span>
        <span class="k">if</span> <span class="n">binned_spectra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must provide spectra object for fitting.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binned_spectra</span><span class="p">,</span> <span class="n">SpatiallyBinnedSpectra</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Must provide a valid SpatiallyBinnedSpectra object!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Provided SpatiallyBinnedSpectra object is undefined!&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span> <span class="o">=</span> <span class="n">binned_spectra</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">spatial_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">nspec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">spatial_index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispaxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">dispaxis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">nwave</span>
        
        <span class="c1"># Get the guess kinematics</span>
        <span class="k">if</span> <span class="n">guess_vel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">guess_vel</span><span class="o">=</span><span class="n">guess_vel</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_vel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must provide initial guess velocity.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guess_sig</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="k">if</span> <span class="n">guess_sig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">guess_sig</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Get the good spectra</span>
        <span class="n">good_snr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">above_snr_limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;minimum_snr&#39;</span><span class="p">])</span>

        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0:^50}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;STELLAR CONTINUUM FITTING&#39;</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Number of binned spectra: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">nbins</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">missing_bins</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Missing bins: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">missing_bins</span><span class="p">)))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;With good S/N and to fit: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                            <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">good_snr</span><span class="p">)))</span>
<span class="c1">#            log_output(self.loggers, 1, logging.INFO, &#39;Total to fit: {0}&#39;.format(</span>
<span class="c1">#                                                            numpy.sum(good_bins)))</span>

        <span class="c1"># TODO: Is there a better way to handle this?</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">good_snr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No good spectra to fit!&#39;</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Fill in any remaining binning parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill_method_par</span><span class="p">(</span><span class="n">dapsrc</span><span class="o">=</span><span class="n">dapsrc</span><span class="p">,</span> <span class="n">analysis_path</span><span class="o">=</span><span class="n">analysis_path</span><span class="p">,</span>
                              <span class="n">tpl_symlink_dir</span><span class="o">=</span><span class="n">tpl_symlink_dir</span><span class="p">)</span>

        <span class="c1"># (Re)Set the output paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_paths</span><span class="p">(</span><span class="n">directory_path</span><span class="p">,</span> <span class="n">dapver</span><span class="p">,</span> <span class="n">analysis_path</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Check that the file path is defined</span>
        <span class="n">ofile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ofile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;File path for output file is undefined!&#39;</span><span class="p">)</span>

        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Output path: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">))</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Output file: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">))</span>
        
        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># If the file already exists, and not clobbering, just read the</span>
        <span class="c1"># file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hardcopy</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Using existing file&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">checksum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">checksum</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Fit the spectra</span>
        <span class="c1"># Mask should be fully defined within the fitting function</span>
        <span class="n">model_wave</span><span class="p">,</span> <span class="n">model_flux</span><span class="p">,</span> <span class="n">model_mask</span><span class="p">,</span> <span class="n">model_par</span> \
                <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitfunc&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">],</span>
                                         <span class="n">loggers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span>

        <span class="c1"># The number of models returned should match the number of</span>
        <span class="c1"># &quot;good&quot; spectra</span>

        <span class="c1"># TODO: Include failed fits in &quot;missing&quot; models?</span>

        <span class="c1"># DEBUG</span>
        <span class="k">if</span> <span class="n">model_flux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">good_snr</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected returned shape of fitted continuum models.&#39;</span><span class="p">)</span>

        <span class="c1"># Set the number of models and the missing models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmodels</span> <span class="o">=</span> <span class="n">model_flux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_missing_models</span><span class="p">()</span>

        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Fitted models: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmodels</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Missing models: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_models</span><span class="p">)))</span>

        <span class="c1"># Construct the 2d hdu list that only contains the fitted models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hardcopy</span> <span class="o">=</span> <span class="n">hardcopy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_construct_2d_hdu</span><span class="p">(</span><span class="n">good_snr</span><span class="p">,</span> <span class="n">model_flux</span><span class="p">,</span> <span class="n">model_mask</span><span class="p">,</span> <span class="n">model_par</span><span class="p">)</span>

        <span class="c1">#---------------------------------------------------------------</span>
        <span class="c1"># Write the data, if requested</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardcopy</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span></div>


<div class="viewcode-block" id="StellarContinuumModel.construct_3d_hdu"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.construct_3d_hdu">[docs]</a>    <span class="k">def</span> <span class="nf">construct_3d_hdu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reformat the model spectra into a cube matching the shape of</span>
<span class="sd">        the DRP fits file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Report</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="n">log_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;Constructing stellar continuum datacube ...&#39;</span><span class="p">)</span>

        <span class="n">bin_indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">model_flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">model_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">flux</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">reconstruct_cube</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">bin_indx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                                  <span class="p">[</span><span class="n">model_flux</span><span class="p">,</span> <span class="n">model_mask</span><span class="p">])</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_cube_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="c1"># Primary header is identical regardless of the shape of the</span>
        <span class="c1"># extensions</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cube_hdr</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">build_cube_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">drpf</span><span class="p">,</span>
                                                 <span class="s1">&#39;K Westfall &lt;westfall@ucolick.org&gt;&#39;</span><span class="p">)</span>

        <span class="c1"># Return the converted hdu without altering the internal hdu</span>
        <span class="k">return</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">hdr</span><span class="p">),</span>
                              <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">flux</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">cube_hdr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;FLUX&#39;</span><span class="p">),</span>
                              <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">cube_hdr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MASK&#39;</span><span class="p">),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;WAVE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="p">])</span></div>


    <span class="c1"># Exact same function as used by SpatiallyBinnedSpectra</span>
<div class="viewcode-block" id="StellarContinuumModel.write"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match_DRP</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the hdu object to the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert the spectral arrays in the HDU to a 3D cube and write</span>
        <span class="c1"># it</span>
        <span class="k">if</span> <span class="n">match_DRP</span><span class="p">:</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_3d_hdu</span><span class="p">()</span>
            <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">hdu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(),</span> <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">loggers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Just write the unique (2D) data</span>
        <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(),</span> <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">loggers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span> </div>


<div class="viewcode-block" id="StellarContinuumModel.read"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read an existing file with an existing set of stellar-continuum</span>
<span class="sd">        models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ifile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ifile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ifile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;File does not exist!: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ifile</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1">#        self.hdu = fits.open(ifile, checksum=checksum)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="n">checksum</span><span class="p">)</span>

        <span class="c1"># Confirm that the internal method is the same as the method</span>
        <span class="c1"># that was used in writing the file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SCKEY&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Keywords in header do not match specified method keywords!&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Keywords in header do not match specified method keywords!&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: &quot;strict&quot; should also check other aspects of the file to</span>
        <span class="c1"># make sure that the details of the method are also the same,</span>
        <span class="c1"># not just the keyword</span>

<span class="c1">#        if not self.quiet:</span>
<span class="c1">#            log_output(self.loggers, 1, logging.INFO, &#39;Reverting to python-native structure.&#39;)</span>
<span class="c1">#        DAPFitsUtil.restructure_rss(self.hdu, ext=self.spectral_arrays)</span>
<span class="c1">#        DAPFitsUtil.restructure_map(self.hdu, ext=self.image_arrays)</span>

        <span class="c1"># Attempt to read the input guess velocity and sigma</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">guess_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SCINPVEL&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">guess_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SCINPSIG&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to read input guess kinematics from file header!&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">guess_vel</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">guess_sig</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Attempt to read the modeling parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fromheader</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fromheader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nmodels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_missing_models</span><span class="p">()</span></div>


<div class="viewcode-block" id="StellarContinuumModel.copy_to_array"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.copy_to_array">[docs]</a>    <span class="k">def</span> <span class="nf">copy_to_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;FLUX&#39;</span><span class="p">,</span> <span class="n">waverange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Wrapper for :func:`mangadap.util.fitsutil.DAPFitsUtil.copy_to_array`</span>
<span class="sd">        specific for :class:`StellarContinuumModel`.</span>

<span class="sd">        Return a copy of the selected data array.  The array size is</span>
<span class="sd">        always :math:`N_{\rm models} \times N_{\rm wavelength}`; i.e., the</span>
<span class="sd">        data is always flattened to two dimensions and the unique</span>
<span class="sd">        spectra are selected.</span>

<span class="sd">        Args:</span>
<span class="sd">            ext (str) : (**Optional**) Name of the extension from which</span>
<span class="sd">                to draw the data.  Must be allowed for the current</span>
<span class="sd">                :attr:`mode`; see :attr:`data_arrays`.  Default is</span>
<span class="sd">                ``&#39;FLUX&#39;``.</span>
<span class="sd">            waverange (array-like) : (**Optional**) Two-element array</span>
<span class="sd">                with the first and last wavelength to include in the</span>
<span class="sd">                computation.  Default is to use the full wavelength</span>
<span class="sd">                range.</span>
<span class="sd">            include_missing (bool) : (**Optional**) Create an array with</span>
<span class="sd">                a size that accommodates the missing models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: A 2D array with a copy of the data from the</span>
<span class="sd">            selected extension.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">copy_to_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span> <span class="n">allowed_ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_arrays</span><span class="p">,</span>
                                         <span class="n">waverange</span><span class="o">=</span><span class="n">waverange</span><span class="p">,</span>
                                    <span class="n">missing_bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_models</span> <span class="k">if</span> <span class="n">include_missing</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                         <span class="n">nbins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span>
                                    <span class="n">unique_bins</span><span class="o">=</span><span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">unique_bins</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">))</span></div>


<div class="viewcode-block" id="StellarContinuumModel.copy_to_masked_array"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.copy_to_masked_array">[docs]</a>    <span class="k">def</span> <span class="nf">copy_to_masked_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;FLUX&#39;</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">waverange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for</span>
<span class="sd">        :func:`mangadap.util.fitsutil.DAPFitsUtil.copy_to_masked_array`</span>
<span class="sd">        specific for :class:`StellarContinuumModel`.</span>

<span class="sd">        Return a copy of the selected data array as a masked array.</span>
<span class="sd">        This is functionally identical to :func:`copy_to_array`,</span>
<span class="sd">        except the output format is a `numpy.ma.MaskedArray`_.  The</span>
<span class="sd">        pixels that are considered to be masked can be specified using</span>
<span class="sd">        `flag`.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            ext (str) : (**Optional**) Name of the extension from which</span>
<span class="sd">                to draw the data.  Must be allowed for the current</span>
<span class="sd">                :attr:`mode`; see :attr:`data_arrays`.  Default is</span>
<span class="sd">                `&#39;FLUX&#39;`.</span>
<span class="sd">            flag (str or list): (**Optional**) (List of) Flag names that</span>
<span class="sd">                are considered when deciding if a pixel should be</span>
<span class="sd">                masked.  The names *must* be a valid bit name as defined</span>
<span class="sd">                by :attr:`bitmask`.  If not provided, *ANY* non-zero</span>
<span class="sd">                mask bit is omitted.</span>
<span class="sd">            waverange (array-like) : (**Optional**) Two-element array</span>
<span class="sd">                with the first and last wavelength to include in the</span>
<span class="sd">                computation.  Default is to use the full wavelength</span>
<span class="sd">                range.</span>
<span class="sd">            include_missing (bool) : (**Optional**) Create an array with</span>
<span class="sd">                a size that accommodates the missing models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: A 2D array with a copy of the data from the</span>
<span class="sd">            selected extension.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">copy_to_masked_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span> <span class="n">mask_ext</span><span class="o">=</span><span class="s1">&#39;MASK&#39;</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">,</span>
                                                <span class="n">bitmask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="p">,</span>
                                                <span class="n">allowed_ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_arrays</span><span class="p">,</span>
                                                <span class="n">waverange</span><span class="o">=</span><span class="n">waverange</span><span class="p">,</span>
                                    <span class="n">missing_bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_models</span> <span class="k">if</span> <span class="n">include_missing</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                                <span class="n">nbins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nmodels</span><span class="p">,</span>
                                        <span class="n">unique_bins</span><span class="o">=</span><span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">unique_bins</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">))</span></div>


<div class="viewcode-block" id="StellarContinuumModel.construct_models"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.construct_models">[docs]</a>    <span class="k">def</span> <span class="nf">construct_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replacement_templates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">redshift_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">deredshift</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">corrected_dispersion</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reconstruct the best fitting models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitclass&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No class object available for constructing the model!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitclass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">construct_models</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Provided fit class object has no callable &#39;</span> \
                                 <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">construct_models</span><span class="se">\&#39;</span><span class="s1"> attribute!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">replacement_templates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">replacement_templates</span><span class="p">,</span> <span class="n">TemplateLibrary</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Provided template replacements must have type TemplateLibrary.&#39;</span><span class="p">)</span>

        <span class="c1"># Only the selected models are constructed, others are masked</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">],</span>
                                            <span class="n">flag</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NO_FIT&#39;</span><span class="p">,</span> <span class="s1">&#39;FIT_FAILED&#39;</span><span class="p">,</span> <span class="s1">&#39;INSUFFICIENT_DATA&#39;</span><span class="p">]))</span>
        <span class="n">templates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;template_library&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">replacement_templates</span> <span class="ow">is</span> <span class="kc">None</span> \
                                            <span class="k">else</span> <span class="n">replacement_templates</span>

        <span class="c1"># The only reason it needs the flux data is to get the shape, so</span>
        <span class="c1"># it doesn&#39;t matter that I&#39;m passing the model flux</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitclass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">construct_models</span><span class="p">(</span><span class="n">templates</span><span class="p">[</span><span class="s1">&#39;WAVE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                        <span class="n">templates</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;WAVE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;FLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">,</span>
                                                        <span class="n">redshift_only</span><span class="o">=</span><span class="n">redshift_only</span><span class="p">,</span>
                                                        <span class="n">deredshift</span><span class="o">=</span><span class="n">deredshift</span><span class="p">,</span>
                                                        <span class="n">corrected_dispersion</span><span class="o">=</span><span class="n">corrected_dispersion</span><span class="p">,</span>
                                                        <span class="n">dvtol</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">)</span></div>


<div class="viewcode-block" id="StellarContinuumModel.reset_continuum_mask_window"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.reset_continuum_mask_window">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">reset_continuum_mask_window</span><span class="p">(</span><span class="n">continuum</span><span class="p">,</span> <span class="n">dispaxis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset the mask of the stellar continuum to a continuous window</span>
<span class="sd">        from the minimum to maximum valid wavelength.</span>

<span class="sd">        .. todo::</span>
<span class="sd">            - Allow continuum to be n-dimensional and use</span>
<span class="sd">              `numpy.apply_along_axis`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">DAPFitsUtil</span><span class="o">.</span><span class="n">get_spatial_shape</span><span class="p">(</span><span class="n">continuum</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dispaxis</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input array should be two-dimensional!&#39;</span><span class="p">)</span>

        <span class="c1"># No pixels are masked!</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">continuum</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">continuum</span>

        <span class="n">_continuum</span> <span class="o">=</span> <span class="n">continuum</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">dispaxis</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">continuum</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

        <span class="n">nspec</span><span class="p">,</span><span class="n">npix</span> <span class="o">=</span> <span class="n">_continuum</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">pix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="p">]</span><span class="o">*</span><span class="n">nspec</span><span class="p">),</span>
                                   <span class="n">mask</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">_continuum</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="n">min_good_pix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dispaxis</span><span class="p">)</span>
        <span class="n">max_good_pix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dispaxis</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_continuum</span><span class="p">,</span> <span class="n">min_good_pix</span><span class="p">,</span><span class="n">max_good_pix</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedConstant</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedConstant</span><span class="p">):</span>
<span class="c1">#                if not quiet:</span>
<span class="c1">#                    warnings.warn(&#39;Full continuum fit is masked.&#39;)</span>
                <span class="k">continue</span>
            <span class="n">c</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">_continuum</span> <span class="k">if</span> <span class="n">dispaxis</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">_continuum</span><span class="o">.</span><span class="n">T</span></div>


<div class="viewcode-block" id="StellarContinuumModel.unmasked_continuum_model"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.unmasked_continuum_model">[docs]</a>    <span class="k">def</span> <span class="nf">unmasked_continuum_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replacement_templates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">redshift_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">deredshift</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">corrected_dispersion</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the stellar continuum unmasked over the full continuous</span>
<span class="sd">        fitting region.  Models are reconstructed based on the model</span>
<span class="sd">        parameters if new template fluxes are provided or if the</span>
<span class="sd">        returned models should not include the LOSVD convolution</span>
<span class="sd">        (redshift_only=True).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the models for the binned spectra</span>
        <span class="n">reconstruct</span> <span class="o">=</span> <span class="n">replacement_templates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">redshift_only</span> <span class="ow">or</span> <span class="n">corrected_dispersion</span>
        <span class="n">continuum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_models</span><span class="p">(</span><span class="n">replacement_templates</span><span class="o">=</span><span class="n">replacement_templates</span><span class="p">,</span>
                                          <span class="n">redshift_only</span><span class="o">=</span><span class="n">redshift_only</span><span class="p">,</span> <span class="n">deredshift</span><span class="o">=</span><span class="n">deredshift</span><span class="p">,</span>
                                          <span class="n">corrected_dispersion</span><span class="o">=</span><span class="n">corrected_dispersion</span><span class="p">)</span> \
                        <span class="k">if</span> <span class="n">reconstruct</span> \
                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_to_masked_array</span><span class="p">(</span><span class="n">flag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">all_spectrum_flags</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">StellarContinuumModel</span><span class="o">.</span><span class="n">reset_continuum_mask_window</span><span class="p">(</span><span class="n">continuum</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span></div>


<span class="c1">#    def fill_to_match(self, binned_spectra, replacement_templates=None, redshift_only=False):</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        Get the stellar continuum that matches the shape of the provided binned_spectra.</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        if binned_spectra is self.binned_spectra:</span>
<span class="c1">#            continuum = self.unmasked_continuum_model(replacement_templates=replacement_templates,</span>
<span class="c1">#                                                        redshift_only=redshift_only)</span>
<span class="c1">#</span>
<span class="c1">#            # Number of models matches the numbers of bins</span>
<span class="c1">#            if binned_spectra.nbins == self.nmodels:</span>
<span class="c1">#                return continuum</span>
<span class="c1">#    </span>
<span class="c1">#            # Fill in bins with no models with masked zeros</span>
<span class="c1">#            _continuum = numpy.ma.zeros(binned_spectra[&#39;FLUX&#39;].data.shape, dtype=float)</span>
<span class="c1">#            _continuum[:,:] = numpy.ma.masked</span>
<span class="c1">#            for i,j in enumerate(self.hdu[&#39;PAR&#39;].data[&#39;BINID_INDEX&#39;]):</span>
<span class="c1">#                _continuum[j,:] = continuum[i,:]</span>
<span class="c1">#            return _continuum</span>
<span class="c1">#</span>
<span class="c1">#        raise NotImplementedError(&#39;Can only match to internal binned_spectra.&#39;)</span>

<div class="viewcode-block" id="StellarContinuumModel.fill_to_match"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.fill_to_match">[docs]</a>    <span class="k">def</span> <span class="nf">fill_to_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binid</span><span class="p">,</span> <span class="n">replacement_templates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">redshift_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">deredshift</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">corrected_dispersion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the stellar-continuum model from this objects that matches</span>
<span class="sd">        the input bin ID matrix.  The output is a 2D matrix ordered by</span>
<span class="sd">        the bin ID; any skipped index numbers in the maximum of the</span>
<span class="sd">        union of the unique numbers in the `binid` and `missing` input</span>
<span class="sd">        are masked.</span>

<span class="sd">        All this does is find the stellar continuum from spaxels in this</span>
<span class="sd">        model and match them to the input spaxels.  Depending on how</span>
<span class="sd">        differently the data data sets have been binned, this says</span>
<span class="sd">        nothing about whether or not the returned models are a good fit</span>
<span class="sd">        to the data!</span>

<span class="sd">        replacement_templates only works if the number of templates is</span>
<span class="sd">        the same as those used during the actual fitting process.</span>

<span class="sd">        use redshift_only if you want to exclude the best-fitting</span>
<span class="sd">        dispersion from the model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The input bin id array must have the same shape as self</span>
        <span class="k">if</span> <span class="n">binid</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input bin ID matrix has incorrect shape.&#39;</span><span class="p">)</span>

        <span class="c1"># Construct the best-fitting models</span>
        <span class="n">best_fit_continuum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unmasked_continuum_model</span><span class="p">(</span>
                                    <span class="n">replacement_templates</span><span class="o">=</span><span class="n">replacement_templates</span><span class="p">,</span>
                                    <span class="n">redshift_only</span><span class="o">=</span><span class="n">redshift_only</span><span class="p">,</span> <span class="n">deredshift</span><span class="o">=</span><span class="n">deredshift</span><span class="p">,</span>
                                    <span class="n">corrected_dispersion</span><span class="o">=</span><span class="n">corrected_dispersion</span><span class="p">)</span>

        <span class="c1"># Get the number of output continuua</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">binid</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">missing</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                    <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binid</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">missing</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>

        <span class="c1"># Map the BINID to the spectrum index, assuming bins are sorted</span>
        <span class="c1"># and that the BINID map has -1 BINID values</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">indx</span><span class="p">,</span> <span class="n">reconstruct</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">u_bin_indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">_bin_indx</span> <span class="o">=</span> <span class="n">u_bin_indx</span><span class="p">[</span><span class="n">reconstruct</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>

        <span class="c1"># Fill in bins with no models with masked zeros</span>
        <span class="n">continuum</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbins</span><span class="p">,</span><span class="n">best_fit_continuum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">continuum</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">binid</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">_bin_indx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">continuum</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">best_fit_continuum</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span>

        <span class="k">return</span> <span class="n">continuum</span></div>


<div class="viewcode-block" id="StellarContinuumModel.matched_kinematics"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.matched_kinematics">[docs]</a>    <span class="k">def</span> <span class="nf">matched_kinematics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binid</span><span class="p">,</span> <span class="n">redshift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dispersion</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">corrected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_dispersion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nearest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the guess redshift and velocity dispersion for all the</span>
<span class="sd">        spectra based on the stellar kinematics.</span>

<span class="sd">        For spectra the were not fit, use the median (unmasked)</span>
<span class="sd">        kinematic measurement if no default value is provided as an</span>
<span class="sd">        argument.</span>

<span class="sd">        Args:</span>
<span class="sd">            binid (numpy.ndarray): 2D array with the bin ID associate</span>
<span class="sd">                with each spaxel in the datacube.  Shape must be the</span>
<span class="sd">                same as :attr:`spatial_shape`.</span>
<span class="sd">            redshift (float): (**Optional**) The default redshift to use</span>
<span class="sd">                for spectra without a stellar-continuum fit.  Default is</span>
<span class="sd">                to use the median of the unmasked measurements</span>
<span class="sd">            dispersion (float): (**Optional**) The default velocity</span>
<span class="sd">                dispersion to use for spectra without a</span>
<span class="sd">                stellar-continuum fit.  Default is 100 km/s.</span>
<span class="sd">            constant (bool): (**Optional**) Force the function to return</span>
<span class="sd">                a constant redshift and dispersion for each spectrum,</span>
<span class="sd">                regardless of any fitted kinematics.</span>
<span class="sd">            cz (bool): (**Optional**) Return the redshift as cz in km/s,</span>
<span class="sd">                as opposed to unitless z.</span>
<span class="sd">            corrected (bool): (**Optional**) By default, the returned</span>
<span class="sd">                velocity dispersions are the measured values, which will</span>
<span class="sd">                include any resolution difference between the templates</span>
<span class="sd">                and the galaxy data.  Setting corrected to True will</span>
<span class="sd">                return the corrected dispersions.</span>
<span class="sd">            min_dispersion (float): (**Optional**) Impose a minimum</span>
<span class="sd">                dispersion.</span>
<span class="sd">            nearest (bool): (**Optional**) Instead of the median of the</span>
<span class="sd">                results for the spectra that were not fit, use the value</span>
<span class="sd">                from the nearest bin.</span>
<span class="sd">            missing (list): (**Optional**) Any bin ID numbers missing</span>
<span class="sd">                from the input `binid` image needed for constructing the</span>
<span class="sd">                output matched data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: Returns (unmasked!) arrays with a redshift</span>
<span class="sd">            (or cz) and dispersion for each binned spectrum.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: Raised if the input redshift or dispersion values</span>
<span class="sd">                are not single numbers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check input</span>
        <span class="k">if</span> <span class="n">redshift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">redshift</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Redshift must be a single number or None.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dispersion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dispersion</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Dispersion must be a single number or None.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">binid</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input bin ID map must match the spatial shape of the DRP cube.&#39;</span><span class="p">)</span>

        <span class="c1"># Get the number of output kinematics</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">binid</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">missing</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
                    <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binid</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">missing</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>

        <span class="c1"># Mask bad values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitmask</span><span class="o">.</span><span class="n">flagged</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;MASK&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                    <span class="p">[</span> <span class="s1">&#39;NO_FIT&#39;</span><span class="p">,</span> <span class="s1">&#39;FIT_FAILED&#39;</span><span class="p">,</span> <span class="s1">&#39;INSUFFICIENT_DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;NEAR_BOUND&#39;</span> <span class="p">])</span>

        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="c1"># Everything is masked so use input guesses</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;All stellar continuum fits have been masked!  Using input guesses.&#39;</span><span class="p">)</span>
            <span class="n">str_z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;guess_redshift&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">str_d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;guess_dispersion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="c1"># Select one per *stellar-continuum model*</span>
            <span class="n">str_z</span> <span class="o">=</span> <span class="n">str_z</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;BINID_INDEX&#39;</span><span class="p">]]</span>
            <span class="n">str_d</span> <span class="o">=</span> <span class="n">str_d</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;BINID_INDEX&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Pull out the data</span>
            <span class="n">str_z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;KIN&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span> \
                            <span class="o">/</span> <span class="n">astropy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">str_d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;KIN&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

            <span class="c1"># Apply the sigma corrections if requested.  Values with the</span>
            <span class="c1"># correction larger than the measured value will be masked!</span>
            <span class="k">if</span> <span class="n">corrected</span><span class="p">:</span>
                <span class="n">sigma_corr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SIGMACORR_EMP&#39;</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
                <span class="n">str_d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">str_d</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sigma_corr</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># Set the default values to use when necessary</span>
        <span class="n">_redshift</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">str_z</span><span class="p">)</span> <span class="k">if</span> <span class="n">redshift</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">redshift</span>
        <span class="n">_dispersion</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">str_d</span><span class="p">)</span> <span class="k">if</span> <span class="n">dispersion</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dispersion</span>
        <span class="k">if</span> <span class="n">min_dispersion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">_dispersion</span> <span class="o">&lt;</span> <span class="n">min_dispersion</span><span class="p">:</span>
            <span class="n">_dispersion</span> <span class="o">=</span> <span class="n">min_dispersion</span>

        <span class="c1"># Just return the single value</span>
        <span class="k">if</span> <span class="n">constant</span><span class="p">:</span>
            <span class="n">str_z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nbins</span><span class="p">,</span> <span class="n">_redshift</span> <span class="o">*</span> <span class="n">astropy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                                        <span class="k">if</span> <span class="n">cz</span> <span class="k">else</span> <span class="n">_redshift</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">str_d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nbins</span><span class="p">,</span> <span class="n">_dispersion</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">str_z</span><span class="p">,</span> <span class="n">str_d</span>

        <span class="c1"># Fill masked values with the nearest datum</span>
        <span class="k">if</span> <span class="n">nearest</span><span class="p">:</span>
            <span class="c1"># Fill masked values with the nearest datum</span>
            <span class="n">best_fit_kinematics</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">str_z</span><span class="p">],</span> <span class="p">[</span><span class="n">str_d</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">valid_bins</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">coo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">[</span><span class="s1">&#39;BINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SKY_COO&#39;</span><span class="p">][</span><span class="n">valid_bins</span><span class="p">,:]</span>
            <span class="n">replace</span> <span class="o">=</span> <span class="n">str_z</span><span class="o">.</span><span class="n">mask</span> <span class="o">|</span> <span class="n">str_d</span><span class="o">.</span><span class="n">mask</span>
            <span class="n">kinematics</span> <span class="o">=</span> <span class="n">replace_with_data_from_nearest_coo</span><span class="p">(</span><span class="n">coo</span><span class="p">,</span> <span class="n">best_fit_kinematics</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span>
            <span class="n">str_z</span> <span class="o">=</span> <span class="n">kinematics</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">str_d</span> <span class="o">=</span> <span class="n">kinematics</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fill any masked values with the single estimate</span>
            <span class="n">str_z</span> <span class="o">=</span> <span class="n">str_z</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">_redshift</span><span class="p">)</span>
            <span class="n">str_d</span> <span class="o">=</span> <span class="n">str_d</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">_dispersion</span><span class="p">)</span>

        <span class="c1"># Map the BINID to the spectrum index, assuming bins are sorted</span>
        <span class="c1"># and that the BINID map has -1 BINID values</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">indx</span><span class="p">,</span> <span class="n">reconstruct</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BINID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">u_bin_indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">_bin_indx</span> <span class="o">=</span> <span class="n">u_bin_indx</span><span class="p">[</span><span class="n">reconstruct</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>

        <span class="c1"># Match the kinematics to the output bin ID map</span>
        <span class="n">_str_z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">(</span><span class="n">nbins</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">_str_d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">(</span><span class="n">nbins</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">binid</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">_bin_indx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">_str_z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">_str_d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="n">str_z</span> <span class="o">=</span> <span class="n">_str_z</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">_redshift</span><span class="p">)</span>
        <span class="n">str_d</span> <span class="o">=</span> <span class="n">_str_d</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">_dispersion</span><span class="p">)</span>
        <span class="c1"># Convert to cz velocities (km/s)</span>
        <span class="k">if</span> <span class="n">cz</span><span class="p">:</span>
            <span class="n">str_z</span> <span class="o">*=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">str_z</span><span class="p">,</span> <span class="n">str_d</span></div>


<div class="viewcode-block" id="StellarContinuumModel.matched_template_flags"><a class="viewcode-back" href="../../../mangadap.proc.stellarcontinuummodel.html#mangadap.proc.stellarcontinuummodel.StellarContinuumModel.matched_template_flags">[docs]</a>    <span class="k">def</span> <span class="nf">matched_template_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binned_spectra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: Function out of date!</span>

<span class="sd">        Return the templates used during the fit to each spectrum,</span>
<span class="sd">        matched to the spectra in the binned_spectra object.  For</span>
<span class="sd">        spectra with no models, the flags are all set to true.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">binned_spectra</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_spectra</span><span class="p">:</span>
            <span class="n">usetpl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;TPLWGT&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>

            <span class="c1"># Number of models matches the numbers of bins</span>
            <span class="k">if</span> <span class="n">binned_spectra</span><span class="o">.</span><span class="n">nbins</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmodels</span><span class="p">:</span>
<span class="c1">#                print(&#39;returning usetpl&#39;)</span>
                <span class="k">return</span> <span class="n">usetpl</span>
    
            <span class="c1"># Fill in bins with no models with masked zeros</span>
<span class="c1">#            print(&#39;Fill in bins with no models with masked zeros&#39;)</span>
            <span class="n">ntpl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">[</span><span class="s1">&#39;fitpar&#39;</span><span class="p">][</span><span class="s1">&#39;template_library&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ntpl</span>
            <span class="n">_usetpl</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">binned_spectra</span><span class="o">.</span><span class="n">nbins</span><span class="p">,</span><span class="n">ntpl</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="s1">&#39;PAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;BINID_INDEX&#39;</span><span class="p">]):</span>
                <span class="n">_usetpl</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">usetpl</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="k">return</span> <span class="n">_usetpl</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Can only match to internal binned_spectra.&#39;</span><span class="p">)</span></div></div>


</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, SDSS-IV/MaNGA Pipeline Group.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'2.2.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>