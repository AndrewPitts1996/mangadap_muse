
.. |ang|   unicode:: U+212B

.. include:: include/links.rst

.. _emissionlines:

Emission-Line Measurements
==========================

Emission-Line Parameters
------------------------

The table below provides a compilation of emission-line parameters
gathered through the development of the DAP. Many of them have not
actually been fit by the DAP in any survey-level runs of the software
and are simply collected here for reference.

Rest wavelengths are `Ritz wavelengths
<https://physics.nist.gov/PhysRefData/ASD/Html/lineshelp.html#RITZ>`_ in
**vacuum**, collected from the `NIST Atomic Spectra Database
<https://physics.nist.gov/PhysRefData/ASD/lines_form.html>`_.

The "M1" and "E2" values are the Einstein :math:`A_{ki}` coefficients
for the magnetic dipole and electric quadrupole transitions,
respectively.  These are collected to fix the expected flux ratio
between specific line doublets.  The expected flux ratio is:

.. math::

    f_1 / f_2 = \lambda_2/\lambda_1\ \cdot\ (M1_1+E2_1)/(M1_2+E2_2)

where, e.g., :math:`\lambda_1` is the rest wavelength of the first line
in the doublet.

Additionally, we have defined some nominal passbands used for
calculations of the line equivalent width (EW), including the main
passband centered on the line and blue and red sidebands that are used
to construct a linear continuum beneath the emission line.

+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| Name                    |  Rest :math:`\lambda` (|ang|) |      M1 |      E2 | EW Passband (|ang|) |  Blue Passband (|ang|) | Red Passband (|ang|) |
+=========================+===============================+=========+=========+=====================+========================+======================+
| HeII                    |                     3204.038  |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NeV                     |                     3346.783  |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NeV                     |                     3426.863  |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H25                     |                     3670.5154 |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H24                     |                     3672.5279 |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H23                     |                     3674.8109 |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H22                     |                     3677.4160 |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H21                     |                     3680.4065 |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H20                     |                     3683.8627 |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H19                     |                     3687.8870 |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H18                     |                     3692.6119 |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H17                     |                     3698.2104 |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H16                     |                     3704.9133 |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H15                     |                     3713.0334 |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H14                     |                     3723.0035 |         |         |                [1]_ |       3706.3 -- 3716.3 |     3738.6 -- 3748.6 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OII                     |                     3727.092  |         |         |    3716.3 -- 3738.3 |       3706.3 -- 3716.3 |     3738.6 -- 3748.6 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OII                     |                     3729.875  |         |         |                [1]_ |       3706.3 -- 3716.3 |     3738.6 -- 3748.6 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H13                     |                     3735.4365 |         |         |                [1]_ |       3706.3 -- 3716.3 |     3738.6 -- 3748.6 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H12                     |                     3751.2243 |         |         |    3746.2 -- 3756.2 |       3738.6 -- 3748.6 |     3756.6 -- 3766.6 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H11                     |                     3771.7080 |         |         |    3761.7 -- 3781.7 |       3756.6 -- 3766.6 |     3779.1 -- 3789.1 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\theta`   |                     3798.9826 |         |         |    3789.0 -- 3809.0 |       3776.5 -- 3791.5 |     3806.5 -- 3821.5 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\eta`     |                     3836.4790 |         |         |    3826.5 -- 3846.5 |       3806.5 -- 3826.5 |     3900.2 -- 3920.2 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NeIII                   |                     3869.86   | 1.74e-1 |         |    3859.9 -- 3879.9 |       3806.5 -- 3826.5 |     3900.2 -- 3920.2 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                     |                     3889.749  |         |         |                [1]_ |       3806.5 -- 3826.5 |     3900.2 -- 3920.2 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\zeta`    |                     3890.1576 |         |         |    3880.2 -- 3900.2 |       3806.5 -- 3826.5 |     3900.2 -- 3920.2 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NeIII                   |                     3968.59   | 5.40e-2 |         |                [1]_ |       3938.6 -- 3958.6 |     3978.6 -- 3998.6 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\epsilon` |                     3971.2020 |         |         |    3961.2 -- 3981.2 |       3941.2 -- 3961.2 |     3981.2 -- 4001.2 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                     |                     4027.3238 |         |         |    4017.3 -- 4037.3 |       3997.3 -- 4017.3 |     4037.3 -- 4057.3 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SII                     |                     4069.749  |         |         |    4062.7 -- 4073.6 |       4049.7 -- 4062.7 |     4082.0 -- 4092.9 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SII                     |                     4077.500  |         |         |    4073.6 -- 4084.5 |       4049.7 -- 4062.7 |     4082.0 -- 4092.9 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\delta`   |                     4102.8991 |         |         |    4092.9 -- 4112.9 |       4082.0 -- 4092.9 |     4112.9 -- 4132.9 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\gamma`   |                     4341.691  |         |         |    4331.7 -- 4351.7 |       4311.7 -- 4331.7 |     4349.7 -- 4358.7 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OIII                    |                     4364.435  |         |         |    4358.7 -- 4374.4 |       4349.7 -- 4358.7 |     4374.4 -- 4384.4 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                     |                     4472.729  |         |         |    4462.7 -- 4482.7 |       4442.7 -- 4462.7 |     4482.7 -- 4502.7 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeII                    |                     4687.015  |         |         |    4677.0 -- 4697.0 |       4667.0 -- 4677.0 |     4697.0 -- 4707.0 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIV                    |                     4712.58   |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                     |                     4714.4578 |         |         |    4707.0 -- 4722.0 |       4697.0 -- 4707.0 |     4722.0 -- 4732.0 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIV                    |                     4741.45   |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\beta`    |                     4862.691  |         |         |    4852.7 -- 4872.7 |       4798.9 -- 4838.9 |     4885.6 -- 4925.6 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                     |                     4923.3051 |         |         |    4913.3 -- 4933.3 |       4898.3 -- 4913.3 |     4933.3 -- 4948.3 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OIII                    |                     4960.295  | 6.21e-3 | 4.57e-6 |    4950.3 -- 4970.3 |       4930.3 -- 4950.3 |     4970.3 -- 4990.3 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OIII                    |                     5008.240  | 1.81e-2 | 3.52e-5 |    4998.2 -- 5018.2 |       4978.2 -- 4998.2 |     5028.2 -- 5048.2 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                     |                     5017.0769 |         |         |                [1]_ |       4988.2 -- 4983.2 |     5028.2 -- 5048.2 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NI                      |                     5199.3490 |         |         |    5189.3 -- 5209.3 |       5169.4 -- 5189.3 |     5211.7 -- 5231.7 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NI                      |                     5201.7055 |         |         |                [1]_ |       5169.4 -- 5189.4 |     5211.7 -- 5231.7 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NII                     |                     5756.19   |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                     |                     5877.243  |         |         |    5867.2 -- 5887.2 |       5847.2 -- 5867.2 |     5887.2 -- 5907.2 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NaI                     |                     5891.583  |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NaI                     |                     5897.558  |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OI                      |                     6302.046  | 5.63e-3 | 2.11e-5 |    6292.0 -- 6312.0 |       6272.0 -- 6292.0 |     6312.0 -- 6332.0 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OI                      |                     6365.535  | 1.82e-3 | 3.39e-6 |    6355.5 -- 6375.5 |       6335.5 -- 6355.5 |     6375.5 -- 6395.5 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NII                     |                     6549.86   | 9.84e-4 | 9.22e-7 |    6542.9 -- 6556.9 |       6483.0 -- 6513.0 |     6623.0 -- 6653.0 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\alpha`   |                     6564.632  |         |         |    6557.6 -- 6571.6 |       6483.0 -- 6513.0 |     6623.0 -- 6653.0 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NII                     |                     6585.271  | 2.91e-3 | 8.65e-6 |    6575.3 -- 6595.3 |       6483.0 -- 6513.0 |     6623.0 -- 6653.0 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                     |                     6679.9956 |         |         |    6670.0 -- 6690.0 |       6652.0 -- 6670.0 |     6690.0 -- 6708.0 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SII                     |                     6718.294  |         |         |    6711.3 -- 6725.3 |       6690.0 -- 6708.0 |     6748.0 -- 6768.0 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SII                     |                     6732.674  |         |         |    6725.7 -- 6739.7 |       6690.0 -- 6708.0 |     6748.0 -- 6768.0 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                     |                     7067.1252 |         |         |    7057.1 -- 7077.1 |       7037.1 -- 7057.1 |     7077.1 -- 7097.1 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIII                   |                     7137.76   | 3.21e-1 |  1.4e-3 |    7127.8 -- 7147.8 |       7107.8 -- 7127.8 |     7147.8 -- 7167.8 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIV                    |                     7172.68   |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIV                    |                     7239.76   |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIV                    |                     7265.33   |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OII                     |                     7321.003  |         | 5.19e-2 |                [1]_ |       7291.0 -- 7311.0 |     7342.8 -- 7362.8 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OII                     |                     7322.01   | 8.37e-3 | 9.07e-2 |    7313.8 -- 7326.8 |       7291.0 -- 7311.0 |     7342.8 -- 7362.8 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OII                     |                     7331.68   | 9.32e-3 | 7.74e-2 |    7326.8 -- 7339.8 |       7291.0 -- 7311.0 |     7342.8 -- 7362.8 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OII                     |                     7332.75   | 1.49e-2 | 3.85e-2 |                [1]_ |       7291.0 -- 7311.0 |     7342.8 -- 7362.8 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIV                    |                     7334.17   |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIII                   |                     7753.24   |  8.3e-2 |  1.3e-4 |    7743.2 -- 7763.2 |       7703.2 -- 7743.2 |     7763.2 -- 7803.2 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P20                     |                     8394.703  |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P19                     |                     8415.630  |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P18                     |                     8440.274  |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P17                     |                     8469.581  |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P16                     |                     8504.819  |         |         |    8494.8 -- 8514.8 |       8474.8 -- 8494.8 |     8514.8 -- 8534.8 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P15                     |                     8547.731  |         |         |    8534.8 -- 8557.7 |       8514.8 -- 8534.8 |     8557.7 -- 8587.7 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P14                     |                     8600.754  |         |         |    8587.7 -- 8610.8 |       8557.7 -- 8587.7 |     8610.8 -- 8650.8 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P13                     |                     8667.398  |         |         |    8657.4 -- 8677.4 |       8617.4 -- 8657.4 |     8677.4 -- 8717.4 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P12                     |                     8752.876  |         |         |    8742.9 -- 8762.9 |       8702.9 -- 8742.9 |     8762.9 -- 8802.9 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm P}\theta`   |                     8865.216  |         |         |    8855.2 -- 8875.2 |       8815.2 -- 8855.2 |     8875.2 -- 8915.2 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SIII                    |                     8831.8    |         |         |                     |                        |                      |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm P}\eta`     |                     9017.384  |         |         |    9007.4 -- 9027.4 |       8977.4 -- 9007.4 |     9027.4 -- 9057.4 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SIII                    |                     9071.1    | 1.85e-2 | 3.94e-5 |    9061.1 -- 9081.1 |       9026.1 -- 9061.1 |     9081.1 -- 9116.1 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm P}\zeta`    |                     9231.546  |         |         |    9221.5 -- 9241.5 |       9181.5 -- 9221.5 |     9241.5 -- 9281.5 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SIII                    |                     9533.2    | 4.78e-2 | 2.09e-4 |    9525.5 -- 9540.9 |       9483.2 -- 9523.2 |     9558.6 -- 9598.6 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm P}\epsilon` |                     9548.588  |         |         |    9540.9 -- 9556.3 |       9483.2 -- 9523.2 |     9558.6 -- 9598.6 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm P}\delta`   |                    10052.123  |         |         |  10042.1 -- 10062.1 |     10002.1 -- 10042.1 |   10062.1 -- 10102.1 |
+-------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+

.. _emissionlines-moments:

Non-parametric Emission-Line Measurements
-----------------------------------------

The DAP performs non-parametric measurements of the emission lines using
a simple moment analysis.  See :mod:`mangadap.proc.emissionlinemoments`
and :ref:`emission-line-moments`.  In survey-level runs of the DAP, we
have typically paired the set of moment measurements and Gaussian
models; however, the number of emission-line moment measurements need
not be matched to the number of emission-line Gaussian models and vice
versa.

Input Data Format
~~~~~~~~~~~~~~~~~

The parameters that define the emission-line moments to calculate are
provided via the
:class:`~mangadap.par.emissionmomentsdb.EmissionMomentsDB` object,
which is built using an `SDSS-style parameter file`_.

The columns of the parameter file are:

+---------------+-----------+-----------------------------------------------------------------------+
| Parameter     | Format    | Description                                                           |
+===============+===========+=======================================================================+
| ``index``     | int       | Unique integer identifier of the emission line.  **Must** be unique.  |
+---------------+-----------+-----------------------------------------------------------------------+
| ``name``      | str       | Name of the transition.                                               |
+---------------+-----------+-----------------------------------------------------------------------+
| ``lambda``    | float     | Rest frame wavelength of the emission line to analyze.                |
+---------------+-----------+-----------------------------------------------------------------------+
| ``waveref``   | str       | The reference frame of the wavelengths; must be either 'air' for air  |
|               |           | or 'vac' for vacuum.                                                  |
+---------------+-----------+-----------------------------------------------------------------------+
| ``primary``   | float[2]  | A two-element vector with the starting and ending wavelength for the  |
|               |           | primary passband surrounding the emission line(s).                    |
+---------------+-----------+-----------------------------------------------------------------------+
| ``blueside``  | float[2]  | A two-element vector with the starting and ending wavelength for a    |
|               |           | passband to the blue of the primary band.                             |
+---------------+-----------+-----------------------------------------------------------------------+
| ``redside``   | float[2]  | A two-element vector with the starting and ending wavelength for a    |
|               |           | passband to the red of the primary band.                              |
+---------------+-----------+-----------------------------------------------------------------------+

and an example file might look like this:

.. code-block:: c

    typedef struct {
        int index;
        char name[6];
        double lambda;
        char waveref[3];
        double primary[2];
        double blueside[2];
        double redside[2];
    } DAPELB;

    DAPELB   2  OIId    3728.4835  vac  { 3716.3  3738.3 } { 3706.3  3716.3 } { 3738.6  3748.6 }
    DAPELB   3  OII     3729.875   vac  {   -1      -1   } {   -1      -1   } {   -1      -1   }

Note in the above example that the second set of parameters define
nonsensical passbands with limits of ``{-1 -1}``. This is used to
signify that the moment parameters are "dummy" or placeholder
parameters. This is used to create an empty channel in the output
``MAPS`` file and is used just to synchronize the channel indices
between the non-parametric and Gaussian-fit results. That is, it's
used to ensure that, e.g., the :math:`{\rm H}\alpha` measurements are
in the same channel for both the ``EMLINE_SFLUX`` and
``EMLINE_GFLUX`` extensions in the :ref:`datamodel-maps`.

Changing the moment parameters
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The moment measurements are performed by
:class:`~mangadap.proc.emissionlinemoments.EmissionLineMoments`; see
:ref:`emission-line-moments`. A set of parameter files that define a
list of emission-line moment sets are provided with the DAP source
distribution and located at
``$MANGADAP_DIR/mangadap/data/emission_bandpass_filters``. There are
a few methods that you can use to change the set of emission-line
parameters used by
:class:`~mangadap.proc.emissionlinemoments.EmissionLineMoments`:

    #. To use one of the existing parameter databases, you can change
       the ``emission_passbands`` keyword in the
       :class:`~mangadap.proc.emissionlinemoments.EmissionLineMoments`
       configuration file. The keyword should be the capitalized root
       of the parameter filename. E.g., to use
       ``$MANGADAP_DIR/mangadap/data/emission_bandpass_filters/elbmpl9.par``,
       set the keyword to ``ELBMPL9``.

    #. To use a *new* parameter database, write the file and save it in
       the ``$MANGADAP_DIR/mangadap/data/emission_bandpass_filters/``
       directory, and then change the relevant configuration file in
       the same way as described above.

.. _emissionlines-modeling:

Gaussian Emission-Line Modeling
-------------------------------

The DAP models the emission lines using single-component Gaussian
functions.  See :mod:`mangadap.proc.emissionlinemoments` and
:ref:`emission-line-modeling`.  In survey-level runs of the DAP, we have
typically paired the set of moment measurements and Gaussian models;
however, the number of emission-line moment measurements need not be
matched to the number of emission-line Gaussian models and vice versa.

.. _emissionlines-model-par-format:

Input Data Format
~~~~~~~~~~~~~~~~~

The parameters that define the emission-line models to fit are provided
via the :class:`~mangadap.par.emissionlinedb.EmissionLineDB` object,
which is built using an `SDSS-style parameter file`_.

The columns of the parameter file are:

+-------------------+-----------+-----------------------------------------------------------------------+
| Parameter         | Format    | Description                                                           |
+===================+===========+=======================================================================+
| ``index``         | int       | Unique integer identifier of the emission line.  **Must** be unique.  |
|                   |           | Specifically used when tying line parameters.                         |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``name``          | str       | Name of the transition.                                               |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``lambda``        | float     | Rest frame wavelength of the emission line to analyze.                |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``waveref``       | str       | The reference frame of the wavelengths; must be either 'air' for air  |
|                   |           | or 'vac' for vacuum.                                                  |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``action``        | str       | A single character setting how the line should be treated.  See       |
|                   |           | :ref:`emission-line-modeling-action`.                                 |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``relative_flux`` | float     | Relative flux of the emission lines.  This should most often be unity |
|                   |           | when the flux is not tied to another line; see                        |
|                   |           | :ref:`emission-line-modeling-mode`.                                   |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``mode``          | str       | Fitting mode for the line.  See :ref:`emission-line-modeling-mode`.   |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``profile``       | str       | The name of the class used to construct the line profile.  The        |
|                   |           | available options are any of the classes in                           |
|                   |           | :mod:`mangadap.util.lineprofiles`.  This functionality will likely be |
|                   |           | deprecated because the lineprofile should essentially always be       |
|                   |           | :class:`~mangadap.util.lineprofiles.FFTGaussianLSF`; selected by      |
|                   |           | setting this parameter to "FFTGaussianLSF".                           |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``ncomp``         | int       | The number of components to fit.  **NOT TYPICALLY USED!**             |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``output_model``  | int       | Flag to include the best-fitting model of the line in the             |
|                   |           | emission-line model spectrum.  **NOT TYPICALLY USED!**                |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``par``           | float[3]  | A list of the initial guess for the line profile parameters.          |
|                   |           | **NOT TYPICALLY USED!** The number of parameters must match the       |
|                   |           | struct declaration at the top of the file.  The initial parameters    |
|                   |           | are automatically adjusted to provide any designated flux ratios, and |
|                   |           | the center is automatically adjusted to the provided redshift for the |
|                   |           | spectrum.  For example, for a GaussianLineProfile, this is typically  |
|                   |           | set to "{1.0 0.0 100.0}".                                             |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``fix``           | int[3]    | A list of flags for fixing the input guess parameters during the fit. |
|                   |           | **NOT TYPICALLY USED!** Use 0 for a free parameter, 1 for a fixed     |
|                   |           | parameter.  The parameter value is only fixed *AFTER* adjusted in the |
|                   |           | flux and or center based on the redshift and the implied tied         |
|                   |           | parameters.  For a free set of parameters using a                     |
|                   |           | GaussianLineProfile, this is set to "{ 0 0 0 }".                      |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``lower_bound``   | str[3]    | A list of lower bounds for the parameters.  **NOT TYPICALLY USED!**   |
|                   |           | For each parameter, use None to indicate no lower bound.  For a       |
|                   |           | GaussianLineProfile with positive flux and standard deviation, this   |
|                   |           | is set to '{ 0.0 None 0.0 }'.                                         |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``upper_bound``   | str[3]    | A list of upper bounds for the parameters.  **NOT TYPICALLY USED!**   |
|                   |           | For each parameter, use None to indicate no upper bound.  For a       |
|                   |           | GaussianLineProfile with maximum standard deviation of 800 km/s, this |
|                   |           | is set to '{ None None 800.0 }'.                                      |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``log_bounded``   | int[3]    | A list of flags used when determining if a fit parameter is near the  |
|                   |           | imposed boundary.  **NOT TYPICALLY USED!** If true, the fraction of   |
|                   |           | the boundary range used is done in logarithmic, not linear,           |
|                   |           | separation.  Use 0 for False, 1 for True.                             |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``blueside``      | float[2]  | A two-element vector with the starting and ending wavelength for a    |
|                   |           | passband to the blue of the primary band.                             |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``redside``       | float[2]  | A two-element vector with the starting and ending wavelength for a    |
|                   |           | passband to the red of the primary band.                              |
+-------------------+-----------+-----------------------------------------------------------------------+

and an example file might look like this:

.. code-block:: c

    typedef struct {
        int index;
        char name[6];
        double lambda;
        char waveref[3];
        char action;
        double relative_flux;
        char mode[6];
        char profile[30];
        int ncomp;
        int output_model;
        double par[3];
        int fix[3];
        char lower_bound[3][10];
        char upper_bound[3][10];
        int log_bounded[3];
        double blueside[2];
        double redside[2];
    } DAPEML;

    DAPEML   2  OII     3727.092   vac  f   1.00  v34  FFTGaussianLSF  1  1  { 1.0 0.0 100.0 }  { 0 0 0 }  {  0.0 None 30.0 }  { None None 400. }  { 0 0 1 }  { 3706.3  3716.3 } { 3738.6  3748.6 }
    DAPEML   3  OII     3729.875   vac  f   1.00   k2  FFTGaussianLSF  1  1  { 1.0 0.0 100.0 }  { 0 0 0 }  {  0.0 None 30.0 }  { None None 400. }  { 0 0 1 }  { 3706.3  3716.3 } { 3738.6  3748.6 }
    DAPEML  33  NII     6549.86    vac  f   0.34  a35  FFTGaussianLSF  1  1  { 1.0 0.0 100.0 }  { 0 0 0 }  {  0.0 None 30.0 }  { None None 400. }  { 0 0 1 }  { 6483.0  6513.0 } { 6623.0  6653.0 }
    DAPEML  34  Ha      6564.632   vac  f   1.00    f  FFTGaussianLSF  1  1  { 1.0 0.0 100.0 }  { 0 0 0 }  {  0.0 None 30.0 }  { None None 400. }  { 0 0 1 }  { 6483.0  6513.0 } { 6623.0  6653.0 }
    DAPEML  35  NII     6585.271   vac  f   1.00  v34  FFTGaussianLSF  1  1  { 1.0 0.0 100.0 }  { 0 0 0 }  {  0.0 None 30.0 }  { None None 400. }  { 0 0 1 }  { 6483.0  6513.0 } { 6623.0  6653.0 }

.. note::

    * Both the emission-line moments database and the emission-line
      modeling database define the sidebands used for the equivalent
      width calculations.  Nominally, these should be the same, but it's
      up to the person that writes the two parameter files to make sure
      that is true.
    * Many of the current parameters in the emission-line modeling
      parameter file are hold-overs from when
      :class:`~mangadap.proc.elric.Elric` was the standard class used
      for the emission-line fitting. Anything marked as "NOT
      TYPICALLY USED" hasn't been adapted for use with the currently
      preferred module, :class:`~mangadap.proc.sasuke.Sasuke`.

.. _emission-line-modeling-action:

Emission-Line "Actions"
+++++++++++++++++++++++

.. include:: include/emissionline-action.rst

.. _emission-line-modeling-mode:

Emission-Line "Modes"
+++++++++++++++++++++

.. include:: include/emissionline-mode.rst

Changing the modeling parameters
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The emission-line modeling is performed by
:class:`~mangadap.proc.emissionlinemodel.EmissionLineModel`; see
:ref:`emission-line-modeling`. A set of files that define a list of
emission-line model parameter sets are provided with the DAP source
distribution and located at
``$MANGADAP_DIR/mangadap/data/emission_lines``. There are a few
methods that you can use to change the set of emission-line
parameters used by
:class:`~mangadap.proc.emissionlinemodel.EmissionLineModel`:

    #. To use one of the existing parameter databases, you can change
       the ``emission_lines`` keyword in the
       :class:`~mangadap.proc.emissionlinemodel.EmissionLineModel`
       configuration file. The keyword should be the capitalized root
       of the parameter filename. E.g., to use
       ``$MANGADAP_DIR/mangadap/data/emission_lines/elpmpl9.par``,
       set the keyword to ``ELPMPL9``.

    #. To use a *new* parameter database, write the file and save it
       in the ``$MANGADAP_DIR/mangadap/data/emission_lines/``
       directory, and then change the relevant configuration file in
       the same way as described above.

----

.. [1] No primary band defined because it overlaps with another line.


