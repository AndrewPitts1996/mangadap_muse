#!/usr/bin/env python3

from __future__ import print_function
from __future__ import division
from __future__ import absolute_import
from __future__ import unicode_literals

import os
import glob
import time
import numpy

from argparse import ArgumentParser

import matplotlib
from matplotlib import pyplot, rc
from matplotlib.ticker import NullFormatter

from astropy.io import fits

from mangadap.dapfits import DAPMapsBitMask
from mangadap.config.defaults import default_dap_method, default_dap_method_path
from mangadap.config.defaults import default_dap_plan_file
from mangadap.par.analysisplan import AnalysisPlanSet
from mangadap.util.fileio import channel_dictionary

#-----------------------------------------------------------------------------

def growth_lim(a, lim, fac, midpoint=None, default=[0., 1.]):
    _a = a.compressed()
    if len(_a) == 0:
        return default
    srt = numpy.ma.argsort(_a)
    start = int(len(_a)*(1.0-lim)/2)
    end = int(len(_a)*(lim + (1.0-lim)/2))
    Da = (_a[srt[end]] - _a[srt[start]])*fac
    mid = (_a[srt[start]] + _a[srt[end]])/2 if midpoint is None else midpoint
#    print(start)
#    print(end)
#    print(Da)
#    print(mid)
    return [ mid - Da/2, mid + Da/2 ]

    
#def column_dictionary(hdu, ext):
#    columndict = {}
#    for k, v in hdu[ext].header.items():
#        if k[0] == 'C':
#            try:
#                i = int(k[1:])-1
#            except ValueError:
#                continue
#            columndict[v] = i
#    return columndict


def init_ax(fig, pos):
    ax = fig.add_axes(pos, axisbg='0.9')
    ax.minorticks_on()
    ax.grid(True, which='major', color='0.8', zorder=0, linestyle='-')
#    ax.grid(True, which='minor', color='0.7', zorder=0, linestyle=':')
    return ax


# Test images:
#  - SPX_MFLUX, SPX_SNR, BINID, BIN_SNR
#  - STELLAR_CONT_FRESID, STELLAR_CONT_CHI2, STELLAR_VEL, STELLAR_SIGMA
#  - EMLINE_SFLUX, EMLINE_GFLUX, EMLINE_GVEL, EMLINE_GSIGMA - all H-alpha
#  - EMLINE_SFLUX (H-beta), EMLINE_GFLUX (H-beta), D4000, Dn4000
def spotcheck_images(analysis_path, daptype, plate, ifudesign, ofile=None, drpver=None,
                     dapver=None):

    bm = DAPMapsBitMask()

    plan_dir = default_dap_method_path(daptype, plate=plate, ifudesign=ifudesign, drpver=drpver,
                                       dapver=dapver, analysis_path=analysis_path)
    ifile = os.path.join(plan_dir, 'manga-{0}-{1}-MAPS-{2}.fits.gz'.format(plate, ifudesign,
                                                                           daptype))
    if not os.path.isfile(ifile):
        raise FileNotFoundError('No file: {0}'.format(ifile))

    print('Reading: {0}'.format(ifile))
    hdu = fits.open(ifile)

    # Check everything is finite
    num_ext = len(hdu)
    for i in range(num_ext):
        if hdu[i].data is None:
            continue
        if not numpy.all(numpy.isfinite(hdu[i].data)):
            raise ValueError('HDU {0} contains infs or NaNs!'.format(hdu[i].name))

    # Build the column dictionaries
    emline = channel_dictionary(hdu, 'EMLINE_GFLUX')
    specindex = channel_dictionary(hdu, 'SPECINDEX')

    # Get the data to plot
    spxflx = numpy.ma.MaskedArray(hdu['SPX_MFLUX'].data.copy())
    extent = [0.5, spxflx.shape[0]+0.5, 0.5, spxflx.shape[1]+0.5 ]
    spxsnr = numpy.ma.MaskedArray(hdu['SPX_SNR'].data.copy())
    binid = numpy.ma.MaskedArray(hdu['BINID'].data.copy(), mask=hdu['BINID'].data<0)
    binsnr = numpy.ma.MaskedArray(hdu['BIN_SNR'].data.copy(), mask=hdu['BIN_MFLUX_MASK'].data>0)

    scfres = numpy.ma.MaskedArray(hdu['STELLAR_CONT_FRESID'].data.copy()[0,:,:],
                                  mask=~(hdu['STELLAR_CONT_FRESID'].data[0,:,:] > 0))
                                  #bm.flagged(hdu['STELLAR_VEL_MASK'].data, 'DONOTUSE'))
    scrchi = numpy.ma.MaskedArray(hdu['STELLAR_CONT_RCHI2'].data.copy(),
                                  mask=~(hdu['STELLAR_CONT_RCHI2'].data > 0))
                                  #mask=bm.flagged(hdu['STELLAR_VEL_MASK'].data, 'DONOTUSE'))
    strvel = numpy.ma.MaskedArray(hdu['STELLAR_VEL'].data.copy(),
                                  mask=bm.flagged(hdu['STELLAR_VEL_MASK'].data, 'DONOTUSE'))
    ustrvel = numpy.ma.MaskedArray(hdu['STELLAR_VEL'].data.copy(),
                                  mask=~bm.flagged(hdu['STELLAR_VEL_MASK'].data, 'UNRELIABLE'))
    ustrvel[~numpy.ma.getmaskarray(ustrvel)] = 0.0
    strsig = numpy.ma.MaskedArray(hdu['STELLAR_SIGMA'].data.copy(),
                                  mask=bm.flagged(hdu['STELLAR_SIGMA_MASK'].data, 'DONOTUSE'))
    ustrsig = numpy.ma.MaskedArray(hdu['STELLAR_SIGMA'].data.copy(),
                                  mask=~bm.flagged(hdu['STELLAR_SIGMA_MASK'].data,
                                                   'UNRELIABLE'))
    ustrsig[~numpy.ma.getmaskarray(ustrsig)] = 0.0

    hasflx = numpy.ma.MaskedArray(hdu['EMLINE_SFLUX'].data.copy()[emline['Ha-6564'],:,:],
            mask=bm.flagged(hdu['EMLINE_SFLUX_MASK'].data[emline['Ha-6564'],:,:], 'DONOTUSE'))
    uhasflx = numpy.ma.MaskedArray(hdu['EMLINE_SFLUX'].data.copy()[emline['Ha-6564'],:,:],
          mask=~bm.flagged(hdu['EMLINE_SFLUX_MASK'].data[emline['Ha-6564'],:,:], 'UNRELIABLE'))
    uhasflx[~numpy.ma.getmaskarray(uhasflx)] = 0.0
    hagflx = numpy.ma.MaskedArray(hdu['EMLINE_GFLUX'].data.copy()[emline['Ha-6564'],:,:],
          mask=bm.flagged(hdu['EMLINE_GFLUX_MASK'].data[emline['Ha-6564'],:,:], 'DONOTUSE'))
    uhagflx = numpy.ma.MaskedArray(hdu['EMLINE_GFLUX'].data.copy()[emline['Ha-6564'],:,:],
          mask=~bm.flagged(hdu['EMLINE_GFLUX_MASK'].data[emline['Ha-6564'],:,:], 'UNRELIABLE'))
    uhagflx[~numpy.ma.getmaskarray(uhagflx)] = 0.0
    hagvel = numpy.ma.MaskedArray(hdu['EMLINE_GVEL'].data.copy()[emline['Ha-6564'],:,:],
          mask=bm.flagged(hdu['EMLINE_GVEL_MASK'].data[emline['Ha-6564'],:,:], 'DONOTUSE'))
    uhagvel = numpy.ma.MaskedArray(hdu['EMLINE_GVEL'].data.copy()[emline['Ha-6564'],:,:],
          mask=~bm.flagged(hdu['EMLINE_GVEL_MASK'].data[emline['Ha-6564'],:,:], 'UNRELIABLE'))
    uhagvel[~numpy.ma.getmaskarray(uhagvel)] = 0.0
    hagsig = numpy.ma.MaskedArray(hdu['EMLINE_GSIGMA'].data.copy()[emline['Ha-6564'],:,:],
        mask=bm.flagged(hdu['EMLINE_GSIGMA_MASK'].data[emline['Ha-6564'],:,:], 'DONOTUSE'))
    uhagsig = numpy.ma.MaskedArray(hdu['EMLINE_GSIGMA'].data.copy()[emline['Ha-6564'],:,:],
        mask=~bm.flagged(hdu['EMLINE_GSIGMA_MASK'].data[emline['Ha-6564'],:,:], 'UNRELIABLE'))
    uhagsig[~numpy.ma.getmaskarray(uhagsig)] = 0.0

    hbsflx = numpy.ma.MaskedArray(hdu['EMLINE_SFLUX'].data.copy()[emline['Hb-4862'],:,:],
          mask=bm.flagged(hdu['EMLINE_SFLUX_MASK'].data[emline['Hb-4862'],:,:], 'DONOTUSE'))
    uhbsflx = numpy.ma.MaskedArray(hdu['EMLINE_SFLUX'].data.copy()[emline['Hb-4862'],:,:],
          mask=~bm.flagged(hdu['EMLINE_SFLUX_MASK'].data[emline['Hb-4862'],:,:], 'UNRELIABLE'))
    uhbsflx[~numpy.ma.getmaskarray(uhbsflx)] = 0.0
    hbgflx = numpy.ma.MaskedArray(hdu['EMLINE_GFLUX'].data.copy()[emline['Hb-4862'],:,:],
          mask=bm.flagged(hdu['EMLINE_GFLUX_MASK'].data[emline['Hb-4862'],:,:], 'DONOTUSE'))
    uhbgflx = numpy.ma.MaskedArray(hdu['EMLINE_GFLUX'].data.copy()[emline['Hb-4862'],:,:],
          mask=~bm.flagged(hdu['EMLINE_GFLUX_MASK'].data[emline['Hb-4862'],:,:], 'UNRELIABLE'))
    uhbgflx[~numpy.ma.getmaskarray(uhbgflx)] = 0.0

    d4000 = numpy.ma.MaskedArray(hdu['SPECINDEX'].data.copy()[specindex['D4000'],:,:],
         mask=bm.flagged(hdu['SPECINDEX_MASK'].data[specindex['D4000'],:,:], 'DONOTUSE'))
    ud4000 = numpy.ma.MaskedArray(hdu['SPECINDEX'].data.copy()[specindex['D4000'],:,:],
         mask=~bm.flagged(hdu['SPECINDEX_MASK'].data[specindex['D4000'],:,:], 'UNRELIABLE'))
    ud4000[~numpy.ma.getmaskarray(ud4000)] = 0.0
    dn4000 = numpy.ma.MaskedArray(hdu['SPECINDEX'].data.copy()[specindex['Dn4000'],:,:],
          mask=bm.flagged(hdu['SPECINDEX_MASK'].data[specindex['Dn4000'],:,:], 'DONOTUSE'))
    udn4000 = numpy.ma.MaskedArray(hdu['SPECINDEX'].data.copy()[specindex['Dn4000'],:,:],
          mask=~bm.flagged(hdu['SPECINDEX_MASK'].data[specindex['Dn4000'],:,:], 'UNRELIABLE'))
    udn4000[~numpy.ma.getmaskarray(udn4000)] = 0.0

    # Get the limits to apply
    flux_lim = growth_lim(numpy.ma.log10(spxflx), 0.90, 1.05)
    t = numpy.ma.append(numpy.ma.log10(spxsnr), numpy.ma.log10(binsnr))
    snr_lim = growth_lim(t, 0.90, 1.05)
    bin_lim = [ numpy.ma.amin(binid), numpy.ma.amax(binid) ]

    res_lim = growth_lim(numpy.ma.log10(scfres), 0.90, 1.05)
    chi_lim = growth_lim(scrchi, 0.90, 1.05)
    t = numpy.ma.append(strvel, hagvel)
    vel_lim = growth_lim(t, 0.85, 1.10, midpoint=0.0)
    if vel_lim[0] < -350:
        vel_lim[0] = -350
    if vel_lim[1] > 350:
        vel_lim[1] = 350
    t = numpy.ma.append(numpy.ma.log10(strsig), numpy.ma.log10(hagsig))
    sig_lim = growth_lim(t, 0.90, 1.05)

    t = numpy.ma.append( numpy.ma.append(hasflx, hagflx),
                         numpy.ma.append(hbsflx, hbgflx) )
#    t = numpy.ma.log10(t)
    hflx_lim = growth_lim(t, 0.95, 1.10)
#    hflx_lim = [ -0.3, 2.2 ]
    t = numpy.ma.append(d4000, dn4000)
#    d4000_lim = growth_lim(t, 0.90, 1.05)
    d4000_lim = [ 1.0, 2.5 ]

#    print(flux_lim)
#    print(snr_lim)
#    print(bin_lim)
#    print(res_lim)
#    print(chi_lim)
#    print(vel_lim)
#    print(sig_lim)
#    print(hflx_lim)
#    print(d4000_lim)


    w,h = pyplot.figaspect(1)
    fig = pyplot.figure(figsize=(2*w,2*h))

    dx = 0.22
    left = 0.05
    top=0.94
    dw = 0.005

    snr_levels = [0.5, 1.0, 1.5, 2.0 ]

    ax = init_ax(fig, [left, top-dx, dx, dx])
    ax.xaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+dx*0.65, top-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(numpy.ma.log10(spxflx), origin='lower', interpolation='nearest',
                   cmap='YlGnBu_r', zorder=4, extent=extent, vmin=flux_lim[0], vmax=flux_lim[1])
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=5)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=6, color='0.5')
    pyplot.colorbar(im, cax=cax, orientation='horizontal',
                    ticks=[numpy.round(flux_lim[0]+0.1, decimals=1),
                           numpy.round(flux_lim[1]-0.1, decimals=1)], format='%.1f')
    ax.text(0.05, 0.05, r'r-band S (spx)', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)

    ax = init_ax(fig, [left+dx+dw, top-dx, dx, dx])
    ax.xaxis.set_major_formatter(NullFormatter())
    ax.yaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+dx+dw+dx*0.65, top-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(numpy.ma.log10(spxsnr), origin='lower', interpolation='nearest',
                   cmap='YlGnBu_r', zorder=4, extent=extent, vmin=snr_lim[0], vmax=snr_lim[1])
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels,  linewidths=1.5, zorder=5)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=6, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal',
                    ticks=[numpy.round(snr_lim[0]+0.1, decimals=1),
                           numpy.round(snr_lim[1]-0.1, decimals=1)], format='%.1f')
    ax.text(0.05, 0.05, r'r-band S/N (spx)', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)
   
    ax.text(1.0, 1.1, r'{0}-{1}; {2}'.format(plate,ifudesign, hdu['PRIMARY'].header['MANGAID']),
            horizontalalignment='center', verticalalignment='center', transform=ax.transAxes,
            fontsize=20)
  
    ax = init_ax(fig, [left+2*dx+2*dw, top-dx, dx, dx])
    ax.xaxis.set_major_formatter(NullFormatter())
    ax.yaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+2*dx+2*dw+dx*0.65, top-0.07*dx, 0.27*dx, 0.01])

    im = ax.imshow(binid[0,:,:], origin='lower', interpolation='nearest', cmap='CMRmap', zorder=4,
                   extent=extent, vmin=bin_lim[0], vmax=bin_lim[1])
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=5)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=6, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal', ticks=bin_lim, format='%.0f')
    ax.text(0.05, 0.05, r'bin ID', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)
 
    ax = init_ax(fig, [left+3*dx+3*dw, top-dx, dx, dx])
    ax.xaxis.set_major_formatter(NullFormatter())
    ax.yaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+3*dx+3*dw+dx*0.65, top-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(numpy.ma.log10(binsnr), origin='lower', interpolation='nearest',
                   cmap='YlGnBu_r', zorder=4, extent=extent, vmin=snr_lim[0], vmax=snr_lim[1])
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=5)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=6, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal',
                    ticks=[numpy.round(snr_lim[0]+0.1, decimals=1),
                           numpy.round(snr_lim[1]-0.1, decimals=1)], format='%.1f')
    ax.text(0.05, 0.05, r'r-band S/N (bin)', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)




    ax = init_ax(fig, [left, top-2*dx-dw, dx, dx])
    ax.xaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+dx*0.65, top-dx-dw-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(numpy.ma.log10(scfres), origin='lower', interpolation='nearest',
                   cmap='inferno', zorder=4, extent=extent, vmin=res_lim[0], vmax=res_lim[1])
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=5)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=6, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal',
                    ticks=[numpy.round(res_lim[0]+0.1, decimals=1),
                           numpy.round(res_lim[1]-0.1, decimals=1)], format='%.1f')
    ax.text(0.05, 0.05, r'log(pPXF Frac. Resid.)', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)

    ax = init_ax(fig, [left+dx+dw,  top-2*dx-dw, dx, dx])
    ax.xaxis.set_major_formatter(NullFormatter())
    ax.yaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+dx+dw+dx*0.65, top-dx-dw-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(scrchi, origin='lower', interpolation='nearest', cmap='inferno', zorder=4,
                   extent=extent, vmin=chi_lim[0], vmax=chi_lim[1])
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=5)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=6, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal',
                    ticks=[numpy.round(chi_lim[0]+0.01, decimals=2),
                           numpy.round(chi_lim[1]-0.01, decimals=2)], format='%.2f')
    ax.text(0.05, 0.05, r'${\rm pPXF}\ \chi^2_\nu$', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)
    
    ax = init_ax(fig, [left+2*dx+2*dw,  top-2*dx-dw, dx, dx])
    ax.xaxis.set_major_formatter(NullFormatter())
    ax.yaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+2*dx+2*dw+dx*0.65, top-dx-dw-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(strvel, origin='lower', interpolation='nearest', cmap='RdBu_r',
                   zorder=4, extent=extent, vmin=vel_lim[0], vmax=vel_lim[1])
    im2 = ax.imshow(ustrvel, origin='lower', interpolation='nearest', cmap='Greens_r',
                    vmin=0, vmax=1, zorder=5, alpha=0.3, extent=extent)
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=6)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=7, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal',
                    ticks=[numpy.round(vel_lim[0]+1), numpy.round(vel_lim[1]-1)], format='%.0f')
    ax.text(0.05, 0.05, r'$V_\ast$', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)
    
    ax = init_ax(fig, [left+3*dx+3*dw,  top-2*dx-dw, dx, dx])
    ax.xaxis.set_major_formatter(NullFormatter())
    ax.yaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+3*dx+3*dw+dx*0.65, top-dx-dw-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(numpy.ma.log10(strsig), origin='lower', interpolation='nearest',
                   cmap='viridis', zorder=4, extent=extent, vmin=sig_lim[0], vmax=sig_lim[1])
    im2 = ax.imshow(ustrsig, origin='lower', interpolation='nearest', cmap='Reds_r',
                    vmin=0, vmax=1, zorder=5, alpha=0.3, extent=extent)
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=6)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=7, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal',
                    ticks=[numpy.round(sig_lim[0]+0.1, decimals=1),
                           numpy.round(sig_lim[1]-0.1, decimals=1)], format='%.1f')
    ax.text(0.05, 0.05, r'$\log\ \sigma_\ast$', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)




    ax = init_ax(fig, [left, top-3*dx-2*dw, dx, dx])
    ax.xaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+dx*0.65, top-2*dx-2*dw-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(hasflx, origin='lower', interpolation='nearest', cmap='inferno',
                   zorder=4, extent=extent, vmin=hflx_lim[0], vmax=hflx_lim[1])
    im2 = ax.imshow(uhasflx, origin='lower', interpolation='nearest', cmap='Greens_r',
              vmin=0, vmax=1, zorder=5, alpha=0.3, extent=extent)
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=6)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=7, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal',
                    ticks=[numpy.round(hflx_lim[0]+0.1, decimals=1),
                           numpy.round(hflx_lim[1]-0.1, decimals=1)], format='%.1f')
    ax.text(0.05, 0.05, r'${\rm H}\alpha\ {\rm flux}$ (sum)', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)

    ax = init_ax(fig, [left+dx+dw,  top-3*dx-2*dw, dx, dx])
    ax.xaxis.set_major_formatter(NullFormatter())
    ax.yaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+dx+dw+dx*0.65, top-2*dx-2*dw-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(hagflx, origin='lower', interpolation='nearest', cmap='inferno',
                   zorder=4, extent=extent, vmin=hflx_lim[0], vmax=hflx_lim[1])
    im2 = ax.imshow(uhagflx, origin='lower', interpolation='nearest', cmap='Greens_r',
              vmin=0, vmax=1, zorder=5, alpha=0.3, extent=extent)
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=6)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=7, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal',
                    ticks=[numpy.round(hflx_lim[0]+0.1, decimals=1),
                           numpy.round(hflx_lim[1]-0.1, decimals=1)], format='%.1f')
    ax.text(0.05, 0.05, r'${\rm H}\alpha\ {\rm flux}$ (Gauss)', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)
    
    ax = init_ax(fig, [left+2*dx+2*dw,  top-3*dx-2*dw, dx, dx])
    ax.xaxis.set_major_formatter(NullFormatter())
    ax.yaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+2*dx+2*dw+dx*0.65, top-2*dx-2*dw-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(hagvel, origin='lower', interpolation='nearest', cmap='RdBu_r',
                   zorder=4, extent=extent, vmin=vel_lim[0], vmax=vel_lim[1])
    im2 = ax.imshow(uhagvel, origin='lower', interpolation='nearest', cmap='Greens_r',
              vmin=0, vmax=1, zorder=5, alpha=0.3, extent=extent)
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=6)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=7, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal',
                    ticks=[numpy.round(vel_lim[0]+1), numpy.round(vel_lim[1]-1)], format='%.0f')
    ax.text(0.05, 0.05, r'$V_{{\rm H}\alpha}$', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)
    
    ax = init_ax(fig, [left+3*dx+3*dw,  top-3*dx-2*dw, dx, dx])
    ax.xaxis.set_major_formatter(NullFormatter())
    ax.yaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+3*dx+3*dw+dx*0.65, top-2*dx-2*dw-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(numpy.ma.log10(hagsig), origin='lower', interpolation='nearest',
                   cmap='viridis', zorder=4, extent=extent, vmin=sig_lim[0], vmax=sig_lim[1])
    im2 = ax.imshow(uhagsig, origin='lower', interpolation='nearest', cmap='Reds_r',
                    vmin=0, vmax=1, zorder=5, alpha=0.3, extent=extent)
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=6)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=7, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal',
                    ticks=[numpy.round(sig_lim[0]+0.1, decimals=1),
                           numpy.round(sig_lim[1]-0.1, decimals=1)], format='%.1f')
    ax.text(0.05, 0.05, r'$\log\ \sigma_{{\rm H}\alpha}$', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)




    ax = init_ax(fig, [left, top-4*dx-3*dw, dx, dx])
    cax = fig.add_axes([left+dx*0.65, top-3*dx-3*dw-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(hbsflx, origin='lower', interpolation='nearest', cmap='inferno',
                   zorder=4, extent=extent, vmin=hflx_lim[0], vmax=hflx_lim[1])
    im2 = ax.imshow(uhbsflx, origin='lower', interpolation='nearest', cmap='Greens_r',
              vmin=0, vmax=1, zorder=5, alpha=0.3, extent=extent)
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=6)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=7, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal',
                    ticks=[numpy.round(hflx_lim[0]+0.1, decimals=1),
                           numpy.round(hflx_lim[1]-0.1, decimals=1)], format='%.1f')
    ax.text(0.05, 0.05, r'${\rm H}\beta\ {\rm flux}$ (sum)', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)

    ax = init_ax(fig, [left+dx+dw,  top-4*dx-3*dw, dx, dx])
    ax.yaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+dx+dw+dx*0.65, top-3*dx-3*dw-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(hbgflx, origin='lower', interpolation='nearest', cmap='inferno',
                   zorder=4, extent=extent, vmin=hflx_lim[0], vmax=hflx_lim[1])
    im2 = ax.imshow(uhbgflx, origin='lower', interpolation='nearest', cmap='Greens_r',
              vmin=0, vmax=1, zorder=5, alpha=0.3, extent=extent)
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=6)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=7, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal',
                    ticks=[numpy.round(hflx_lim[0]+0.1, decimals=1),
                           numpy.round(hflx_lim[1]-0.1, decimals=1)], format='%.1f')
    ax.text(0.05, 0.05, r'${\rm H}\beta\ {\rm flux}$ (Gauss)', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)
   
    ax = init_ax(fig, [left+2*dx+2*dw,  top-4*dx-3*dw, dx, dx])
    ax.yaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+2*dx+2*dw+dx*0.65, top-3*dx-3*dw-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(d4000, origin='lower', interpolation='nearest', cmap='RdBu_r',
                   zorder=4, extent=extent, vmin=d4000_lim[0], vmax=d4000_lim[1])
    im2 = ax.imshow(ud4000, origin='lower', interpolation='nearest', cmap='Greens_r',
                    vmin=0, vmax=1, zorder=5, alpha=0.3, extent=extent)
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=6)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=7, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal', ticks=d4000_lim, format='%.1f')
    ax.text(0.05, 0.05, r'D4000', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)
    
    ax = init_ax(fig, [left+3*dx+3*dw,  top-4*dx-3*dw, dx, dx])
    ax.yaxis.set_major_formatter(NullFormatter())
    cax = fig.add_axes([left+3*dx+3*dw+dx*0.65, top-3*dx-3*dw-0.07*dx, 0.27*dx, 0.01])
    im = ax.imshow(dn4000, origin='lower', interpolation='nearest', cmap='RdBu_r',
                   zorder=4, extent=extent, vmin=d4000_lim[0], vmax=d4000_lim[1])
    im2 = ax.imshow(udn4000, origin='lower', interpolation='nearest', cmap='Greens_r',
                    vmin=0, vmax=1, zorder=5, alpha=0.3, extent=extent)
    cnt = ax.contour(numpy.ma.log10(spxsnr), origin='lower', extent=im.get_extent(),
                     colors='0.5', levels=snr_levels, linewidths=1.5, zorder=6)
#    pyplot.clabel(cnt, inline=1, fontsize=8, fmt='%.1f', zorder=7, color='k')
    pyplot.colorbar(im, cax=cax, orientation='horizontal', ticks=d4000_lim, format='%.1f')
    ax.text(0.05, 0.05, r'Dn4000', horizontalalignment='left',
            verticalalignment='center', transform=ax.transAxes)

    if ofile is not None:
        fig.canvas.print_figure(ofile, bbox_inches='tight')
        print('Writing: {0}'.format(ofile))
    else:
        pyplot.show()

    fig.clear()
    pyplot.close(fig)

    

#-----------------------------------------------------------------------------

if __name__ == '__main__':
    t = time.clock()

    parser = ArgumentParser()

    parser.add_argument('plate', type=int, help='plate ID to process')
    parser.add_argument('ifudesign', type=int, help='IFU design to process')

    parser.add_argument('--drpver', type=str, help='DRP version', default=None)
    parser.add_argument('--dapver', type=str, help='DAP version', default=None)
    parser.add_argument('--dap_src', type=str, help='Top-level directory with the DAP source code;'
                        ' defaults to $MANGADAP_DIR', default=None)
    parser.add_argument("--analysis_path", type=str, help="main DAP output path", default=None)

    parser.add_argument("--plan_file", type=str, help="parameter file with the MaNGA DAP "
                        "execution plan to use instead of the default" , default=None)

    parser.add_argument('--daptype', type=str, help='DAP processing type', default=None)
    parser.add_argument('--normal_backend', dest='bgagg', action='store_false', default=True)

    arg = parser.parse_args()

    if arg.bgagg:
        matplotlib.use('Agg')

    # Set the the analysis path and make sure it exists
    analysis_path = default_analysis_path(drpver=arg.drpver, dapver=arg.dapver) \
                            if arg.analysis_path is None else arg.analysis_path

    daptypes = []
    if arg.daptype is None:
        plan_file = default_dap_plan_file(drpver=arg.drpver, dapver=arg.dapver,
                                          analysis_path=arg.analysis_path) \
                                            if arg.plan_file is None else arg.plan_file
        analysisplan = AnalysisPlanSet.from_par_file(plan_file)
        daptypes = [ default_dap_method(plan=p) for p in analysisplan ]
    else:
        daptypes = [arg.daptype]

    for daptype in daptypes:
        plan_qa_dir = default_dap_method_path(daptype, plate=arg.plate, ifudesign=arg.ifudesign,
                                              qa=True, drpver=arg.drpver, dapver=arg.dapver,
                                              analysis_path=analysis_path)
        ofile = os.path.join(plan_qa_dir,
                             'manga-{0}-{1}-MAPS-{2}-spotcheck.png'.format(arg.plate,
                                                                           arg.ifudesign, daptype))
        if not os.path.isdir(plan_qa_dir):
            os.makedirs(plan_qa_dir)

        spotcheck_images(analysis_path, daptype, arg.plate, arg.ifudesign, ofile=ofile)

    print('Elapsed time: {0} seconds'.format(time.clock() - t))



